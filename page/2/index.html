<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"qaqowoqaq.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="jyyyyyyyyyx">
<meta property="og:url" content="https://qaqowoqaq.github.io/page/2/index.html">
<meta property="og:site_name" content="jyyyyyyyyyx">
<meta property="og:locale">
<meta property="article:author" content="jyyyx">
<meta property="article:tag" content="cs">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://qaqowoqaq.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'cn'
  };
</script>

  <title>jyyyyyyyyyx</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">jyyyyyyyyyx</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">åæ¥å±…ä¸Š</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://qaqowoqaq.github.io/undefined/undefined/undefined/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jyyyx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jyyyyyyyyyx">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/undefined/undefined/undefined/undefined/" class="post-title-link" itemprop="url">csapp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-06-15 20:20:57" itemprop="dateCreated datePublished" datetime="2023-06-15T20:20:57+08:00">2023-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-06-16 10:06:48" itemprop="dateModified" datetime="2023-06-16T10:06:48+08:00">2023-06-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/csapp/" itemprop="url" rel="index"><span itemprop="name">csapp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ"><a href="#æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ" class="headerlink" title="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ"></a>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ</h1><h2 id="0x-ff-æ‚é¡¹"><a href="#0x-ff-æ‚é¡¹" class="headerlink" title="0x ff æ‚é¡¹"></a>0x ff æ‚é¡¹</h2><p>Instruction set Architectureï¼šISA,æŒ‡ä»¤é›†ä½“ç³»æ¶æ„</p>
<p>è½¯ä»¶å’Œç¡¬ä»¶ä¹‹é—´çš„ä¸€å±‚æŠ½è±¡å±‚</p>
<p>å†¯è¯ºä¾æ›¼è®¡ç®—æœºï¼Œå³ç¨‹åº<strong>å­˜å‚¨å‹</strong>è®¡ç®—æœº</p>
<p>é‡è¦æ€æƒ³ï¼šç¨‹åºå°±æ˜¯ä¸€ç³»åˆ—è¢«ç¼–ç äº†çš„å­—èŠ‚åºåˆ—ï¼ˆçœ‹ä¸Šå»å’Œæ•°æ®ä¸€æ¨¡ä¸€æ ·ï¼‰</p>
<hr>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/SovietPower/p/14877143.html">https://www.cnblogs.com/SovietPower/p/14877143.html</a></p>
<h2 id="0x-00-å‚è€ƒèµ„æ–™-amp-amp-lab"><a href="#0x-00-å‚è€ƒèµ„æ–™-amp-amp-lab" class="headerlink" title="0x 00 å‚è€ƒèµ„æ–™ &amp;&amp; lab"></a>0x 00 å‚è€ƒèµ„æ–™ &amp;&amp; lab</h2><p>officialï¼š</p>
<p><a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/students.html">å®˜ç½‘</a></p>
<p><a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/labs.html">å®éªŒ</a></p>
<hr>
<p>note:</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV17K4y1N7Q2?spm_id_from=333.999.0.0&vd_source=38033fe3a1f136728a1d6f8acf710b51">è§†é¢‘è¯¦è§£</a> </p>
<p><a target="_blank" rel="noopener" href="https://github.com/yangminz/bcst_csapp">ç¬”è®°å‚è€ƒè§†é¢‘çš„æºç </a></p>
<hr>
<p>labï¼š</p>
<p><a target="_blank" rel="noopener" href="https://github.com/wuxueqian14/CSAPP-Lab#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA">æ¯”è¾ƒè¯¦ç»†çš„Attackï¼ŒDataï¼ŒBoom Labå‚è€ƒ</a></p>
<p><a target="_blank" rel="noopener" href="https://kazamayc.github.io/2021/02/05/csapp-lab/">Boomï¼ŒAttackï¼ŒShell Lab</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/505497911">å…¨éƒ¨å®éªŒçš„è¯¦ç»†å‚è€ƒâ€“çŸ¥ä¹</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43362650/article/details/122890142">å…¨éƒ¨å®éªŒçš„è¯¦ç»†å‚è€ƒâ€“CSDN</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Exely/CSAPP-Labs">å…¨éƒ¨å®éªŒçš„è¯¦ç»†å‚è€ƒâ€“Github</a></p>
<hr>
<p>video:</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1RK4y1R7Kf?spm_id_from=333.999.0.0&vd_source=38033fe3a1f136728a1d6f8acf710b51">å¯¼è¯»</a>        <a target="_blank" rel="noopener" href="https://fengmuzi2003.gitbook.io/csapp3e/">å¯¼è¯»ç¬”è®°</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1cD4y1D7uR?spm_id_from=333.788.top_right_bar_window_custom_collection.content.click&vd_source=38033fe3a1f136728a1d6f8acf710b51">å°è§†é¢‘å¤ä¹ </a></p>
<hr>
<p>bookï¼š</p>
<p><a target="_blank" rel="noopener" href="https://hansimov.gitbook.io/csapp/">å­¦ç”Ÿç‰ˆé‡ç‚¹çŸ¥è¯†</a></p>
<p><a href="instructor">è®²å¸ˆç‰ˆé‡ç‚¹çŸ¥è¯†</a></p>
<hr>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">labæ“ä½œæµç¨‹</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.datalabï¼š</span></span><br><span class="line">åœ¨æºæ–‡ä»¶ bits.c ä¸­å®Œå–„å‡½æ•°å³å¯</span><br><span class="line">./dlc bits.c 	 // ç”¨äºæ£€æŸ¥ç¨‹åºæ˜¯å¦åˆæ³•ï¼Œæ˜¯å¦ä½¿ç”¨äº†ç¨‹åºè§„å®šçš„ç¬¦å·</span><br><span class="line">make btest   	 // btestæ˜¯è¯„åˆ†(æ£€æŸ¥å¯¹é”™å·¥å…·)ï¼Œæ¯æ¬¡æ‰§è¡Œbtetså‰éƒ½è¦é‡æ–°makeä¸€ä¸‹</span><br><span class="line">./btest bits.c   // è¯„åˆ†</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2.bomblab</span></span><br><span class="line">./bomb</span><br><span class="line">è¾“å…¥ç­”æ¡ˆ</span><br><span class="line">å¯¼è¯»P3-52åˆ†é’Ÿæœ‰ç¬¬ä¸€å…³çš„å®æ“</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3.attacklab</span></span><br><span class="line">./hex2raw &lt; att1.txt &gt; attraw1.txt // å°†å­—èŠ‚åºåˆ—at t1è½¬æ¢ä¸ºå­—ç¬¦ä¸²attraw1</span><br><span class="line">./ctarget -q -i attraw1.txt     //æµ‹è¯•ç­”æ¡ˆ</span><br><span class="line">// (https://github.com/wuxueqian14/csapp-lab/tree/master/Attack%20Lab)</span><br></pre></td></tr></table></figure>



<h2 id="0x-01-äºŒè¿›åˆ¶"><a href="#0x-01-äºŒè¿›åˆ¶" class="headerlink" title="0x 01 äºŒè¿›åˆ¶"></a>0x 01 äºŒè¿›åˆ¶</h2><p>å†…å­˜ä¸­å­˜å‚¨çš„æ˜¯ç”µå‹ï¼Œç„¶åé€šè¿‡ï¼ˆä¸çŸ¥é“ï¼‰æŸç§æ–¹å¼<strong>æŠ½è±¡</strong>ä¸ºæ•°å­—01ï¼Œç„¶è€Œè®¡ç®—æœºçš„å†…å­˜å¤ªå¤§äº†ï¼Œä»¥è‡´äº01çš„ä¸ªæ•°å®åœ¨å¤ªå¤šäº†ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬æŠŠåŸæœ‰çš„0å’Œ1åˆ†å—ï¼Œå¹¶å†æ¬¡æŠ½è±¡ä¸º0,1â€¦ã€‚</p>
<p><img src="file:///C:\Users\24072\AppData\Roaming\Tencent\Users\2407217576\QQ\WinTemp\RichOle\7E[W6J9]YPX$8MS~3CCM[DG.png" alt="img"></p>
<p>åŠ å…¥å†…å­˜ä¸­æœ‰n bit,æ¯m bitåˆ†ä¸ºä¸€å—ï¼Œåˆ™æœ€å¤šå¯ä»¥åˆ†ä¸º2^må—ï¼Œå› ä¸ºm bitçš„æ’åˆ—ç»„åˆæ•°ä¸º2 ^ nä¸ªåºåˆ—ï¼ˆsequenceï¼‰</p>
<p>ä¾‹å¦‚åè¿›åˆ¶æ•°å­—123ï¼Œå®ƒåº”è¯¥è¡¨ç¤ºä¸º<code>1*10^2 + 2*10^1 + 3*10^0</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„123å‡†ç¡®æ¥è¯´åº”è¯¥æ˜¯ä¸€ä¸ªsequenceï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ•°ã€‚</p>
<p>æ•°æ˜¯ä¸€ä¸ªæ¯”è¾ƒå”¯å¿ƒçš„æŠ½è±¡çš„æ¦‚å¿µï¼Œä½ è¯´ä¸€ä¸ªæ•°3ï¼Œå®ƒå¯ä»¥æ˜¯åè¿›åˆ¶åºåˆ—3ï¼Œä¹Ÿå¯ä»¥æ˜¯äºŒè¿›åˆ¶åºåˆ—11â€¦ï¼Œ3å’Œ11éƒ½æ˜¯è¿™ä¸ªçœŸæ­£çš„ï¼ˆå”¯å¿ƒçš„ï¼‰3ï¼Œè¿™äº›åºåˆ—ä¹‹é—´æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¸ä»…å¦‚æ­¤ï¼Œä»–ä»¬çš„è¿ç®—ä¹Ÿæ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚åè¿›åˆ¶çš„åºåˆ—1+2ï¼Œå¯¹åº”çš„äºŒè¿›åˆ¶ä¸‹åºåˆ—ä¸º1+01</p>
<p><strong>å–åå¯¹ç§°</strong>ï¼šå¯¹ç§°è½´çš„ä¸¤ä¾§æ˜¯ç›¸åæ•°</p>
<p>å¯¹äº1,2,3,4ï¼Œä»–ä»¬åˆ†åˆ«å–åå¯¹ç§°äº-1ï¼Œ-2ï¼Œ-3ï¼Œ-4</p>
<p>å¯¹äºäºŒè¿›åˆ¶000,001,010,011ï¼Œä»–ä»¬åˆ†åˆ«å–åå¯¹ç§°äº111,110,101,100</p>
<p><img src="https://s1.328888.xyz/2022/08/29/CrzXC.png" alt="IMAGE"></p>
<h2 id="0x-02-äºŒè¿›åˆ¶è¿ç®—"><a href="#0x-02-äºŒè¿›åˆ¶è¿ç®—" class="headerlink" title="0x 02 äºŒè¿›åˆ¶è¿ç®—"></a>0x 02 äºŒè¿›åˆ¶è¿ç®—</h2><p><strong>ä½è¿ç®—çš„å¾ªç¯åœˆï¼š</strong></p>
<p><img src="https://s1.328888.xyz/2022/09/06/5OAqi.png" alt="IMG"></p>
<p>â€‹										ï¼ˆintç±»å‹æœ‰ç¬¦å·æ•°ï¼‰</p>
<p><img src="https://s1.328888.xyz/2022/09/06/5jEa0.png" alt="img"></p>
<p>â€‹										(intç±»å‹æ— ç¬¦å·æ•°)</p>
<p>é€šè¿‡è¿™å¼ å›¾ï¼Œä½ å¯èƒ½ä¼šæ›´å¥½åœ°ç†è§£è¡¥ç å’Œæ— ç¬¦å·æ•°è¿ç®—æ˜¯åœ¨mod 2^n ä¸‹è®¡ç®—çš„æ„ä¹‰ã€‚</p>
<p>çœ‹ä¸€ä¸‹æ ‘çŠ¶æ•°ç»„lowbitå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">lowbit</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> x &amp; -x; <span class="comment">// &lt;==&gt; x &amp; (~x + 1);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¸ºä»€ä¹ˆèƒ½æ±‚å¾—æœ€åä¸€ä¸ª1æ‰€åœ¨ä½ç½®çš„ä»£è¡¨çš„æƒå€¼å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆ -xï¼Œå…¶å®å°±æ˜¯xçš„è¡¥ç ã€‚å…³äºè¡¥ç ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ±‚è¡¥ç çš„æ–¹æ³•ï¼šä»å³åˆ°å·¦ç›´åˆ°ç¬¬ä¸€ä¸ª1ä¿æŒä¸å˜ï¼Œåé¢çš„ä½å–åï¼Œæˆ‘ä»¬å°†xå’Œxçš„è¡¥ç åšä¸è¿ç®—ï¼Œæœ€åå¾—åˆ°çš„ç»“æœä¸€å®šæ˜¯è¿™æ ·çš„å½¢å¼ï¼š00..010..0ï¼Œæœ€åä¸€ä¸ª1å·¦ä¾§å…¨ä¸º0ï¼Œå³ä¾§ä¹Ÿå…¨ä¸º0ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">func1</span><span class="params">(<span class="type">unsigned</span> x)</span> &#123;</span><br><span class="line">    <span class="comment">// è¾“å‡ºä¸€ä¸ªæ— ç¬¦å·æ•°xï¼Œåˆ¤æ–­xåœ¨åå…­è¿›åˆ¶ä¸‹çš„çš„æ¯ä¸€ä½æ˜¯ä¸æ˜¯å­—æ¯</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥ä½æ˜¯å­—æ¯å°±è¿”å›1ï¼Œå¦åˆ™è¿”å›0</span></span><br><span class="line">    <span class="comment">// å¹¶ä»¥ä¸€ä¸ª16è¿›åˆ¶æ•°çš„å½¢å¼è¿”å›</span></span><br><span class="line">    <span class="type">unsigned</span> x1 = (x &amp; <span class="number">0x22222222</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> x2 = (x &amp; <span class="number">0x44444444</span>) &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    <span class="type">unsigned</span> x3 = (x &amp; <span class="number">0x88888888</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;[1]:%04x\n[2]:%04x\n[3]:%04x\n&quot;, x1, x2, x3);</span></span><br><span class="line">    <span class="keyword">return</span> x3 &amp; (x2 | x1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">func2</span><span class="params">(<span class="type">unsigned</span> x)</span> &#123;</span><br><span class="line">    <span class="comment">// è¾“å‡ºä¸€ä¸ªæ— ç¬¦å·æ•°xï¼Œåˆ¤æ–­xåœ¨åå…­è¿›åˆ¶ä¸‹çš„æ¯ä¸€ä½æ˜¯ä¸æ˜¯å­—æ¯</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ‰€æœ‰ä½éƒ½æ˜¯å­—æ¯è¿”å›1ï¼Œå¦åˆ™è¿”å›0</span></span><br><span class="line">    x = func1(x); <span class="comment">//å¾—åˆ°äº†æ¯ä¸€ä½çš„ç»“æœ</span></span><br><span class="line">    x = x &amp; (x &gt;&gt; <span class="number">16</span>); <span class="comment">// æ¯æ¬¡åˆ¤æ–­ä¸€åŠ</span></span><br><span class="line">    x = x &amp; (x &gt;&gt;  <span class="number">8</span>);</span><br><span class="line">    x = x &amp; (x &gt;&gt;  <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">func3</span><span class="params">(<span class="type">unsigned</span> x)</span> &#123;</span><br><span class="line">    <span class="comment">// bigCount</span></span><br><span class="line">    <span class="type">unsigned</span> c;</span><br><span class="line">    c = (x &amp; <span class="number">0x55555555</span>) + ((x &gt;&gt;  <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">    c = (c &amp; <span class="number">0x33333333</span>) + ((c &gt;&gt;  <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">    c = (c &amp; <span class="number">0x0f0f0f0f</span>) + ((c &gt;&gt;  <span class="number">4</span>) &amp; <span class="number">0x0f0f0f0f</span>);</span><br><span class="line">    c = (c &amp; <span class="number">0x00ff00ff</span>) + ((c &gt;&gt;  <span class="number">8</span>) &amp; <span class="number">0x00ff00ff</span>);</span><br><span class="line">    c = (c &amp; <span class="number">0x0000ffff</span>) + ((c &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0x0000ffff</span>);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> x = <span class="number">0x1</span>;</span><br><span class="line">    <span class="comment">// printf(&quot;0x%X = %X\n&quot;, x, func1(x));</span></span><br><span class="line">    <span class="comment">// printf(&quot;0x%X = %X\n&quot;, x, func2(x));</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;0x%X = %d\n&quot;</span>, x, func3(x));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="0x-03-æµ®ç‚¹æ•°"><a href="#0x-03-æµ®ç‚¹æ•°" class="headerlink" title="0x 03 æµ®ç‚¹æ•°"></a>0x 03 æµ®ç‚¹æ•°</h2><p>ä¸ºä»€ä¹ˆ IEEE 754æµ®ç‚¹æ•°Floatç±»å‹çš„bias&#x3D;127è€Œä¸æ˜¯128ï¼Ÿ</p>
<p>å…¶å®è¿™ä¹Ÿæ²¡æœ‰ä¸€ä¸ªå®˜æ–¹çš„è¯´æ³•ï¼Œä¸è¿‡ä¸ºäº†è®©è‡ªå·±æ¥å—è¿™ä¸ªè®¾å®šï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦è€ƒè™‘ï¼š</p>
<ol>
<li>é¦–å…ˆï¼Œbiasé‡‡ç”¨127æ—¶ç»å¯¹å€¼çš„èŒƒå›´æ¯”è¾ƒå¯¹ç§°</li>
<li>å…¶æ¬¡ï¼Œbiasé‡‡ç”¨127æ—¶æœ€å¤§çš„æŒ‡æ•°æ˜¯127æ¯”bias&#x3D;128æ—¶çš„126å¤§ï¼Œè™½ç„¶åªå¤§1ï¼Œä½†æ˜¯æˆ‘ä»¬ç›´åˆ°æŒ‡æ•°çš„å¢é•¿æ˜¯â€œçˆ†ç‚¸â€çš„ï¼Œå› æ­¤å…¶è¡¨ç¤ºçš„èŒƒå›´ä¹Ÿå¤§å¾—å¤šã€‚</li>
</ol>
<p>æµ®ç‚¹çš„æ ¹æ®expå’Œfracåˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š</p>
<ol>
<li>exp&#x3D;111..1ï¼ŒæŒ‡æ•°å…¨1ã€‚æ­¤æ—¶åˆåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šï¼ˆ1ï¼‰å½“fracå…¨0æ—¶è¡¨ç¤ºæ— ç©·å¤§ï¼Œæ ¹æ®ç¬¦å·ä½åˆåˆ†ä¸ºæ­£æ— ç©·å’Œè´Ÿæ— ç©·ã€‚ï¼ˆ2ï¼‰fracä¸å…¨ä¸º0ï¼Œè¡¨ç¤ºNaNï¼Œä¸€ç§æœªå®šä¹‰è¡Œä¸ºã€‚ï¼ˆå¯ä»¥è¿™æ ·åŒºåˆ†æ— ç©·å’ŒNaNï¼Œç”±äºæœªå®šä¹‰çš„è¡Œä¸ºæœ‰å¾ˆå¤šï¼Œå› æ­¤éœ€è¦æ ¹æ®fracè¿›ä¸€æ­¥åŒºåˆ†ï¼Œæ‰€ä»¥fracä¸æ˜¯å›ºå®šçš„å…¨0ï¼Œï¼ˆèƒ¡ä¹±çŒœçš„ï¼‰ï¼Œå¯ä»¥è¿™æ ·è®°å¿†ï¼‰ã€‚</li>
<li>exp&#x3D;000..0ï¼ŒæŒ‡æ•°å…¨0ã€‚è¡¨ç¤ºä¸è§„æ ¼åŒ–çš„æµ®ç‚¹æ•°ã€‚è¿™é‡Œçš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æ‹“å±•ç²¾åº¦å’ŒèŒƒå›´ï¼ˆå¾€å€¼å°çš„æ–¹å‘ï¼‰ã€‚</li>
<li>elseï¼Œè§„æ ¼åŒ–æµ®ç‚¹æ•°ã€‚</li>
</ol>
<p>å°†ä¸€ä¸ªæ— ç¬¦å·æ•°è½¬æ¢ä¸ºä¸€ä¸ªæµ®ç‚¹æ•°çš„è¡¨ç¤ºå½¢å¼å¹¶ä¿å­˜åœ¨ä¸€ä¸ªæ— ç¬¦å·æ•°å­—ä¸­</p>
<p><a target="_blank" rel="noopener" href="https://lostphp.com/hexconvert/">IEEE 754æµ®ç‚¹æ•°åå…­è¿›åˆ¶ç›¸äº’è½¬æ¢</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/68131179">å…³äºæµ®ç‚¹æ•°èˆå…¥çš„è®¨è®º</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">uint2float</span><span class="params">(<span class="type">uint32_t</span> u)</span>&#123; <span class="comment">// å°†ä¸€ä¸ªæœåŠ¡å·æ•°uè½¬æ¢æˆæµ®ç‚¹æ•°å­˜å‚¨çš„å½¢å¼</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç‰¹åˆ¤</span></span><br><span class="line">    <span class="keyword">if</span> (u == <span class="number">0x00000000</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x00000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ‰¾åˆ°æœ€åä¸€ä¸ª1çš„åé¢çš„ä¸€ä¸ªä½ç½®ï¼Œæ±‚å¾—è¯¥1åé¢è¿˜æœ‰å¤šå°‘ä¸ªæ•°</span></span><br><span class="line">    <span class="type">int</span> n = <span class="number">31</span>;</span><br><span class="line">    <span class="keyword">while</span> (n &gt;= <span class="number">0</span> &amp;&amp; (((u &gt;&gt; n) &amp; <span class="number">0x1</span>) == <span class="number">0x0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        n = n - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;n: &quot;</span> &lt;&lt; n &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">uint32_t</span> e, f; <span class="comment">// exp, frac</span></span><br><span class="line">    <span class="comment">// &lt;= 0000 0000 1.111 1111 1111 1111 1111 1111 : 32ä½</span></span><br><span class="line">    <span class="comment">// uçš„ä½æ•°&lt;=24ï¼Œæ­¤æ—¶å†éšè—ä¸€ä¸ª1ï¼Œå°±&lt;=23ä½ï¼Œäºæ˜¯fracå°±å¯ä»¥ä¿å­˜æ‰€æœ‰ä½ï¼Œä¸éœ€è¦èˆå…¥</span></span><br><span class="line">    <span class="keyword">if</span> (u &lt;= <span class="number">0x00ffffff</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// no need rounding</span></span><br><span class="line">        <span class="type">uint32_t</span> mask = <span class="number">0xffffffff</span> &gt;&gt; (<span class="number">32</span> - n); <span class="comment">// maskå°±æ˜¯fracçš„æ©ç </span></span><br><span class="line">        f = (u &amp; mask) &lt;&lt; (<span class="number">23</span> - n);             <span class="comment">// f = u &amp; maskå¾—åˆ°fracï¼Œä½†è¿˜éœ€è¦å·¦ç§»ç§»åŠ¨åˆ°æœ€å³ä¾§[frac00..0]ï¼Œè€Œä¸æ˜¯[00..0frac]</span></span><br><span class="line">        e = n + <span class="number">127</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;e: 0x%x, f: 0x%x\n&quot;</span>, e, f);</span><br><span class="line">        <span class="keyword">return</span> (e &lt;&lt; <span class="number">23</span>) | f;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// &gt;= 0000 0001 0000 0000 0000 0000 0000 0000 </span></span><br><span class="line">    <span class="comment">// æ€»ä½æ•°&gt;=25ï¼Œä¸€ä½å¯ä»¥éšè—ï¼Œè¿˜å‰©ä¸‹è‡³å°‘24ä½ï¼Œfracæ— æ³•å…¨éƒ¨ä¿å­˜ï¼Œéœ€è¦èˆå…¥(rounding)</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// expand to 64 bit for situations like 0xffffffff</span></span><br><span class="line">        <span class="type">uint64_t</span> a = <span class="number">0</span>;</span><br><span class="line">        a += u;</span><br><span class="line">        <span class="comment">// compute g, r, s</span></span><br><span class="line">        <span class="type">uint32_t</span> g = (a &gt;&gt; (n - <span class="number">23</span>)) &amp; <span class="number">0x1</span>;</span><br><span class="line">        <span class="type">uint32_t</span> r = (a &gt;&gt; (n - <span class="number">23</span> - <span class="number">1</span>)) &amp; <span class="number">0x1</span>;</span><br><span class="line">        <span class="type">uint32_t</span> s = <span class="number">0x0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; n - <span class="number">23</span> - <span class="number">1</span>; ++ j)</span><br><span class="line">        &#123;</span><br><span class="line">            s = s | ((u &gt;&gt; j) &amp; <span class="number">0x1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// compute carry</span></span><br><span class="line">        a = a &gt;&gt; (n - <span class="number">23</span>);</span><br><span class="line">        <span class="comment">// 0    1    ?    ... ?</span></span><br><span class="line">        <span class="comment">// [24] [23] [22] ... [0]</span></span><br><span class="line">        <span class="keyword">if</span> (r &amp; (g | s) == <span class="number">0x1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            a = a + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// check carry</span></span><br><span class="line">        <span class="keyword">if</span> ((a &gt;&gt; <span class="number">23</span>) == <span class="number">0x1</span>) /</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 0    1    ?    ... ?</span></span><br><span class="line">            <span class="comment">// [24] [23] [22] ... [0]</span></span><br><span class="line">            f = a &amp; <span class="number">0x007fffff</span>; <span class="comment">// 0x0000 0000 0111 1111 1111 1111 1111 1111åªä¿ç•™frac</span></span><br><span class="line">            e = n + <span class="number">127</span>;</span><br><span class="line">            <span class="keyword">return</span> (e &lt;&lt; <span class="number">23</span>) | f;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((a &gt;&gt; <span class="number">23</span>) == <span class="number">0x2</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 1    0    0    ... 0</span></span><br><span class="line">            <span class="comment">// [24] [23] [22] ... [0]</span></span><br><span class="line">            e = n + <span class="number">1</span> + <span class="number">127</span>;</span><br><span class="line">            <span class="keyword">return</span> (e &lt;&lt; <span class="number">23</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// INF as default error</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x7f800000</span>; <span class="comment">// 0 1111 1111 000 0000 0000 0000 0000 0000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> x;  <span class="built_in">cin</span> &gt;&gt; x;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x&quot;</span>, uint2float(<span class="number">0x10000000</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="0x-04-æ—¶åºç”µè·¯å’Œç»„åˆç”µè·¯"><a href="#0x-04-æ—¶åºç”µè·¯å’Œç»„åˆç”µè·¯" class="headerlink" title="0x 04 æ—¶åºç”µè·¯å’Œç»„åˆç”µè·¯"></a>0x 04 æ—¶åºç”µè·¯å’Œç»„åˆç”µè·¯</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_20265495/article/details/41314577">åŸæ–‡é“¾æ¥ï¼š</a></p>
<hr>
<p><strong>æ•°å­—ç”µè·¯</strong>æ ¹æ®é€»è¾‘åŠŸèƒ½çš„ä¸åŒç‰¹ç‚¹ï¼Œå¯ä»¥åˆ†æˆä¸¤å¤§ç±»ï¼Œä¸€ç±»å«<strong>ç»„åˆé€»è¾‘ç”µè·¯</strong>ï¼ˆç®€ç§°ç»„åˆç”µè·¯ï¼‰ï¼Œå¦ä¸€ç±»å«åš<strong>æ—¶åºé€»è¾‘ç”µè·¯</strong>ï¼ˆç®€ç§°æ—¶åºç”µè·¯ï¼‰ã€‚ç»„åˆé€»è¾‘ç”µè·¯åœ¨é€»è¾‘åŠŸèƒ½ä¸Šçš„ç‰¹ç‚¹æ˜¯ä»»æ„æ—¶åˆ»çš„è¾“å‡ºä»…ä»…å–å†³äºè¯¥æ—¶åˆ»çš„è¾“å…¥ï¼Œä¸ç”µè·¯åŸæ¥çš„çŠ¶æ€æ— å…³ã€‚è€Œæ—¶åºé€»è¾‘ç”µè·¯åœ¨é€»è¾‘åŠŸèƒ½ä¸Šçš„ç‰¹ç‚¹æ˜¯ä»»æ„æ—¶åˆ»çš„è¾“å‡ºä¸ä»…å–å†³äºå½“æ—¶çš„è¾“å…¥ä¿¡å·ï¼Œè€Œä¸”è¿˜å–å†³äºç”µè·¯åŸæ¥çš„çŠ¶æ€ï¼Œæˆ–è€…è¯´ï¼Œè¿˜ä¸ä»¥å‰çš„è¾“å…¥æœ‰å…³ã€‚</p>
<p>æ—¶åºç”µè·¯ï¼Œæ˜¯ç”±æœ€åŸºæœ¬çš„é€»è¾‘é—¨ç”µè·¯åŠ ä¸Šåé¦ˆé€»è¾‘å›è·¯ï¼ˆè¾“å‡ºåˆ°è¾“å…¥ï¼‰æˆ–å™¨ä»¶ç»„åˆè€Œæˆçš„ç”µè·¯ï¼Œä¸ç»„åˆç”µè·¯æœ€æœ¬è´¨çš„åŒºåˆ«åœ¨äºæ—¶åºç”µè·¯å…·æœ‰è®°å¿†åŠŸèƒ½ã€‚</p>
<p>æ—¶åºç”µè·¯çš„ç‰¹ç‚¹æ˜¯ï¼šè¾“å‡ºä¸ä»…å–å†³äºå½“æ—¶çš„è¾“å…¥å€¼ï¼Œè€Œä¸”è¿˜ä¸ç”µè·¯è¿‡å»çš„çŠ¶æ€æœ‰å…³ã€‚å®ƒç±»ä¼¼äºå«å‚¨èƒ½å…ƒä»¶çš„ç”µæ„Ÿæˆ–ç”µå®¹çš„ç”µè·¯ï¼Œå¦‚è§¦å‘å™¨ã€é”å­˜å™¨ã€è®¡æ•°å™¨ã€ç§»ä½å¯„å­˜å™¨ã€å­˜å‚¨å™¨ç­‰ç”µè·¯éƒ½æ˜¯æ—¶åºç”µè·¯çš„å…¸å‹å™¨ä»¶ï¼Œæ—¶åºé€»è¾‘ç”µè·¯çš„çŠ¶æ€æ˜¯ç”±å­˜å‚¨ç”µè·¯æ¥è®°å¿†å’Œè¡¨ç¤ºçš„ã€‚</p>
<p>æ—¶åºç”µè·¯å’Œç»„åˆç”µè·¯çš„åŒºåˆ«ï¼š<br>æ—¶åºç”µè·¯å…·æœ‰<strong>è®°å¿†åŠŸèƒ½</strong>ã€‚æ—¶åºç”µè·¯çš„ç‰¹ç‚¹æ˜¯ï¼šè¾“å‡ºä¸ä»…å–å†³äºå½“æ—¶çš„è¾“å…¥å€¼ï¼Œè€Œä¸”è¿˜ä¸ç”µè·¯è¿‡å»çš„çŠ¶æ€æœ‰å…³ã€‚ç»„åˆé€»è¾‘ç”µè·¯åœ¨é€»è¾‘åŠŸèƒ½ä¸Šçš„ç‰¹ç‚¹æ˜¯ä»»æ„æ—¶åˆ»çš„è¾“å‡ºä»…ä»…å–å†³äºè¯¥æ—¶åˆ»çš„è¾“å…¥ï¼Œä¸ç”µè·¯åŸæ¥çš„çŠ¶æ€æ— å…³</p>
<p>æ—¶åºç”µè·¯æ˜¯ æ—¶åº é€»è¾‘ ç”µè·¯ã€‚æ—¶åºï¼Œæ—¶é—´ é¡ºåºï¼Œæ˜¯åœ¨æ—¶é’Ÿçš„æ¨åŠ¨ä¸‹å·¥ä½œçš„ï¼Œcpuå°±æ˜¯ä¸€ä¸ªå¤æ‚çš„æ—¶åºç”µè·¯ã€‚</p>
<p>ç»„åˆé€»è¾‘ç”µè·¯å’Œæ—¶åºé€»è¾‘ç”µè·¯çš„æœ€æ ¹æœ¬åŒºåˆ«åœ¨äºï¼šç»„åˆé€»è¾‘ç”µè·¯çš„è¾“å‡ºåœ¨ä»»ä¸€æ—¶åˆ»åªå–å†³äºå½“æ—¶çš„è¾“å…¥ä¿¡å·ï¼›è€Œæ—¶åºé€»è¾‘ç”µè·¯çš„è¾“å‡ºï¼Œä¸ä»…å’Œå½“å‰çš„è¾“å…¥æœ‰å…³ï¼Œè¿˜å’Œä¸Šæ—¶åˆ»çš„è¾“å‡ºæœ‰å…³ï¼Œå®ƒå…·æœ‰è®°å¿†å…ƒä»¶ï¼ˆè§¦å‘å™¨ï¼‰ï¼Œå¯ä»¥è®°å½•å‰ä¸€æ—¶åˆ»çš„è¾“å‡ºçŠ¶æ€ï¼Œå®ƒå¯ä»¥æ²¡æœ‰è¾“å…¥ï¼Œä»…åœ¨æ—¶é’Ÿçš„é©±åŠ¨ä¸‹ï¼Œç»™å‡ºè¾“å‡ºã€‚</p>
<p>æ—¶åºç”µè·¯çš„åŸºæœ¬ç»“æ„ï¼š</p>
<p><img src="https://img-blog.csdn.net/20151210201333026?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center" alt="img"></p>
<p>ç»“æ„ç‰¹å¾ï¼š<em>ç”µè·¯ç”±ç»„åˆç”µè·¯å’Œå­˜å‚¨ç”µè·¯ç»„æˆ</em>ï¼Œç”µè·¯å­˜åœ¨åé¦ˆ </p>
<h2 id="0x-05-ç¼“å†²åŒºæ¼æ´å®éªŒ"><a href="#0x-05-ç¼“å†²åŒºæ¼æ´å®éªŒ" class="headerlink" title="0x 05 ç¼“å†²åŒºæ¼æ´å®éªŒ"></a>0x 05 ç¼“å†²åŒºæ¼æ´å®éªŒ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> <span class="comment">//bomb.c</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">echo</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">4</span>];</span><br><span class="line">	gets(buffer); <span class="comment">//ç¼“å†²åŒºæº¢å‡ºçš„å…³é”®</span></span><br><span class="line">	<span class="built_in">puts</span>(buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;pls input: &quot;</span>);</span><br><span class="line">	echo();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">æ“ä½œæ­¥éª¤ï¼š</span><br><span class="line">1. gcc bomb.c -o main -fno-stack-protector -g</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-fno-stack-protectorå–æ¶ˆæ ˆä¿æŠ¤ï¼Ÿ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-gè°ƒè¯•æ¨¡å¼ï¼Œå› ä¸ºåé¢è¿˜éœ€è¦è°ƒè¯•</span></span><br><span class="line"></span><br><span class="line">2. gdb main</span><br><span class="line">2.1 åœ¨echoå‡½æ•°çš„getså‡½æ•°åŠ ä¸Šä¸€ä¸ªæ–­ç‚¹ï¼šb 6</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">echo</span>å‡½æ•°ä½äºmain.cçš„ç¬¬å…­è¡Œ</span></span><br><span class="line">2.2 r</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">runè¿è¡Œç¨‹åºï¼Œæ­¤æ—¶ä¼šåœ¨æ–­ç‚¹getså‡½æ•°åœä¸‹</span></span><br><span class="line">2.3 info f </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ˜¾ç¤ºæ ˆä¿¡æ¯ï¼Œå¦‚ä¸‹æ–¹å›¾-æ ˆä¿¡æ¯æ‰€ç¤º</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åœ¨è¿™äº›ä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸‰ä¸ªåœ°å€ï¼š</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(1)frame at 0x7ff.f3d0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(2)rbp at   0x7ff.f3c0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(3)bip at.  0x7ff.f3c8</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…¶ä¸­frame atçš„åœ°å€æ˜¯å‡½æ•°<span class="built_in">echo</span>å ç”¨æ ˆçš„åœ°å€</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ­¤æ—¶ï¼Œè¿”å›åœ°å€ripå’Œæ—§çš„æ ˆé¡¶æŒ‡é’ˆrbpå·²ç»å…¥æ ˆ</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç”±æ­¤å¯è§ï¼Œç¨‹åºè¿˜æ²¡è¿è¡Œï¼Œè¿”å›åœ°å€å’Œæ—§çš„æ ˆé¡¶æŒ‡é’ˆå°±ä¼šå…¥æ ˆ</span></span><br><span class="line">2.4 p/a &amp;buffer[0]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ‰“å°æ•°ç»„bufferçš„é¦–åœ°å€</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€šè¿‡ç»“æ„å›¾ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ•°ç»„ä¸è¿”å›åœ°å€ripä¹‹é—´å·®äº†12ï¼ˆc8-bcï¼‰å­—èŠ‚ï¼Œå¦‚æœæˆ‘ä»¬getsçš„æ•°ç»„å¤§äºç­‰äº12å­—èŠ‚ï¼Œé‚£ä¹ˆè¿”å›åœ°å€çš„æ•°æ®å°±ä¼šè¢«ç ´åï¼Œ</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>![image-20220907100422585](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20220907100422585.png)</p>
<p>(å›¾-æ ˆä¿¡æ¯)</p>
<p>![13C288AA-6A07-463D-A689-CC7FEF2DCB91](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;13C288AA-6A07-463D-A689-CC7FEF2DCB91.png)</p>
<p>(å›¾-æ•°ç»„åœ°å€)</p>
<p><img src="https://1484576603-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-MV9vJFv4kmvRLgEog6g%2F-MZuBW3GNKr5zld5JHFH%2F-MZuER6OHxdJ7z3gtPNL%2Fimage.png?alt=media&token=ecba360a-06d3-4734-9430-aab5fd84cbee" alt="img"></p>
<p>(å›¾-è§†é¢‘æµ‹è¯•è¿è¡Œgetså‰çš„æ ˆ)</p>
<p><img src="https://1484576603-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-MV9vJFv4kmvRLgEog6g%2F-MZrajFxkCIYEw7i-1-F%2F-MZrrKB09-F7NqAWNBKB%2Finitpintu_%E5%89%AF%E6%9C%AC.jpg?alt=media&token=35b89f3f-e6d2-4aa9-b7d0-2da8ad86450b" alt="img"></p>
<p>ï¼ˆå›¾-è§†é¢‘æµ‹è¯•è¿è¡Œgetsåçš„æ ˆï¼‰</p>
<h2 id="0x-06-Computer-English"><a href="#0x-06-Computer-English" class="headerlink" title="0x 06 Computer English"></a>0x 06 Computer English</h2><hr>
<p>commonï¼šæ³¨é‡Š</p>
<p>overrideï¼šè¦†ç›–</p>
<p>entryï¼šå…¥å£ï¼Œæ¡ç›®ï¼Œè¾“å…¥</p>
<p>Place holderï¼šç«™ä½</p>
<p>ascendingï¼šå‡åº</p>
<p>descendingï¼šé™åº</p>
<p>commaï¼šé€—å·</p>
<p>bracketsï¼šæ‹¬å·</p>
<p>determine: ç¡®å®šï¼Œå†³å®šï¼Œåˆ¤å®šï¼Œä¸‹å†³å¿ƒ</p>
<p>deterministic: ç¡®å®šè¡Œ</p>
<p>finite: æœ‰é™çš„</p>
<p>infinite: æ— é™çš„</p>
<p>automaton: è‡ªåŠ¨æœº</p>
<p>positive: æ­£æ•°</p>
<p>negative: è´Ÿæ•°</p>
<p>decimal: åè¿›åˆ¶</p>
<p>hexadecimalï¼šåå…­è¿›åˆ¶</p>
<p>octal: å…«è¿›åˆ¶</p>
<p>optimazationï¼šä¼˜åŒ–</p>
<p>pruningï¼šå‰ªæ</p>
<p>decode:è¯‘ç </p>
<p>instance: ä¾‹å­ï¼Œå®ä¾‹</p>
<p>cpuå’Œmemory å°±ç»„æˆäº†ä¸€ä¸ªçŠ¶æ€æœº</p>
<p>operand æ“ä½œæ•°</p>
<p>opreatorï¼šæ“ä½œç¬¦</p>
<p>memoryï¼šå†…å­˜&#x2F;å­˜å‚¨å™¨</p>
<p>recursionï¼šé€’å½’</p>
<p>reduceï¼šå½’çº¦</p>
<p>iterate: è¿­ä»£</p>
<p>transistorï¼šæ™¶ä½“ç®¡</p>
<p>complementï¼šè¡¥å……ï¼Œè¡¥è¿ç®—(ï½)ï¼Œè¾…</p>
<p>parse: è§£æ</p>
<p>simulator: æ¨¡æ‹Ÿå™¨</p>
<p>simulate: æ¨¡æ‹Ÿï¼Œä»¿çœŸï¼Œå‡è£…</p>
<p>converterï¼šè½¬æ¢å™¨</p>
<p>verbose: å†—é•¿çš„ï¼Œå•°å—¦</p>
<p>handler: ç®¡ç†è€…ï¼Œå¤„ç†ç¨‹åº</p>
<p>illustrate: è¯´æ˜</p>
<p>universal: é€šç”¨çš„</p>
<p>pecuilar:  ç‰¹æœ‰ï¼Œå¥‡ç‰¹ï¼Œä¸€åœº</p>
<hr>
<h2 id="0x-07-makefile"><a href="#0x-07-makefile" class="headerlink" title="0x 07 makefile"></a>0x 07 <a target="_blank" rel="noopener" href="https://subingwen.cn/linux/makefile/#3-1-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F">makefile</a></h2><h3 id="1-è§„åˆ™"><a href="#1-è§„åˆ™" class="headerlink" title=".1 è§„åˆ™"></a>.1 è§„åˆ™</h3><p>ï¼ˆ1ï¼‰makeå‘½ä»¤å…·æœ‰<strong>è‡ªåŠ¨æ¨å¯¼</strong>çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ä¾èµ–ä¸­çš„.oæ–‡ä»¶ï¼Œå³ä½¿ä¸å­˜åœ¨ï¼Œmakeä¼šä½¿ç”¨å†…éƒ¨é»˜è®¤çš„æ„é€ è§„åˆ™ç”Ÿæˆè¿™äº›.oæ–‡ä»¶ã€‚</p>
<p>ï¼ˆ2ï¼‰makeåé¢<strong>ä¸å¸¦å‚æ•°</strong>é»˜è®¤æ‰§è¡Œç¬¬ä¸€æ¡å‘½ä»¤</p>
<p>ï¼ˆ3ï¼‰makçš„<strong>æ—¶é—´æˆ³è§„åˆ™</strong>ï¼š</p>
<blockquote>
<p>make å‘½ä»¤æ‰§è¡Œçš„æ—¶å€™ä¼šæ ¹æ®æ–‡ä»¶çš„æ—¶é—´æˆ³åˆ¤å®šæ˜¯å¦æ‰§è¡Œ makefile æ–‡ä»¶ä¸­ç›¸å…³è§„åˆ™ä¸­çš„å‘½ä»¤ã€‚</p>
<ol>
<li>ç›®æ ‡æ˜¯é€šè¿‡ä¾èµ–ç”Ÿæˆçš„ï¼Œå› æ­¤æ­£å¸¸æƒ…å†µä¸‹ï¼šç›®æ ‡æ—¶é—´æˆ³ &gt; æ‰€æœ‰ä¾èµ–çš„æ—¶é—´æˆ³ , å¦‚æœæ‰§è¡Œ make å‘½ä»¤çš„æ—¶å€™æ£€æµ‹åˆ°è§„åˆ™ä¸­çš„ç›®æ ‡å’Œä¾èµ–æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè§„åˆ™ä¸­çš„å‘½ä»¤å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚</li>
<li>å½“ä¾èµ–æ–‡ä»¶è¢«æ›´æ–°äº†ï¼Œæ–‡ä»¶æ—¶é—´æˆ³ä¹Ÿä¼šéšä¹‹è¢«æ›´æ–°ï¼Œè¿™æ—¶å€™ ç›®æ ‡æ—¶é—´æˆ³ &lt; æŸäº›ä¾èµ–çš„æ—¶é—´æˆ³ , åœ¨è¿™ç§æƒ…å†µä¸‹ç›®æ ‡æ–‡ä»¶ä¼šé€šè¿‡è§„åˆ™ä¸­çš„å‘½ä»¤è¢«é‡æ–°ç”Ÿæˆã€‚</li>
<li>å¦‚æœè§„åˆ™ä¸­çš„ç›®æ ‡å¯¹åº”çš„æ–‡ä»¶æ ¹æœ¬å°±ä¸å­˜åœ¨ï¼Œ é‚£ä¹ˆè§„åˆ™ä¸­çš„å‘½ä»¤è‚¯å®šä¼šè¢«æ‰§è¡Œã€‚</li>
</ol>
</blockquote>
<p>ï¼ˆ4ï¼‰å¯¹äºä¸ç”Ÿæˆç›®æ ‡æ–‡ä»¶çš„ç›®æ ‡ç§°ä¸ºä¼ªç›®æ ‡ï¼Œä¸ºäº†é¿å…å¾®ä¼ªç›®æ ‡çš„åå­—å’ŒçœŸå®çš„æ–‡ä»¶åé‡å¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¼ªç›®æ ‡çš„å‰é¢åŠ ä¸Šå…³é”®å­—ï¼š.PHONY(å‡) ä¾‹å¦‚ï¼š</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean</span></span><br><span class="line"><span class="section">clean: </span></span><br><span class="line">	rm *.o</span><br></pre></td></tr></table></figure>

<p>å£°æ˜ä½ä¼ªç›®æ ‡ä¸»è¦æ˜¯é¿å…è¿™ç§æƒ…å†µï¼š</p>
<blockquote>
<p>å¦‚æœç›®æ ‡ä¸å­˜åœ¨è§„åˆ™çš„å‘½ä»¤è‚¯å®šè¢«æ‰§è¡Œï¼Œ å¦‚æœç›®æ ‡æ–‡ä»¶å­˜åœ¨äº†å°±éœ€è¦æ¯”è¾ƒè§„åˆ™ä¸­ç›®æ ‡æ–‡ä»¶å’Œä¾èµ–æ–‡ä»¶çš„æ—¶é—´æˆ³ï¼Œæ»¡è¶³æ¡ä»¶æ‰æ‰§è¡Œè§„åˆ™çš„å‘½ä»¤ï¼Œå¦åˆ™ä¸æ‰§è¡Œã€‚</p>
<p>åŠ å…¥ç›®æ ‡æ˜¯cleanï¼Œè€Œæ°å¥½æœ‰ä¸€ä¸ªçœŸå®çš„cleanæ–‡ä»¶ï¼Œåªè¦cleanæ–‡ä»¶ä¸æ›´æ–°ï¼Œé‚£ä¹ˆcleanç›®æ ‡å°±æ— æ³•æ‰§è¡Œã€‚</p>
</blockquote>
<p>ï¼ˆæé†’ï¼‰<strong>ç›®å½•è¿æ¥åˆ°åšå®¢ä¸­çš„å®ä¾‹6å¯ä»¥å¥½å¥½çœ‹çœ‹ğŸ‘€</strong></p>
<h3 id="2-å˜é‡"><a href="#2-å˜é‡" class="headerlink" title=".2 å˜é‡"></a>.2 å˜é‡</h3><p>makeä¸­çš„å˜é‡åˆ†ä¸ºä¸‰ç§ï¼š</p>
<p><strong>1.è‡ªå®šä¹‰å˜é‡</strong>ï¼šå³ç”¨æˆ·è‡ªå·±å®šä¹‰çš„å˜é‡ï¼Œmakefileä¸­çš„å˜é‡æ˜¯<strong>æ²¡æœ‰ç±»å‹</strong>çš„ï¼Œç›´æ¥åˆ›å»ºå˜é‡ç„¶åç»™å…¶èµ‹å€¼å°±å¯ä»¥äº†ã€‚é€šè¿‡$(obj) å¯ä»¥å–å‡ºè‡ªå®šä¹‰çš„objå˜é‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">obj = main.c</span><br><span class="line">target = main</span><br><span class="line">depend = main.o</span><br><span class="line"></span><br><span class="line">$(target): $(depend)</span><br><span class="line">	gcc $(obj) -o $(target)</span><br><span class="line"></span><br><span class="line"># --------------</span><br><span class="line"># ä¸Šé¢çš„å‘½ä»¤ç­‰ä»·äºä¸‹é¢ï¼š</span><br><span class="line"></span><br><span class="line">main: main.o</span><br><span class="line">	gcc main.c -o main</span><br></pre></td></tr></table></figure>

<p><strong>2.é¢„å®šä¹‰å˜é‡ï¼š</strong>åœ¨makefileä¸­æœ‰ä¸€äº›å·²ç»å®šä¹‰å¥½çš„å˜é‡ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›å˜é‡ï¼Œä¸ç”¨è¿›è¡Œå®šä¹‰ï¼Œé¢„å®šä¹‰å˜é‡çš„åå­—ä¸€èˆ¬æ˜¯å¤§å†™çš„ã€‚</p>
<p>![96D31374-3040-4B27-8A65-B9DE685E3351](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;96D31374-3040-4B27-8A65-B9DE685E3351.png)</p>
<p><strong>3.è‡ªåŠ¨å˜é‡ï¼š</strong>makefileæ™ºèƒ½é¼“çš„è§„åˆ™è¯­å¥ç»å¸¸ä¼šå‡ºç°ç›®æ ‡æ–‡ä»¶å’Œä¾èµ–æ–‡ä»¶ï¼Œ<strong>è‡ªåŠ¨å˜é‡ç”¨æ¥ä»£è¡¨è¿™äº›è§„åˆ™ä¸­çš„ç›®æ ‡æ–‡ä»¶å’Œä¾èµ–æ–‡ä»¶ï¼Œå¹¶ä¸”è¡™é—¨åªèƒ½åœ¨è§„åˆ™çš„å‘½ä»¤æ€»ä½¿ç”¨ã€‚</strong></p>
<p>![DC05ED8E-B70B-44FB-A799-E6D0C938CF7F](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;DC05ED8E-B70B-44FB-A799-E6D0C938CF7F.png)</p>
<h3 id="3-æ¨¡å¼åŒ¹é…"><a href="#3-æ¨¡å¼åŒ¹é…" class="headerlink" title=".3 æ¨¡å¼åŒ¹é…"></a>.3 æ¨¡å¼åŒ¹é…</h3><p>æ¨¡å¼åŒ¹é…å¸¸å¸¸ä¸è‡ªåŠ¨å˜é‡ç»“åˆä½¿ç”¨ï¼Œç”¨æ¥ç®€åŒ–makefileï¼Œå‡å°‘å†—ä½™å’Œé‡å¤ä¹¦å†™ã€‚</p>
<h3 id="4-å‡½æ•°"><a href="#4-å‡½æ•°" class="headerlink" title=".4 å‡½æ•°"></a>.4 å‡½æ•°</h3><p>1.wildcardï¼šé€šé…ç¬¦ï¼Œç”¨æ¥åŒ¹é…åˆ¶å®šç›®å½•ä¸‹çš„æ–‡ä»¶</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ä¸¾ä¾‹: åˆ†åˆ«æœç´¢ä¸‰ä¸ªä¸åŒç›®å½•ä¸‹çš„ .c æ ¼å¼çš„æºæ–‡ä»¶</span></span><br><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> /home/robin/a/*.c /home/robin/b/*.c *.c)</span>  <span class="comment"># *.c == ./*.c</span></span><br><span class="line"><span class="comment"># è¿”å›å€¼: å¾—åˆ°ä¸€ä¸ªå¤§çš„å­—ç¬¦ä¸², é‡Œè¾¹æœ‰è‹¥å¹²ä¸ªæ»¡è¶³æ¡ä»¶çš„æ–‡ä»¶å, æ–‡ä»¶åä¹‹é—´ä½¿ç”¨ç©ºæ ¼é—´éš”</span></span><br><span class="line">/home/robin/a/a.c /home/robin/a/b.c /home/robin/b/c.c /home/robin/b/d.c e.c f.c</span><br></pre></td></tr></table></figure>



<p>2.patsubstï¼špattern subsitudeï¼ŒåŒ¹é…ä»£æ›¿ï¼Œç”¨æ¥æ›¿æ¢æ–‡ä»¶åçš„åç¼€</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">src = a.cpp b.cpp c.cpp e.cpp</span><br><span class="line"><span class="comment"># æŠŠå˜é‡ src ä¸­çš„æ‰€æœ‰æ–‡ä»¶åçš„åç¼€ä» .cpp æ›¿æ¢ä¸º .o</span></span><br><span class="line">obj = <span class="variable">$(<span class="built_in">patsubst</span> %.cpp, %.o, <span class="variable">$(src)</span>)</span> </span><br><span class="line"><span class="comment"># obj çš„å€¼ä¸º: a.o b.o c.o e.o</span></span><br></pre></td></tr></table></figure>



<h2 id="0x-08-gdb"><a href="#0x-08-gdb" class="headerlink" title="0x 08 gdb"></a>0x 08 gdb</h2><h3 id="0-å‚è€ƒ"><a href="#0-å‚è€ƒ" class="headerlink" title=".0 å‚è€ƒ"></a>.0 å‚è€ƒ</h3><p>![9523F5A0-416A-4635-99DB-47685282748F](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;9523F5A0-416A-4635-99DB-47685282748F.png)</p>
<p><a target="_blank" rel="noopener" href="https://subingwen.cn/linux/gdb/#5-3-3-next">æœ¬æ–‡æ¡£å‚è€ƒæ¥æºï¼ŒåŠŸèƒ½åŸºç¡€è€Œç®€å•</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/XxPIfrQ3E0GR88UsmQNggg">è®¾è®¡å¤šçº¿ç¨‹ï¼Œå¤šè¿›åŸç­‰é«˜çº§åŠŸèƒ½ï¼Œè¾ƒä¸ºå¤æ‚</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yanbinghu.com/2019/04/20/41283.html">çŸ¥ä¹</a></p>
<h3 id="1-æ·»åŠ å‘½ä»¤è¡Œå‚æ•°"><a href="#1-æ·»åŠ å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title=".1 æ·»åŠ å‘½ä»¤è¡Œå‚æ•°"></a>.1 æ·»åŠ å‘½ä»¤è¡Œå‚æ•°</h3><figure class="highlight plaintext"><figcaption><span>args â€¦```	å¯åŠ¨gdbåï¼Œåœ¨ç¨‹åºå¯åŠ¨ä¹‹å‰è®¾ç½®å‚æ•°</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">```show args```	æŸ¥çœ‹è®¾ç½®çš„å‘½ä»¤è¡Œå‚æ•°</span><br><span class="line"></span><br><span class="line">### .2 å¯åŠ¨ç¨‹åº</span><br><span class="line"></span><br><span class="line">åœ¨æ•´ä¸ªgdbè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå¯åŠ¨é¥®ç”¨ç¨‹åºçš„å‘½ä»¤åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚</span><br><span class="line"></span><br><span class="line">```run```		å¯ä»¥ç¼©å†™ä¸º `r`ï¼Œå¦‚æœç¨‹åºä¸­è®¾ç½®äº†æ–­ç‚¹ä¼šåœåœ¨ç¬¬ä¸€ä¸ªæ–­ç‚¹çš„ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æ–­ç‚¹ï¼Œç¨‹åºå°±æ‰§è¡Œå®Œäº†ã€‚</span><br><span class="line"></span><br><span class="line">`start` 	å¯åŠ¨ç¨‹åºï¼Œæœ€ç»ˆä¼šé˜»å¡åœ¨mainå‡½æ•°çš„ç¬¬ä¸€è¡Œï¼Œç­‰å¾…è¾“å…¥åç»­å…¶ä»– gdb å‘½ä»¤ã€‚</span><br><span class="line"></span><br><span class="line">&gt; start æ˜¯è¦å¼€å§‹è¿è¡Œï¼Œ run æ˜¯çœŸçš„è¿è¡Œã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### .3 é€€å‡º gdb</span><br><span class="line"></span><br><span class="line">`quit`  ç¼©å†™ä¸º `q`</span><br><span class="line"></span><br><span class="line">### .4 æŸ¥çœ‹ä»£ç </span><br><span class="line"></span><br><span class="line">`list`	å¯ä»¥ç¼©å†™ä¸º `l` ï¼Œé€šè¿‡è¿™ä¸ªå‘½ä»¤å¯ä»¥æŸ¥çœ‹é¡¹ç›®ä¸­ä»»æ„ä¸€ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”è¿˜å¯ä»¥é€šè¿‡æ–‡ä»¶è¡Œå·ï¼Œå‡½æ•°åç­‰æ–¹å¼æŸ¥çœ‹ã€‚</span><br><span class="line"></span><br><span class="line">``` shell</span><br><span class="line">(gdb) list</span><br><span class="line">(gdb) list è¡Œå·</span><br><span class="line">(gdb) list å‡½æ•°å</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªé¡¹ç›®é€šå¸¸ç”±å¤šä¸ªæºæ–‡ä»¶æ„æˆï¼Œé»˜è®¤æƒ…å†µä¸‹é€šè¿‡ list æŸ¥çœ‹çš„æ˜¯ç¨‹åºå…¥å£ main å‡½æ•°å¯¹åº”çš„æ–‡ä»¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) list æ–‡ä»¶åï¼šè¡Œå·</span><br><span class="line">(gdb) list æ–‡ä»¶åï¼šå‡½æ•°å</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤æƒ…å†µä¸‹ list ä¹‹æ˜¾ç¤º 10 è¡Œçš„å†…å®¹ã€‚å¦‚æœæƒ³æ˜¾ç¤ºæ›´å¤šï¼Œå¯ä»¥é€šè¿‡ <code>set listsize</code> è®¾ç½®ï¼ŒåŒæ—¶å¦‚æœæƒ³æŸ¥çœ‹å½“å‰æ˜¾ç¤ºçš„è¡Œæ•°å¯ä»¥é€šè¿‡ <code>show listsize</code> æŸ¥çœ‹ã€‚è¿™é‡Œçš„ 	<code>listsize</code> å¯ä»¥ç¼©å†™ä¸º <code>list</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) set listsize è¡Œå·</span><br><span class="line">(gdb) show listsize</span><br></pre></td></tr></table></figure>



<h3 id="5-æ–­ç‚¹æ“ä½œ"><a href="#5-æ–­ç‚¹æ“ä½œ" class="headerlink" title=".5 æ–­ç‚¹æ“ä½œ"></a>.5 æ–­ç‚¹æ“ä½œ</h3><p>å¦‚æœæƒ³é€šè¿‡ gdb æ‰æ—¶æŸä¸€è¡Œæˆ–è€…å¾—åˆ°æŸä¸ªå˜é‡åœ¨è¿è¡ŒçŠ¶æ€ä¸‹çš„å®é™…å€¼ï¼Œå°±éœ€è¦åœ¨è¿™ä¸€è¡Œè®¾ç½®æ–­ç‚¹ï¼Œç¨‹åºæŒ‡å®šåˆ°æ–­ç‚¹çš„ä½ç½®å°±ä¼šé˜»å¡ã€‚æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ gdb çš„è°ƒè¯•å‘½ä»¤å¾—åˆ°æˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯äº†ã€‚</p>
<p>è®¾ç½®æ–­ç‚¹ï¼š<code>break</code> ç¼©å†™ä¸º <code>b</code></p>
<p>æ–­ç‚¹çš„è®¾ç½®æ–¹å¼ç”±ä¸¤ç§ï¼š</p>
<ol>
<li>å¸¸è§„æ–­ç‚¹ï¼šç¨‹åºåªè¦è¿è¡Œåˆ°è¿™ä¸ªä½ç½®å°±ä¼šé˜»å¡</li>
<li>æ¡ä»¶æ–­ç‚¹ï¼šåªæœ‰æŒ‡å®šçš„æ¡ä»¶è¢«æ»¡è¶³äº†ç¨‹åºæ‰ä¼šåœ¨æ–­ç‚¹å¤„é˜»å¡</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®æ™®é€šæ–­ç‚¹åˆ°å½“å‰æ–‡ä»¶</span></span><br><span class="line">(gdb) b è¡Œå·</span><br><span class="line">(gdb) b å‡½æ•°å # åœåœ¨å‡½æ•°çš„ç¬¬ä¸€è¡Œ</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®æ™®é€šæ–­ç‚¹åˆ°æŸä¸ªéå½“å‰æ–‡ä»¶</span></span><br><span class="line">(gdb) b æ–‡ä»¶åï¼šè¡Œå·</span><br><span class="line">(gdb) b é—®ä»·åï¼šå‡½æ•°å # åœåœ¨å‡½æ•°çš„ç¬¬ä¸€è¡Œ</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®æ¡ä»¶æ–­ç‚¹</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨å¾ªç¯ä¸­æ¡ä»¶æ–­ç‚¹ç”¨çš„æ¯”è¾ƒå¤š</span></span><br><span class="line">(gdb)  b è¡Œå· if å˜é‡å == æŸä¸ªå€¼</span><br></pre></td></tr></table></figure>

<hr>
<p>æŸ¥çœ‹æ–­ç‚¹ï¼š<code>info break</code> ï¼Œå…¶ä¸­ <code>info</code> å¯ä»¥ç¼©å†™ä¸º <code>i</code> , <code>break</code> å¯ä»¥ç¼©å†™ä¸º <code>b</code></p>
<blockquote>
<p>info break æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯æ—¶çš„ä¸€äº›å¸¸ç”¨çš„å±æ€§ï¼šNum:   æ–­ç‚¹çš„ç¼–å·ï¼Œåˆ é™¤æ–­ç‚¹æˆ–è€…è®¾ç½®æ–­ç‚¹çŠ¶æ€çš„æ—¶å€™éƒ½éœ€è¦ä½¿ç”¨<br>Enb:    å½“å‰æ–­ç‚¹çš„çŠ¶æ€ï¼Œy è¡¨ç¤ºæ–­ç‚¹å¯ç”¨ï¼Œn è¡¨ç¤ºæ–­ç‚¹ä¸å¯ç”¨<br>What:  æè¿°æ–­ç‚¹è¢«è®¾ç½®åœ¨äº†å“ªä¸ªæ–‡ä»¶çš„å“ªä¸€è¡Œæˆ–è€…å“ªä¸ªå‡½æ•°ä¸Š</p>
</blockquote>
<hr>
<p>å¦‚æœç¡®å®šè®¾ç½®çš„æŸä¸ªæ–­ç‚¹ä¸å†è¢«ä½¿ç”¨äº†ï¼Œå¯ç”¨å°†å…¶åˆ é™¤ï¼Œåˆ é™¤å‘½ä»¤æ˜¯ <code>delete</code> æ–­ç‚¹ç¼–å· , è¿™ä¸ª <code>delete</code> å¯ä»¥ç®€å†™ä¸º <code>del</code> ä¹Ÿå¯ä»¥å†ç®€å†™ä¸º <code>d</code>ã€‚</p>
<p>åˆ é™¤æ–­ç‚¹çš„æ–¹å¼æœ‰ä¸¤ç§: <strong>åˆ é™¤(ä¸€ä¸ªæˆ–è€…å¤šä¸ª)æŒ‡å®šæ–­ç‚¹</strong>æˆ–è€…<strong>åˆ é™¤ä¸€ä¸ªè¿ç»­çš„æ–­ç‚¹åŒºé—´</strong>ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">delete == del == d</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">éœ€è¦ info b æŸ¥çœ‹æ–­ç‚¹çš„ä¿¡æ¯, ç¬¬ä¸€åˆ—å°±æ˜¯ç¼–å·</span></span><br><span class="line">(gdb) d æ–­ç‚¹çš„ç¼–å·1 [æ–­ç‚¹ç¼–å·2 ...]</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸¾ä¾‹:</span> </span><br><span class="line">(gdb) d 1          # åˆ é™¤ç¬¬1ä¸ªæ–­ç‚¹</span><br><span class="line">(gdb) d 2 4 6      # åˆ é™¤ç¬¬2,4,6ä¸ªæ–­ç‚¹</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ é™¤ä¸€ä¸ªèŒƒå›´, æ–­ç‚¹ç¼–å· num1 - numN æ˜¯ä¸€ä¸ªè¿ç»­åŒºé—´</span></span><br><span class="line">(gdb) d num1-numN</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸¾ä¾‹, åˆ é™¤ç¬¬1åˆ°ç¬¬5ä¸ªæ–­ç‚¹</span></span><br><span class="line">(gdb) d 1-5</span><br></pre></td></tr></table></figure>



<hr>
<p>å¦‚æœæŸä¸ªæ–­ç‚¹åªæ˜¯ä¸´æ—¶ä¸éœ€è¦äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è®¾ç½®ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œè®¾ç½®å‘½ä»¤ä¸º <code>disable</code> æ–­ç‚¹ç¼–å·ï¼Œå½“éœ€è¦çš„æ—¶å€™å†å°†å…¶è®¾ç½®å›å¯ç”¨çŠ¶æ€ï¼Œè®¾ç½®å‘½ä»¤ä¸º <code>enable</code> æ–­ç‚¹ç¼–å·ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># è®©æ–­ç‚¹å¤±æ•ˆä¹‹å, gdbè°ƒè¯•è¿‡ç¨‹ä¸­ç¨‹åºæ˜¯ä¸ä¼šåœåœ¨è¿™ä¸ªä½ç½®çš„</span><br><span class="line"># disable == dis</span><br><span class="line"># è®¾ç½®æŸä¸€ä¸ªæˆ–è€…æŸå‡ ä¸ªæ–­ç‚¹æ— æ•ˆ</span><br><span class="line">(gdb) dis æ–­ç‚¹1çš„ç¼–å· [æ–­ç‚¹2çš„ç¼–å· ...]</span><br><span class="line"></span><br><span class="line"># è®¾ç½®æŸä¸ªåŒºé—´æ–­ç‚¹æ— æ•ˆ</span><br><span class="line">(gdb) dis æ–­ç‚¹1ç¼–å·-æ–­ç‚¹nç¼–å·</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">2       breakpoint     keep y   0x0000000000400cce in main() at test.cpp:14</span><br><span class="line">4       breakpoint     keep y   0x0000000000400cdd in main() at test.cpp:16</span><br><span class="line">5       breakpoint     keep y   0x0000000000400d46 in main() at test.cpp:23</span><br><span class="line">6       breakpoint     keep y   0x0000000000400d4e in main() at test.cpp:25</span><br><span class="line">7       breakpoint     keep y   0x0000000000400d6e in main() at test.cpp:28</span><br><span class="line">8       breakpoint     keep y   0x0000000000400d7d in main() at test.cpp:30</span><br><span class="line"></span><br><span class="line"># è®¾ç½®ç¬¬2, ç¬¬4 ä¸ªæ–­ç‚¹æ— æ•ˆ</span><br><span class="line">(gdb) dis 2 4</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">2       breakpoint     keep n   0x0000000000400cce in main() at test.cpp:14</span><br><span class="line">4       breakpoint     keep n   0x0000000000400cdd in main() at test.cpp:16</span><br><span class="line">5       breakpoint     keep y   0x0000000000400d46 in main() at test.cpp:23</span><br><span class="line">6       breakpoint     keep y   0x0000000000400d4e in main() at test.cpp:25</span><br><span class="line">7       breakpoint     keep y   0x0000000000400d6e in main() at test.cpp:28</span><br><span class="line">8       breakpoint     keep y   0x0000000000400d7d in main() at test.cpp:30</span><br><span class="line"></span><br><span class="line"># è®¾ç½® ç¬¬5,6,7,8ä¸ª æ–­ç‚¹æ— æ•ˆ</span><br><span class="line">(gdb) dis 5-8</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹æ–­ç‚¹ä¿¡æ¯</span><br><span class="line">(gdb) i b</span><br><span class="line">Num     Type           Disp Enb Address            What</span><br><span class="line">2       breakpoint     keep n   0x0000000000400cce in main() at test.cpp:14</span><br><span class="line">4       breakpoint     keep n   0x0000000000400cdd in main() at test.cpp:16</span><br><span class="line">5       breakpoint     keep n   0x0000000000400d46 in main() at test.cpp:23</span><br><span class="line">6       breakpoint     keep n   0x0000000000400d4e in main() at test.cpp:25</span><br><span class="line">7       breakpoint     keep n   0x0000000000400d6e in main() at test.cpp:28</span><br><span class="line">8       breakpoint     keep n   0x0000000000400d7d in main() at test.cpp:30</span><br></pre></td></tr></table></figure>

<p>è®©æ— æ•ˆçš„æ–­ç‚¹ç”Ÿæ•ˆï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">enable</span> == ena</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®æŸä¸€ä¸ªæˆ–è€…æŸå‡ ä¸ªæ–­ç‚¹æœ‰æ•ˆ</span></span><br><span class="line">(gdb) ena æ–­ç‚¹1çš„ç¼–å· [æ–­ç‚¹2çš„ç¼–å· ...]</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è®¾ç½®æŸä¸ªåŒºé—´æ–­ç‚¹æœ‰æ•ˆ</span></span><br><span class="line">(gdb) ena æ–­ç‚¹1ç¼–å·-æ–­ç‚¹nç¼–å·</span><br></pre></td></tr></table></figure>



<h3 id="6-è°ƒè¯•å‘½ä»¤"><a href="#6-è°ƒè¯•å‘½ä»¤" class="headerlink" title=".6 è°ƒè¯•å‘½ä»¤"></a>.6 è°ƒè¯•å‘½ä»¤</h3><p>å¦‚æœè°ƒè¯•çš„ç¨‹åºè¢«æ–­ç‚¹é˜»å¡äº†åˆæƒ³è®©ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ <code>continue</code> å‘½ä»¤ã€‚ç¨‹åºä¼šç»§ç»­è¿è¡Œï¼Œç›´åˆ°é‡åˆ°ä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„æ–­ç‚¹ã€‚&#96;&#96;continue<code>å¯ä»¥ç¼©å†™ä¸º</code>c&#96;ã€‚</p>
<p>åœ¨ gdb è°ƒè¯•çš„æ—¶å€™å¦‚æœéœ€è¦æ‰“å°å˜é‡çš„å€¼ï¼Œ ä½¿ç”¨çš„å‘½ä»¤æ˜¯ <code>print</code>, å¯ç¼©å†™ä¸º <code>p</code>ã€‚å¦‚æœæ‰“å°çš„å˜é‡æ˜¯æ•´æ•°è¿˜å¯ä»¥æŒ‡å®šè¾“å‡ºçš„æ•´æ•°çš„æ ¼å¼ï¼Œæ ¼å¼åŒ–è¾“å‡ºçš„æ•´æ•°å¯¹åº”çš„å­—ç¬¦è¡¨å¦‚ä¸‹ï¼š</p>
<p>![9BDD57D6-6D87-4080-B269-951C45DEC259](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;9BDD57D6-6D87-4080-B269-951C45DEC259.png)</p>
<p><code>printf</code> çš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">print</span> == p</span></span><br><span class="line">(gdb) p å˜é‡å</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¦‚æœå˜é‡æ˜¯ä¸€ä¸ªæ•´å½¢, é»˜è®¤å¯¹åº”çš„å€¼æ˜¯ä»¥10è¿›åˆ¶æ ¼å¼è¾“å‡º, å…¶ä»–æ ¼å¼è¯·å‚è€ƒä¸Šè¡¨</span></span><br><span class="line">(gdb) p/fmt å˜é‡å</span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸¾ä¾‹</span></span><br><span class="line">(gdb) p i       # 10è¿›åˆ¶</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">5 = 3</span></span><br><span class="line">(gdb) p/x i     # 16è¿›åˆ¶</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">6 = 0x3</span></span><br><span class="line">(gdb) p/o i     # 8è¿›åˆ¶</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">7 = 03</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœåœ¨è°ƒè¯•è¿‡ç¨‹ä¸­éœ€è¦æŸ¥çœ‹æŸä¸ªå˜é‡çš„ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>ptype</code>, è¯­æ³•æ ¼å¼å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¯­æ³•æ ¼å¼</span></span><br><span class="line">(gdb) ptype å˜é‡å</span><br></pre></td></tr></table></figure>

<p>ä¸¾ä¾‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ‰“å°å˜é‡ç±»å‹</span></span><br><span class="line">(gdb) ptype i</span><br><span class="line">type = int</span><br><span class="line">(gdb) ptype array[i]</span><br><span class="line">type = int</span><br><span class="line">(gdb) ptype array</span><br><span class="line">type = int [12]</span><br></pre></td></tr></table></figure>

<hr>
<p>å•æ­¥è°ƒè¯•</p>
<p><code>step</code> å‘½ä»¤å¯ä»¥ç¼©å†™ä¸º <code>s</code>, å‘½ä»¤è¢«æ‰§è¡Œä¸€æ¬¡ä»£ç è¢«å‘ä¸‹æ‰§è¡Œä¸€è¡Œï¼Œå¦‚æœè¿™ä¸€è¡Œæ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆç¨‹åºä¼šè¿›å…¥åˆ°å‡½æ•°ä½“å†…éƒ¨ã€‚</p>
<p>å¦‚æœé€šè¿‡ <code>s</code> å•æ­¥è°ƒè¯•è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨ï¼Œ<strong>æƒ³è¦è·³å‡ºè¿™ä¸ªå‡½æ•°ä½“ï¼Œ å¯ä»¥æ‰§è¡Œ <code>finish</code> å‘½ä»¤ã€‚å¦‚æœæƒ³è¦è·³å‡ºå‡½æ•°ä½“å¿…é¡»è¦ä¿è¯å‡½æ•°ä½“å†…ä¸èƒ½æœ‰æœ‰æ•ˆæ–­ç‚¹ï¼Œå¦åˆ™æ— æ³•è·³å‡ºã€‚</strong></p>
<p><code>next</code> å‘½ä»¤å’Œ <code>step</code> å‘½ä»¤åŠŸèƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œåªæ˜¯åœ¨ä½¿ç”¨ <code>next</code> è°ƒè¯•ç¨‹åºçš„æ—¶å€™ä¸ä¼šè¿›å…¥åˆ°å‡½æ•°ä½“å†…éƒ¨ï¼Œ<code>next</code> å¯ä»¥ç¼©å†™ä¸º <code>n</code></p>
<p>é€šè¿‡ <code>until</code> å‘½ä»¤å¯ä»¥ç›´æ¥è·³å‡ºæŸä¸ªå¾ªç¯ä½“ï¼Œè¿™æ ·å°±èƒ½æé«˜è°ƒè¯•æ•ˆç‡äº†ã€‚å¦‚æœæƒ³ç›´æ¥ä»å¾ªç¯ä½“ä¸­è·³å‡ºï¼Œå¿…é¡»è¦æ»¡è¶³ä»¥ä¸‹çš„æ¡ä»¶ï¼Œå¦åˆ™å‘½ä»¤ä¸ä¼šç”Ÿæ•ˆï¼š</p>
<h2 id="0x-e5-ç»“æ„ä½“å­—èŠ‚å¯¹é½è§„åˆ™"><a href="#0x-e5-ç»“æ„ä½“å­—èŠ‚å¯¹é½è§„åˆ™" class="headerlink" title="0x e5 ç»“æ„ä½“å­—èŠ‚å¯¹é½è§„åˆ™"></a>0x e5 ç»“æ„ä½“å­—èŠ‚å¯¹é½è§„åˆ™</h2><p>ç»“æ„ä½“çš„å¤§å°ç»å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸ä¼šç›´æ¥ç­‰äºå„ä¸ªæˆå‘˜å¤§å°çš„æ€»å’Œï¼Œç¼–è¯‘å™¨ä¸ºäº†ä¼˜åŒ–å¯¹ç»“æ„ä½“æˆå‘˜çš„è®¿é—®æ€»ä¼šåœ¨ç»“æ„ä½“ä¸­æ’å…¥ä¸€äº›ç©ºç™½å­—èŠ‚ï¼Œæœ‰å¦‚ä¸‹ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">align_basic</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">char</span> c;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">double</span> d;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ­¤æ—¶<code>sizeof(align_basic)</code>çš„å€¼ä¼šæ˜¯<code>sizeof(char)+sizeof(int)+sizeof(double)</code>çš„å€¼ä¹ˆï¼Ÿ</p>
<p><img src="https://pic3.zhimg.com/80/v2-dca7f4f607fdbc884079e30c10ceb7ae_1440w.png" alt="img"></p>
<p>å¦‚ä¸Šå›¾ç»è¿‡æµ‹è¯•æˆ‘ä»¬å‘ç°å…¶å¤§å°ä¸º16ä¸ªå­—èŠ‚å¹¶ä¸ç­‰äº1+4+8&#x3D;13ä¸ªå­—èŠ‚ï¼Œå¯çŸ¥ç¼–è¯‘å™¨ç»™align_basicç»“æ„ä½“æ’å…¥äº†å¦å¤–3ä¸ªå­—èŠ‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ†æç¼–è¯‘å™¨å¯¹é½å­—èŠ‚çš„è§„åˆ™ä»¥åŠç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„ç»“æ„ï¼Œé¦–å…ˆæ„Ÿè°¢<a href="https://link.zhihu.com/?target=http://blog.csdn.net/liukun321/article/details/6974282">ç»“æ„ä½“åœ¨å†…å­˜ä¸­çš„å¯¹é½è§„åˆ™ - å’•å”§å’•å”§shubo.lkçš„ä¸“æ  - åšå®¢é¢‘é“ - CSDN.NET</a>è¿™ç¯‡æ–‡ç« çš„ä½œè€…ï¼Œåœ¨æ­¤ä¹‹å‰æˆ‘å¯¹å†…å­˜å¯¹é½ä¹Ÿæ˜¯ä¸€çŸ¥åŠè§£ï¼Œå¾ˆå¤šæ—¶å€™ä¹Ÿè§£é‡Šä¸æ˜ç™½ã€‚</p>
<p>&#x3D;&#x3D;è§„åˆ™ä¸€ï¼šç»“æ„ä½“ä¸­å…ƒç´ æŒ‰ç…§å®šä¹‰é¡ºåºä¾æ¬¡ç½®äºå†…å­˜ä¸­ï¼Œä½†å¹¶ä¸æ˜¯ç´§å¯†æ’åˆ—ã€‚ä»ç»“æ„ä½“é¦–åœ°å€å¼€å§‹ä¾æ¬¡å°†å…ƒç´ æ”¾å…¥å†…å­˜æ—¶ï¼Œå…ƒç´ ä¼šè¢«æ”¾ç½®åœ¨å…¶è‡ªèº«å¯¹é½å¤§å°çš„æ•´æ•°å€åœ°å€ä¸Šã€‚&#x3D;&#x3D;è¿™é‡Œè¯´çš„åœ°å€æ˜¯å…ƒç´ åœ¨ç»“æ„ä½“ä¸­çš„åç§»é‡ï¼Œç»“æ„ä½“é¦–åœ°å€åç§»é‡ä¸º0ã€‚</p>
<p>åœ¨align_basicä¸­å…ƒç´ cæ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆå®ƒçš„åœ°å€ä¸º0ï¼Œç¬¬äºŒä¸ªå…ƒç´ iä¸ä¼šè¢«æ”¾åœ¨åœ°å€1å¤„ï¼Œintçš„å¯¹é½å¤§å°ä¸º4ä¸ªå­—èŠ‚ï¼Œæ­¤æ—¶è™½ç„¶å…ƒç´ cåªå æ®ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ç”±äºiçš„åœ°å€å¿…é¡»åœ¨4å­—èŠ‚çš„æ•´æ•°å€ä¸Šï¼Œæ‰€ä»¥åœ°å€å¿…é¡»å†å‘ååœ¨ç§»åŠ¨ä¸‰ä¸ªå­—èŠ‚ï¼Œæ•…è€Œéœ€è¦æ”¾åœ¨åœ°å€4ä¸Šï¼Œæ­¤æ—¶å‰ä¸¤ä¸ªå…ƒç´ å·²ç»å æ®äº†8ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ dä¼šè¢«ç›´æ¥æ”¾åœ¨åœ°å€8ä¸Šï¼Œå› ä¸ºdoubleçš„å¯¹é½å¤§å°ä¸º8ä¸ªå­—èŠ‚ï¼Œè€Œå‰é¢ä¸¤ä¸ªå…ƒç´ å·²ç»å æ®äº†8ä¸ªå­—èŠ‚ï¼Œæ­£å¥½æ˜¯doubleå¯¹é½å¤§å°çš„æ•´æ•°å€ï¼Œæ‰€ä»¥å…ƒç´ dä¸éœ€è¦å†å¾€åç§»åŠ¨ã€‚è¯´äº†è¿™ä¹ˆå¤šä¹Ÿä¸å¦‚è®©æœºå™¨ç»™æˆ‘ä»¬éªŒè¯ä¸‹æœ‰è¯´æœåŠ›ï¼š</p>
<p><code>printf(&quot;%d %d %d %d\n&quot;, sizeof(align_basic), &amp;align_basic::c, &amp;align_basic::i, &amp;align_basic::d);</code></p>
<p><img src="https://pic3.zhimg.com/80/v2-d729bea11322919cc59e03e03d3e221a_1440w.png" alt="img"></p>
<p><img src="https://pic2.zhimg.com/80/v2-25407fa9c8f77c2f3d17a12546793a0d_1440w.png" alt="img"></p>
<p>é‚£ä¹ˆè¿™æ ·å°±å¤Ÿäº†å—ï¼Œä¼šä¸ä¼šå¤ªç®€å•ï¼Ÿæˆ‘ä»¬æŠŠå…ƒç´ iå’Œdçš„ä½ç½®äº¤æ¢ä¸‹ï¼Œæ­¤æ—¶ç»“æ„ä½“çš„å¤§å°ä¼šæ˜¯20å—ï¼Œæˆ‘ä»¬ä»ç„¶å…ˆè®©æœºå™¨è¯´è¯ï¼Œ(âŠ™oâŠ™)â€¦æ¯•ç«Ÿåé¢æ‰“è„¸æœ‰è¯æ®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">align_basic</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="type">char</span> c;</span><br><span class="line">	<span class="type">double</span> d;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, <span class="keyword">sizeof</span>(align_basic));</span><br></pre></td></tr></table></figure>

<p><img src="https://pic4.zhimg.com/80/v2-cbfea1a547f205a2d4b2306748da3953_1440w.png" alt="img"></p>
<p>æˆ‘ä»¬å‘ç°æ­¤æ—¶ç»“æ„ä½“çš„å¤§å°å¹¶ä¸æ˜¯20è€Œæ˜¯24ï¼Œé‚£ä¹ˆå¤šå‡ºæ¥çš„è¿™4ä¸ªå­—èŠ‚å¦‚ä½•è§£é‡Šï¼Ÿæˆ‘ä»¬å¼•å‡ºç¬¬äºŒæ¡è§„åˆ™ã€‚</p>
<p>&#x3D;&#x3D;è§„åˆ™äºŒï¼šå¦‚æœç»“æ„ä½“å¤§å°ä¸æ˜¯æ‰€æœ‰å…ƒç´ ä¸­æœ€å¤§å¯¹é½å¤§å°çš„æ•´æ•°å€ï¼Œåˆ™ç»“æ„ä½“å¯¹é½åˆ°æœ€å¤§å…ƒç´ å¯¹é½å¤§å°çš„æ•´æ•°å€ï¼Œå¡«å……ç©ºé—´æ”¾ç½®åˆ°ç»“æ„ä½“æœ«å°¾ã€‚&#x3D;&#x3D;</p>
<p>è¿ç”¨è§„åˆ™ä¸€ï¼Œæ­¤æ—¶cä»ç„¶æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå…¶åœ°å€ä¸º0ï¼Œç¬¬äºŒä¸ªå…ƒç´ åœ°å€ä¸º8ï¼Œ ç¬¬ä¸‰ä¸ªå…ƒç´ åœ°å€ä¸º16ï¼Œç„¶åè¿ç”¨è§„åˆ™äºŒï¼Œcï¼Œdï¼Œiä¸­dçš„å¯¹é½å¤§å°ä¸º8æœ€å¤§æ‰€ä»¥æ•´ä¸ªç»“æ„å¿…é¡»å¯¹é½åˆ°8çš„æ•´æ•°å€ï¼Œå‰é¢æ˜¯ä¸‰ä¸ªå…ƒç´ å·²ç»å æ®äº†20ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œåªéœ€è¦åœ¨ç»“æ„ä½“çš„å°¾éƒ¨å¡«å……4ä¸ªå­—èŠ‚çš„ç©ºé—´å°±æ˜¯8çš„å€æ•°äº†ï¼Œæ‰€ä»¥æ­¤æ—¶æ•´ä¸ªç»“æ„ä½“çš„å¤§å°ä¸º24ä¸ªå­—èŠ‚ã€‚</p>
<p><code>printf(&quot;%d %d %d %d\n&quot;, sizeof(align_basic), &amp;align_basic::c, &amp;align_basic::d, &amp;align_basic::i);</code></p>
<p><img src="https://pic3.zhimg.com/80/v2-c66b0aa643b60eecb9dbf06916c56482_1440w.png" alt="img"></p>
<p><img src="https://pic4.zhimg.com/80/v2-0294208ed70bb94feb9868310a191eb3_1440w.png" alt="img"></p>
<p>&#x3D;&#x3D;è§„åˆ™ä¸‰ï¼šåŸºæœ¬æ•°æ®ç±»å‹çš„å¯¹é½å¤§å°ä¸ºå…¶è‡ªèº«çš„å¤§å°ï¼Œç»“æ„ä½“æ•°æ®ç±»å‹çš„å¯¹é½å¤§å°ä¸ºå…¶å…ƒç´ ä¸­æœ€å¤§å¯¹é½å¤§å°å…ƒç´ çš„å¯¹é½å¤§å°ã€‚&#x3D;&#x3D; è§„åˆ™ä¸‰å¯ä»¥ç”±è§„åˆ™äºŒæ¨å¯¼å‡ºæ¥ã€‚</p>
<p>charç±»å‹çš„å¯¹é½å¤§å°ä¸º1å­—èŠ‚ï¼Œshortç±»å‹çš„å¯¹é½å¤§å°ä¸º2å­—èŠ‚ï¼Œintç±»å‹çš„å¤§å°ä¸º4å­—èŠ‚ï¼Œdoubleçš„å¯¹é½å¤§å°ä¸º8å­—èŠ‚ï¼Œalign_basicç»“æ„ä½“ä¸­æœ€å¤§å¯¹é½å¤§å°å…ƒç´ ä¸ºdæ˜¯doubleç±»å‹ï¼Œæ‰€ä»¥align_basicçš„å¯¹é½å¤§å°æ˜¯8ã€‚æœ‰äººä¼šé—®å¦‚æœç»“æ„ä½“ä¸­æœ‰æ•°ç»„å‘¢ï¼Ÿå¾ˆç®€å•å°†æ•°ç»„çœ‹åšæ˜¯è¿ç»­æ•°ä¸ªç›¸åŒç±»å‹çš„å…ƒç´ å³å¯ã€‚</p>
<h2 id="0x-e6-ç¬¬ä¸€ç« å°ç»“"><a href="#0x-e6-ç¬¬ä¸€ç« å°ç»“" class="headerlink" title="0x e6 ç¬¬ä¸€ç« å°ç»“"></a>0x e6 ç¬¬ä¸€ç« å°ç»“</h2><p>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿçš„â€œç³»ç»Ÿâ€ï¼Œå¹¶ä¸æ˜¯æ“ä½œç³»ç»Ÿï¼Œè¿™ä¸ªç³»ç»ŸåŒ…æ‹¬äº†ç¡¬ä»¶ï¼Œæ“ä½œç³»ç»Ÿï¼Œç½‘ç»œï¼Œç¼–è¯‘ç­‰ç­‰</p>
<p>å­¦ä¹ è®¡ç®—æœºç³»ç»Ÿåº”è¯¥å…·å¤‡çš„ä¸‰ä¸ª<strong>æŠ½è±¡èƒ½åŠ›</strong>ï¼šé—®é¢˜æŠ½è±¡ï¼Œç³»ç»ŸæŠ½è±¡ï¼ˆcsappï¼‰ï¼Œæ•°æ®æŠ½è±¡</p>
<p>è®¡ç®—æœºç³»ç»Ÿæ˜¯ç”±ç¡¬ä»¶å’Œ<strong>ç³»ç»Ÿè½¯ä»¶</strong>ç»„æˆçš„ã€‚</p>
<p>æ•°å­—çš„æœºå™¨è¡¨ç¤ºæ–¹æ³•æ˜¯å¯¹çœŸå€¼çš„<strong>æœ‰é™è¿‘ä¼¼å€¼</strong>ã€‚</p>
<p>æŒ‡ä»¤çš„æ‰§è¡Œï¼š</p>
<ol>
<li>ä»ç£ç›˜è¯»å–æŒ‡ä»¤å’Œæ•°æ®åˆ°å†…å­˜</li>
<li>ä»å†…å­˜é€åˆ°cpuä¸­å»æ‰§è¡Œ</li>
<li>å°†è¿”å›çš„æ•°æ®é€åˆ°å±å¹•</li>
</ol>
<h2 id="0x-e7-bomb-lab"><a href="#0x-e7-bomb-lab" class="headerlink" title="0x e7 bomb lab"></a>0x e7 bomb lab</h2><h3 id="1-phase1"><a href="#1-phase1" class="headerlink" title=".1 phase1"></a>.1 phase1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">disas mainï¼Œå¯ä»¥å‘ç°æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²èµ‹å€¼ç»™äº† $rdi</span><br><span class="line">å¹¶ä¸”ä¹‹åè°ƒç”¨äº†å‡½æ•°&lt;phase_1&gt;</span><br><span class="line">disas phase_1</span><br><span class="line">å‘ç°æ²¡æœ‰ä¿®æ”¹å¯„å­˜å™¨ $rdi çš„å€¼</span><br><span class="line">ç„¶åæŠŠä¸€ä¸ªç«‹å³æ•° 0x402400 ä¼ ç»™äº†å¯„å­˜å™¨ $esi</span><br><span class="line">ä¹‹åè°ƒç”¨å‡½æ•° &lt;strings_not_euqal&gt;</span><br><span class="line">åœ¨ä¹‹åtest $eax $eax</span><br><span class="line">å¦‚æœ jeï¼Œå³ $eax = 0</span><br><span class="line">è°ƒç”¨å‡½æ•° &lt;eoplode_bomb&gt;ï¼Œç‚¸å¼¹çˆ†ç‚¸</span><br><span class="line">å¦åˆ™æ­£å¸¸è¿”å›</span><br><span class="line"></span><br><span class="line">è¿›å…¥å‡½æ•° &lt;strings_not_equal&gt;</span><br><span class="line">è¯¥å‡½æ•°åˆä¼šè°ƒç”¨ &lt;string_length&gt; å‡½æ•°</span><br><span class="line">è¿™ä¸ªå‡½æ•°ä¼šè®¡ç®— $rdi å†…å­—ç¬¦ä¸²çš„é•¿åº¦</span><br><span class="line"></span><br><span class="line">p/x $rdx :ä»¥x(16è¿›åˆ¶)æ–¹å¼æ‰“å°å¯„å­˜å™¨$rdxçš„å€¼</span><br><span class="line">x $rdx æ£€æŸ¥(examine) $rdxå†…å­˜ä¸­çš„å€¼</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/36809923">watch &#x3D; sepcial break</a></p>
<h3 id="2-phase2"><a href="#2-phase2" class="headerlink" title=".2 phase2"></a>.2 phase2</h3><h3 id="3-phase3"><a href="#3-phase3" class="headerlink" title=".3 phase3"></a>.3 phase3</h3><p>![78E9B95E-D7EC-4E49-8A30-94EF4B0A4D48](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;78E9B95E-D7EC-4E49-8A30-94EF4B0A4D48.png)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># phase_3</span><br><span class="line"><span class="title function_">if</span><span class="params">(eax &gt; <span class="number">1</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">7</span> &lt; rsp + <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        eax = rsp + <span class="number">0x8</span>; <span class="comment">// first input</span></span><br><span class="line">        <span class="keyword">switch</span>(eax)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>: </span><br><span class="line">                eax = <span class="number">0xcf</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                eax = <span class="number">0x137</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                eax = <span class="number">0x2c3</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                eax = <span class="number">0x100</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                eax = <span class="number">0x185</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                eax = <span class="number">0xce</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                eax = <span class="number">0x2aa</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">        &#125;</span><br><span class="line">        	<span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        		eax = <span class="number">0x147</span>;</span><br><span class="line">                <span class="keyword">if</span>(rsp + <span class="number">0xc</span> == eax)    <span class="keyword">return</span> Accept;</span><br><span class="line">                <span class="keyword">else</span>    <span class="keyword">return</span> BOOM!!!;       		</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> BOOM!!!</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> BOOM!!!;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ‰å¤šç»„ç­”æ¡ˆï¼šæ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¸èƒ½è¾“å…¥åå…­è¿›åˆ¶æ•°ï¼Œåªèƒ½è¾“å…¥10è¿›åˆ¶æ•°ï¼Œå› ä¸ºè¿™é‡Œçš„æ•°æ®çš„è¯»å¦‚æ˜¯é‡‡ç”¨sscanfï¼ŒæŠŠæˆ‘ä»¬çš„è¾“å…¥ä½œä¸ºstr,å¦‚æœæˆ‘ä»¬çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸ªåå…­è¿›åˆ¶æ•°ï¼Œé‚£ä¹ˆä¸€å®šä»¥0xå¼€å¤´ï¼Œç»“æœ0ä¼šè¢«è¯»å–åˆ°ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¯»åˆ°xä¸åˆæ³•å°±ç»“æŸäº†ã€‚</p>
<table>
<thead>
<tr>
<th>ç¬¬ä¸€ä¸ªå‚æ•°</th>
<th>ç¬¬äºŒä¸ªå‚æ•°</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>207</td>
</tr>
<tr>
<td>1</td>
<td>311</td>
</tr>
<tr>
<td>2</td>
<td>707</td>
</tr>
<tr>
<td>3</td>
<td>256</td>
</tr>
<tr>
<td>4</td>
<td>389</td>
</tr>
<tr>
<td>5</td>
<td>206</td>
</tr>
<tr>
<td>6</td>
<td>682</td>
</tr>
<tr>
<td>7</td>
<td>327</td>
</tr>
</tbody></table>
<h3 id="4-phase4"><a href="#4-phase4" class="headerlink" title=".4 phase4"></a>.4 phase4</h3><p>ç¬¬ä¸€ä¸ªå‚æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.func4:</span><br><span class="line">eax = edx</span><br><span class="line">eax -= edx</span><br><span class="line">ecx = eax</span><br><span class="line">ecx &gt;&gt;= <span class="number">0x1f</span> <span class="comment">// unsigned</span></span><br><span class="line">eax += ecx</span><br><span class="line">eax &gt;&gt;= <span class="number">1</span></span><br><span class="line">ecx = &amp;(rax+rso+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">if</span>(ecx &lt;= edi)  </span><br><span class="line">&#123;</span><br><span class="line">    eax = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(exc &gt;= edi)  <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// åªæœ‰å½“ ecx&lt;=edi&lt;=ecxï¼Œå³edi=ecx=7æ—¶å¯ä»¥æ­£å¸¸é€€å‡ºå¹¶è¿”å›0</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        ã€‚ã€‚ã€‚</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    edx = &amp;(rcx - <span class="number">1</span>)</span><br><span class="line">    call func4</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// goal: make eax = 0</span></span><br></pre></td></tr></table></figure>



<p>ç¬¬äºŒä¸ªå‚æ•°çœ‹phrase4çš„æ±‡ç¼–å¾ˆå®¹æ˜“å¾—å‡ºä¸º0</p>
<h3 id="5-phase5"><a href="#5-phase5" class="headerlink" title=".5 phase5"></a>.5 phase5</h3><p><a target="_blank" rel="noopener" href="https://github.com/wuxueqian14/csapp-lab/tree/master/Bomb%20Lab">reference</a></p>
<h3 id="6-phase6"><a href="#6-phase6" class="headerlink" title=".6 phase6"></a>.6 phase6</h3><p>ä¸æƒ³åšäº†</p>
<h3 id="7-phase7"><a href="#7-phase7" class="headerlink" title=".7 phase7"></a>.7 phase7</h3><p>no</p>
<h3 id="8-answer-2016"><a href="#8-answer-2016" class="headerlink" title=".8 answer(2016)"></a>.8 answer(2016)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br><span class="line">1 2 4 8 16 32</span><br><span class="line">7 327</span><br><span class="line">7 0</span><br><span class="line">)/.%&amp;&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="0x-09-Assemblyå®éªŒ"><a href="#0x-09-Assemblyå®éªŒ" class="headerlink" title="0x 09 Assemblyå®éªŒ"></a>0x 09 Assemblyå®éªŒ</h2><p><img src="/Users/epoch/Library/Containers/com.tencent.qq/Data/Library/Caches/Images/BE9A5FC6EBB55797FF78C5D5105D31DF.png" alt="BE9A5FC6EBB55797FF78C5D5105D31DF"></p>
<p>å¦‚ä¸Šå›¾ï¼Œæˆ‘ä»¬ç”¨(gdb) x minglingæ‰“å° 0x7fffffffe3b0é™„è¿‘çš„å€¼ï¼Œè¿™ä¸ªåœ°å€æ˜¯ä¸ªè™šæ‹Ÿåœ°å€ï¼Œå®ƒåœ¨å†…å­˜ä¸­çš„å€¼ä¸º0x0</p>
<p>æ ˆæŒ‡é’ˆæ˜¯ä¼šæµ®åŠ¨çš„ï¼ä½†æ˜¯rspå’Œrbpçš„å·®å€¼åº”è¯¥æ˜¯ä¸å˜çš„ã€‚</p>
<p>gdb(ni) ï¼šä¼šè·³å‡ºå‡½æ•°æ‰§è¡Œ</p>
<p>gdb(si)ï¼šä¼šè¿›å…¥å‡½æ•°æ‰§è¡Œ</p>
<p>![A44D5C36-2816-49B3-9E01-23E15BC5DA72](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;A44D5C36-2816-49B3-9E01-23E15BC5DA72.png)</p>
<p>å°ç«¯å­˜å‚¨çš„åˆä¸€ä¸ªä¾‹å­å•Šï¼Œæˆ‘ä»¬æŠŠå¯„å­˜å™¨ %rbp(0x7fffffffe3d0) æ”¾å…¥ %rspï¼Œè§‚å¯Ÿå¯ä»¥å‘ç°ï¼Œ0x00007ffffå€æ”¾åœ¨äº†åé¢çš„åœ°å€ï¼Œè€Œ0xffffe3d0è¢«æ”¾åœ¨äº†å‰é¢çš„åœ°å€ã€‚xå‘½ä»¤æ‰“å°çš„åœ°å€ä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹æ˜¯ä»¥4ä¸ºå•ä½é€’å¢çš„ï¼Œ</p>
<h2 id="0x-0a-ld-preloadç¯å¢ƒå˜é‡åŠ«æŒå‡½æ•°"><a href="#0x-0a-ld-preloadç¯å¢ƒå˜é‡åŠ«æŒå‡½æ•°" class="headerlink" title="0x 0a ld_preloadç¯å¢ƒå˜é‡åŠ«æŒå‡½æ•°"></a>0x 0a ld_preloadç¯å¢ƒå˜é‡åŠ«æŒå‡½æ•°</h2><p>é¦–å…ˆåœ¨ç›®å½•ä¸‹åˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ main.c å’Œ txt</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> <span class="comment">// main.c</span></span><br><span class="line">&#123;</span><br><span class="line">	FILE *fd = fopen(<span class="string">&quot;txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(fd == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;*** open file error!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;open file success!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸æ¥è¯´æœ€åç¨‹åºä¼šæ­£ç¡®æ‰§è¡Œ</p>
<p>ä½†å¦‚æœæˆ‘ä»¬æ›´æ”¹åŠ¨æ€é“¾æ¥åº“</p>
<p>å…ˆåˆ›å»ºä¸€ä¸ªtrikåŠ¨æ€é“¾æ¥åº“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> <span class="comment">// trik.c</span></span></span><br><span class="line">FILE *<span class="title function_">fopen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;*** Always open error!&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC trik.c -o trik.so</span><br><span class="line">LD_PRELOAD=$PWD/trik.so ./a.out</span><br></pre></td></tr></table></figure>

<p>æœ€åæ–‡ä»¶ä¼šæ‰“å¼€å¤±è´¥</p>
<p>![53DE4182-359A-4F3E-80BB-4B97508E7F9B](&#x2F;Users&#x2F;epoch&#x2F;Library&#x2F;Containers&#x2F;com.tencent.qq&#x2F;Data&#x2F;Library&#x2F;Application Support&#x2F;QQ&#x2F;Users&#x2F;2407217576&#x2F;QQ&#x2F;Temp.db&#x2F;53DE4182-359A-4F3E-80BB-4B97508E7F9B.png)</p>
<p>åŸç†å°±æ˜¯é€šè¿‡è‡ªå·±å†™çš„åº“å‡½æ•°åŠ«æŒç³»ç»Ÿçš„åº“å‡½æ•°ï¼Œä½¿å¾—ç¨‹åºæ‰§è¡Œæˆ‘ä»¬çš„åº“å‡½æ•°ã€‚</p>
<h2 id="0x-0b-attack-lab"><a href="#0x-0b-attack-lab" class="headerlink" title="0x 0b attack lab"></a>0x 0b attack lab</h2><h2 id="0x0c-é“¾æ¥-points"><a href="#0x0c-é“¾æ¥-points" class="headerlink" title="0x0c é“¾æ¥ points"></a>0x0c é“¾æ¥ points</h2><p>1.å¼•å…¥å“‘èŠ‚ç‚¹dummy</p>
<p>2.å¼•å…¥æ•°æ®ç»“æ„â€“elf</p>
<p>3.é™æ€é“¾æ¥çš„è¿‡ç¨‹ï¼šelfå®šä½åˆ°ç¬¦å·-&gt;ç¬¦å·è§£æ-&gt;é‡å®šä½</p>
<p>4.*.o, elf éƒ½æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶</p>
<p>5.unixä¸‹å¤§éƒ¨åˆ†å·¥å…·éƒ½åœ¨&#x2F;usr&#x2F;binæˆ–è€…&#x2F;binç›®å½•ä¸‹çš„ã€‚ä½¿ç”¨hexdumpå¯ä»¥æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶</p>
<p>6.ç¬¬ä¸€ä¸ªsectionçš„nameä¸ºç©ºï¼ˆå…¶å®å«åš undefine sectionï¼‰ï¼Œä¸”æ•°æ®å…¨ä¸º0ï¼Œé‡Œé¢å­˜æ”¾çš„å†…å®¹æ˜¯undefineçš„æ•°æ®ã€‚</p>
<p>7.å°†å‡½æ•°å®šä¹‰ä¸ºä¸€ä¸ªå¼±ç¬¦å·ï¼š<code>attribute__((weak)) int add*() &#123;&#125;</code> ,è¿™é‡Œçš„ <code>add</code> å‡½æ•°è¢«å®šä¹‰ä¸ºä¸€ä¸ªå¼±ç¬¦å·ï¼Œå®ƒå¯ä»¥è¢«å¼ºç¬¦å·å‡½æ•° <code>add</code> è¦†ç›–ã€‚</p>
<p>8.å¯¹äº <code>C Language</code> æ¥è¯´ï¼Œå‡ºç° <code>Warning</code> è¯´æ˜ä½ çš„è¯­å¥æœ‰<strong>æ­§ä¹‰</strong> ï¼Œä½†æ˜¯ C è¯­è¨€ä¸ºä½ é€‰æ‹©äº†ä¸€ç§ç»“æœï¼Œæ³¨æ„è¿™ç§ç»“æœå¯èƒ½ä¸ä½ çš„æœ¬æ„ä¸åŒï¼</p>
<p>9.å¯¹äºåˆå§‹åŒ–ä¸º <code>0</code> çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ï¼Œä¹Ÿè¢«åˆ’åˆ†åˆ° <code>.bss</code>ï¼Œè¿™æ˜¯å› ä¸ºå…¨å±€å˜é‡å’Œé™æ€å˜é‡é»˜è®¤åˆå§‹åŒ–å°±æ˜¯ <code>0</code>ã€‚</p>
<p>10.ä¸ºä»€ä¹ˆåœ¨å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ä¸­æœ‰ <code>COMMON</code>ï¼Œåœ¨å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­å°±æ²¡æœ‰ <code>COMMON</code> äº†å‘¢ã€‚</p>
<blockquote>
<p> å›æƒ³ä¸€ä¸‹<code>COMMON</code>çš„å®šä¹‰ï¼Œå¯¹äºæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œ å±äº<code>COMMON</code>ã€‚</p>
<p>å¯¹äºæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œ åœ¨é“¾æ¥ä¹‹åå®ƒæœ‰ä¸‰ç§å¯èƒ½çš„æƒ…å†µï¼ˆå‡è®¾è¿™é‡Œæœ‰ä¸¤ä¸ªæ–‡ä»¶ <code>s1.c</code>, <code>s2.c</code>ï¼Œåœ¨ <code>s1.c</code> ä¸­å®šä¹‰æœ‰æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ <code>g</code>ï¼‰</p>
<ol>
<li><p>å¦‚æœåœ¨ <code>s2.c</code> ä¸­ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªå…¨å±€å˜é‡ <code>g</code> å¹¶ä¸”åˆå§‹åŒ–ä¸º <code>0</code>ï¼Œåˆ™ <code>g</code> å±äº <code>.bss</code> èŠ‚</p>
</li>
<li><p>å¦‚æœåˆå§‹åŒ–ä¸æ˜¯ <code>0</code>ï¼Œå°±å±äº <code>.data</code></p>
</li>
<li><p>å¦‚æœ <code>s2.c</code> æ²¡æœ‰å®šä¹‰ <code>g</code> ï¼Œé‚£ä¹ˆ s2 å°±å±äº <code>.bss</code></p>
<p>å› ä¸ºæœ‰å¦‚ä¸Šä¸‰ç§ï¼ˆåˆæ³•ï¼‰æƒ…å†µï¼Œæ‰€ä»¥æŠŠå®ƒåˆ’åˆ†åˆ° <code>COMMON</code>ï¼Œè€Œä¹‹æ‰€ä»¥åœ¨å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­æ²¡æœ‰äº† <code>COMMON</code> ,æ˜¯å› ä¸ºæ­¤æ—¶å·²ç»é“¾æ¥å®Œäº†ï¼Œ<code>g</code> å±äºé‚£ä¸ªèŠ‚å·²ç»å¾ˆæ˜ç¡®äº†ï¼Œå› æ­¤ä¹Ÿå°±ä¸éœ€è¦äº†ã€‚</p>
</li>
</ol>
</blockquote>
<ol start="11">
<li></li>
</ol>
<h2 id="0x0d-ä¿®æ”¹-ROF-ä¿¡æ¯çš„å®éªŒ"><a href="#0x0d-ä¿®æ”¹-ROF-ä¿¡æ¯çš„å®éªŒ" class="headerlink" title="0x0d ä¿®æ”¹ ROF ä¿¡æ¯çš„å®éªŒ"></a>0x0d ä¿®æ”¹ ROF ä¿¡æ¯çš„å®éªŒ</h2><p>é¦–å…ˆç¼–è¯‘æºæ–‡ä»¶ <code>add.c</code> ç”Ÿæˆå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ <code>add.o</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> addcnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">	addcnt ++ ;</span><br><span class="line">	<span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä½¿ç”¨ <code>hexdump -S add.o</code> æŸ¥çœ‹ <code>Section Headers</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] .text             PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000003c  0000000000000000  AX       0     0     4</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000228</span><br><span class="line">       0000000000000060  0000000000000018   I       9     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  0000007c</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  0000007c</span><br><span class="line">       0000000000000004  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 5] .comment          PROGBITS         0000000000000000  0000007c</span><br><span class="line">       0000000000000027  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 6] .note.GNU-stack   PROGBITS         0000000000000000  000000a3</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 7] .eh_frame         PROGBITS         0000000000000000  000000a8</span><br><span class="line">       0000000000000030  0000000000000000   A       0     0     8</span><br><span class="line">  [ 8] .rela.eh_frame    RELA             0000000000000000  00000288</span><br><span class="line">       0000000000000018  0000000000000018   I       9     7     8</span><br><span class="line">  [ 9] .symtab           SYMTAB           0000000000000000  000000d8</span><br><span class="line">       0000000000000138  0000000000000018          10    11     8</span><br><span class="line">  [10] .strtab           STRTAB           0000000000000000  00000210</span><br><span class="line">       0000000000000018  0000000000000000           0     0     1</span><br><span class="line">  [11] .shstrtab         STRTAB           0000000000000000  000002a0</span><br><span class="line">       0000000000000059  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ä¸‹æ ‡ä¸º <code>1</code> çš„èŠ‚æ˜¯ <code>.text</code> èŠ‚</p>
<p>æˆ‘ä»¬ç°åœ¨è¦ä¿®æ”¹ <code>add.o</code> ä½¿å…¶æ˜¾ç¤ºä¸º <code>.ext</code> èŠ‚</p>
<p>é¦–å…ˆéœ€è¦ä¸‹è½½ <code>hexedit</code></p>
<p>ç„¶åæ‹·è´ä¸€ä»½ <code>add.o</code> çš„å‰¯æœ¬ <code>badadd.o</code></p>
<p>ï¼ˆä¸åœ¨æºæ–‡ä»¶ä¸Šç›´æ¥ä¿®æ”¹æ˜¯ä¸ªå¥½ä¹ æƒ¯ï¼‰</p>
<p>ç„¶åæ‰§è¡Œå‘½ä»¤<code>hexdump -c badadd.o</code> æ‰¾åˆ° <code>.text</code> çš„ä½ç½®ã€‚</p>
<p>é€šè¿‡ <code>elf header</code> ä¸­çš„ä¿¡æ¯å¯ä»¥å¾—åˆ° <code>Section header table</code> çš„ <code>offset</code> ä¸º <code>0x300</code>ï¼Œå…¶ä¸­æ¯ä¸ªæ¡ç›®(<code>entry</code>) çš„ <code>size</code> ä¸º <code>0x40</code> ï¼Œç”±æ­¤å¯ä»¥å¾—åˆ°ç¬¬äºŒä¸ªæ¡ç›®ï¼ˆä¸‹æ ‡ä¸º1ï¼‰çš„ <code>.text</code> èŠ‚çš„ä½ç½®ä¸º <code>0x340</code>ï¼Œå¹¶é€šè¿‡ <code>struct elf64_shdr</code> å¾—åˆ°å‰ <code>4</code> ä¸ªå­—èŠ‚ä¸º <code>name</code>ã€‚</p>
<p><code>00000340  20 00 00 00 01 00 00 00  06 00 00 00 00 00 00 00  | ...............|</code></p>
<p><code>name = 0x00000020</code> ,æˆ‘ä»¬åªéœ€è¦ä¿®æ”¹å…¶ä¸º <code>0x00000022</code>ï¼Œå°±å¯ä»¥å®ç° <code>name</code> å¾€ååç§»ä¸¤ä¸ªå­—èŠ‚</p>
<p>è¿™æ · <code>name</code> å°±ä» &#96;&#96;.text<code>å˜æˆäº†</code>ext&#96;</p>
<p>æ‰§è¡Œå‘½ä»¤ï¼š<code>hexedit badadd.o</code> æ‰¾åˆ°ä½ç½®å¹¶ä¿®æ”¹å³å¯ã€‚</p>
<p>æŒ‰ <code>F10</code> é€€å‡º</p>
<p>æœ€åç»“æœå¦‚ä¸‹ï¼š</p>
<p><code>readelf -S badadd.o</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[Nr] Name              Type             Address           Offset</span><br><span class="line">       Size              EntSize          Flags  Link  Info  Align</span><br><span class="line">  [ 0]                   NULL             0000000000000000  00000000</span><br><span class="line">       0000000000000000  0000000000000000           0     0     0</span><br><span class="line">  [ 1] ext               PROGBITS         0000000000000000  00000040</span><br><span class="line">       000000000000003c  0000000000000000  AX       0     0     4</span><br><span class="line">  [ 2] .rela.text        RELA             0000000000000000  00000228</span><br><span class="line">       0000000000000060  0000000000000018   I       9     1     8</span><br><span class="line">  [ 3] .data             PROGBITS         0000000000000000  0000007c</span><br><span class="line">       0000000000000000  0000000000000000  WA       0     0     1</span><br><span class="line">  [ 4] .bss              NOBITS           0000000000000000  0000007c</span><br><span class="line">       0000000000000004  0000000000000000  WA       0     0     4</span><br><span class="line">  [ 5] .comment          PROGBITS         0000000000000000  0000007c</span><br><span class="line">       0000000000000027  0000000000000001  MS       0     0     1</span><br><span class="line">  [ 6] .note.GNU-stack   PROGBITS         0000000000000000  000000a3</span><br><span class="line">       0000000000000000  0000000000000000           0     0     1</span><br><span class="line">  [ 7] .eh_frame         PROGBITS         0000000000000000  000000a8</span><br><span class="line">       0000000000000030  0000000000000000   A       0     0     8</span><br><span class="line">  [ 8] .rela.eh_frame    RELA             0000000000000000  00000288</span><br><span class="line">       0000000000000018  0000000000000018   I       9     7     8</span><br><span class="line">  [ 9] .symtab           SYMTAB           0000000000000000  000000d8</span><br><span class="line">       0000000000000138  0000000000000018          10    11     8</span><br><span class="line">  [10] .strtab           STRTAB           0000000000000000  00000210</span><br><span class="line">       0000000000000018  0000000000000000           0     0     1</span><br><span class="line">  [11] .shstrtab         STRTAB           0000000000000000  000002a0</span><br><span class="line">       0000000000000059  0000000000000000           0     0     1</span><br></pre></td></tr></table></figure>







<h2 id="0x0e-vim-tabe"><a href="#0x0e-vim-tabe" class="headerlink" title="0x0e vim tabe"></a>0x0e vim tabe</h2><p>vimä¸­çš„åˆ†é¡µå‘½ä»¤ï¼Œå¤šçª—å£vim</p>
<p>é€šè¿‡<code>help tab-page-intro</code>å‘½ä»¤ï¼Œå¯ä»¥è·å¾—å…³äºæ ‡ç­¾é¡µä½¿ç”¨çš„æ›´å¤šä¿¡æ¯ã€‚</p>
<table>
<thead>
<tr>
<th><code>:tabnew</code></th>
<th align="left">æ–°å»ºæ ‡ç­¾é¡µ</th>
</tr>
</thead>
<tbody><tr>
<td><code>:tabs</code></td>
<td align="left">æ˜¾ç¤ºå·²æ‰“å¼€æ ‡ç­¾é¡µçš„åˆ—è¡¨</td>
</tr>
<tr>
<td><code>:tabc</code></td>
<td align="left">å…³é—­å½“å‰æ ‡ç­¾é¡µ</td>
</tr>
<tr>
<td><code>:tabe &lt;filename&gt;</code></td>
<td align="left">æ‰“å¼€æ–°æ–‡ä»¶(tabedit)</td>
</tr>
<tr>
<td><code>:tabp</code></td>
<td align="left">ç§»åŠ¨åˆ°ä¸Šä¸€ä¸ªæ ‡ç­¾é¡µ</td>
</tr>
<tr>
<td><code>:tabn</code></td>
<td align="left">ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µ(tabnext)</td>
</tr>
<tr>
<td><code>:gt</code></td>
<td align="left">ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªæ ‡ç­¾é¡µ</td>
</tr>
<tr>
<td><code>:tabr</code></td>
<td align="left">ç§»åŠ¨åˆ°ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ(tabrewind,tabfirst)</td>
</tr>
<tr>
<td><code>:tabl</code></td>
<td align="left">ç§»åŠ¨åˆ°æœ€åä¸€ä¸ªæ ‡ç­¾é¡µ(tablast)</td>
</tr>
<tr>
<td><code>$vim -p &lt;f1&gt; &lt;f2&gt; &lt;f3&gt;</code></td>
<td align="left">vimå¼€å¯å¤šä¸ªæ ‡ç­¾é¡µ</td>
</tr>
</tbody></table>
<h2 id="0x0f-bilbili-é“¾æ¥"><a href="#0x0f-bilbili-é“¾æ¥" class="headerlink" title="0x0f bilbili é“¾æ¥"></a>0x0f bilbili é“¾æ¥</h2><p>é“¾æ¥æ­¥éª¤ï¼š</p>
<blockquote>
<ol>
<li>parse text</li>
<li>symbol parse</li>
<li>Relocation</li>
</ol>
<p>2 å’Œ 3 éƒ½ä¾èµ–äº 1 çš„ text</p>
</blockquote>
<h1 id="Csapp-Link"><a href="#Csapp-Link" class="headerlink" title="Csapp Link"></a>Csapp Link</h1><h2 id="English"><a href="#English" class="headerlink" title="::English"></a>::English</h2><p>separate compliationï¼šåˆ†ç¦»ç¼–è¯‘</p>
<p>manglingï¼šé‡æ•´</p>
<h2 id="Tool"><a href="#Tool" class="headerlink" title=":: Tool"></a>:: Tool</h2><p>GNU READELFï¼šæŸ¥çœ‹ç›®æ ‡æ–‡ä»¶å†…å®¹çš„å¾ˆæ–¹ä¾¿çš„å·¥å…·ã€‚</p>
<h2 id="0x00-introduce"><a href="#0x00-introduce" class="headerlink" title="0x00 introduce"></a>0x00 introduce</h2><h3 id="1-é“¾æ¥çš„æ‰§è¡Œé˜¶æ®µ"><a href="#1-é“¾æ¥çš„æ‰§è¡Œé˜¶æ®µ" class="headerlink" title="1. é“¾æ¥çš„æ‰§è¡Œé˜¶æ®µ"></a>1. é“¾æ¥çš„æ‰§è¡Œé˜¶æ®µ</h3><ol>
<li>compile time</li>
<li>load time</li>
<li>run time</li>
</ol>
<h3 id="2-why-learn-link"><a href="#2-why-learn-link" class="headerlink" title="2. why learn link"></a>2. <strong>why</strong> learn link</h3><ol>
<li>ç†è§£é“¾æ¥å™¨å°†å¸®åŠ©ä½ æ„é€ å¤§å‹ç¨‹åº</li>
<li>ç†è§£é“¾æ¥å™¨å°†å¸®åŠ©ä½ é¿å…ä¸€äº›å±é™©çš„ç¼–ç¨‹é”™è¯¯ã€‚</li>
<li>ç†è§£é“¾æ¥å™¨å°†å¸®åŠ©ä½ ç†è§£è¯­è¨€çš„ä½œç”¨åŸŸè§„åˆ™æ˜¯å¦‚ä½•å®ç°çš„ã€‚</li>
<li>ç†è§£é“¾æ¥å°†å¸®åŠ©ä½ ç†è§£å…¶ä»–é‡è¦çš„ç³»ç»Ÿæ¦‚å¿µã€‚ï¼ˆåŠ è½½å’Œè¿è¡Œç¨‹åºï¼Œè™šæ‹Ÿå†…å­˜ï¼Œåˆ†é¡µï¼Œå†…å­˜æ˜ å°„ï¼‰</li>
<li>ç†è§£é“¾æ¥å°†ä½¿ä½ èƒ½å¤Ÿåˆ©ç”¨å…±äº«åº“ã€‚</li>
</ol>
<h2 id="0x01-compiler-driver"><a href="#0x01-compiler-driver" class="headerlink" title="0x01 compiler driver"></a>0x01 compiler driver</h2><p>compiler dirverï¼šç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº</p>
<p>å®ƒä»£è¡¨ç”¨æˆ·åœ¨éœ€è¦çš„æ—¶å€™è°ƒç”¨ï¼š</p>
<ol>
<li>cpp</li>
<li>cc1</li>
<li>as</li>
<li>ld</li>
</ol>
<p>å¯ä»¥ä½¿ç”¨ -v é€‰é¡¹æŸ¥çœ‹è¿™ä¸ªè¿‡ç¨‹</p>
<p>å½“æˆ‘ä»¬åœ¨ Linux å‘½ä»¤è¡Œè¾“å…¥ï¼š<code>./proc</code></p>
<p>shell è°ƒç”¨æ“ä½œç³»ç»Ÿä¸­ä¸€ä¸ªå«åš<strong>åŠ è½½å™¨</strong>çš„å‡½æ•°ï¼Œå®ƒå°†å¯æ‰§è¡Œæ–‡ä»¶ proc ä¸­çš„ä»£ç å’Œæ•°æ®å¤åˆ¶åˆ°å†…å­˜ï¼Œç„¶åå°†æ§åˆ¶è½¬ç§»åˆ°è¿™ä¸ªç¨‹åºçš„å¼€å¤´ã€‚</p>
<h2 id="0x02-static-link"><a href="#0x02-static-link" class="headerlink" title="0x02 static link"></a>0x02 static link</h2><p>Relocaable object file: ç”±å„ç§ä¸åŒçš„ä»£ç å’Œæ•°æ®èŠ‚ï¼ˆsectionï¼‰ç»„æˆï¼Œæ¯ä¸€èŠ‚éƒ½æ˜¯ä¸€ä¸ªè¿ç»­çš„å­—èŠ‚åºåˆ—ã€‚</p>
<p>ä¸ºäº†æ„é€  executable fileï¼Œlinker å¿…é¡»å®Œæˆä¸¤ä¸ªä¸»è¦ä»»åŠ¡ï¼š</p>
<ol>
<li>Symbol resolutionï¼ˆç¬¦å·è§£æï¼‰ï¼šç¬¦å·è§£æçš„ç›®çš„æ˜¯å°†æ¯ä¸ªç¬¦å·å¼•ç”¨æ­£å¥½å’Œä¸€ä¸ªç¬¦å·å®šä¹‰å…³è”èµ·æ¥ã€‚</li>
<li>relocationï¼ˆé‡å®šä½ï¼‰ã€‚</li>
</ol>
<p>Symbolï¼ˆç¬¦å·ï¼‰ï¼šç›®æ ‡æ–‡ä»¶å®šä¹‰å’Œå¼•ç”¨ç¬¦å·ï¼Œæ¯ä¸ªç¬¦å·å¯¹åº”äºä¸€ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªå±€éƒ¨å˜é‡æˆ–ä¸€ä¸ªé™æ€å˜é‡ï¼ˆå³Cè¯­è¨€ä»»ä½•é static å±æ€§å£°æ˜çš„å˜é‡ï¼‰ã€‚</p>
<p>Compiler and Assembly generate code and data section start at address 0, linker connect every symbol define with one memory address, so can relocate those sections, and then modify all the symbol define, make them point the address. Linker use the detailed instructions of relocation entry(é‡å®šä½æ¡ç›®) which generated by assembly to execute those relocation with no check.</p>
<h2 id="0x03-object-file"><a href="#0x03-object-file" class="headerlink" title="0x03 object file"></a>0x03 object file</h2><p>object fileï¼ˆç›®æ ‡æ–‡ä»¶ï¼‰ types:</p>
<ol>
<li>relocatable object fileï¼šåœ¨ç¼–è¯‘æ—¶ä¸å…¶ä»–å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶åˆå¹¶èµ·æ¥ï¼Œåˆ›å»ºä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚</li>
<li>executable object file</li>
<li>Share object fileï¼ˆå…±äº«ç›®æ ‡æ–‡ä»¶ï¼‰: ä¸€ç§ç‰¹æ®Šç±»å‹çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥åœ¨åŠ è½½æˆ–è€…è¿è¡Œæ—¶è¢«åŠ¨æ€åœ°åŠ è½½è¿›å†…å­˜å¹¶é“¾æ¥ã€‚</li>
</ol>
<p>Compiler and Assembly generate relocatable object file.  Linker generate executable  object file.</p>
<p>Technically talking, a object module(ç›®æ ‡æ¨¡å—) is a byte sequence,  and a object file is a object module which storage in disk as a type of file.</p>
<p>ç›®æ ‡æ–‡ä»¶æ˜¯æŒ‰ç…§ç‰¹å®šçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼æ¥ç»„ç»‡çš„ï¼Œå„ä¸ªç³»ç»Ÿçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼éƒ½ä¸ç›¸åŒã€‚</p>
<ol>
<li>Unix: a.out</li>
<li>Windows: PE(Portable Executable)(å¯ç§»æ¤å¯æ‰§è¡Œ)</li>
<li>MacOS-X: Mach-O </li>
<li>Modern x86-64 and Unix: ELF(Executable and Linkable Format)(å¯æ‰§è¡Œå¯é“¾æ¥æ ¼å¼)</li>
</ol>
<h2 id="0x04-relocatable-object-file"><a href="#0x04-relocatable-object-file" class="headerlink" title="0x04 relocatable object file"></a>0x04 relocatable object file</h2><p>å…¸å‹çš„ELFå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶</p>
<p><img src="https://s1.328888.xyz/2022/09/28/spfaF.png" alt="IMG"></p>
<p>ELF contains:   ELF headerï¼ŒSectionsï¼ŒSection header table(èŠ‚å¤´éƒ¨è¡¨)ã€‚</p>
<p>(1) ELF headerï¼š</p>
<ol>
<li>ä»¥ä¸€ä¸ª 16 å­—èŠ‚çš„åºåˆ—å¼€å§‹ï¼Œè¿™ä¸ªåºåˆ—æè¿°äº†ç”Ÿæˆè¯¥æ–‡ä»¶çš„ç³»ç»Ÿçš„<strong>å­—çš„å¤§å°</strong>å’Œ<strong>å­—èŠ‚é¡ºåºã€‚</strong></li>
<li>å‰©ä¸‹çš„éƒ¨åˆ†åŒ…å«å¸®åŠ©é“¾æ¥å™¨è¯­æ³•åˆ†æå’Œè§£é‡Šç›®æ ‡æ–‡ä»¶çš„ä¿¡æ¯ã€‚å…¶ä¸­åŒ…å«ï¼š<ul>
<li>ELF å¤´çš„å¤§å°</li>
<li>ç›®æ ‡æ–‡ä»¶çš„ç±»å‹ï¼ˆå¯é‡å®šä½ã€å¯æ‰§è¡Œæˆ–è€…å…±äº«ï¼‰</li>
<li>æœºå™¨ç±»å‹ï¼ˆx86-64ï¼‰</li>
<li>èŠ‚å¤´éƒ¨è¡¨çš„æ–‡ä»¶åç§»</li>
<li>èŠ‚å¤´éƒ¨è¡¨ä¸­æ¡ç›®çš„å¤§å°å’Œæ•°é‡</li>
</ul>
</li>
</ol>
<p>(2) Section headere table: ä¸åŒ Section çš„ä½ç½®å’Œå¤§å°æ˜¯ç”±èŠ‚å¤´éƒ¨è¡¨æè¿°çš„ï¼Œå…¶ä¸­ç›®æ ‡æ–‡ä»¶ä¸­çš„æ¯ä¸ªèŠ‚éƒ½æœ‰ä¸€ä¸ªå›ºå®šå¤§å°çš„æ¡ç›®ï¼ˆentryï¼‰ã€‚</p>
<p>(3) Section:</p>
<ol>
<li>.textï¼šå·²ç¼–è¯‘ç¨‹åºçš„<strong>æœºå™¨ä»£ç ã€‚</strong></li>
<li>.rodataï¼šåªè¯»æ•°æ®ã€‚</li>
<li>.dataï¼šå·²åˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€ C å˜é‡ã€‚ï¼ˆå±€éƒ¨å˜é‡åœ¨æ ˆä¸­ï¼Œæ—¢ä¸å‡ºç°åœ¨ .dataä¸­ï¼Œä¹Ÿä¸å‡ºç°åœ¨ .bssæ±‡æ€»ï¼‰</li>
<li>.bssï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å’Œé™æ€ C å˜é‡ï¼Œä»¥åŠæ‰€æœ‰è¢«åˆå§‹åŒ–ä¸º 0 çš„å…¨å±€æˆ–é™æ€å˜é‡ï¼ˆé»˜è®¤åˆå§‹åŒ–ï¼‰ã€‚åœ¨ç›®æ ‡æ–‡ä»¶ä¸­<strong>è¿™ä¸ªèŠ‚ä¸å ç”¨å®é™…çš„ç©ºé—´ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªå ä½ç¬¦ã€‚</strong> ç›®æ ‡æ–‡ä»¶ä¸­åŒºåˆ† .bss å’Œ .data æ˜¯ä¸ºäº†<strong>ç©ºé—´æ•ˆç‡</strong>ï¼šåœ¨ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œæœªåˆå§‹åŒ–å˜é‡ä¸éœ€è¦å ç”¨ä»»ä½•å®é™…çš„ç£ç›˜ç©ºé—´ã€‚è¿è¡Œæ—¶ï¼Œåœ¨å†…å­˜ä¸­åˆ†é…è¿™äº›å˜é‡ï¼Œåˆå§‹åŒ–ä¸º0ã€‚</li>
<li>.symtabï¼›ç¬¦å·è¡¨ã€‚å­˜æ”¾åœ¨ç¨‹åºä¸­<strong>å¼•ç”¨</strong>å’Œ<strong>å®šä¹‰</strong>çš„å‡½æ•°å’Œå…¨å±€å˜é‡çš„ä¿¡æ¯ã€‚ï¼ˆä¸åŒ…å«å±€éƒ¨å˜é‡çš„æ¡ç›®ï¼‰ã€‚</li>
<li>.rel.textï¼šrelocationã€‚ä¸€ä¸ª .text èŠ‚æ€»ä½ç½®çš„åˆ—è¡¨ã€‚å½“ Linker æŠŠè¿™ä¸ªç›®æ ‡æ–‡ä»¶å’Œå…¶ä»–æ–‡ä»¶ç»„åˆæ—¶ï¼Œéœ€è¦ä¿®æ”¹è¿™äº›ä½ç½®ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä»»ä½•è°ƒç”¨å¤–éƒ¨å‡½æ•°æˆ–è€…å¼•ç”¨å…¨å±€å˜é‡çš„<strong>æŒ‡ä»¤</strong>éƒ½éœ€è¦ä¿®æ”¹ã€‚</li>
<li>.rel.dataï¼šè¢«æ¨¡å—å®šä¹‰æˆ–å¼•ç”¨çš„æ‰€æœ‰å…¨å±€å˜é‡çš„é‡å®šä½ä¿¡æ¯ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä»»ä½•å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼Œå¦‚æœå®ƒçš„å€¼æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡åœ°å€æˆ–è€…å¤–éƒ¨å®šä¹‰çš„å‡½æ•°çš„<strong>åœ°å€</strong>ï¼Œéƒ½éœ€è¦è¢«ä¿®æ”¹ã€‚</li>
<li>.debugï¼šè°ƒè¯•ç¬¦å·è¡¨ã€‚åªæœ‰ä½¿ç”¨ -g é€‰é¡¹æ—¶æ‰ä¼šå¾—åˆ°è¿™å¼ è¡¨ã€‚</li>
<li>.lineï¼šåŸå§‹ C æºç¨‹åºä¸­çš„è¡Œå¥½å’Œ .text èŠ‚ ä¸­æœºå™¨æŒ‡ä»¤ä¹‹é—´çš„<strong>æ˜ å°„</strong>ã€‚åªæœ‰ä½¿ç”¨ -g é€‰é¡¹æ—¶æ‰ä¼šå¾—åˆ°è¿™å¼ è¡¨ã€‚</li>
<li>.strtabï¼šå­—ç¬¦ä¸²è¡¨ã€‚å…¶å†…å®¹åŒ…å« .symbol å’Œ .debugèŠ‚ä¸­çš„ç¬¦å·è¡¨ï¼Œå·²ç»èŠ‚å¤´éƒ¨ä¸­çš„èŠ‚åå­—ã€‚å­—ç¬¦ä¸²è¡¨å°±æ˜¯ä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²çš„åºåˆ—ã€‚</li>
</ol>
<p>ä¸ºä»€ä¹ˆæœªåˆå§‹åŒ–çš„æ•°æ®æˆä¸º  .bss</p>
<blockquote>
<p>èµ·å§‹äº IMB 704 æ±‡ç¼–è¯­è¨€ï¼ˆå¤§çº¦åœ¨1957å¹´ï¼‰ Block Storage Start(å—å­˜å‚¨å¼€å§‹)æŒ‡ä»¤çš„é¦–å­—æ¯ç¼©å†™ã€‚å¹¶æ²¿ç”¨è‡³ä»Šã€‚</p>
<p>ä½ å¯ä»¥è¿™æ ·ç†è§£å¹¶åŒºåˆ†äº .dataï¼šBetter Save Spaceï¼ˆæ›´å¥½çš„èŠ‚çœç©ºé—´ï¼‰çš„ç¼©å†™ã€‚</p>
</blockquote>
<h2 id="0x05-symbol-and-symbol-table"><a href="#0x05-symbol-and-symbol-table" class="headerlink" title="0x05 symbol and symbol table"></a>0x05 symbol and symbol table</h2><p>â€‹			 	</p>
<p>æ¯ä¸ª relocatable object module m éƒ½æœ‰ä¸€ä¸ªç¬¦å·è¡¨ï¼Œå®ƒåŒ…å« m å®šä¹‰å’Œå¼•ç”¨çš„ç¬¦å·çš„ä¿¡æ¯ã€‚åœ¨ Linker çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œæœ‰ä¸‰ç§ä¸åŒçš„ç¬¦å·ï¼š</p>
<ol>
<li>m å®šä¹‰çš„å¹¶ä¸”èƒ½è¢«å…¶ä»– module å¼•ç”¨çš„å…¨å±€ç¬¦å·ã€‚</li>
<li>å…¶ä»– module å®šä¹‰å¹¶è¢«æ¨¡å— m å¼•ç”¨çš„å…¨å±€ç¬¦å·ï¼Œ</li>
<li>åªè¢« m å®šä¹‰å’Œå¼•ç”¨çš„å±€éƒ¨ç¬¦å·ã€‚</li>
</ol>
<p>ç¬¦å·è¡¨æ˜¯ç”± Assembly æ„é€ çš„ï¼Œä½¿ç”¨ Compiler è¾“å‡ºåˆ°æ±‡ç¼–è¯­è¨€ .s æ–‡ä»¶ä¸­çš„ç¬¦å·ã€‚</p>
<p>.symtab èŠ‚çš„å†…å®¹æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„çš„å…ƒç´ æ˜¯ä¸€ä¸ªç¬¦å·æ¡ç›®ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> name;</span><br><span class="line">    <span class="type">char</span> type: <span class="number">4</span>,</span><br><span class="line">    	binding: <span class="number">4</span>;</span><br><span class="line">    <span class="type">char</span> reserved;</span><br><span class="line">    <span class="type">short</span> section;</span><br><span class="line">    <span class="type">long</span> value;</span><br><span class="line">    <span class="type">long</span> size;</span><br><span class="line">&#125; Elf_64_Symbol;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nameï¼šæ˜¯å­—ç¬¦ä¸²è¡¨ä¸­çš„å­—èŠ‚ä¸²ï¼ŒæŒ‡å‘ç¬¦å·çš„ä»¥ null ç»“å°¾çš„å­—ç¬¦ä¸²åå­—ã€‚</p>
<p>sectionï¼ˆbase_addressï¼‰ï¼šåˆ°èŠ‚å¤´éƒ¨è¡¨çš„ç´¢å¼•ï¼ŒæŒ‡æ˜è¢«åˆ†é…åˆ°é‚£ä¸ªèŠ‚ã€‚</p>
<p>valueï¼ˆoffset_addressï¼‰ï¼šæ˜¯ç¬¦å·çš„åœ°å€ã€‚å¯¹äºå¯é‡å®šä½çš„ module æ¥è¯´ï¼Œvalue æ˜¯è·å®šä¹‰ç›®æ ‡çš„èŠ‚çš„å…¶å®åœ°å€çš„ offsetã€‚</p>
<p>sizeï¼šæ˜¯ç›®æ ‡çš„å¤§å°ï¼ˆbyteï¼‰ã€‚</p>
<p>typeï¼šdata or functionã€‚</p>
<p>bindingï¼šstatic or global</p>
<p>æœ‰ä¸‰ä¸ªç‰¹æ®Šçš„<strong>ä¼ªèŠ‚</strong>ï¼Œå®ƒä»¬åœ¨èŠ‚å¤´éƒ¨è¡¨ä¸­æ˜¯æ²¡æœ‰æ¡ç›®çš„ï¼ˆåªæœ‰å¯é‡å®šä½ç›®æ ‡æ¨¡å—æ‰æœ‰ï¼‰ï¼š</p>
<ol>
<li>ABSï¼šä¸åº”è¯¥è¢«é‡å®šä½çš„ç¬¦å·ã€‚</li>
<li>UNDEFï¼šæœªå®šä¹‰çš„ç¬¦å·ï¼Œä¹Ÿå°±æ˜¯åœ¨æœ¬ç›®æ ‡æ¨¡å—ä¸­å¼•ç”¨ï¼Œä½†æ˜¯åœ¨å…¶å®ƒåœ°æ–¹å®šä¹‰çš„ç¬¦å·ã€‚</li>
<li>COMMONï¼šè¿˜æœªè¢«åˆ†é…ä½ç½®çš„æœªåˆå§‹åŒ–çš„æ•°æ®ç›®æ ‡ã€‚å¯¹äº common uç¬¦å·ï¼Œvalue å­—æ®µç»™å‡º<strong>å¯¹å…¶è¦æ±‚</strong>ã€‚</li>
</ol>
<p>common å’Œ .bss çš„åŒºåˆ«å¾ˆç»†å¾®ï¼Œç°ä»£çš„ GCC æ ¹æ®ä»¥ä¸‹è§„åˆ™åˆ†é…ç¬¦å·ï¼š</p>
<ol>
<li>Common: æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</li>
<li>.bssï¼šæœªåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼ŒåŠå…¶åˆå§‹åŒ–ä¸º0çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡</li>
</ol>
</blockquote>
<h2 id="0x06-symbol-parse"><a href="#0x06-symbol-parse" class="headerlink" title="0x06 symbol parse"></a>0x06 symbol parse</h2><h3 id="1-é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•"><a href="#1-é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•" class="headerlink" title="1.é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•"></a>1.é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•</h3><p>é“¾æ¥å™¨è§£æç¬¦å·å¼•ç”¨çš„æ–¹æ³•æ˜¯å°†æ¯ä¸ªå¼•ç”¨äºå®ƒè¾“å…¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨çš„ä¸€ä¸ªç¡®å®šçš„ç¬¦å·å®šä¹‰å…³è”èµ·æ¥ã€‚</p>
<p>å¯¹é‚£äº›å’Œå¼•ç”¨å®šä¹‰åœ¨ç›¸åŒæ¨¡å—ä¸­çš„å±€éƒ¨ç¬¦å·çš„å¼•ç”¨ï¼Œç¬¦å·è§£ææ˜¯éå¸¸ç®€å•æ˜äº†çš„ã€‚ç¼–è¯‘å™¨åªå…è®¸æ¯ä¸ªæ¨¡å—ä¸­æ¯ä¸ªå±€éƒ¨ç¬¦å·æœ‰ä¸€ä¸ªå®šä¹‰ã€‚é™æ€å±€éƒ¨å˜é‡ä¹Ÿä¼šæœ‰æœ¬åœ°é“¾æ¥å™¨ç¬¦å·ï¼Œç¼–è¯‘å™¨è¿˜è¦ç¡®ä¿ä»–ä»¬æ‹¥æœ‰å”¯ä¸€çš„åå­—ã€‚</p>
<p>ä¸è¿‡ï¼Œå¯¹å…¨å±€ç¬¦å·çš„å¼•ç”¨è§£æå°±æ£˜æ‰‹çš„å¤šã€‚å½“ç¼–è¯‘å™¨é‡åˆ°ä¸€ä¸ªä¸æ˜¯åœ¨å½“å‰æ¨¡å—ä¸­å®šä¹‰çš„ç¬¦å·ï¼ˆå˜é‡æˆ–è€…å‡½æ•°åï¼‰æ—¶ï¼Œä¼šå‡è®¾è¯¥ç¬¦å·æ˜¯åœ¨å…¶å®ƒæŸä¸ªæ¨¡å—ä¸­å®šä¹‰çš„ï¼Œå‡æˆä¸€ä¸ªé“¾æ¥å™¨ç¬¦å·è¡¨æ¡ç›®ï¼Œå¹¶æŠŠå®ƒäº¤ç»™é“¾æ¥å™¨å¤„ç†ã€‚å¦‚æœé“¾æ¥å™¨åœ¨å®ƒçš„ä»»ä½•è¾“å…¥æ¨¡å—ä¸­éƒ½æ‰¾ä¸åˆ°è¿™ä¸ªè¢«å¼•ç”¨ç¬¦å·çš„å®šä¹‰ï¼Œå°±è¾“å‡ºä¸€æ¡ï¼ˆé€šå¸¸å¾ˆéš¾é˜…è¯»çš„ï¼‰é”™è¯¯ä¿¡æ¯å¹¶ç»ˆæ­¢ã€‚</p>
<h3 id="2-c-å’Œ-java-ä¸­çš„é‡æ•´å’Œæ¢å¤"><a href="#2-c-å’Œ-java-ä¸­çš„é‡æ•´å’Œæ¢å¤" class="headerlink" title="2.c++ å’Œ java ä¸­çš„é‡æ•´å’Œæ¢å¤"></a>2.c++ å’Œ java ä¸­çš„<strong>é‡æ•´</strong>å’Œ<strong>æ¢å¤</strong></h3><p>C++ å’Œ Java éƒ½å…è®¸é‡è½½æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•åœ¨æºä»£ç ä¸­æœ‰ç›¸åŒåå­—ï¼Œå´æœ‰ç€ä¸åŒçš„å‚æ•°åˆ—è¡¨ã€‚é‚£ä¹ˆé“¾æ¥å™¨æ˜¯å¦‚ä½•åŒºåˆ«è¿™äº›ä¸åŒçš„é‡è½½å‡½æ•°ä¹‹é—´çš„å·®å¼‚å‘¢ï¼Ÿ</p>
<p>å› æ­¤ç¼–è¯‘å™¨å°†æ¯ä¸ªå”¯ä¸€çš„æ–¹æ³•å’Œå‚æ•°åˆ—è¡¨ç»„åˆç¼–ç æˆä¸€ä¸ªå¯¹é“¾æ¥å™¨æ¥è¯´å”¯ä¸€çš„åå­—ã€‚è¿™ç§ç¼–ç è¿‡ç¨‹å«åšé‡æ•´ï¼ˆmanglingï¼‰ï¼Œè€Œç›¸åçš„è¿‡ç¨‹å«åšæ¢å¤ï¼ˆdemanglingï¼‰ã€‚</p>
<p>å¹¸è¿çš„äº‹ï¼ŒC++ å’Œ Javaä½¿ç”¨å…¼å®¹çš„é‡æ•´ç­–ç•¥ã€‚ä¸€ä¸ªè¢«é‡æ•´çš„ç±»åå­—æ˜¯ç”±åå­—ä¸­å­—ç¬¦çš„æ•´æ•°æ•°é‡ï¼Œåé¢è·Ÿä¸ŠåŸå§‹åå­—ç»„æˆçš„ã€‚ä¾‹å¦‚ï¼šç±» Foo è¢«ç¼–ç æˆ 3Fooã€‚æ–¹æ³•è¢«ç¼–ç ä¸ºåŸå§‹æ–¹æ³•åï¼Œåé¢åŠ ä¸Šâ€˜__â€™ï¼ˆä¸‹åˆ’çº¿ï¼‰ï¼ŒåŠ ä¸Šè¢«é‡æ•´çš„é›·é¸£ï¼Œå†åŠ ä¸Šæ¯ä¸ªå‚æ•°çš„å•å­—æ¯ç¼–ç ã€‚æ¯”å¦‚ï¼šFoo::bar(int, long) è¢«ç¼–ç ä¸º bar_3fooilã€‚</p>
<p>é‡æ•´å…¨å±€å˜é‡å’Œæ¨¡ç‰ˆåå­—çš„ç­–ç•¥æ˜¯ç›¸ä¼¼çš„ã€‚</p>
<p>ä¾‹å¦‚ C++ç¨‹åº ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">get</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">get</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b, <span class="type">int</span> c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> a + b + c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> a = <span class="number">1</span>, b = <span class="number">2</span>, c = <span class="number">3</span>;</span><br><span class="line">	<span class="type">int</span> sum1, sum2;</span><br><span class="line">	sum1 = <span class="built_in">get</span>(a, b, c);</span><br><span class="line">	sum2 = <span class="built_in">get</span>(a, b);</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;sum1: &quot;</span> &lt;&lt; sum1 &lt;&lt; endl;</span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;sum2: &quot;</span> &lt;&lt; sum2 &lt;&lt; endl;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>
<p><code>readelf mangling.o --syms</code></p>
<p>å¾—åˆ°å¦‚ä¸‹ç¬¦å·è¡¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Symbol table &#x27;.symtab&#x27; contains 30 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS mangling.cpp</span><br><span class="line">     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 .text</span><br><span class="line">     3: 0000000000000000     0 SECTION LOCAL  DEFAULT    3 .data</span><br><span class="line">     4: 0000000000000000     0 SECTION LOCAL  DEFAULT    4 .bss</span><br><span class="line">     5: 0000000000000000     1 OBJECT  LOCAL  DEFAULT    4 _ZStL8__ioinit</span><br><span class="line">     6: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    4 $d</span><br><span class="line">     7: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    1 $x</span><br><span class="line">     8: 0000000000000000     0 SECTION LOCAL  DEFAULT    5 .rodata</span><br><span class="line">     9: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    5 $d</span><br><span class="line">    10: 00000000000000fc    96 FUNC    LOCAL  DEFAULT    1 _Z41__static_ini[...]</span><br><span class="line">    11: 000000000000015c    28 FUNC    LOCAL  DEFAULT    1 _GLOBAL__sub_I__[...]</span><br><span class="line">    12: 0000000000000000     0 SECTION LOCAL  DEFAULT    6 .init_array</span><br><span class="line">    13: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT    6 $d</span><br><span class="line">    14: 0000000000000000     0 SECTION LOCAL  DEFAULT    9 .note.GNU-stack</span><br><span class="line">    15: 0000000000000014     0 NOTYPE  LOCAL  DEFAULT   10 $d</span><br><span class="line">    16: 0000000000000000     0 SECTION LOCAL  DEFAULT   10 .eh_frame</span><br><span class="line">    17: 0000000000000000     0 SECTION LOCAL  DEFAULT    8 .comment</span><br><span class="line">    18: 0000000000000000    32 FUNC    GLOBAL DEFAULT    1 _Z3getii</span><br><span class="line">    19: 0000000000000020    44 FUNC    GLOBAL DEFAULT    1 _Z3getiii</span><br><span class="line">    20: 000000000000004c   176 FUNC    GLOBAL DEFAULT    1 main</span><br><span class="line">    21: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _ZSt4cout</span><br><span class="line">    22: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _ZStlsISt11char_[...]</span><br><span class="line">    23: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _ZNSolsEi</span><br><span class="line">    24: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _ZSt4endlIcSt11c[...]</span><br><span class="line">    25: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _ZNSolsEPFRSoS_E</span><br><span class="line">    26: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _ZNSt8ios_base4I[...]</span><br><span class="line">    27: 0000000000000000     0 NOTYPE  GLOBAL HIDDEN   UND __dso_handle</span><br><span class="line">    28: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND _ZNSt8ios_base4I[...]</span><br><span class="line">    29: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND __cxa_atexit</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œä¸¤ä¸ª get å‡½æ•°åˆ†åˆ«è¢«æ ‡è¯†ä¸ºï¼š<code>_Z3getii</code> å’Œ <code>_Z3getiii</code></p>
<h3 id="3-Linux-å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·"><a href="#3-Linux-å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·" class="headerlink" title="3. Linux å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·"></a>3. Linux å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·</h3><p>å¼ºç¬¦å·ï¼šå‡½æ•°å’Œå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡</p>
<p>å¼±ç¬¦å·ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡</p>
<p>Linux å¤„ç†å¤šé‡å®šä¹‰çš„ç¬¦å·åçš„ä¸‰ä¸ªè§„åˆ™ï¼š</p>
<ol>
<li>ä¸å…è®¸å¤šä¸ªåŒåçš„å¼ºç¬¦å·ã€‚</li>
<li>å¦‚æœæœ‰ä¸€ä¸ªå¼ºç¬¦å·å’Œå¤šä¸ªå¼±ç¬¦å·åŒåï¼Œé€‰æ‹©å¼ºç¬¦å·ã€‚</li>
<li>å¦‚æœæœ‰å¤šä¸ªå¼±ç¬¦å·åŒåï¼Œä»»æ„é€‰æ‹©ä¸€ä¸ªã€‚</li>
</ol>
<h3 id="4-é™æ€åº“"><a href="#4-é™æ€åº“" class="headerlink" title="4. é™æ€åº“"></a>4. é™æ€åº“</h3><h4 id="4-1-ä¸ºä»€ä¹ˆè¦å¼•å…¥é™æ€åº“ï¼Ÿ"><a href="#4-1-ä¸ºä»€ä¹ˆè¦å¼•å…¥é™æ€åº“ï¼Ÿ" class="headerlink" title="4.1 ä¸ºä»€ä¹ˆè¦å¼•å…¥é™æ€åº“ï¼Ÿ"></a>4.1 ä¸ºä»€ä¹ˆè¦å¼•å…¥é™æ€åº“ï¼Ÿ</h4><p>å¦‚æœä¸å¼•å…¥é™æ€åº“çš„è¯ï¼Œè¯•æƒ³ä¸€ä¸‹ç¼–è¯‘å™¨å¼€å‘äººå‘˜ä¼šä½¿ç”¨ä»€ä¹ˆæ–¹æ³•æ¥å‘ç”¨æˆ·æä¾›è¿™äº›å‡½æ•°ã€‚</p>
<blockquote>
<p>ç¼–è¯‘å™¨ä»£åŠ³ï¼</p>
</blockquote>
<p>ä¸€ç§æ–¹æ³•æ˜¯è®©ç¼–è¯‘å™¨è¾¨è®¤å‡ºå¯¹æ ‡å‡†å‡½æ•°çš„è°ƒç”¨ï¼Œå¹¶ç›´æ¥ç”Ÿæˆç›¸åº”çš„ä»£ç ã€‚å¯¹äºé‚£äº›æä¾›äº†ä¸€å°éƒ¨åˆ†æ ‡å‡†å‡½æ•°çš„è¯­è¨€ï¼ˆä¾‹å¦‚ Pascalï¼‰æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¯¹äº C è¿™ç§æ ‡å‡†å®šä¹‰äº†å¤§é‡çš„æ ‡å‡†å‡½æ•°æ˜¯ä¸å¯ä»¥çš„ã€‚å› ä¸ºæ¯æ¬¡æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤ä¸€ä¸ªæ ‡å‡†åº“å‡½æ•°æ—¶ï¼Œå°±éœ€è¦ä¸€ä¸ªæ–°çš„ç¼–è¯‘å™¨ç‰ˆæœ¬ã€‚ç„¶è€Œï¼Œå¯¹äºåº”ç”¨ç¨‹åºçŒ¿è€Œè¨€ï¼Œè¿™ç§æ–¹æ³•æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œå› ä¸ºæ ‡å‡†å‡½æ•°å°†æ€»æ˜¯å¯ç”¨ï¼ˆåªéœ€è¦ä½ ç¼–è¯‘å™¨å¼€å‘äººå‘˜æå®šå°±è¡Œäº†ï¼Œç®¡æˆ‘ä»€ä¹ˆäº‹ - -</p>
<blockquote>
<p>æ‰€æœ‰å‡½æ•°å¯¹åº”ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ¨¡å—ï¼</p>
</blockquote>
<p>å¦ä¸€ç§æ–¹æ³•æ˜¯å°†æ‰€æœ‰çš„ C å‡½æ•°éƒ½æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„å¯é‡å®šä½ç›®æ ‡æ¨¡å—ä¸­ï¼ˆæ¯”å¦‚è¯´ libc.aï¼‰ï¼Œåº”ç”¨ç¨‹åºçŒ¿å¯ä»¥æŠŠè¿™ä¸ªæ¨¡å—è¿æ¥åˆ°ä»–ä»¬çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼š</p>
<p><code>gcc main.c /usr/lib/libc.o</code></p>
<p>IOS C99 å®šä¹‰çš„ Cåº“ï¼šlibc.a; æ•°å­¦å‡½æ•°åº“ï¼šlibm.a</p>
<p>é€šè¿‡æŠŠå‡½æ•°æ”¾åœ¨ç›®æ ‡æ¨¡å—ä¸­ï¼Œå¯ä»¥æŠŠç¼–è¯‘å™¨çš„å®ç°ä¸æ ‡å‡†å‡½æ•°çš„å®ç°åˆ†ç¦»å¼€æ¥ã€‚ä½†æ˜¯ï¼Œç°åœ¨æ¯ä¸ªå¯æ‰§è¡Œæ–‡ä»¶éƒ½åŒ…å«ç€ä¸€ä»½æ ‡å‡†å‡½æ•°é›†åˆçš„å‰¯æœ¬ï¼ˆé™¤éä½ ä¸é“¾æ¥å®ƒï¼Œä½†è¿™æ€ä¹ˆå¯èƒ½å‘¢ï¼Ÿï¼‰ï¼Œè¿™æ˜¯å¯¹<strong>ç£ç›˜çš„æåº¦æµªè´¹</strong>ï¼åœ¨ä¸€ä¸ªå…¸å‹çš„ç³»ç»Ÿä¸­ï¼Œlibc.a å¤§çº¦æ˜¯ 5MBï¼Œllib.a å¤§çº¦æ˜¯ 2MBï¼‰ã€‚å¦å¤–ï¼Œæ¯ä¸ªè¿è¡Œçš„ç¨‹åºéƒ½å°†å®ƒçš„è¿™äº›å‡½æ•°çš„å‰¯æœ¬æ”¾åœ¨å†…å­˜ä¸­ï¼Œè¿™æ˜¯<strong>å¯¹å†…å­˜çš„æå¤§æµªè´¹</strong>ã€‚æ­¤å¤–ï¼Œåªè¦æ ‡å‡†åº“ä¿®æ”¹äº†ä¸€ä¸ªå°å°çš„åœ°æ–¹ï¼Œæ— è®ºå¤šä¹ˆå°ï¼Œä½ éƒ½è¦é‡æ–°ç¼–è¯‘æ•´ä¸ªæºæ–‡ä»¶ï¼Œéå¸¸<strong>è€—æ—¶</strong>ã€‚</p>
<blockquote>
<p>æ¯ä¸ªå‡½æ•°å¯¹åº”ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ¨¡å—ï¼</p>
</blockquote>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸ºæ¯ä¸ªåº“å‡½æ•°åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„å¯é‡å®šä½æ¨¡å—ï¼ŒæŠŠä»–ä»¬æ”¾åœ¨ä¸€ä¸ªä¸ºå¤§å®¶éƒ½çŸ¥é“çš„ç›®å½•ä¸­æ¥è§£å†³å…¶ä¸­çš„ä¸€äº›é—®é¢˜ã€‚ç„¶è€Œï¼Œé—®é¢˜ä¹Ÿæ˜¯ç›¸å½“æ˜æ˜¾çš„ï¼š</p>
<ol>
<li>é‚£ä½ è¦æ‰‹å†™å¤šå°‘æ¨¡å—å•Šï¼Ÿ</li>
<li>å¤ªå¤šäº†ä¸å°å¿ƒå†™é”™åå­—äº†æ€ä¹ˆåŠï¼Ÿä»å¤´å†æ£€æŸ¥ä¸€éå§ï¼</li>
<li>å¤ªå¤šäº†ï¼Œä½ å¾—å†™åˆ°ä»€ä¹ˆæ—¶å€™ï¼Ÿ</li>
<li>ã€‚ã€‚ã€‚</li>
<li>çœŸæ˜¯ä¸€ä¸ªéº»çƒ¦åˆè€—æ—¶åˆç³Ÿå¿ƒçš„è¿‡ç¨‹ï¼</li>
</ol>
<p><code> gcc main.c /usr/lib/printf.o /usr/lib/scanf.o ........</code></p>
<blockquote>
<p>é™æ€åº“ï¼</p>
</blockquote>
<p>äºæ˜¯ï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œé™æ€åº“è¯ç”Ÿäº†ï¼ï¼ï¼</p>
<p>æˆ‘ä»¬å¯ä»¥ç»“åˆä¸Šé¢çš„æ–¹æ³•ï¼Œæ—¢ä¸æŠŠæ‰€æœ‰å‡½æ•°åˆ’åˆ†åˆ°ä¸€ä¸ªæ¨¡å—ï¼Œä¹Ÿä¸æ¯ä¸ªå‡½æ•°å¯¹åº”ä¸€ä¸ªæ¨¡å—ï¼Œè€Œæ˜¯æŠŠä¸€äº›ç›¸å…³çš„å‡½æ•°åˆ’åˆ†åˆ°ä¸€ä¸ªæ¨¡å—ï¼ˆä¾‹å¦‚ C æ ‡å‡†åº“å’Œæ•°å­¦åº“ç­‰ï¼‰ï¼Œç„¶åå°è£…æˆä¸€ä¸ªå•ç‹¬çš„é™æ€åº“æ–‡ä»¶ã€‚è€Œä¸æ˜¯æ¯ä¸ªå‡½æ•°å¯¹åº”ä¸€ä¸ªæ¨¡å—ã€‚</p>
<p><code>gcc main.c /usr/lib/libc.a /usr/lib/libm.a .. </code></p>
<p>ä½ å¯èƒ½ä¼šé—®ï¼šè¿™ä¸ªé™æ€åº“å’Œå‰é¢æŠŠæ‰€æœ‰å‡½æ•°æ”¾åœ¨ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ¨¡å—æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿä¸å°±æ˜¯ä¸€ä¸ªå«ï¼ˆæ¨¡å— .o)ï¼Œä¸€ä¸ªå«é™æ€åº“ï¼ˆ.aï¼‰ç½¢äº†ï¼</p>
<p>é‚£æˆ‘å¯å°±å¾—ç»™ä½ å¥½å¥½è®²è®²äº†ï¼šå½“æ‰€æœ‰å‡½æ•°å°è£…åœ¨ä¸€ä¸ªæ¨¡å—ä¸­ï¼Œé‚£æˆ‘ä»¬é“¾æ¥çš„æ—¶å€™ï¼Œå°±ä¸å¾—ä¸é“¾æ¥æ‰€æœ‰åº“å‡½æ•°äº†ã€‚</p>
<p>ä½†æ˜¯ï¼æ¥ä¸‹æ¥å¥½å¥½å¬äº†ï¼</p>
<p>å¦‚æœè¯´æ¨¡å—æ˜¯å‡½æ•°çš„é›†åˆï¼Œé‚£ä¹ˆé™æ€åº“å°±æ˜¯æ¨¡å—çš„é›†åˆï¼æ‰€ä»¥ï¼Œä½ å¯èƒ½æƒ³åˆ°äº†ï¼Œè™½ç„¶æˆ‘ä»¬é“¾æ¥åˆ°äº†é™æ€åº“ï¼Œä½†å¹¶ä¸é“¾æ¥é™æ€åº“ä¸­çš„æ‰€æœ‰æ¨¡å—ï¼Œè€Œæ˜¯åªé“¾æ¥éœ€è¦ç”¨åˆ°çš„æ¨¡å—ï¼Œè¿™æ ·æ—¢é¿å…äº†ç±»ä¼¼äºä¸€ä¸ªå‡½æ•°ä¸€ä¸ªæ¨¡å—é‚£æ ·é“¾æ¥æ¨¡å—å¤ªå¤šçš„é—®é¢˜ï¼Œåˆé¿å…äº†é“¾æ¥æ‰€æœ‰æ¨¡å—çš„é—®é¢˜ã€‚</p>
<p>ä½ å¯èƒ½ä¼šé—®ï¼šè¿™æ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯ï¼šæš´åŠ›å‡ºå¥‡è¿¹ï¼Œå¾ªç¯åˆ¤æ–­æ˜¯å¦ç”¨åˆ°å°±å¥½äº†ã€‚ç”¨ä¸åˆ°çš„æ¨¡å—å°±èˆå¼ƒæ‰ã€‚</p>
<p>å¦™ä¸å¦™ï¼å†çœ‹ä¸€çœ‹é™æ€åº“çš„å®šä¹‰å§ã€‚</p>
<blockquote>
<p>åœ¨ Linux ä¸­ï¼Œé™æ€åº“æ˜¯ä»¥ä¸€ç§ç§°ä¸º <strong>å­˜æ¡£(archive)</strong> çš„ç‰¹æ®Šæ–‡ä»¶å½¢å¼å­˜æ”¾åœ¨<strong>ç£ç›˜</strong>ä¸­çš„ã€‚å­˜æ¡£æ˜¯ä¸€ç»„è¿æ¥èµ·æ¥çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œæœ‰ä¸€ä¸ªå¤´éƒ¨ç”¨æ¥æè¿°æ¯ä¸ªæˆå‘˜ç›®æ ‡æ–‡ä»¶çš„å¤§å°å’Œä½ç½®ã€‚å­˜æ¡£æ–‡ä»¶ç”±åç¼€ï¼ˆ.a)æ ‡è¯†ã€‚</p>
</blockquote>
<h3 id="4-2-åˆ›å»ºé™æ€åº“"><a href="#4-2-åˆ›å»ºé™æ€åº“" class="headerlink" title="4.2 åˆ›å»ºé™æ€åº“"></a>4.2 åˆ›å»ºé™æ€åº“</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/x_wukong/p/5713437.html">é™æ€åº“å’ŒåŠ¨æ€åº“åˆ›å»ºå‚è€ƒ</a></p>
<blockquote>
<p>(1) é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æºæ–‡ä»¶ï¼ˆ.cï¼‰</p>
<p>è¿™é‡Œä¸º mul.c å’Œ add.c</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> mulcnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mul</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">	mulcnt ++ ;</span><br><span class="line">	<span class="keyword">return</span> a * b;</span><br><span class="line">&#125;<span class="comment">// mul.c</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> addcnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">	addcnt ++ ;</span><br><span class="line">	<span class="keyword">return</span> a + b;</span><br><span class="line">&#125;<span class="comment">// add.c</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>(2) ç„¶åï¼Œæˆ‘ä»¬éœ€è¦å°†æºæ–‡ä»¶å¤„ç†æˆå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶</p>
</blockquote>
<p><code>gcc -c add.c mul.c</code></p>
<blockquote>
<p>(3) æœ€åï¼Œå°†éœ€è¦çš„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶å°è£…åˆ°é™æ€åº“ä¸­ã€‚</p>
<p>ä¾‹å¦‚ï¼š <code>ar rcs mylib.a a.o b.o...</code></p>
<p>r: replace and insert</p>
<p>c : create</p>
<p>s: add index</p>
</blockquote>
<p><code>ar rcs mylib.a add.o mul.o</code></p>
<blockquote>
<p>(4) åˆ«ä»¥ä¸ºå°±è¿™æ ·ç»“æŸäº†ï¼Œç¼–å†™ä¸ª main ç¨‹åºæµ‹è¯•ä½ ä¸‹ä½ çš„åº“å§ï¼</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">1</span>, y = <span class="number">2</span>;</span><br><span class="line">	<span class="type">int</span> s1 = add(x, y);</span><br><span class="line">	<span class="type">int</span> s2 = mul(x, y);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;x = %d, y = %d\nsum = %d, mul = %d\n&quot;</span>, x, y, s1, s2);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c testar.c # å…ˆç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span><br><span class="line">gcc --static -o main testar.o -L. mylib.a # ä¸é™æ€åº“é“¾æ¥</span><br></pre></td></tr></table></figure>

<blockquote>
<p>â€“static å‚æ•°å‘Šè¯‰ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åºï¼Œé“¾æ¥å™¨åº”è¯¥æ„å»ºä¸€ä¸ªå®Œå…¨é“¾æ¥çš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼Œå®ƒå¯ä»¥åŠ è½½åˆ°å†…å­˜å¹¶è¿è¡Œï¼Œåœ¨åŠ è½½æ—¶æ— éœ€æ›´è¿›ä¸€æ­¥çš„é“¾æ¥ã€‚æ‰€ä»¥è¯´ä¸åŠ ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>-Ldir æŒ‡æ˜äº†é“¾æ¥å™¨åœ¨é‚£ä¸ªç›®å½•ä¸‹æŸ¥æ‰¾ mylib.aï¼Œdotå°±è¡¨ç¤ºå½“å‰ç›®å½•ã€‚</p>
</blockquote>
<h2 id="0x07-relocation"><a href="#0x07-relocation" class="headerlink" title="0x07 relocation"></a>0x07 relocation</h2><h3 id="1-é‡å®šä½çš„ä»»åŠ¡ï¼š"><a href="#1-é‡å®šä½çš„ä»»åŠ¡ï¼š" class="headerlink" title="1. é‡å®šä½çš„ä»»åŠ¡ï¼š"></a>1. é‡å®šä½çš„ä»»åŠ¡ï¼š</h3><p>é‡å®šä½åˆå¹¶è¾“å…¥æ¨¡å—ï¼Œå¹¶ä¸ºæ¯ä¸ªç¬¦å·åˆ†é…è¿è¡Œæ—¶åœ°å€ã€‚</p>
<p>ç”±ä¸¤æ­¥ç»„æˆï¼š</p>
<ol>
<li><p>é‡å®šä½èŠ‚å’Œç¬¦å·å®šä¹‰ï¼š</p>
<ol>
<li>å°†æ‰€æœ‰ç›¸åŒç±»å‹çš„èŠ‚åˆå¹¶ä¸ºä¸€ä¸ªèŠ‚</li>
<li>å°†è¿è¡Œæ—¶å†…å­˜åœ°å€èµ‹ç»™æ–°çš„èšåˆèŠ‚</li>
<li>èµ‹ç»™è¾“å…¥æ¨¡å—å®šä¹‰çš„æ¯ä¸ªç¬¦å·</li>
</ol>
<p>å®Œæˆåï¼Œç¨‹åºä¸­çš„æ¯æ¡æŒ‡ä»¤å’Œå…¨å±€å˜é‡éƒ½æœ‰å”¯ä¸€çš„è¿è¡Œæ—¶å†…å­˜åœ°å€äº†ã€‚</p>
</li>
<li><p>é‡å®šä½èŠ‚ä¸­çš„ç¬¦å·å¼•ç”¨ï¼šé“¾æ¥å™¨ä¿®æ”¹ä»£ç èŠ‚å’Œæ•°æ®èŠ‚ä¸­å¯¹æ¯ä¸ªç¬¦å·çš„å¼•ç”¨ï¼Œä½¿å¾—å®ƒä»¬æŒ‡å‘æ­£ç¡®çš„è¿è¡Œæ—¶åœ°å€ã€‚è¦æ‰§è¡Œè¿™ä¸€æ­¥ï¼Œé“¾æ¥å™¨ä¾èµ–äºå¯é‡å®šä½ç›®æ ‡æ¨¡å—ä¸­ç§°ä¸º<strong>é‡å®šä½æ¡ç›®</strong>çš„æ•°æ®ç»“æ„ã€‚</p>
</li>
</ol>
<h3 id="2-é‡å®šä½æ¡ç›®"><a href="#2-é‡å®šä½æ¡ç›®" class="headerlink" title="2. é‡å®šä½æ¡ç›®"></a>2. é‡å®šä½æ¡ç›®</h3><p>ä¸ºä»€ä¹ˆéœ€è¦é‡å®šä½æ¡ç›®ï¼Ÿ</p>
<blockquote>
<p>å½“æ±‡ç¼–å™¨ç”Ÿæˆä¸€ä¸ªç›®æ ‡æ¨¡å—æ—¶ï¼Œå®ƒå¹¶ä¸çŸ¥é“æ•°æ®å’Œä»£ç æœ€ç»ˆå°†æ”¾åœ¨å†…å­˜ä¸­çš„ä»€ä¹ˆä½ç½®ã€‚</p>
<p>å®ƒä¹Ÿä¸çŸ¥é“è¿™ä¸ªæ¨¡å—å¼•ç”¨çš„ä»»ä½•å¤–éƒ¨å®šä¹‰çš„å‡½æ•°æˆ–è€…å…¨å±€å˜é‡çš„ä½ç½®ã€‚</p>
<p>æ‰€ä»¥ï¼Œæ— è®ºä½•æ—¶æ±‡ç¼–å™¨é‡åˆ°å¯¹æœ€ç»ˆä½ç½®æœªçŸ¥çš„ç›®æ ‡å¼•ç”¨ï¼Œå®ƒå°±ä¼šç”Ÿæˆä¸€ä¸ª <strong>â€œé‡å®šä½æ¡ç›®â€</strong>ï¼Œå‘Šè¯‰é“¾æ¥å™¨åœ¨å°†ç›®æ ‡æ–‡ä»¶åˆå¹¶æˆå¯æ‰§è¡Œæ–‡ä»¶æ—¶è®¸å’Œä¿®æ”¹è¿™ä¸ªå¼•ç”¨ã€‚</p>
<p>ä»£ç çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ .rel.text ä¸­ï¼Œå·²åˆå§‹åŒ–æ•°æ®çš„é‡å®šä½æ¡ç›®æ”¾åœ¨ .rel.data ä¸­ã€‚</p>
</blockquote>
<p>ELF é‡å®šä½æ¡ç›®çš„æ ¼å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> offset;	<span class="comment">// æˆ‘åœ¨é‚£</span></span><br><span class="line">    <span class="type">long</span> type: <span class="number">32</span>;	<span class="comment">// æ€ä¹ˆå¼•ç”¨</span></span><br><span class="line">    	smybol: <span class="number">32</span>; <span class="comment">// æˆ‘å¼•ç”¨äº†è°</span></span><br><span class="line">    <span class="type">long</span> addend;	<span class="comment">// æˆ‘çš„åç§»é‡</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>offset æ˜¯éœ€è¦è¢«ä¿®æ”¹çš„å¼•ç”¨çš„åœ¨èŠ‚å†…çš„åç§»ã€‚ï¼ˆä¸€èˆ¬æ˜¯ä¸€ä¸ªåœ°å€ï¼‰</p>
<p>symbol æ ‡è¯†è¢«ä¿®æ”¹å¼•ç”¨åº”è¯¥æŒ‡å‘çš„ç¬¦å·ã€‚</p>
<p>type å‘ŠçŸ¥é“¾æ¥å™¨å¦‚ä½•ä¿®æ”¹æ–°çš„å¼•ç”¨ã€‚</p>
<p>addend æ˜¯ä¸€ä¸ªæœ‰ç¬¦å·å¸¸æ•°ï¼Œä¸€äº›ç±»å‹çš„é‡å®šä½è¦ä½¿ç”¨å®ƒå¯¹è¢«ä¿®æ”¹å¼•ç”¨çš„å€¼åšåç§»è°ƒæ•´ã€‚ï¼ˆaddendçš„å€¼ä¸€èˆ¬æ˜¯å½“å‰å¼•ç”¨çš„åœ°å€è·ç¦»ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»ï¼‰ï¼ˆè®²çš„æ ‡å‡†ä¸€ç‚¹å°±æ˜¯å¯¹ rip çš„ä¿®æ­£ï¼Œå› ä¸ºé‡å®šä½æ‰€åœ¨çš„åœ°å€å¹¶ä¸æ˜¯ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ rip åœ°å€ï¼‰</p>
</blockquote>
<p>ä¸¤ç§æœ€åŸºæœ¬çš„é‡å®šä½ç±»å‹ï¼ˆtypeï¼‰ï¼š</p>
<ol>
<li><p>R_X86_64_PC32ï¼šé‡å®šä½ä¸€ä¸ªä½¿ç”¨ 32 ä½ PC ç›¸å¯¹åœ°å€çš„å¼•ç”¨ã€‚ï¼ˆä¸€ä¸ª PC ç›¸å¯¹åœ°å€å°±æ˜¯è·ç¨‹åºè®¡æ•°å™¨(PC)çš„å½“å‰è¿è¡Œæ—¶å€¼çš„åç§»é‡ã€‚å½“ CPU æ‰§è¡Œä¸€æ¡ä½¿ç”¨ PC ç›¸å¯¹å¯»å€çš„æŒ‡ä»¤æ—¶ï¼Œå®ƒå°±å°†åœ¨æŒ‡ä»¤ä¸­ç¼–ç çš„ 32 ä½å€¼åŠ ä¸Š PC çš„å½“å‰è¿è¡Œæ—¶å€¼ï¼Œå¾—åˆ°æœ‰æ•ˆåœ°å€ï¼Œ PC å€¼é€šå¸¸æ˜¯<strong>ä¸‹ä¸€æ¡</strong>æŒ‡ä»¤åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼‰ã€‚</p>
<blockquote>
<p>ç®€è€Œè¨€ä¹‹ï¼Œ<strong>ç›¸å¯¹</strong>çš„æ„æ€å°±æ˜¯ï¼Œç›¸å¯¹äº<strong>ä¸‹ä¸€æ¡æŒ‡ä»¤</strong>çš„åç§»é‡ã€‚</p>
</blockquote>
</li>
<li><p>R_X86_64_32ï¼šé‡å®šä½ä¸€ä¸ª 32 ä½ç»å¯¹åœ°å€çš„å¼•ç”¨ã€‚é€šè¿‡ç»å¯¹å¯»å€ï¼ŒCPU ç›´æ¥ä½¿ç”¨åœ¨æŒ‡ä»¤ä¸­ç¼–ç çš„ 32 ä½å€¼ä½œä¸ºæœ‰æ•ˆåœ°å€ã€‚</p>
</li>
</ol>
<h3 id="3-é‡å®šä½ç¬¦å·å¼•ç”¨"><a href="#3-é‡å®šä½ç¬¦å·å¼•ç”¨" class="headerlink" title="3. é‡å®šä½ç¬¦å·å¼•ç”¨"></a>3. é‡å®šä½ç¬¦å·å¼•ç”¨</h3><blockquote>
<p> ç›¸å¯¹å¼•ç”¨</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call addr </span><br><span class="line">	sym.offset: R_X86_64_PC32 sym</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œè¦æ¸…æ¥šæˆ‘ä»¬çš„ç›®æ ‡ï¼šé€šè¿‡ addr çš„<strong>ç›¸å¯¹åç§»</strong>å¾—åˆ°è¯¥ç¬¦å·çš„è¿è¡Œæ—¶åœ°å€ï¼Œè¿™ä¸ªåœ°å€æˆ‘ä»¬æ˜¯å·²çŸ¥çš„ã€‚ï¼ˆæˆ‘ä»¬ç”¨ADDR(x)è¡¨ç¤ºç¬¦å· x çš„è¿è¡Œæ—¶åœ°å€ï¼‰</p>
<p>å½“å‰å¼•ç”¨çš„åœ°å€ + è·ç¦»ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡ +  addr &#x3D; ç›®æ ‡ç¬¦å·çš„è¿è¡Œæ—¶åœ°å€</p>
<p>addr &#x3D; ADDR(sym) - ï¼ˆå½“å‰å¼•ç”¨çš„åœ°å€ + è·ç¦»ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡ï¼‰</p>
<p>ä¸è¿‡ï¼Œè·ç¦»ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡é€šå¸¸ä»¥ sym.addend çš„å½¢å¼å­˜åœ¨ï¼Œäºæ˜¯ï¼Œä¸Šå¼å˜æˆäº†ï¼š</p>
<p>addr &#x3D; ADDR(sym) - å½“å‰å¼•ç”¨çš„åœ°å€ + sym.addend</p>
<blockquote>
<p>æˆ‘ä»¬å‘ç°ï¼Œå…¬å¼åœ¨ç»è¿‡è½¬æ¢åï¼Œç”± â€œè·ç¦»â€ ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»é‡å˜æˆäº† â€œåŠ ä¸Šâ€  sym.addendã€‚</p>
<p>è€Œåç§»é‡è‚¯å®šæ˜¯ä¸€ä¸ªæ­£æ•°ï¼ˆä¸ç„¶æ€ä¹ˆåç§»åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼‰ï¼Œæ‰€ä»¥è¯´ sym.addend è‚¯å®šæ˜¯ä¸ªè´Ÿæ•°ã€‚</p>
<p>è‡ªå·±æ¨å¯¼çš„ï¼Œä¸ä¸€å®šå¯¹ï¼Ÿï¼Ÿ</p>
</blockquote>
<p>è€Œå½“å‰å¼•ç”¨çš„åœ°å€ &#x3D; å¼•ç”¨æ‰€åœ¨èŠ‚çš„è¿è¡Œæ—¶åœ°å€ + å¼•ç”¨çš„åç§»(sym.offset)</p>
<p>æ‰€ä»¥ï¼Œä¸Šå¼æœ€ç»ˆç­‰äºå¦‚ä¸‹ï¼š</p>
<p>addr &#x3D; ADDR(sym) - ï¼ˆADDR(Section) + sym.offsetï¼‰+ sym.addend</p>
<hr>
<blockquote>
<p>ç»å¯¹å¼•ç”¨</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call addr</span><br><span class="line">	sym.offset: R-X86_64_32 sym</span><br></pre></td></tr></table></figure>

<p>addr &#x3D; ADDR(sym) + sym.addend</p>
<p>åœ¨ç»å¯¹å¼•ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦åŠ ä¸Šåç§»é‡addendï¼Œåªä¸è¿‡ sym.addend&#x3D;0ã€‚</p>
<p>å¯ä»¥å‘ç°ï¼Œç›¸è¾ƒäºç»å¯¹å¼•ç”¨ï¼Œç›¸å¯¹å¼•ç”¨åªéœ€è¦å‡å»å½“å‰å¼•ç”¨çš„åœ°å€å³å¯ï¼Œè·ç¦»ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åç§»ä¿å­˜åœ¨äº† addend ä¸­ã€‚</p>
<h2 id="0x08-executable-object-file"><a href="#0x08-executable-object-file" class="headerlink" title="0x08 executable object file"></a>0x08 executable object file</h2><p>å…¸å‹çš„ ELF å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ï¼ˆEOFï¼Œæ®µå’ŒèŠ‚ï¼‰ï¼š</p>
<p><img src="https://s1.328888.xyz/2022/09/28/spsQp.png" alt="img"></p>
<p>ELFå¤´è¿˜åŒ…æ‹¬äº†ç¨‹åºçš„å…¥å£ç‚¹ï¼Ÿä¹Ÿå°±æ˜¯ç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ã€‚</p>
<p>é€šè¿‡å›¾å¯ä»¥å‘ç°ï¼ŒEOF æ–‡ä»¶ä¸­è¿˜å¤šäº† .init èŠ‚ã€‚.initèŠ‚å®šä¹‰äº†ä¸€ä¸ªå°å‡½æ•°ï¼Œå«åš _init_ï¼Œç¨‹åºçš„åˆå§‹åŒ–ä»£ç ä¼šè°ƒç”¨å®ƒã€‚</p>
<p>.textï¼Œ.dataï¼Œ.rodata ä¸å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„èŠ‚æ˜¯ç›¸ä¼¼çš„ï¼Œé™¤äº†è¿™äº›èŠ‚å·²ç»è¢«é‡å®šä½åˆ°å®ƒä»¬æœ€ç»ˆçš„è¿è¡Œæ—¶å†…å­˜åœ°å€ä»¥å¤–ã€‚</p>
<p>å› ä¸º EOF æ–‡ä»¶æ˜¯<strong>å®Œå…¨é“¾æ¥</strong>çš„ï¼ˆå·²è¢«é‡å®šä½ï¼‰ï¼Œæ‰€ä»¥å®ƒä¸å†éœ€è¦ .rel èŠ‚ã€‚</p>
<blockquote>
<p>EOF æ–‡ä»¶è¿˜æœ‰å¯¹å…¶è¦æ±‚ã€‚è¿™ä¸»è¦ä¸è™šæ‹Ÿå†…å­˜æœ‰å…³</p>
</blockquote>
<h2 id="0x09-load-EOF"><a href="#0x09-load-EOF" class="headerlink" title="0x09 load EOF"></a>0x09 load EOF</h2><p>æˆ‘ä»¬é€šå¸¸åœ¨ Linux Shell å‘½ä»¤è¡Œè¾“å…¥å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶çš„åå­— (ä¾‹å¦‚prog) æ¥æ‰§è¡Œå®ƒ:</p>
<p><code>Linux&gt; ./prog</code></p>
<p>å› ä¸º prog ä¸æ˜¯ä¸€ä¸ªå†…ç½®çš„ shell å‘½ä»¤ï¼Œæ‰€ä»¥ shell ä¼šè®¤ä¸º prog æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ã€‚</p>
<p>é€šè¿‡è°ƒç”¨æŸä¸ªé©»ç•™åœ¨å†…å­˜ä¸­ç§°ä¸º<strong>åŠ è½½å™¨ï¼ˆloaderï¼‰</strong>çš„æ“ä½œç³»ç»Ÿä»£ç æ¥è¿è¡Œå®ƒã€‚</p>
<p>ä»»ä½• Linux ç¨‹åºéƒ½å¯ä»¥é€šè¿‡è°ƒç”¨ <strong>execve()</strong> è°ƒç”¨åŠ è½½å™¨ã€‚</p>
<p>åŠ è½½å™¨å°† EOF æ–‡ä»¶çš„ä»£ç å’Œæ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°å†…å­˜ä¸­ï¼Œç„¶åé€šè¿‡è·³è½¬åˆ°ç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤æˆ–å…¥å£ç‚¹æ¥è¿è¡Œè¯¥ç¨‹åºã€‚è¿™ä¸ªå°†ç¨‹åºä»ç£ç›˜å¤åˆ¶åˆ°å†…å­˜å¹¶è¿è¡Œçš„è¿‡ç¨‹å«åš â€œåŠ è½½â€ã€‚</p>
<p><img src="https://s1.328888.xyz/2022/10/12/8jGhJ.png" alt="img"></p>
<h2 id="0x0a-dynamic-link-shared-library"><a href="#0x0a-dynamic-link-shared-library" class="headerlink" title="0x0a dynamic link shared library"></a>0x0a dynamic link shared library</h2><h3 id="1-ä¸ºä»€ä¹ˆå¼•å…¥åŠ¨æ€åº“"><a href="#1-ä¸ºä»€ä¹ˆå¼•å…¥åŠ¨æ€åº“" class="headerlink" title="1. ä¸ºä»€ä¹ˆå¼•å…¥åŠ¨æ€åº“"></a>1. ä¸ºä»€ä¹ˆå¼•å…¥åŠ¨æ€åº“</h3><p>å½“ç„¶æ˜¯å› ä¸ºé™æ€åº“æœ‰ä¸€äº›ç¼ºç‚¹äº†ã€‚</p>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œé™æ€åº“ä¸æ–¹ä¾¿åç»­çš„æ›´æ–°å’Œç»´æŠ¤ã€‚</p>
<blockquote>
<p>é™æ€åº“å’Œæ‰€æœ‰è½¯ä»¶ä¸€æ ·ï¼Œéœ€è¦å®šæœŸç»´æŠ¤å’Œæ›´æ–°ã€‚</p>
<p>å¦‚æœåº”ç”¨ç¨‹åºå‘˜æƒ³è¦ä½¿ç”¨ä¸€ä¸ªåº“çš„æœ€æ–°ç‰ˆæœ¬ï¼Œä»–ä»¬å¿…é¡»ä»¥æŸç§æ–¹å¼äº†è§£åˆ°è¯¥åº“çš„æ›´æ–°æƒ…å†µï¼Œç„¶åæ˜¾å¼çš„å°†ä»–ä»¬çš„ç¨‹åºä¸æ›´æ–°äº†çš„åº“é‡æ–°é“¾æ¥ã€‚</p>
</blockquote>
<p>ç¬¬äºŒä¸ªé—®é¢˜ï¼Œé™æ€æˆ·ä»ç„¶ä¼šé€ æˆå¯¹å†…å­˜èµ„æºçš„æå¤§æµªè´¹ã€‚ </p>
<blockquote>
<p>è™½ç„¶åœ¨ä¸Šé¢ â€œå¼•å…¥é™æ€åº“â€ ä¸€èŠ‚ä¸­æˆ‘ä»¬å·²ç»è¯´æ˜äº†ï¼Œé™æ€åº“å·²ç»æ˜¯ä¸€ç§æ¯”è¾ƒèŠ‚çº¦å†…å­˜èµ„æºçš„æ–¹å¼ã€‚</p>
<p>ä½†é‚£ä»…ä»…æ˜¯åœ¨åªé’ˆå¯¹ä¸€ä¸ªæ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°½å¯èƒ½åªå¼•ç”¨å¿…é¡»ç”¨åˆ°çš„æ¨¡å—è€Œé¿å…å¼•ç”¨äº†è®¸å¤šä¸ä¼šç”¨åˆ°çš„æ¨¡å—é€ æˆå†…å­˜æµªè´¹ã€‚</p>
<p>ä½†è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬å­˜åœ¨è®¸å¤šæ–‡ä»¶å‘¢ï¼Œå‡ ä¹æ¯ä¸ªæ–‡ä»¶éƒ½ä¼šç”¨åˆ° printf() å‡½æ•°ç­‰æ ‡å‡† IO å‡½æ•°ã€‚åœ¨è¿è¡Œæ—¶ï¼Œè¿™äº›å‡½æ•°çš„ä»£ç ä¼šè¢«å¤åˆ¶åˆ°æ¯ä¸ªè¿è¡Œè¿›ç¨‹çš„æ–‡æœ¬æ®µä¸­ï¼ˆè¯•æƒ³ä¸€ä¸‹å¦‚æœæˆ‘ä»¬ printf() äº†å‡ ç™¾æ¬¡ï¼Œéš¾é“æ¯ä¸€æ¬¡è°ƒç”¨éƒ½è¦å¤åˆ¶ä¸€ä»½ printf() çš„ä»£ç å—ï¼Ÿé‚£ä¹Ÿå¤ªæµªè´¹å†…å­˜äº†ï¼ï¼‰ã€‚</p>
<p>ç‰¹åˆ«æ˜¯åœ¨ä¸€ä¸ªè¿è¡Œä¸Šç™¾ä¸ªé‡‘å±‚çš„å…¸å‹ç³»ç»Ÿä¸Šï¼Œè¿™å°†æ˜¯å¯¹ç¨€ç¼ºçš„å†…å­˜èµ„æºçš„æå¤§æµªè´¹ã€‚</p>
<p><strong>ï¼ˆå†…å­˜çš„ä¸€ä¸ªæœ‰è¶£å±æ€§å°±æ˜¯æ— è®ºç³»ç»Ÿçš„å†…å­˜å¤šå¤§ï¼Œä»–æ€»æ˜¯ä¸€ç§å¥‡ç¼ºèµ„æºã€‚ç£ç›˜ç©ºé—´å’Œå¨æˆ¿çš„åƒåœ¾æ¡¶å…·æœ‰åŒæ ·çš„å±æ€§ï¼‰ã€‚</strong></p>
</blockquote>
<p>äºæ˜¯ï¼Œä¸ºäº†è‡´åŠ›è§£å†³é™æ€åº“çš„ç¼ºæ†¾ï¼Œå…±äº«åº“è¯ç”Ÿäº†ã€‚</p>
<p><strong>å…±äº«åº“æ˜¯ä¸€ä¸ªç›®æ ‡æ¨¡å—</strong>ï¼Œåœ¨è¿è¡Œæˆ–åŠ è½½æ—¶ï¼Œ<strong>å¯ä»¥åŠ è½½åˆ°ä»»æ„çš„å†…å­˜ç©ºé—´</strong>ï¼Œå¹¶å’Œä¸€ä¸ªåœ¨å†…å­˜ä¸­çš„ç¨‹åº<strong>é“¾æ¥</strong>èµ·æ¥ã€‚è¿™ä¸ªé“¾æ¥çš„è¿‡ç¨‹å°±å«åš <strong>â€œåŠ¨æ€é“¾æ¥â€</strong>ï¼Œæ˜¯ç”±ä¸€ä¸ªå«åšåŠ¨æ€é“¾æ¥å™¨çš„ç¨‹åºæ¥æ‰§è¡Œçš„ã€‚</p>
<p>å…±äº«åº“ä¹Ÿç§°ä¸º **â€œå…±äº«ç›®æ ‡â€(shared object)**ã€‚åœ¨ Linux ç³»ç»Ÿä¸­ç”¨ <strong>.so</strong> åç¼€æ¥æ ‡è¯†ã€‚å¾®è½¯çš„æ“ä½œç³»ç»Ÿå¤§é‡çš„ä½¿ç”¨äº†å…±äº«åº“ï¼Œå®ƒä»¬ç§°ä¸º **DLL(åŠ¨æ€é“¾æ¥åº“)**ã€‚</p>
<h3 id="2-å…±äº«åº“çš„å·¥ä½œæ–¹å¼"><a href="#2-å…±äº«åº“çš„å·¥ä½œæ–¹å¼" class="headerlink" title="2. å…±äº«åº“çš„å·¥ä½œæ–¹å¼"></a>2. å…±äº«åº“çš„å·¥ä½œæ–¹å¼</h3><p>å…±äº«åº“æ˜¯ä»¥ä¸¤ç§ä¸åŒçš„æ–¹å¼æ¥å®ç° â€œå…±äº«â€çš„ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨ä»»ä½•ç»™å®šçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå¯¹äºä¸€ä¸ªé…·åªæœ‰ä¸€ä¸ª .so æ–‡ä»¶ï¼Œæ‰€æœ‰å¼•ç”¨è¯¥åº“çš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶åˆ†äº«è¿™ä¸ª .so æ–‡ä»¶ä¸­çš„ä»£ç å’Œæ•°æ®ï¼Œè€Œä¸æ˜¯åƒé™æ€åº“çš„å†…å®¹é‚£æ ·è¢«å¤åˆ¶å’ŒåµŒå…¥åˆ°å¼•ç”¨å®ƒä»¬çš„å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­ã€‚ï¼ˆè§£å†³äº†é™æ€åº“å†…å­˜æµªè´¹çš„é—®é¢˜ï¼‰</p>
<p>å…¶æ¬¡ï¼Œå†å†…å­˜ä¸­ï¼Œä¸€ä¸ªå…±äº«åº“çš„ .text èŠ‚çš„ä¸€ä¸ªå‰¯æœ¬å¯ä»¥è¢«ä¸åŒçš„æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å…±äº«ï¼ˆä¸è™šæ‹Ÿå†…å­˜æœ‰å…³ï¼‰ã€‚</p>
<p><img src="https://s1.328888.xyz/2022/10/12/86kb0.png" alt="img"></p>
<p>å¦‚ä½•æ„é€ ä¸€ä¸ªå…±äº«åº“ï¼š</p>
<p><code>gcc -shared -fpic -o libname.so module1.o module2.o ....</code></p>
<blockquote>
<p>-fpic é€‰é¡¹æŒ‡ç¤ºç¼–è¯‘å™¨ç”Ÿæˆä¸ä½ç½®æ— å…³çš„ä»£ç ã€‚</p>
<p>-shared é€‰é¡¹æŒ‡ç¤ºç¼–è¯‘å™¨åˆ›å»ºä¸€ä¸ªå…±äº«çš„ç›®æ ‡æ–‡ä»¶ã€‚</p>
</blockquote>
<p>ä¸‹é¢å°†å°†è¿™ä¸ªå…±äº«åº“é“¾æ¥åˆ°ç¨‹åºå½“ä¸­ï¼š</p>
<p><code>gcc -o prog main.c ./libname.so</code></p>
<p>æ ¹æ®ä¸Šå›¾(7-16)æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ prog21 åœ¨åŠ è½½ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¿è¡Œæ—¶å¯ä»¥å’ŒåŠ¨æ€åº“ livvector.so é“¾æ¥ã€‚åŸºæœ¬çš„æ€è·¯å°±æ˜¯å½“åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼Œé™æ€æ‰§è¡Œä¸€äº›é“¾æ¥ï¼Œç„¶ååœ¨ç¨‹åºåŠ è½½æ—¶ï¼Œ<strong>åŠ¨æ€å®Œæˆé“¾æ¥è¿‡ç¨‹</strong>ã€‚</p>
<blockquote>
<p>by xjyï¼š</p>
<p>æ³¨æ„ä¸Šé¢çš„è¯å¹¶ä¸çŸ›ç›¾ï¼Œå‰ä¸€å¥è¯è¯´ç¨‹åºè¿è¡Œæ—¶å’ŒåŠ¨æ€åº“é“¾æ¥ï¼Œä¸‹ä¸€å¥åˆè¯´åœ¨ç¨‹åºåŠ è½½æ—¶åŠ¨æ€å®Œæˆé“¾æ¥ã€‚ä¸€ä¸ªæ˜¯åœ¨è¿è¡Œæ—¶ï¼Œä¸€ä¸ªæ˜¯åœ¨åŠ è½½æ—¶ã€‚</p>
<p>è¿™å¯èƒ½æ˜¯å› ä¸ºç¨‹åºå¹¶ä¸æ˜¯ç›´æ¥å…¨éƒ¨åŠ è½½åˆ°å†…å­˜çš„ï¼ˆæ“ä½œç³»ç»Ÿï¼‰ï¼Œå®ƒç”¨åˆ°ä¸€ç‚¹å°±åŠ è½½ä¸€ç‚¹ï¼Œæ‰€ä»¥è¯´ï¼ŒåŠ è½½å’Œè¿è¡Œæ˜¯äº¤å‰çš„ã€‚</p>
</blockquote>
<p>æ³¨æ„ï¼Œå†æ•´ä¸ªé“¾æ¥çš„è¿‡ç¨‹å½“æ²¡æœ‰ä»»ä½•åŠ¨æ€åº“çš„ä»£ç å’Œæ•°æ®çœŸçš„è¢«å¤åˆ¶åˆ°å¯æ‰§è¡Œæ–‡ä»¶ prog21 å½“ä¸­ã€‚åä¹‹ï¼Œé“¾æ¥å™¨å¤åˆ¶äº†ä¸€äº›é‡å®šä½å’Œç¬¦å·è¡¨ä¿¡æ¯ï¼Œå®ƒä»¬ä½¿å¾—è¿è¡Œæ—¶å¯ä»¥è§£æå¯¹åŠ¨æ€åº“ä¸­ä»£ç å’Œæ•°æ®çš„å¼•ç”¨ã€‚</p>
<h3 id="3-å°å®éªŒ"><a href="#3-å°å®éªŒ" class="headerlink" title="3. å°å®éªŒ"></a>3. å°å®éªŒ</h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå°å®éªŒï¼Œ1.cï¼Œ2.c ç”¨æ¥æ„å»ºåŠ¨æ€åº“å’Œé™æ€åº“ï¼Œmain.c æ˜¯æµ‹è¯•å‡½æ•°ã€‚</p>
<p>app æ˜¯é“¾æ¥é™æ€åº“ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p>prog æ˜¯é“¾æ¥åŠ¨æ€åº“ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p>å¯ä»¥å‘ç°ï¼Œprog çš„å¤§å°æ¯” app å°çš„å¤šï¼ˆå°äº†50å¤šå€ï¼‰ã€‚</p>
<p><img src="https://s1.328888.xyz/2022/10/12/86JI6.png" alt="IMG"></p>
<h1 id="csapp-memory"><a href="#csapp-memory" class="headerlink" title="csapp memory"></a>csapp memory</h1><h2 id="ä¸€ã€cache"><a href="#ä¸€ã€cache" class="headerlink" title="ä¸€ã€cache"></a>ä¸€ã€cache</h2><h3 id="0x01-ä¸€ç§åˆå§‹åŒ–æ–¹å¼"><a href="#0x01-ä¸€ç§åˆå§‹åŒ–æ–¹å¼" class="headerlink" title="0x01 ä¸€ç§åˆå§‹åŒ–æ–¹å¼"></a>0x01 ä¸€ç§åˆå§‹åŒ–æ–¹å¼</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> l, r;</span><br><span class="line">    <span class="type">char</span> s[<span class="number">100</span>];</span><br><span class="line">&#125; <span class="type">node_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">node_t</span> p = &#123;</span><br><span class="line">        .l = <span class="number">100</span>,</span><br><span class="line">        .r = <span class="number">200</span>,</span><br><span class="line">        .s = <span class="string">&quot;hello,world!&quot;</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;node: %d %d %s\n&quot;</span>, p.l, p.r, p.s);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="0x02-note"><a href="#0x02-note" class="headerlink" title="0x02 note"></a>0x02 note</h3><p>æˆ‘ä»¬çŸ¥é“å†…å­˜æ˜¯åˆ†é¡µçš„ï¼Œcacheçš„ line åªä¼šå­˜åœ¨äºæŸä¸€ä¸ªé¡µï¼Œå®ƒä¸ä¼šè·¨é¡µå­˜åœ¨ã€‚</p>
<h3 id="0x03-true-x2F-fake-sharing"><a href="#0x03-true-x2F-fake-sharing" class="headerlink" title="0x03 true&#x2F;fake sharing"></a>0x03 true&#x2F;fake sharing</h3><p>ç½ªé­ç¥¸é¦–ï¼šMESI åè®®</p>
<p>false sharingæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¯¹äºsumæ±‚å’Œè¿™ä¸ªä¾‹å­ï¼Œè™½ç„¶æˆ‘ä»¬è®¾ç½®sum1å’Œsum2åˆ†åˆ«æ±‚å’Œï¼Œä½†æ˜¯sum1å’Œsum2éƒ½æ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„ï¼Œå¹¶ä¸”åœ°å€ååˆ†æ¥è¿‘ï¼Œæ‰€ä»¥å®ƒä»¬å¯èƒ½åœ¨åŒä¸€ä¸ªcacheå½“ä¸­ï¼Œè¿™æ ·ä¸ç®¡æ˜¯sum1ä¿®æ”¹è¿˜æ˜¯sum2ä¿®æ”¹ï¼Œéƒ½ä¼šè§¦æ³• MESI çš„åŒæ­¥åè®®ï¼Œè¿™æ · false sharingçš„é€Ÿåº¦å’Œtrue sharingç›¸å·®å‡ ä¹æ— å‡ ã€‚</p>
<h3 id="0x04-MESI-protocol"><a href="#0x04-MESI-protocol" class="headerlink" title="0x04 MESI protocol"></a>0x04 MESI protocol</h3><p>exclusiveï¼šç‹¬æœ‰çš„</p>
<p>exclusive å’Œ shared ä¸èƒ½å…±å­˜</p>
<p>å››ç§çŠ¶æ€ï¼šï¼ˆç”±äºè¯»æ•°æ®ä¸ä¼šäº§ç”Ÿæ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤è¿™é‡Œåªè€ƒè™‘å†™æ•°æ®æ“ä½œï¼‰</p>
<p>M: (exclusive) modify, like dirty. ç‰©ç†åœ°å€è¢«ç¼“å­˜åˆ°æŸä¸€ä¸ª cacheï¼Œå¹¶ä¸”æ•°æ®å·²ç»è¢«ä¿®æ”¹</p>
<p>E:  exclusive (clean).ç‰©ç†åœ°å€è¢«ç¼“å­˜åˆ°æŸä¸€ä¸ª cacheï¼Œå¹¶ä¸”æ•°æ®æ²¡æœ‰è¢«ä¿®æ”¹</p>
<p>S:  (exclusive) shared clean.ç‰©ç†åœ°å€è¢«ç¼“å­˜åˆ° cacheï¼Œå¹¶ä¸”å¤šä¸ª cache å…±äº«ã€‚</p>
<blockquote>
<p>å¦‚æœä¿®æ”¹ä¸€ä¸ªçŠ¶æ€ä¸º s çš„ cacheï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªå¹¿æ’­ï¼Œå°†æ‰€æœ‰å…¶ä»–çŠ¶æ€ä¸º s çš„ cache çš„çŠ¶æ€ä¿®æ”¹ä¸º invalidï¼ˆå…·ä½“æ–¹æ³•æ˜¯å°†å…¶æ‹¥æœ‰æ•°æ®å†™å…¥åˆ° dramï¼Œç„¶åä¿®æ”¹çŠ¶æ€ä¸º invalidï¼‰ï¼Œç„¶åå°†è‡ªå·±çš„çŠ¶æ€ä¿®æ”¹ä¸º Mï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å…¨å±€çŠ¶æ€ä¸‹åªæœ‰ä¸€ä¸ª Mï¼Œä¹Ÿå°±æ˜¯ exclusiveçš„ã€‚</p>
</blockquote>
<p>I: invalid.ç‰©ç†åœ°å€å¹¶æ²¡æœ‰ç¼“å­˜åˆ° cacheã€‚</p>
<blockquote>
<p>æ­¤æ—¶å¦‚æœå‘ç”Ÿ cache write</p>
<ol>
<li>å¦‚æœå…¶ä»– cache çš„çŠ¶æ€éƒ½æ˜¯ invalidï¼Œä»å†…å­˜ load æ•°æ®ï¼Œä¿®æ”¹å™¨çŠ¶æ€ä¸º Mã€‚</li>
<li>å¦‚æœå­˜åœ¨ (shared)SçŠ¶æ€ çš„ cacheï¼Œå°†å®ƒä»¬çš„æ•°æ®å†™å…¥åˆ° dramï¼Œç„¶åä¿®æ”¹çŠ¶æ€ä¸º invalidã€‚</li>
</ol>
</blockquote>
<p>æ¯ä¸ªå¤„ç†å™¨çš„cache lineéƒ½æ˜¯ dram çš„ cache line çš„æ‹·è´</p>
<h2 id="äºŒã€page-table"><a href="#äºŒã€page-table" class="headerlink" title="äºŒã€page table"></a>äºŒã€page table</h2><h3 id="0x01-tips"><a href="#0x01-tips" class="headerlink" title="0x01 tips"></a>0x01 tips</h3><p>åœ°å€ç¿»è¯‘ç”±ç¡¬ä»¶å®ç°ï¼Œæ“ä½œç³»ç»Ÿä¸ºåº”ç”¨æä¾›è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>TLB ä¹Ÿæ˜¯ä¸€ä¸ª cacheã€‚</p>
<p>ç°åœ¨ 64 ä½çš„å¤„ç†å™¨(cpu)çš„è™šæ‹Ÿåœ°å€ä¸€èˆ¬å…¶å®åªæœ‰ 48 ä½ï¼Œå‰©ä¸‹çš„ 16 ä½å±äºå†…æ ¸ã€‚</p>
<p>è™šæ‹Ÿåœ°å€ç©ºé—´å‘ˆç°å±€éƒ¨å¯†é›†ï¼Œæ•´ä½“ç¨€ç–çš„ç‰¹å¾ã€‚</p>
<p>å¤šçº§é¡µè¡¨åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼ˆæ»¡æ˜ å°„ï¼Œæ¯é¡µéƒ½å¿…é¡»æœ‰æœ‰æ•ˆæ•°æ®ï¼‰æ˜¯ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ï¼Œæ­¤æ—¶é¡µè¡¨æ¡ç›®ä¼šæ¯”æœ´ç´ é¡µè¡¨å¤šå‡ºæ¥ä¸€å€ã€‚ä½†è¿™ç§æƒ…å†µå‡ ä¹ä¸å¯èƒ½å‡ºç°ï¼ˆè™šæ‹Ÿåœ°å€ç©ºé—´çš„ç¨€ç–æ€§å’Œç¨‹åºçš„å±€éƒ¨æ€§ï¼‰ã€‚</p>
<p>é¡µè¡¨åˆ†é…åœ¨æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ€ã€‚</p>
<p>åœ¨windowsä¸‹ï¼Œèµ„æºç®¡ç†å™¨çš„å†…å­˜ä¸­å¯ä»¥çœ‹åˆ°ï¼šåˆ†é¡µç¼“å†²æ± å’Œéåˆ†é¡µç¼“å†²æ± ã€‚åˆ†é¡µç¼“å†²æ± æŒ‡çš„æ˜¯å¯ä»¥å’Œç£ç›˜è¿›è¡Œæ¢å…¥(page in)å’Œæ¢å‡º(page out)çš„é¡µï¼Œè€Œéåˆ†é¡µå¹¶ä¸æ˜¯æŒ‡ä¸åˆ†é¡µï¼Œè€Œæ˜¯ä¸èƒ½å–ç£ç›˜è¿›è¡Œ swapã€‚</p>
<h3 id="0x02-how-to-reflect-va2pa"><a href="#0x02-how-to-reflect-va2pa" class="headerlink" title="0x02 how to reflect va2pa"></a>0x02 how to reflect va2pa</h3><p>åœ¨æˆ‘ä»¬ç¼–å†™çš„åœ°å€è½¬æ¢å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç®€å•çš„é€šè¿‡å»æ¨¡æ•°å°†ç‰©ç†åœ°å€è½¬æ¢ä¸ºè™šæ‹Ÿåœ°å€ï¼Œç„¶è€Œï¼Œè¿™æ˜¯æä¸ºä¸åˆç†çš„ï¼Œä¾‹å¦‚ï¼š</p>
<ol>
<li>äº§ç”Ÿä¸åˆæ³•çš„åœ°å€ï¼ˆåœ°å€è¶Šç•Œï¼‰ã€‚ä¾‹å¦‚ï¼š0x200(1024)%0x200&#x3D;0x000ï¼Œå®ƒäº§ç”Ÿäº†ä¸€ä¸ªåœ°å€ä¸º 0 çš„åœ°å€ï¼Œè¿™æ˜¾ç„¶æ˜¯é”™è¯¯çš„ã€‚</li>
<li>ä¸åŒè¿›ç¨‹é—´åœ°å€å†²çªçš„é—®é¢˜ã€‚å› ä¸ºæ¯ä¸ªè¿›ç¨‹çš„åœ°å€éƒ½æ˜¯ä» 0x00400000 å¼€å§‹çš„ï¼Œè€Œç›¸åŒåœ°å€å–æ¨¡ä¹‹åçš„å€¼æ˜¯ç›¸åŒçš„ï¼Œè¿™å°±ä¼šå¯¼è‡´åœ°å€å†²çªã€‚</li>
</ol>
<p>ä¸€ç§å¯è¡Œçš„æ–¹æ³•æ˜¯ä½¿ç”¨ hashmap å®Œæˆç‰©ç†åœ°å€åˆ°è™šæ‹Ÿåœ°å€åœ°å€æ˜ å°„ã€‚å®ƒè§£å†³äº†ä½¿ç”¨å–æ¨¡æ–¹æ³•äº§ç”Ÿçš„å†²çªå’Œè¶Šç•Œé—®é¢˜ï¼Œä½†æ˜¯ï¼Œå®ƒåˆä¼šäº§ç”Ÿä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>å†…å­˜æµªè´¹ä¸¥é‡ã€‚åœ¨ hashmap ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–çš„ä¸¤ä»½ç©ºé—´æ¥åˆ†åˆ«å­˜å‚¨ç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€ä»¥è®°å½•ä»–ä»¬çš„æ˜ å°„å…³ç³»ï¼Œå¹¶ä¸”ï¼Œç”±äº hashmap å¹¶ä¸æ˜¯å…¨éƒ¨ä½¿ç”¨çš„ï¼Œå®ƒçš„å†…éƒ¨ä¼šæœ‰ç©ºé—²ï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦ä¹˜ä¸Šä¸€ä¸ªç©ºé—²ç‡ k(k&gt;&#x3D;1)ï¼Œå› æ­¤ hashmap å°±éœ€è¦é¢å¤–çš„ 2k å€çš„é¢å¤–å†…å­˜ç©ºé—´è¦ä¿å­˜æ˜ å°„ä¿¡æ¯ã€‚</li>
<li>ç ´åç¨‹åºçš„å±€éƒ¨æ€§ã€‚ç”±äº hashmap çš„æ˜ å°„æ˜¯ç¦»æ•£çš„ï¼Œè¿™å°±ä¼šå¯¼è‡´ç¨‹åºä¼šè¢«ç¦»æ•£åŒ–ï¼Œç ´åç¨‹åºçš„å±€éƒ¨æ€§ã€‚</li>
</ol>
<p>ä½†æ˜¯ï¼Œhashmap äº§ç”Ÿçš„è¿™ä¸¤ä¸ªé—®é¢˜å±äº æ€§èƒ½ é—®é¢˜ï¼Œå®ƒåªæ˜¯å¯¼è‡´ç¨‹åºè¿è¡Œæ•ˆç‡ä¸å¥½ï¼Œå¹¶ä¸ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œé”™è¯¯ã€‚è€Œå–æ¨¡æ–¹æ³•åˆ™ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œå‡ºé”™ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å†æ¥æƒ³ï¼Œhashmap ä¸­è®°å½•å¦‚æ­¤ä¹‹å¤šçš„æ˜ å°„ä¿¡æ¯æ˜¯å¦æœ‰å¿…è¦ï¼Ÿ</p>
<p>è‚¯å®šæ˜¯æœ‰å¿…è¦çš„ï¼Œä¸ç„¶æˆ‘ä»¬å°±æ— æ³•æ‰¾åˆ°ç‰©ç†åœ°å€äº†ã€‚ä½†æ˜¯ï¼å¦‚æœæˆ‘ä»¬é€šè¿‡è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ä¸æ˜¯ç¦»æ•£çš„ï¼Œä¾‹å¦‚ï¼š</p>
<blockquote>
<p>è™šæ‹Ÿåœ°å€ 0x1,0x2ï¼Œé€šè¿‡ hashmap åœ°å€æ˜ å°„ä¸ºç‰©ç†åœ°å€ï¼š0xa, 0xabcdã€‚å¦‚æœæˆ‘ä»¬æƒ³æ‰¾åˆ°è¿™ä¸¤ä¸ªç‰©ç†åœ°å€ï¼Œæˆ‘ä»¬å¿…é¡»ä¿å­˜æ˜ å°„ä¿¡æ¯ï¼Œå› ä¸º 0xa, 0xabcd ä¹‹é—´æ¯«æ— å…³è”ã€‚ä½†æ˜¯è¿™ç§ç¦»æ•£æ€§æ˜¯æ¯«æ— å¿…è¦çš„ï¼Œå¦‚æœæˆ‘ä»¬å°†åœ°å€æ˜ å°„ä¸º 0xa, 0xb è¿™ç§è¿ç»­çš„åœ°å€çš„è¯ï¼Œå®ƒä¸ä»…å¯ä»¥é¿å…ç ´åç¨‹åºçš„å±€éƒ¨æ€§ï¼Œè¿˜èƒ½å‡å°‘åœ°å€æ˜ å°„éœ€è¦ä¿å­˜çš„ä¿¡æ¯ã€‚</p>
<p>æ¯”å¦‚è™šæ‹Ÿåœ°å€ [0x0, 0xffff] è¿™ä¸€å—åŒºåŸŸï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨ hashmapï¼Œå®ƒéœ€è¦ 0xffff ä»½æ˜ å°„ä¿¡æ¯ï¼Œè¿™ä¹Ÿå¤ªå¤šäº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœ hashmap æ˜ å°„çš„åœ°å€æ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸‰å…ƒç»„(va0, pa0, offset) ï¼ˆoffsetè¡¨ç¤ºåç§»é‡ï¼‰æ¥æ‰¾åˆ°è¿™ä¸ªåŒºåŸŸå†…ä»»æ„ä¸€ä¸ªåœ°å€çš„æ˜ å°„ï¼Œå¹¶ä¸”ä»…ä»…åªéœ€è¦ä¸€ä»½æ˜ å°„ä¿¡æ¯ï¼Œå¯¹äºä»»æ„ vaï¼Œpa&#x3D;pa0+va-va0ï¼ˆva &gt;&#x3D; va0 &amp;&amp; va &lt;&#x3D; va0 + offsetï¼‰ã€‚</p>
<p>ç°åœ¨ï¼Œ å®Œæˆåœ°å€æ˜ å°„éœ€è¦çš„é¢å¤–ä¿¡æ¯ç”± 2k å˜æˆäº† 3Mï¼ŒM å°±æ˜¯ä¸Šè¿°ä¸‰å…ƒç»„çš„æ•°é‡ï¼Œè¿™ä¸ª M è¿œå°äºåœ°å€çš„æ•°é‡ã€‚</p>
</blockquote>
<p>è¿™å°±æ˜¯åˆ†æ®µæ€æƒ³ã€‚</p>
<p>å½“ç„¶ï¼Œåˆ†æ®µä¹Ÿæ˜¯æœ‰é—®é¢˜çš„ï¼Œä¾‹å¦‚ï¼š</p>
<ol>
<li>ç¢ç‰‡ã€‚å†…éƒ¨ç¢ç‰‡å’Œå¤–éƒ¨ç¢ç‰‡ã€‚</li>
<li>æ¯æ¬¡è®¡ç®—éƒ½éœ€è¦æ¯”è¾ƒ va æ˜¯å¦è¶Šç•Œã€‚(va &gt;&#x3D; va0 &amp;&amp; va &lt;&#x3D; va0 + offset)</li>
<li>ä¸æ–¹ä¾¿æ‹“å±•ã€‚å½“æˆ‘ä»¬çš„æ®µå¤ªå¤§æˆ–è€…æˆ–è®¸é¢‘ç¹æ‹“å±•çš„æ—¶å€™ï¼Œå¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„ç©ºé—´æ¯”è¾ƒéº»çƒ¦ã€‚</li>
</ol>
<p>æ‰€ä»¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ offset å˜æˆä¸€ä¸ªè¾ƒå°ä¸”å›ºå®šçš„æ•°å€¼ï¼Œè¿™å°±æ˜¯åˆ†é¡µæ€æƒ³ã€‚</p>
<h3 id="0x03-address-transfer"><a href="#0x03-address-transfer" class="headerlink" title="0x03 address transfer"></a>0x03 address transfer</h3><p><a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/arm64-memory-addressing.html">ARM64æ¶æ„ä¸‹åœ°å€ç¿»è¯‘ç›¸å…³çš„å®å®šä¹‰</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/muahao/p/10297852.html">else</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1374439">else</a></p>
<h3 id="0x04-page-falult"><a href="#0x04-page-falult" class="headerlink" title="0x04 page falult"></a>0x04 page falult</h3><p>MM: main memoryï¼Œä¸»å­˜</p>
<p>page table is the <strong>cache</strong> from disk to main memory</p>
<p>äº¤æ¢ç©ºé—´ï¼šå½“æˆ‘ä»¬é¡µè¡¨ç¼“å­˜çš„é¡µæ»¡äº†ä¹‹åï¼Œæˆ‘ä»¬æƒ³å†å¾€å†…å­˜æ˜ å°„ä¸€é¡µï¼Œæ­¤æ—¶éœ€è¦å°†è¯¥é¡µ page outï¼Œä½†æ˜¯å¦‚æœè¯¥é¡µçš„æ•°æ®è¢«ä¿®æ”¹äº† dirtyï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<ol>
<li>ä¸ç®¡å®ƒï¼Œè¿™è‚¯å®šä¸è¡Œ</li>
<li>å°†è¯¥é¡µå†™å›æ–‡ä»¶ program fileï¼Œè¿™ä¹Ÿè‚¯å®šä¸è¡Œï¼Œæˆ‘ä»¬ä¸åº”è¯¥ä¿®æ”¹æºæ–‡ä»¶ã€‚</li>
<li>æ”¾åˆ°åˆ«çš„åœ°æ–¹ â€“ swap spaceã€‚</li>
</ol>
<p>å°†ä¸€é¡µä» mm æ”¾åˆ° swap space çš„è¿‡ç¨‹å°±å«åš swap out</p>
<p>ç›¸åçš„ï¼Œå°†é¡µä» swap space å†æ”¾åˆ° mm çš„è¿‡ç¨‹å«åš swap in</p>
<p>æ‰€ä»¥è¯´ï¼Œä¸€ä¸ªæ–‡ä»¶å ç”¨çš„ç©ºé—´åŒ…æ‹¬äº† mm å’Œ swap</p>
<p>swap space ä¹Ÿåœ¨ç£ç›˜</p>
<p><strong>demand paging</strong>:  waiting until the miss to copy the page to DRAM is konwn as deman paging</p>
<p>ç¨‹åºçš„ä»£ç æ–‡ä»¶ï¼Œä¾‹å¦‚ .data æ®µå®ƒæ˜¯å­˜å‚¨åœ¨ç£ç›˜å½“ä¸­çš„ï¼Œæ‰€ä»¥å®ƒä¸å†…å­˜ä¹‹é—´å¯ä»¥å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œä½†æ˜¯ .data æ®µï¼Œstack, heap ä¸æ˜¯å­˜å‚¨åœ¨ç£ç›˜å½“ä¸­çš„ï¼Œå½“æˆ‘ä»¬éœ€è¦æŠŠè¿™äº›çŸ­å­˜æ”¾åœ¨ç£ç›˜å½“ä¸­æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ”¾å…¥ swap space ä¸­ã€‚å®ƒä»¬åˆç§°ä¸º<strong>â€œåŒ¿åé¡µâ€</strong>(åœ¨ç£ç›˜ä¸­æ²¡æœ‰æ–‡ä»¶ä¸å®ƒå¯¹åº”)ã€‚ </p>
<h2 id="ä¸‰ã€virtual-memory-overview"><a href="#ä¸‰ã€virtual-memory-overview" class="headerlink" title="ä¸‰ã€virtual memory overview"></a>ä¸‰ã€virtual memory overview</h2><p>â€‹       virtual memory ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ç‰©ç†å†…å­˜å’Œè¿›ç¨‹æ‰€çœ‹åˆ°çš„è™šæ‹Ÿå†…å­˜ä¸åŒ¹é…çš„é—®é¢˜ï¼Œæ‰€ä»¥è¯´æ¯ä¸ª virtual memory è‚¯å®šæ˜¯æä¾›ç»™æ¯ä¸€ä¸ª<strong>è¿›ç¨‹</strong>çš„ã€‚</p>
<p>æ¯ä¸ªè¿›ç¨‹å°±æ˜¯ä¸€æ®µ active çš„å†…å­˜ï¼Œä¾‹å¦‚ï¼š</p>
<ol>
<li>.text æ˜¯æ­»çš„</li>
<li>.data æ˜¯æ´»çš„ï¼Œå› ä¸ºå®ƒéœ€è¦å†™å…¥æ“ä½œç­‰</li>
</ol>
<p>å¦‚æœåŒºåˆ† user çš„è™šæ‹Ÿåœ°å€ç©ºé—´å’Œ kernel çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼škernel çš„64ä½è™šæ‹Ÿåœ°å€çš„æœ€é«˜ä½æ˜¯1ï¼Œuser çš„64ä½è™šæ‹Ÿåœ°å€çš„æœ€é«˜ä½æ˜¯ 0ã€‚</p>
<p>æˆ‘ä»¬é€šå¸¸çœ‹åˆ°çš„ç¨‹åºçš„è™šæ‹Ÿåœ°å€ç©ºé—´å›¾ä¸­ï¼Œ user çš„è™šæ‹Ÿåœ°å€ç©ºé—´åœ°å€çš„é«˜éƒ¨åˆ†éƒ½è¢« stack å ç”¨äº†ï¼Œä½†æ˜¯è¿™é€šå¸¸æ˜¯ä½œè€…çš„ç®€åŒ–ï¼Œå®é™…ä¸Šåœ°å€çš„æœ€é«˜éƒ¨åˆ†è¢« kernel éƒ¨åˆ†å ç”¨äº†ï¼Œåªä¸è¿‡ä¸€åŠä¸æ ‡è¯†å‡ºæ¥ã€‚</p>
<p>åªæœ‰ç¬¬ä¸€çº§é¡µè¡¨å¯ä»¥åŒºåˆ†user mode or kernel modeï¼Œå› ä¸ºåªæœ‰ç¬¬ä¸€çº§é¡µè¡¨å¯ä»¥å¾—åˆ°åœ°å€çš„æœ€é«˜ä½ã€‚</p>
<p>ç”¨æˆ·çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­çš„ user éƒ¨åˆ†æ˜ å°„åˆ°ç¨‹åºçš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„user éƒ¨åˆ†ï¼Œæ˜ å°„æ–¹æ³•ä¸ºï¼š0x0 + addrï¼Œkernel mode éƒ¨åˆ†çš„æ˜ å°„æ–¹æ³•ä¸ºï¼š0xffff + addrï¼Œuserçš„è™šæ‹Ÿåœ°å€ç©ºé—´çš„åœ°å€æœ€é«˜ä¸º2^48ã€‚0xffffæ­£å¥½æ˜¯16ä½ã€‚</p>
<p>pgb åœ¨ kernel ä¸­åªæœ‰å”¯ä¸€ä¸€ä»½ã€‚</p>
<p>kernel çš„è™šæ‹Ÿåœ°å€ä» 2^47ï¼Ÿ</p>
<p>å†…æ ¸çš„åœ°å€ç¿»è¯‘å…¨å±€ä¸€è‡´ã€‚</p>
<h2 id="å››ã€TLB"><a href="#å››ã€TLB" class="headerlink" title="å››ã€TLB"></a>å››ã€TLB</h2><p>hardware accelerationï¼šç¡¬ä»¶åŠ é€Ÿ</p>
<p>TLB is the cache of va2pa</p>
<p>æˆ‘ä»¬å¯ä»¥æŠŠ cache çœ‹ä½œä¸€ä¸ª key-value åº“</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="cn">
    <link itemprop="mainEntityOfPage" href="https://qaqowoqaq.github.io/undefined/undefined/undefined/undefined/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="jyyyx">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="jyyyyyyyyyx">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/undefined/undefined/undefined/undefined/" class="post-title-link" itemprop="url">C++ concurrency programming</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-06-15 20:20:57" itemprop="dateCreated datePublished" datetime="2023-06-15T20:20:57+08:00">2023-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-06-16 10:15:25" itemprop="dateModified" datetime="2023-06-16T10:15:25+08:00">2023-06-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cpp/" itemprop="url" rel="index"><span itemprop="name">Cpp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="C-Concurrency-In-Action"><a href="#C-Concurrency-In-Action" class="headerlink" title="C++ Concurrency In Action"></a>C++ Concurrency In Action</h1><h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a target="_blank" rel="noopener" href="https://www.bookstack.cn/read/Cpp_Concurrency_In_Action/README.md#C++%20Concurrency%20In%20Action">Bookå¼€æºå¤„,æ„Ÿè§‰ç¿»è¯‘å¾ˆçƒ‚</a></p>
<p>å…³äºå¼‚å¸¸ï¼š</p>
<blockquote>
<p><strong>å‡ºç°å¼‚å¸¸å¹¶ä¸æ„å‘³ç€ç¨‹åºæœ¬èº«å‡ºäº†é—®é¢˜ï¼Œè€Œæ˜¯ç¨‹åºå¤–éƒ¨çš„è¾“å…¥æ— æ³•è®©æ­£å¸¸ä¸šåŠ¡ç»§ç»­æ‰§è¡Œï¼Œè¿™æ—¶åº”è¯¥æ‰§è¡Œçš„æ˜¯å¼‚å¸¸ä¸šåŠ¡ï¼Œè€Œå¼‚å¸¸å°±æ˜¯è¿™ä¸¤ç§ä¸šåŠ¡è½¬æ¥çš„æ¡¥æ¢â€”â€”å®ƒæä¾›ä¸€ç§æœºåˆ¶ï¼Œä½¿å¾—ç¨‹åºå‘˜åœ¨éµå®ˆä¸€å®šè§„åˆ™ä¹‹ä¸‹ï¼Œè¿™ä¸ªå¼‚å¸¸ä¸šåŠ¡èƒ½å¤Ÿæ­£ç¡®å®Œæˆã€‚</strong></p>
<p>å¼‚å¸¸å®‰å…¨çš„ä¸‰ä¸ªçº§åˆ«ï¼šnoexcept,  basic, strong</p>
<p><a target="_blank" rel="noopener" href="https://01io.tech/error-handling-cpp-exception-safety/">ref</a></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/cpp/how-to-design-for-exception-safety?view=msvc-170">ref</a></p>
</blockquote>
<h2 id="P0-English"><a href="#P0-English" class="headerlink" title="P0 English"></a>P0 English</h2><p>spinï¼šè‡ªæ—‹è½¬</p>
<p>unary predicateï¼šä¸€å…ƒè°“è¯s</p>
<p>binary predicateï¼šäºŒå…ƒè°“è¯</p>
<p>predicateï¼šè°“è¯</p>
<p>snapshotï¼šå¿«ç…§</p>
<p>nice-to-haveï¼šå¯æœ‰å¯æ— </p>
<p>parallelism: å¹¶è¡Œ</p>
<p>serializationï¼šä¸²å½¢</p>
<p>RAII: Resource Acqusition Is Initializationï¼Œèµ„æºè·å–å³åˆå§‹åŒ–</p>
<p>Abstraction penaltyï¼šæŠ½è±¡ä»£ä»·</p>
<p>daemon thread: å®ˆæŠ¤çº¿ç¨‹</p>
<p>invariants:ä¸å˜é‡</p>
<p>race conditionï¼šæ¡ä»¶ç«äº‰</p>
<p>grammarï¼šè¯­æ³•</p>
<p>semanticsï¼šè¯­ä¹‰</p>
<p>malicious_functionï¼šæ¶æ„å‡½æ•°</p>
<p>hierarchical: åˆ†å±‚çš„</p>
<p>granularity: ç²’åº¦</p>
<p>idiomï¼šæƒ¯ç”¨æ³•</p>
<p>nest: åµŒå¥—</p>
<p>recursiveï¼šäº’æ–¥</p>
<p>synchronizationï¼šåŒæ­¥</p>
<p>condition variableï¼šæ¡ä»¶å˜é‡</p>
<p>futureï¼šæœŸæœ›</p>
<p>spurious wakeupï¼šä¼ªå”¤é†’</p>
<p>asynchronizationï¼šå¼‚æ­¥</p>
<p>pivotï¼šæ¢çº½</p>
<p>chronoï¼šæ—¶é—´</p>
<h2 id="P1-Hello-concurrency"><a href="#P1-Hello-concurrency" class="headerlink" title="P1 Hello, concurrency"></a>P1 Hello, concurrency</h2><p><strong>contest switch</strong></p>
<blockquote>
<p>save cpu state and instruction pointer, calculate which task should we switched, and load new cpu state. then, cpu will load the instruction and data in cache</p>
</blockquote>
<p><strong>hardware concurrency</strong></p>
<blockquote>
<p>truly concurrency</p>
</blockquote>
<p><strong>the way of concurrency</strong></p>
<blockquote>
<ol>
<li><p>Multiprocessing concurrency: need to IPC, so more complex and more slowly, but it has good isolation and more safety</p>
</li>
<li><p>Multithreading concurrency: need to solve concurrency problem carefully</p>
</li>
</ol>
</blockquote>
<p>**Warning: **this book base on multiply thread concurrency</p>
<p><strong>why need to concurrency:</strong> only one for code <strong>ioslation</strong> and other for <strong>prefomance</strong></p>
<p><strong>test code:</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">hello</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Hello, Concurrency!&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(hello)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="P2-Thread-management"><a href="#P2-Thread-management" class="headerlink" title="P2 Thread management"></a>P2 Thread management</h2><h3 id="2-1-preface"><a href="#2-1-preface" class="headerlink" title="2.1 preface"></a>2.1 preface</h3><h4 id="2-1-1-generalize"><a href="#2-1-1-generalize" class="headerlink" title="2.1.1 generalize"></a>2.1.1 generalize</h4><blockquote>
<ol>
<li>create and run a new thread</li>
<li>join or detain thread</li>
<li>unique identify of thread</li>
</ol>
</blockquote>
<h4 id="2-1-2-start-thread"><a href="#2-1-2-start-thread" class="headerlink" title="2.1.2 start thread"></a>2.1.2 start thread</h4><p>thread run when you create a object of <code>std::thread</code></p>
<p><code>std::thread</code> can create a object by <code>function object</code>, like this example:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">hello</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Hello, Concurrency!&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">background_task</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">void</span>)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Hello, I am a new thread!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="comment">// do something else</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Good bye~&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    background_task f;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(f)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>But, if you want to pass a tempate object to <code>std::thread</code>, in this way:<code>thread my_t(background_task());</code></p>
<p>You will found this run with error: <code>my_t is a declaration of funtion</code></p>
<p>This is because C++â€™s <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Most_vexing_parse">most vexing parse</a>, in that declaration, my_t will be parsed in a funtion but a object, you can solve this by following way:</p>
<ol>
<li>use of an extra parenthesis: <code>thread t(( background_task() ));</code></li>
<li>use C++11 initialization: <code>thread t&#123; background_task() &#125;;</code></li>
<li>use C++11 lambda:</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">thread <span class="title">t</span><span class="params">([]&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    cout &lt;&lt; <span class="string">&quot;Hello, this is a thread!&quot;</span> &lt;&lt; endl;</span></span></span><br><span class="line"><span class="params"><span class="function">    cout &lt;&lt; <span class="string">&quot;byt~&quot;</span> &lt;&lt; endl;</span></span></span><br><span class="line"><span class="params"><span class="function">&#125;)</span></span>;</span><br></pre></td></tr></table></figure>

<p>If you doesnâ€™t decide join or detain your thread, then it will call dtor(<code>std::terminate()</code>).</p>
<h4 id="2-1-2-join-thread"><a href="#2-1-2-join-thread" class="headerlink" title="2.1.2 join thread"></a>2.1.2 join thread</h4><p>If you detach a thread like this way:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">func</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> &amp;i;</span><br><span class="line">    <span class="built_in">func</span>(<span class="type">int</span> &amp;_i) : <span class="built_in">i</span>(_i) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">unsigned</span> j = <span class="number">0</span>; j &lt; <span class="number">1024</span> * <span class="number">1024</span>; j ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; j &lt;&lt; <span class="string">&quot; - &quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;-Hello,World!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">oops</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> local_state = <span class="number">1024</span>;</span><br><span class="line">    <span class="function">func <span class="title">my_func</span><span class="params">(local_state)</span></span>;</span><br><span class="line">    <span class="built_in">my_func</span>();</span><br><span class="line">    <span class="function">thread <span class="title">my_thread</span><span class="params">(my_func)</span></span>;</span><br><span class="line">    my_thread.<span class="built_in">detach</span>(); <span class="comment">// wrong!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">oops</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In <code>std::thread my_thread</code>, we pass by value of <code>my_func</code> and access local object in <code>func::operator()</code> , if funtion <code>oops</code> exit before thread <code>my_thread</code> exit, then <code>my_thread</code> will access local value which is destoryed, and the behaviour when it happened is UB. </p>
<blockquote>
<p>so it is important to choose a valid way to wait you thread.</p>
<p>and a programming habit is <strong>do not create a thread which can access local object</strong></p>
</blockquote>
<p>A easy and rude way to wait a thread until exit is <code>join</code></p>
<p>if you call <code>join</code>, the resoures about thread will clean automatilly, and you cant call <code>join</code> double times and more.</p>
<p>you can call <code>joinable()</code> to get if you can join, it return false if you haved joined </p>
<h4 id="2-1-3-join-in-special-condition"><a href="#2-1-3-join-in-special-condition" class="headerlink" title="2.1.3 join in special condition"></a>2.1.3 join in special condition</h4><p>Look the next code:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">func</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">thread_guard</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">thread_guard</span><span class="params">(thread &amp;<span class="type">_t</span>)</span> : t(_t) &#123;</span>&#125;</span><br><span class="line">    ~<span class="built_in">thread_guard</span>() </span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;~ thread_guard&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">if</span>(t.<span class="built_in">joinable</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            t.<span class="built_in">join</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;~ end&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">thread_guard</span>(thread_guard <span class="type">const</span> &amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    thread_guard&amp; <span class="keyword">operator</span>=(thread_guard <span class="type">const</span> &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    thread &amp;t;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_something</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;function f() do something here..&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">throw</span>(<span class="built_in">string</span>(<span class="string">&quot;No reason exception&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> local_state = <span class="number">1024</span>;</span><br><span class="line">    <span class="function">func <span class="title">my_func</span><span class="params">(local_state)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(my_func)</span></span>;</span><br><span class="line">    <span class="built_in">do_something</span>();</span><br><span class="line">    <span class="comment">// if do_something() throw exception</span></span><br><span class="line">    <span class="comment">// then t.join will be skiped and t would call terminate</span></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">f</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(string &amp;e)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;catch in main: &quot;</span> &lt;&lt; e &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>In function <code>f()</code>, if <code>do_something()</code> throw exception, and not catched, then <code>f()</code> wiil exit and skiped <code>join()</code></p>
<p>A solution is followings:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">func</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_something</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;function f() do something here..&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">throw</span>(<span class="built_in">string</span>(<span class="string">&quot;No reason exception&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> local_state = <span class="number">1024</span>;</span><br><span class="line">    <span class="function">func <span class="title">my_func</span><span class="params">(local_state)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(my_func)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">do_something</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(string &amp;e) <span class="comment">// (1)</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;catch in f: &quot;</span> &lt;&lt; e &lt;&lt; endl;</span><br><span class="line">        t.<span class="built_in">join</span>();</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">f</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(string &amp;e)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;catch in main: &quot;</span> &lt;&lt; e &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>But, a better way is in RAII</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">func</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">thread_guard</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">thread_guard</span>(thread&amp; <span class="type">_t</span>) : <span class="built_in">t</span>(<span class="type">_t</span>) &#123;&#125;</span><br><span class="line">    ~<span class="built_in">thread_guard</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;~thread_guard&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">if</span>(t.<span class="built_in">joinable</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            t.<span class="built_in">join</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;~thread_guard end&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">thread_guard</span>(<span class="type">const</span> thread&amp; <span class="type">_t</span>)=<span class="keyword">delete</span>;</span><br><span class="line">    thread_guard&amp; <span class="keyword">operator</span>=(<span class="type">const</span> thread&amp; <span class="type">_t</span>) = <span class="keyword">delete</span>;</span><br><span class="line"><span class="keyword">private</span>:    </span><br><span class="line">    thread &amp;t;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_something</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;function f() do something here..&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">throw</span>(<span class="built_in">string</span>(<span class="string">&quot;No reason exception&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> local_state = <span class="number">1024</span>;</span><br><span class="line">    <span class="function">func <span class="title">my_func</span><span class="params">(local_state)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(my_func)</span></span>;</span><br><span class="line">    <span class="function">thread_guard <span class="title">g</span><span class="params">(t)</span></span>;</span><br><span class="line">    <span class="built_in">do_something</span>();</span><br><span class="line">    <span class="comment">// the next will skiped if do_something() throw exception</span></span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;f() end&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">f</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(string &amp;e)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;catch in main: &quot;</span> &lt;&lt; e &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this way, although <code>do_something()</code> will throw exception and skip <code>join</code>, the object <code>g</code> will call <code>dtor</code> to <code>join</code> the thread he managed</p>
<h4 id="2-1-4-detach-thread"><a href="#2-1-4-detach-thread" class="headerlink" title="2.1.4 detach thread"></a>2.1.4 detach thread</h4><h3 id="2-2-pass-value"><a href="#2-2-pass-value" class="headerlink" title="2.2 pass value"></a>2.2 pass value</h3><p>Whaterver the parameters type you set(reference or value), thread will <strong>copy</strong> always! Just copy all arguments in the memory space itself.</p>
<p>In the following code, function <code>f()</code> receive a int pass by value and a string pass by reference</p>
<p>And because we detach the thread <code>t</code>, so we would canâ€™t receiver itâ€™s output.</p>
<blockquote>
<p>åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œå‡½æ•° f æ‰“å°çš„ s å¯èƒ½ä¼šä¹±ç ï¼Œè¿™æ˜¯å› ä¸ºå‡½æ•° buf å®é™…ä¸Šæ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå®ƒæŒ‡å‘å±€éƒ¨å˜é‡ã€‚</p>
<p>å¹¶ä¸”å®ƒçš„ç±»å‹æ˜¯ <code>const char *</code>ï¼Œå½“æˆ‘ä»¬æŠŠå®ƒä¼ é€’ç»™ <code>string</code> æ—¶ï¼Œä¼šæ‰§è¡Œä¸€ä¸ªéšå¼ç±»å‹è½¬æ¢ã€‚</p>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬æ— æ³•ç¡®ä¿éšå¼ç±»å‹è½¬æ¢ä¸ thread ä¼ é€’å‚æ•°æ—¶è¿›è¡Œ copy çš„æ‰§è¡Œé¡ºåºé—®é¢˜ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ‰å¯èƒ½ä¼ é€’ç»™ string çš„äº‹è½¬æ¢å‰çš„å˜é‡ï¼ˆbuf åªæƒ³çš„æŒ‡é’ˆï¼‰</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span> i, string <span class="type">const</span> &amp;s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;int: &quot;</span> &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;string: &quot;</span> &lt;&lt; s &lt;&lt; endl; <span class="comment">// string s will chaos</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">1024</span>;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;value = %i&quot;</span>, value);</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(f, value, buf)</span></span>;</span><br><span class="line">    t.<span class="built_in">detach</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func end&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">func</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So, the solution is easy, explicit call type convention</p>
<p><code>thread t(f, value, string(buf));</code></p>
<hr>
<p>But, sometimes, we actually want to pass by refernece, the solution is use <code>std::ref</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span> &amp;i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;thread: &quot;</span> &lt;&lt; &amp;i &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">1024</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func: &quot;</span> &lt;&lt; &amp;value &lt;&lt; endl;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(f, ref(value))</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func end&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">func</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Also, you can pass class funtion and itâ€™s this object</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">X</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">do_work</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;val: &quot;</span> &lt;&lt; val &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    X x;</span><br><span class="line">    x.val = <span class="number">10</span>;</span><br><span class="line">    <span class="comment">// pass pointer </span></span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(&amp;X::do_work, &amp;x)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func end&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">func</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p>But, for some type, the operator assignment or operator copy is deleted, like <code>unique_ptr&lt;&gt;</code>, so should <code>move</code> but copy.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(unique_ptr&lt;<span class="type">int</span>&gt; q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;value: &quot;</span> &lt;&lt; *q &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">unique_ptr&lt;<span class="type">int</span>&gt; <span class="title">q</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">1024</span>))</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(f, move(q))</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func() end&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">func</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It would CE If you not use <code>std::move</code>.</p>
<blockquote>
<p>Thread cant copt too.</p>
</blockquote>
<h3 id="2-3-transfer-possessiveness"><a href="#2-3-transfer-possessiveness" class="headerlink" title="2.3 transfer possessiveness"></a>2.3 transfer possessiveness</h3><h4 id="2-3-1-preface"><a href="#2-3-1-preface" class="headerlink" title="2.3.1 preface"></a>2.3.1 preface</h4><p>ä½ ä¸èƒ½é€šè¿‡èµ‹æ–°å€¼æ“ä½œæ¥â€œä¸¢å¼ƒâ€ä¸€ä¸ªçº¿ç¨‹ï¼Œå³ï¼šä½ ä¸èƒ½å°†ä¸€ä¸ªçº¿ç¨‹ move åˆ°ä¸€ä¸ªå·²ç»åˆ†é…äº†ä»»åŠ¡çš„çº¿ç¨‹ã€‚</p>
<p>ä½ ä¹Ÿä¸å¯ä»¥å°†ä¸€ä¸ªçº¿ç¨‹ copy åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä½ å¯ä»¥å°†ä¸€ä¸ªçº¿ç¨‹ move åˆ°å¦ä¸€ä¸ªç©ºçº¿ç¨‹ã€‚</p>
<p>å¯¹äºä¸‹é¢çš„å½¢å¼ï¼ˆ1ï¼‰æ˜¯åˆæ³•çš„ï¼Œå› ä¸º <code>thread(f)</code> æ˜¯ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ â€“ ç§»åŠ¨æ“ä½œä¼šéšå¼çš„è°ƒç”¨ï¼Œå¦‚æœæ˜¯ä¸€ä¸ª <code>å…·åå¯¹è±¡</code>ï¼Œ å°±éœ€è¦æ˜¾ç¤ºçš„è°ƒç”¨ <code>move</code>ï¼Œå¦‚ (2) æ‰€ç¤ºã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span></span>;</span><br><span class="line">thread t;</span><br><span class="line">t = <span class="built_in">thread</span>(f); <span class="comment">// (1)</span></span><br><span class="line">thread t2 = <span class="built_in">move</span>(f); <span class="comment">// (2)</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¯¹äº (3) æ‰€ç¤ºå°±ä¼š CEï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">thread t;</span><br><span class="line">t = <span class="built_in">thread</span>(f);</span><br><span class="line">thread t2 = <span class="built_in">move</span>(t);</span><br><span class="line">t = <span class="built_in">thread</span>(f);</span><br><span class="line">t2 = <span class="built_in">move</span>(t);   <span class="comment">// (3) t2 å·²ç»è¢«åˆ†é…</span></span><br><span class="line">t2.<span class="built_in">join</span>();</span><br></pre></td></tr></table></figure>



<h4 id="2-3-2-scoped-thread"><a href="#2-3-2-scoped-thread" class="headerlink" title="2.3.2 scoped_thread"></a>2.3.2 scoped_thread</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">thread_guard</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">func</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*===========================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">scoped_thread</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">scoped_thread</span><span class="params">(std::thread <span class="type">_t</span>)</span> </span></span><br><span class="line"><span class="function">        : t(std::move(_t)) </span></span><br><span class="line"><span class="function">    &#123;</span></span><br><span class="line">        <span class="keyword">if</span>(!t.<span class="built_in">joinable</span>())</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;No thread!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">scoped_thread</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        t.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">scoped_thread</span>(<span class="type">const</span> scoped_thread&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    scoped_thread&amp; <span class="keyword">operator</span>=(<span class="type">const</span> scoped_thread&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    thread t;   <span class="comment">// ä¸èƒ½æ˜¯å¼•ç”¨</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> local_value = <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">// ä¸‹é¢è¯å¤šåŠ ä¸€å¯¹æ‹¬å·ï¼Œå¦åˆ™ä¼šè¢«è®¤å®šä¸ºå‡½æ•°çš„å£°æ˜</span></span><br><span class="line">    <span class="comment">// é€šè¿‡ moveï¼Œæˆ‘ä»¬å°±æ— éœ€åˆ›å»ºå…·åå¯¹è±¡æ¥åˆ›å»º thread</span></span><br><span class="line">    <span class="function">scoped_thread <span class="title">t</span><span class="params">((std::thread(func(local_value))))</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;func() end&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç–‘é—®ï¼Ÿ</p>
<p>ä¸ºå•¥ä¸æŠŠ ctor é‡Œçš„ t è®¾ç½®ä¸ºå³å€¼å¼•ç”¨å‘¢ï¼Ÿ</p>
</blockquote>
<h4 id="2-3-3-jpthread"><a href="#2-3-3-jpthread" class="headerlink" title="2.3.3 jpthread"></a>2.3.3 jpthread</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">thread_guard</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">scoped_thread</span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">func</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*===========================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">joining_thread</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">joining_thread</span>() <span class="keyword">noexcept</span> = <span class="keyword">default</span>; <span class="comment">// ??</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Callable, <span class="keyword">typename</span> ...Args&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">explicit</span> <span class="title">joining_thread</span><span class="params">(Callable &amp;&amp;func, Args&amp;&amp; ...args)</span></span></span><br><span class="line"><span class="function">        :t(std::forward&lt;Callable&gt;(func), std::forward&lt;Args&gt;(args) ...) // ???</span></span><br><span class="line"><span class="function">        &#123;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">joining_thread</span>(joining_thread &amp;&amp;other) <span class="keyword">noexcept</span></span><br><span class="line">        : <span class="built_in">t</span>(std::<span class="built_in">move</span>(other.t))</span><br><span class="line">        &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">joining_thread</span>(thread <span class="type">_t</span>) <span class="keyword">noexcept</span></span><br><span class="line">        : <span class="built_in">t</span>(std::<span class="built_in">move</span>(<span class="type">_t</span>))</span><br><span class="line">        &#123;&#125;</span><br><span class="line"></span><br><span class="line">    joining_thread&amp; <span class="keyword">operator</span>=(joining_thread &amp;&amp;other) <span class="keyword">noexcept</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">joinable</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">join</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        t = std::<span class="built_in">move</span>(other.t);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºå•¥ä¸æ˜¯ thread &amp;&amp;t</span></span><br><span class="line">    joining_thread&amp; <span class="keyword">operator</span>=(thread t) <span class="keyword">noexcept</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">joinable</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">join</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        t = std::<span class="built_in">move</span>(t);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">joining_thread</span>() <span class="keyword">noexcept</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">joinable</span>())</span><br><span class="line">            <span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(joining_thread &amp;other)</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        t.<span class="built_in">swap</span>(other.t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::<span class="function">thread::id <span class="title">get_id</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.<span class="built_in">get_id</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">joinable</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.<span class="built_in">joinable</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">join</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.<span class="built_in">join</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">detach</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        t.<span class="built_in">detach</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">const</span> std::thread&amp; <span class="title">as_thread</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::thread&amp; <span class="title">as_thread</span><span class="params">()</span> <span class="keyword">noexcept</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// å°† const thread&amp; çš„ const å±æ€§å»æ‰</span></span><br><span class="line">        <span class="comment">// å»æ‰ const å±æ€§å¿…é¡»ç”¨ const_cast</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;thread&amp;&gt;(</span><br><span class="line">            <span class="comment">// å°† &amp;this è½¬æ¢ä¸º const ç±»å‹</span></span><br><span class="line">            <span class="comment">// åŠ ä¸Š const å±æ€§ç”¨ static_cast</span></span><br><span class="line">            <span class="built_in">static_cast</span>&lt;<span class="type">const</span> joining_thread&amp;&gt;(*<span class="keyword">this</span>).<span class="built_in">as_thread</span>()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::thread t;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ç–‘é—®ï¼Ÿ</p>
<p>ä¸ºå•¥ä¸æŠŠ ctor ä¸­çš„ <code>thread t</code> æ”¹ä¸º <code>thread &amp;&amp;t</code> å‘¢ï¼Ÿ</p>
</blockquote>
<h3 id="2-4-determin-count-of-thread"><a href="#2-4-determin-count-of-thread" class="headerlink" title="2.4 determin count of thread"></a>2.4 determin count of thread</h3><p><code>thread::hardware_concurrency()</code> ï¼šè¿”å›å¹¶å‘çº¿ç¨‹çš„æ•°é‡ã€‚</p>
<p>å¹¶è¡Œç‰ˆçš„ <code>std::accumulate</code></p>
<blockquote>
<p>å› ä¸ºæ•°æ®èŒƒå›´å¹¶ä¸å¤§ï¼Œå› æ­¤å¾—å‡ºçš„æ—¶é—´æ¶ˆè€—æ„ä¹‰ä¸å¤§ï¼</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*===========================*/</span></span><br><span class="line"><span class="comment">/*      std::accumulate      */</span></span><br><span class="line"><span class="comment">/*    concurrency version    */</span></span><br><span class="line"><span class="comment">/*===========================*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// just the warpped function of std::accumulate</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Iterator, <span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">accumulate_block</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(Iterator first, Iterator last, T&amp; result)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        result = std::<span class="built_in">accumulate</span>(first, last, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Iterator, <span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function">T <span class="title">parallel_accumulate</span><span class="params">(Iterator first, Iterator last, T init)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="type">cul_t</span> = <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span>;</span><br><span class="line">    <span class="keyword">using</span> <span class="type">ul_t</span> = <span class="type">unsigned</span> <span class="type">long</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">cul_t</span> length = std::<span class="built_in">distance</span>(first, last);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// special check</span></span><br><span class="line">    <span class="keyword">if</span>(!length)</span><br><span class="line">        <span class="keyword">return</span> init;</span><br><span class="line"></span><br><span class="line">    <span class="type">cul_t</span> min_pre_thread = <span class="number">25</span>; <span class="comment">// ä¸€ä¸ªçº¿ç¨‹è‡³å°‘å¤„ç† 25 ä¸ªä»»åŠ¡</span></span><br><span class="line">    <span class="comment">// æœ€å¤§çº¿ç¨‹æ•°ä¸ºï¼šä»»åŠ¡æ€»æ•° / æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„ä»»åŠ¡æ•°é‡ï¼Œä¸Šå–æ•´</span></span><br><span class="line">    <span class="type">cul_t</span> max_threads = (length + min_pre_thread - <span class="number">1</span>) / min_pre_thread;</span><br><span class="line">    </span><br><span class="line">    <span class="type">cul_t</span> hardware_thread = std::thread::<span class="built_in">hardware_concurrency</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å› ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢çš„æˆæœ¬ä¹Ÿå¾ˆé«˜ï¼Œå› æ­¤å’Œç³»ç»ŸçœŸæ­£çš„å¹¶å‘é‡å– min</span></span><br><span class="line">    <span class="type">cul_t</span> num_threads = std::<span class="built_in">min</span>(hardware_thread != <span class="number">0</span> ? hardware_thread : <span class="number">2</span>, max_threads);</span><br><span class="line">    <span class="comment">// æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªä»»åŠ¡å—</span></span><br><span class="line">    <span class="type">cul_t</span> block_size = length / num_threads;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::vector&lt;T&gt; <span class="title">results</span><span class="params">(num_threads)</span></span>; <span class="comment">// result[num_threads-1] uesed to save finally result</span></span><br><span class="line">    <span class="function">std::vector&lt;std::thread&gt; <span class="title">threads</span><span class="params">(num_threads - <span class="number">1</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ†å— </span></span><br><span class="line">    Iterator block_start = first;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">ul_t</span> i = <span class="number">0</span>; i &lt; num_threads - <span class="number">1</span>; ++ i )</span><br><span class="line">    &#123;</span><br><span class="line">        Iterator block_end = block_start;</span><br><span class="line">        std::<span class="built_in">advance</span>(block_end, block_size);</span><br><span class="line">        threads[i] = std::<span class="built_in">thread</span>(</span><br><span class="line">            <span class="built_in">accumulate_block</span>&lt;Iterator, T&gt;(),</span><br><span class="line">            block_start, block_end, std::<span class="built_in">ref</span>(results[i])</span><br><span class="line">        );</span><br><span class="line">        block_start = block_end;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æœ€ç»ˆå¯èƒ½ä¸æ»¡ä¸€ä¸ªæ•´å—ï¼Œå³å¯èƒ½ä¸èƒ½åˆ‡å¥½åˆ†ä¸ºä¸€ä¸ªå—</span></span><br><span class="line">    <span class="built_in">accumulate_block</span>&lt;Iterator, T&gt;()(</span><br><span class="line">        block_start, last, results[num_threads - <span class="number">1</span>]</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»Ÿè®¡æœ€ç»ˆç»“æœ</span></span><br><span class="line">    for_each(threads.<span class="built_in">begin</span>(), threads.<span class="built_in">end</span>(), <span class="built_in">mem_fn</span>(&amp;thread::join));</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">accumulate</span>(results.<span class="built_in">begin</span>(), results.<span class="built_in">end</span>(), init);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">using</span> ull = <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>;</span><br><span class="line">    vector&lt;ull&gt; num;</span><br><span class="line">    ull sum;</span><br><span class="line">    <span class="type">clock_t</span> cur;</span><br><span class="line">    <span class="type">const</span> ull MAX_REP = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">for</span>(ull i = <span class="number">0</span>; i &lt; MAX_REP; i ++ )</span><br><span class="line">        num.<span class="built_in">push_back</span>(i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// test std::accumulate</span></span><br><span class="line">    cur = <span class="built_in">clock</span>();</span><br><span class="line">    sum = <span class="built_in">accumulate</span>(num.<span class="built_in">begin</span>(), num.<span class="built_in">end</span>(), (ull)<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;time = %.4lf\n&quot;</span>, (<span class="built_in">clock</span>()-cur) * <span class="number">1.0</span> / CLOCKS_PER_SEC);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;sum: &quot;</span> &lt;&lt; sum &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// test concurrency accumulate</span></span><br><span class="line">    cur = <span class="built_in">clock</span>();</span><br><span class="line">    sum = <span class="built_in">parallel_accumulate</span>(num.<span class="built_in">begin</span>(), num.<span class="built_in">end</span>(), (ull)<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;time = %.4lf\n&quot;</span>, (<span class="built_in">clock</span>()-cur) * <span class="number">1.0</span> / CLOCKS_PER_SEC);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;sum: &quot;</span> &lt;&lt; sum &lt;&lt; endl;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="2-5-thread-id"><a href="#2-5-thread-id" class="headerlink" title="2.5 thread id"></a>2.5 thread id</h3><p><code>thread::get_id()</code>ï¼šå¦‚æœçº¿ç¨‹æ²¡æœ‰æ‰§è¡Œï¼Œä¼šæ‰“å°ï¼š<code>thread::id of a non-executing thread</code></p>
<p><code>this_thread::get_id()</code> ï¼š è¿”å›å½“å‰çº¿ç¨‹çš„ id</p>
<p>çº¿ç¨‹æ ‡è¯†ç¬¦å¯ä»¥ç”¨æ¥æ¯”è¾ƒï¼Œæ’åºï¼Œå“ˆå¸Œç­‰ã€‚</p>
<p>é€šè¿‡çº¿ç¨‹æ ‡è¯†ç¬¦å¯ä»¥å®ç°ä¸åŒçš„çº¿ç¨‹æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚</p>
<p><code>get_id()</code> çš„è¾“å‡ºæ˜¯ä¾èµ–äºå®ç°çš„ï¼Œä½†æ˜¯C++ æ ‡å‡†è§„å®šç›¸åŒ ID çš„çº¿ç¨‹å¿…é¡»æœ‰ç›¸åŒçš„è¾“å‡ºã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*======================*/</span></span><br><span class="line"></span><br><span class="line">thread::id master_thread_id;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fun</span><span class="params">(<span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(this_thread::<span class="built_in">get_id</span>() == master_thread_id)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;I am master&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;I am slaver&quot;</span> &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; id &lt;&lt; <span class="string">&quot;]&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    vector&lt;thread&gt; threads;</span><br><span class="line">    <span class="comment">// create master</span></span><br><span class="line">    <span class="function">thread <span class="title">master</span><span class="params">(fun, <span class="number">0</span>)</span></span>;</span><br><span class="line">    master_thread_id = master.<span class="built_in">get_id</span>();</span><br><span class="line">    threads.<span class="built_in">push_back</span>(<span class="built_in">move</span>(master));    <span class="comment">// must add move!</span></span><br><span class="line">    <span class="comment">// create slaver</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i ++ )    threads.<span class="built_in">push_back</span>(<span class="built_in">thread</span>(fun, i + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// join</span></span><br><span class="line">    for_each(threads.<span class="built_in">begin</span>(), threads.<span class="built_in">end</span>(), <span class="built_in">mem_fn</span>(&amp;thread::join));</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="P3-data-share"><a href="#P3-data-share" class="headerlink" title="P3 data share"></a>P3 data share</h2><h3 id="3-1-problems"><a href="#3-1-problems" class="headerlink" title="3.1 problems"></a>3.1 problems</h3><h4 id="3-1-1-race-condition"><a href="#3-1-1-race-condition" class="headerlink" title="3.1.1 race condition"></a>3.1.1 race condition</h4><p>æ¡ä»¶ç«äº‰åˆ†ä¸ºæ¶æ€§æ¡ä»¶ç«äº‰å’Œè‰¯æ€§æ¡ä»¶ç«äº‰ï¼Œè‰¯æ€§æ¡ä»¶ç«äº‰ä¸ä¼šå¯¹ç³»ç»Ÿæœ‰ä»€ä¹ˆå½±å“ã€‚</p>
<p>é¿å…æ¶æ€§æ¡ä»¶ç«äº‰çš„æ–¹æ³•ï¼š</p>
<ol>
<li>å¯¹æ•°æ®ç»“æ„é‡‡ç”¨æŸç§ä¿æŠ¤æœºåˆ¶ï¼Œä¾‹å¦‚ï¼šmutex</li>
<li>æ— é”æ•°æ®ç»“æ„</li>
<li>äº‹åŠ¡</li>
</ol>
<h4 id="3-1-2-use-mutex-to-avoid-RC"><a href="#3-1-2-use-mutex-to-avoid-RC" class="headerlink" title="3.1.2 use mutex to avoid RC"></a>3.1.2 use mutex to avoid RC</h4><p>C++ ä¸ºæˆ‘ä»¬æä¾›äº†äº’æ–¥é‡ç”¨æ¥é¿å…æ¶æ€§æ¡ä»¶ç«äº‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ä¾‹åŒ– <code>std::mutex</code> åˆ›å»ºäº’æ–¥é‡ï¼Œå¹¶é€šè¿‡ <code>lock()</code> å’Œ <code>unlock()</code> è¿›è¡Œä¸Šé”å’Œè§£é”ï¼Œä½†å¹¶ä¸æ¨èä½ è¿™ä¹ˆåšï¼Œè®¤ä¸ºäººæ€»ä¼šçŠ¯é”™ ğŸ˜­</p>
<p>æ‰€ä»¥ï¼Œç±»ä¼¼æ™ºèƒ½æŒ‡é’ˆï¼ŒC++ æ ‡å‡†åº“ä¸ºäº’æ–¥é‡æä¾›äº†ä¸€ä¸ª RAII è¯­æ³•çš„æ¨¡æ¿ç±» <code>std::lock_guard</code>ï¼Œå…¶ä¼šåœ¨æ„é€ çš„æ—¶å€™è‡ªåŠ¨ä¸Šé”ï¼Œå¹¶åœ¨ææ„çš„æ—¶å€™è‡ªåŠ¨è§£é”ã€‚</p>
<p>ä»–ä»¬éƒ½åœ¨ <code>&lt;mutex&gt;</code> å¤´æ–‡ä»¶å½“ä¸­ã€‚</p>
<p>ç¤ºä¾‹ç¨‹åºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*===========================*/</span></span><br><span class="line"></span><br><span class="line">list&lt;<span class="type">int</span>&gt; L; <span class="comment">// shared data</span></span><br><span class="line">mutex m;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_to_list</span><span class="params">(<span class="type">int</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">guard</span><span class="params">(m)</span></span>;</span><br><span class="line">    L.<span class="built_in">push_back</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">list_contains</span><span class="params">(<span class="type">int</span> value_to_find)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">lock_guard&lt;mutex&gt; <span class="title">guard</span><span class="params">(m)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">find</span>(L.<span class="built_in">begin</span>(), L.<span class="built_in">end</span>(), value_to_find) != L.<span class="built_in">end</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ )    L.<span class="built_in">push_back</span>(i);</span><br><span class="line">    cout &lt;&lt; <span class="built_in">list_contains</span>(<span class="number">3</span>) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†äº’æ–¥é‡ä¹Ÿä¸æ€»æ˜¯å®‰å…¨çš„ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä¸€ä¸ªç±»ä¸­è¿”å›äº†è¢«ä¿æŠ¤æ•°æ®çš„æŒ‡é’ˆæˆ–å¼•ç”¨æ—¶ï¼Œä¼šç ´åå¯¹æ•°æ®çš„ä¿æŠ¤ï¼Œå¹¶ä¸”ä¸ä¼šè¢«äº’æ–¥é”é™åˆ¶ã€‚</p>
<p>å› æ­¤ï¼Œå¯¹æ¥å£çš„è®¾è®¡éœ€è¦ç›¸å½“è°¨æ…ï¼Œè¦ç¡®ä¿äº’æ–¥é‡èƒ½é”ä½ä»»ä½•å¯¹ä¿æŠ¤æ•°æ®çš„è®¿é—®ï¼Œå¹¶ä¸”â€œä¸ç•™åé—¨â€ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„ç¨‹åºå½“ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¼•ç”¨æŠŠè¢«ä¿æŠ¤æ•°æ®ä¼ é€’åˆ°äº’æ–¥é”ä½œç”¨äºä¹‹å¤–ï¼Œä»è€Œé€ æˆä¸€ä¸ªæ½œåœ¨çš„é™·é˜±ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*===========================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">some_data</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    string b;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">do_something</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;You are a fool manğŸ˜„...\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">data_wrapper</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    some_data data;</span><br><span class="line">    std::mutex m;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Function&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">process_data</span><span class="params">(Function func)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">lock_guard&lt;mutex&gt; <span class="title">l</span><span class="params">(m)</span></span>;</span><br><span class="line">        <span class="built_in">func</span>(data); <span class="comment">// ä¼ é€’â€œä¿æŠ¤â€æ•°æ®ç»™ç”¨æˆ·å‡½æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">some_data *unprotected;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">malicious_function</span><span class="params">(some_data&amp; protected_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    unprotected = &amp;protected_data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data_wrapper x;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    x.<span class="built_in">process_data</span>(malicious_function);</span><br><span class="line">    <span class="comment">// ç°åœ¨ï¼Œæˆ‘ä¹ˆå°†ä¸€ä¸ªè¢«ä¿æŠ¤çš„æ•°æ®æ‹¿å‡ºæ¥äº†ï¼Œå¹¶ä¸”å¯ä»¥éšæ„å¤„ç†</span></span><br><span class="line">    unprotected-&gt;<span class="built_in">do_something</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">Foo</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="3-2-mutex"><a href="#3-2-mutex" class="headerlink" title="3.2 mutex"></a>3.2 mutex</h3><h4 id="3-2-1-RC-between-interface"><a href="#3-2-1-RC-between-interface" class="headerlink" title="3.2.1 RC between interface"></a>3.2.1 RC between interface</h4><p>ä½¿ç”¨äº’æ–¥é‡å¯¹æ•°æ®è¿›è¡Œä¿æŠ¤å¹¶ä¸èƒ½ä¸‡äº‹å¤§å‰ã€‚</p>
<p>ä¾‹ä¸€ï¼šåˆ é™¤åŒé“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹</p>
<blockquote>
<p>å½“æˆ‘ä»¬è¦åˆ é™¤åŒé“¾è¡¨ä¸­çš„èŠ‚ç‚¹ <code>P</code> æ—¶ï¼Œä»…ä»…å¯¹ P æ·»åŠ äº’æ–¥é‡æ˜¯ä¸è¡Œçš„ï¼Œè¿˜éœ€è¦å¯¹ <code>P-&gt;next</code>, <code>P-&gt;prev</code> åŒæ—¶æ·»åŠ äº’æ–¥é”ã€‚</p>
</blockquote>
<p>ä¾‹äºŒï¼šå †æ ˆ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stack&lt;<span class="type">int</span>&gt; s;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!s.<span class="built_in">empty</span>()) <span class="comment">// (1)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> value = s.<span class="built_in">top</span>(); <span class="comment">// (2)</span></span><br><span class="line">        s.<span class="built_in">pop</span>();             <span class="comment">// (3)</span></span><br><span class="line">        <span class="built_in">do_something</span>(value); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œå½“å †æ ˆéç©ºæ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ä»ä¸­å–å‡ºæ ˆé¡¶ç´ ï¼Œå†è°ƒç”¨ <code>pop()</code>ï¼Œä½†å…¶å® (1) å’Œ (2) ä¹‹é—´æ˜¯æœ‰ç«äº‰æ¡ä»¶çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯èƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹åœ¨ (1) ä¸ (2) ä¹‹é—´ä¹Ÿæ‰ç”¨äº† <code>pop()</code>ã€‚</p>
<p>å¦ä¸€ä¸ªæ½œåœ¨çš„ç«äº‰æ¡ä»¶å‘æ­£åœ¨ (2) å’Œ (3) ä¹‹é—´ï¼Œå¯èƒ½æœ‰ä¸¤ä¸ªçº¿ç¨‹å…ˆåæ‰§è¡Œäº† <code>top()</code>ï¼Œä½†æ²¡æœ‰æ‰§è¡Œ <code>pop()</code>ï¼Œæ­¤æ—¶ä¸¤ä¸ªçº¿ç¨‹å¤„ç†å <code>value</code> çš„å€¼å¯èƒ½æ˜¯ç›¸åŒçš„ï¼Œè¿™ç§é”™è¯¯å¾ˆéš¾å®šä½ï¼Œå› ä¸ºç¨‹åºæ²¡æœ‰å‡ºé”™ï¼Œå‡ºé”™çš„æ˜¯ä½ çš„é€»è¾‘ã€‚</p>
<blockquote>
<p>è¿™å°±éœ€è¦æ¥å£è®¾è®¡ä¸Šæœ‰è¾ƒå¤§çš„æ”¹åŠ¨ï¼Œæè®®ä¹‹ä¸€å°±æ˜¯ä½¿ç”¨åŒä¸€äº’æ–¥é‡æ¥ä¿æŠ¤ top()å’Œ pop()ã€‚Tom Cargill[1]æŒ‡å‡ºå½“ä¸€ä¸ªå¯¹è±¡çš„æ‹·è´æ„é€ å‡½æ•°åœ¨æ ˆä¸­æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼å°±ä¼šæœ‰é—®é¢˜ã€‚åœ¨ Herb Sutter[2]çœ‹æ¥ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥ä»â€œå¼‚å¸¸å®‰å…¨â€çš„è§’åº¦å®Œç¾è§£å†³ï¼Œä¸è¿‡æ½œåœ¨çš„æ¡ä»¶ç«äº‰ï¼Œå¯èƒ½ä¼šç»„æˆä¸€äº›æ–°çš„ç»„åˆã€‚</p>
</blockquote>
<p>ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„äº‹æƒ…æ˜¯ï¼Œæˆ‘ä»¬å¯èƒ½ä¸å¾—ä¸é¢ä¸´ä¾‹äºŒä¸­çš„ç«äº‰æ¡ä»¶ã€‚åœ¨å †æ ˆçš„ pop æ“ä½œä¸­ï¼ˆæœ‰è¿”å›å€¼ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬ç›´æ¥æŠŠå®¹å™¨å…ƒç´  â€ç§»åŠ¨â€œ åˆ°ç›®æ ‡ä½ç½®ï¼Œå¯èƒ½ä¼šå› ä¸º <code>bad_alloc</code> å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯å†…å­˜ä¸è¶³è€Œå¯¼è‡´æ•°æ®æ²¡æœ‰æ‹·è´å‡ºå»ï¼Œå¹¶ä¸”æ ˆä¸­çš„æ•°æ®ä¹Ÿæ¯ç ´åäº†ã€‚</p>
<p>å› æ­¤ï¼Œè®¾è®¡äººå‘˜é€šå¸¸æŠŠè¿™ä¸ªæ“ä½œæ“ä½œåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>top()</li>
<li>pop()</li>
</ol>
<p>ç”±æ­¤æ¥ç¡®ä¿æ•°æ®ä¸ä¼šåœ¨å†…å­˜ä¸è¶³æ—¶å‡ºé”™ï¼Œä½†æˆ‘ä»¬ä¹‹å‰è®¨è®ºè¿‡äº†ï¼Œåœ¨ 1 å’Œ 2 ä¹‹é—´ï¼Œæœ‰ç«äº‰æ¡ä»¶ã€‚</p>
<p>ä½†å¹¸å¥½ï¼Œæˆ‘ä»¬è¿˜æœ‰å…¶å®ƒé€‰é¡¹ï¼Œå°½ç®¡ä»–ä»¬ä¹Ÿä¸æ˜¯å®Œç¾çš„ã€‚</p>
<p><strong>solution1ï¼šå°†å˜é‡çš„å¼•ç”¨ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥ pop() å‡½æ•°ä¸­å–å¾—æƒ³è¦çš„â€å¼¹å‡ºå€¼â€œ</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">std::stack&lt;std::vector&lt;<span class="type">int</span>&gt;&gt; stk;</span><br><span class="line"><span class="comment">/*------------------------*/</span></span><br><span class="line">std::vector&lt;<span class="type">int</span>&gt; result;</span><br><span class="line">stk.<span class="built_in">pop</span>(result);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ç§æ–¹æ³•æœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼š</p>
<ol>
<li>éœ€è¦æ„é€ å‡ºä¸€ä¸ªæ ˆä¸­ç±»å‹çš„å®ä¾‹ç”¨äºæ¥å—ç›®æ ‡å€¼ï¼Œè¿™ä¼šå¯¼è‡´ç©ºé—´å’Œç©ºé—´çš„é¢å¤–å¼€é”€ç­‰</li>
<li>è¦æ±‚ç±»å‹å¿…é¡»æ”¯æŒèµ‹å€¼æ“ä½œï¼Œå¾ˆå¤šç±»å‹å³ä½¿æ”¯æŒç§»åŠ¨æ„é€ å’Œæ‹·è´æ„é€ ï¼Œå¯èƒ½ä¹Ÿä¸æ”¯æŒèµ‹å€¼</li>
</ol>
</blockquote>
<p><strong>solution2ï¼šæ— å¼‚å¸¸æŠ›å‡ºçš„æ‹·è´æ„é€ å‡½æ•°æˆ–ç§»åŠ¨æ„é€ å‡½æ•°</strong></p>
<p><strong>solution3ï¼šè¿”å›æŒ‡å‘å¼¹å‡ºå€¼çš„æŒ‡é’ˆ</strong></p>
<p><strong>solution4ï¼šâ€œé€‰é¡¹1 + é€‰é¡¹2â€æˆ– â€œé€‰é¡¹1 + é€‰é¡¹3â€</strong></p>
<p><strong>Exampleï¼š thread safe stack</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN test_begin()</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   test_end()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_end</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test_begin</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*===========================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">empty_stack</span> : exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span> * <span class="title">what</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[Error] empty stack!&quot;</span>; <span class="comment">// ä¸è¦æ·»åŠ æ ¼å¼æ§åˆ¶ç¬¦</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadsaft_stack</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadsaft_stack</span>() : <span class="built_in">data</span>(std::<span class="built_in">stack</span>&lt;T&gt;()) &#123;&#125;</span><br><span class="line">    <span class="built_in">threadsaft_stack</span>(<span class="type">const</span> threadsaft_stack &amp;other)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// åœ¨å‡½æ•°ä½“è€Œä¸æ˜¯æˆå‘˜åˆå§‹åŒ–åˆ—è¡¨ä¸­copyå¯ä»¥ç¡®ä¿æ•°æ®çš„æ­£ç¡®æ€§</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(other.m)</span></span>;</span><br><span class="line">        data = other.m;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸æä¾›å¤ªå¤šæ¥å£</span></span><br><span class="line">    threadsaft_stack&amp; <span class="keyword">operator</span>=(<span class="type">const</span> threadsaft_stack &amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T new_value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m)</span></span>;</span><br><span class="line">        data.<span class="built_in">push</span>(new_value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data.<span class="built_in">empty</span>())    <span class="keyword">throw</span> <span class="built_in">empty_stack</span>();    <span class="comment">// æ£€æŸ¥æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨ä¿®æ”¹çš„å †æ ˆå‰ï¼Œåˆ†é…å‡ºè¿”å›å€¼</span></span><br><span class="line">        <span class="function"><span class="type">const</span> std::shared_ptr&lt;T&gt; <span class="title">res</span><span class="params">(std::make_shared&lt;T&gt;(std::make_shared&lt;T&gt;(data.top())))</span></span>;</span><br><span class="line">        data.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pop</span><span class="params">(T &amp;value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data.<span class="built_in">empty</span>())    <span class="keyword">throw</span> <span class="built_in">empty_stack</span>();</span><br><span class="line">        <span class="comment">// æ³¨æ„ä¸‹é¢è°ƒç”¨çš„éƒ½æ˜¯ stack çš„å†…ç½®å‡½æ•°</span></span><br><span class="line">        value = data.<span class="built_in">top</span>();</span><br><span class="line">        data.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> data.<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::stack&lt;T&gt; data;</span><br><span class="line">    std::mutex m;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    threadsaft_stack&lt;<span class="type">int</span>&gt; s;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i ++ )  s.<span class="built_in">push</span>(i);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;push done&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="type">int</span> x;</span><br><span class="line">    s.<span class="built_in">pop</span>(x);</span><br><span class="line">    cout &lt;&lt; x &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    <span class="built_in">Foo</span>();</span><br><span class="line">    <span class="comment">/*======================*/</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å…¶å®æœ¬è´¨ä¸Šå°±æ˜¯å°†åŸæœ¬çš„ä¸¤ä¸ªå‡½æ•°ï¼ˆtop å’Œ popï¼‰å®ç°çš„æ“ä½œé›†æˆåˆ°ä¸€ä¸ªå‡½æ•°ï¼ˆpopï¼‰å½“ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡äº’æ–¥é‡å®Œæˆæ•°æ®çš„ä¿æŠ¤ã€‚</p>
<p>é€šè¿‡ä¸€ä¸ªå‡½æ•°ä¿®æ”¹æˆ‘ä»¬çš„å‚æ•°ï¼Œå¾ˆè‡ªç„¶çš„æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯è¿”å›å€¼ï¼Œè€Œæ˜¯ä¼ å¼•ç”¨ã€‚</p>
<p>åœ¨è¿”å›å€¼è¿™ç§æ–¹å¼ä¸­ï¼Œreturn ä¸€ä¸ªå¼•ç”¨æ˜¯å±é™©çš„ï¼Œè¿™æˆ‘ä»¬å‰é¢æåˆ°è¿‡ã€‚ç›´æ¥ return å€¼çš„è¯å¼€é”€å¯èƒ½å¾ˆå¤§ï¼Œå› æ­¤æˆ‘ä»¬è€ƒè™‘ä¼ å‡ºä¸€ä¸ªåŠ¨æ€å¯¹è±¡ï¼Œè€Œæ‰‹åŠ¨ new&#x2F;delete ä¸å®‰å…¨ï¼Œå› æ­¤ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆã€‚</p>
</blockquote>
<h4 id="3-2-2-deadlock"><a href="#3-2-2-deadlock" class="headerlink" title="3.2.2 deadlock"></a>3.2.2 deadlock</h4><p>é¿å…æ­»é”çš„æ–¹æ³•ï¼š</p>
<ol>
<li>æŒ‡å®šè·å¾—é”çš„é¡ºåº</li>
<li>ä¸€æ¬¡æ€§åŠ å…¨éƒ¨é”</li>
<li>â€¦</li>
</ol>
<p>C++ æ ‡å‡†åº“çš„ <code>std::lock</code> å¯ä»¥ä¸€æ¬¡æ€§é”ä½å¤šä¸ªäº’æ–¥é‡å¹¶ä¸”æ²¡æœ‰æ­»é”é£é™©ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">bank_account</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">bank_account</span><span class="params">(<span class="type">int</span> _balance)</span> : balance(_balance) &#123;</span>&#125;</span><br><span class="line">    <span class="type">int</span> balance;</span><br><span class="line">    std::mutex m;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">less_amount</span> : std::exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">what</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Too little money in your amount ^ ^ !&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">transfer</span><span class="params">(bank_account &amp;from, bank_account &amp;to, <span class="type">int</span> amount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(&amp;from == &amp;to)    <span class="keyword">return</span> ;</span><br><span class="line">    <span class="keyword">if</span>(from.balance &lt; amount)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span>(<span class="built_in">less_amount</span>());</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::<span class="built_in">lock</span>(from.m, to.m);</span><br><span class="line">    <span class="function">std::lock_guard <span class="title">lock1</span><span class="params">(from.m, std::adopt_lock)</span></span>;</span><br><span class="line">    <span class="function">std::lock_guard <span class="title">lock2</span><span class="params">(to.m, std::adopt_lock)</span></span>;</span><br><span class="line"></span><br><span class="line">    from.balance -= amount;</span><br><span class="line">    to.balance += amount;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">bank_account <span class="title">my_account</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    <span class="function">bank_account <span class="title">your_account</span><span class="params">(<span class="number">50</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(transfer, std::ref(my_account), std::ref(your_account), <span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(transfer, std::ref(your_account), std::ref(my_account), <span class="number">5</span>)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t3</span><span class="params">(transfer, std::ref(my_account), std::ref(my_account), <span class="number">100</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    t3.<span class="built_in">join</span>();</span><br><span class="line">    </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;my_account.balance = &quot;</span> &lt;&lt; my_account.balance &lt;&lt; <span class="string">&quot;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;your_account.balance = &quot;</span> &lt;&lt; your_account.balance &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶è§„å®šä¸€ä¸ªè·å¾—é”çš„é¡ºåºå¯ä»¥é¿å…æ­»é”ï¼Œä½†ä»–ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œç”šè‡³è¯´ï¼Œä¼šèµ·åˆ°é€‚å¾—å…¶åçš„æ•ˆæœï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">bank_account</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">bank_account</span><span class="params">(<span class="type">int</span> _balance)</span> : balance(_balance) &#123;</span>&#125;</span><br><span class="line">    <span class="type">int</span> balance;</span><br><span class="line">    std::mutex m;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">less_amount</span> : std::exception</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">const</span> <span class="type">char</span>* <span class="title">what</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Too little money in your amount ^ ^ !&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bank_swap</span><span class="params">(bank_account &amp;from, bank_account &amp;to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(&amp;from == &amp;to)    <span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// std::lock(from.m, to.m);</span></span><br><span class="line">    from.m.<span class="built_in">lock</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;I get From, balance: &quot;</span> &lt;&lt; from.balance &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">5</span>);   </span><br><span class="line">    </span><br><span class="line">    to.m.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function">std::lock_guard <span class="title">lock1</span><span class="params">(from.m, std::adopt_lock)</span></span>;</span><br><span class="line">    <span class="function">std::lock_guard <span class="title">lock2</span><span class="params">(to.m, std::adopt_lock)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">swap</span>(from.balance, to.balance);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">bank_account <span class="title">my_account</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">    <span class="function">bank_account <span class="title">your_account</span><span class="params">(<span class="number">50</span>)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(bank_swap, std::ref(my_account), std::ref(your_account))</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(bank_swap, std::ref(your_account), std::ref(my_account))</span></span>;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;my_account.balance = &quot;</span> &lt;&lt; my_account.balance &lt;&lt; <span class="string">&quot;\n&quot;</span></span><br><span class="line">                <span class="string">&quot;your_account.balance = &quot;</span> &lt;&lt; your_account.balance &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è™½ç„¶åœ¨ <code>swap()</code> ä¸­è§„å®šäº†è·å¾—é”çš„é¡ºåºï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬äº¤æ¢äº† <code>swap()</code> çš„å‚æ•°é¡ºåºï¼Œé‚£ä¹ˆç»“æœå°±å¾ˆå¯æ€•äº†ï¼</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/lock_tag">std::defer_lock, std::try_to_lock, std::adopt_lock</a></p>
<table>
<thead>
<tr>
<th><code>defer_lock_t</code></th>
<th>ä¸è·å¾—äº’æ–¥çš„æ‰€æœ‰æƒ</th>
</tr>
</thead>
<tbody><tr>
<td>try_to_lock_t</td>
<td>å°è¯•è·å¾—äº’æ–¥çš„æ‰€æœ‰æƒè€Œä¸é˜»å¡</td>
</tr>
<tr>
<td>adopt_lock_t</td>
<td>å‡è®¾è°ƒç”¨æ–¹çº¿ç¨‹å·²æ‹¥æœ‰äº’æ–¥çš„æ‰€æœ‰æƒ</td>
</tr>
</tbody></table>
</blockquote>
<p><strong>Advise to avoid deadlockï¼š</strong></p>
<ol>
<li>é¿å…åµŒå¥—é”ï¼Œå°½é‡åªä½¿ç”¨ä¸€ä¸ªé”</li>
<li>é¿å…åœ¨æŒæœ‰é”æ—¶è°ƒç”¨ç”¨æˆ·æä¾›çš„ä»£ç </li>
<li>ä½¿ç”¨å›ºå®šé¡ºåºè·å–é”</li>
<li>ä½¿ç”¨å±‚çº§é”</li>
</ol>
<h4 id="3-2-3-hierarchical-mutex"><a href="#3-2-3-hierarchical-mutex" class="headerlink" title="3.2.3 hierarchical_mutex"></a>3.2.3 hierarchical_mutex</h4><blockquote>
<p> <a target="_blank" rel="noopener" href="https://mysteriouspreserve.com/blog/2021/09/15/Hierarchical-Mutex/">reference</a></p>
</blockquote>
<p>å±‚çº§é”çš„æ„ä¹‰åœ¨äºï¼šåœ¨è¿è¡Œæ—¶çº¦å®šæ˜¯å¦è¿›è¡Œæ£€æŸ¥ï¼Œè¿™ä¸ªå»ºè®®éœ€è¦å¯¹åº”ç”¨å±‚è¿›è¡Œåˆ†å±‚ï¼Œå¹¶ä¸”è¯†åˆ«åœ¨ç»™å®šå±‚ä¸Šæ‰€æœ‰äº’æ–¥é‡ã€‚</p>
<p>å±‚çº§é”çš„æ ¸å¿ƒå°±æ˜¯ï¼šæ¯ä¸ªäº’æ–¥é‡æœ‰ä¸€ä¸ªå±‚çº§å€¼ï¼Œçº¿ç¨‹åªèƒ½ä»¥å±‚çº§å€¼é€’å‡çš„é¡ºåºè·å–é”ï¼Œç”±æ­¤å®ç°é¡ºåºæ€§ã€‚</p>
<p>**Sample complement: **</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">hierarchical_mutex</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">hierarchical_mutex</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> value)</span></span></span><br><span class="line"><span class="function">        : hierarchichy_value(value), </span></span><br><span class="line"><span class="function">          previous_hierarchichy_value(<span class="number">0</span>)</span></span><br><span class="line"><span class="function">        &#123;</span>&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">check_for_hierarchy_violation</span>();</span><br><span class="line">        internal_mutex.<span class="built_in">lock</span>();</span><br><span class="line">        <span class="comment">// å¤‡ä»½å±‚çº§å€¼</span></span><br><span class="line">        <span class="built_in">update_hierarchy_value</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">unlock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ¢å¤å±‚çº§å€¼</span></span><br><span class="line">        this_thread_hierarchy_value = previous_hierarchichy_value;</span><br><span class="line">        internal_mutex.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">try_lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">check_for_hierarchy_violation</span>();</span><br><span class="line">        <span class="keyword">if</span>(!internal_mutex.<span class="built_in">try_lock</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">update_hierarchy_value</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::mutex internal_mutex;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éœ€è¦æ„é€ çš„é”çš„å±‚çº§å€¼</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">const</span> hierarchichy_value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this_thread_hierarchy_value çš„å¤‡ä»½</span></span><br><span class="line">    <span class="comment">// å› ä¸ºåœ¨ unlock ä¹‹åéœ€è¦æ¢å¤ä¸Šä¸€æ¬¡çš„å€¼</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> previous_hierarchichy_value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰çš„å±‚çº§å€¼ï¼Œç¬¬äºŒä¸ªé”çš„å±‚çº§å€¼å¿…é¡»å°äºè¯¥å€¼</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">thread_local</span> <span class="type">unsigned</span> <span class="type">long</span> this_thread_hierarchy_value; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">check_for_hierarchy_violation</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœéœ€è¦æ„é€ çš„é”çš„å±‚çº§å€¼å¤§äºç­‰äºå½“å‰é”çš„å±‚çº§å€¼ï¼Œä¸åˆæ³•</span></span><br><span class="line">        <span class="keyword">if</span>(this_thread_hierarchy_value &lt;= hierarchichy_value)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">throw</span> std::<span class="built_in">logic_error</span>(<span class="string">&quot;mutex hierarchy violated&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update_hierarchy_value</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°å½“å‰é”çš„å±‚çº§å€¼</span></span><br><span class="line">        previous_hierarchichy_value = this_thread_hierarchy_value;</span><br><span class="line">        this_thread_hierarchy_value = hierarchichy_value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸èƒ½åŠ  static</span></span><br><span class="line"><span class="function"><span class="keyword">thread_local</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="title">hierarchical_mutex::this_thread_hierarchy_value</span><span class="params">(ULONG_MAX)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">hierarchical_mutex <span class="title">m1</span><span class="params">(<span class="number">1000</span>)</span></span>;</span><br><span class="line"><span class="function">hierarchical_mutex <span class="title">m2</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;F2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="function">lock_guard&lt;hierarchical_mutex&gt; <span class="title">lock</span><span class="params">(m1)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;F1&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="function">lock_guard&lt;hierarchical_mutex&gt; <span class="title">lock</span><span class="params">(m2)</span></span>;</span><br><span class="line">    <span class="built_in">f2</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">f1</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>åˆå§‹åŒ– static æˆå‘˜æ—¶ä¸èƒ½åŠ  staticï¼Œé¿å…ä¸ class ä¹‹å¤–çš„ static å˜é‡æ··æ·†</li>
<li>ä¸ºä»€ä¹ˆå°† this_thread_hierarchy_value è®¾ç½®ä¸º thread_local static ? åªæœ‰è¿™æ ·æ‰èƒ½å®ç°åŠ¨æ€æ›´æ–°å±‚çº§ï¼Œå½“æˆ‘ä»¬æ›´æ–°äº† this_thread_hierarchy_value çš„å€¼ä¹‹åï¼Œä¸‹ä¸€ä¸ªåˆ›å»ºçš„ hierarchical_mutex å¯¹è±¡ä½¿ç”¨çš„æ˜¯æ›´æ–°ä¹‹åçš„å€¼ã€‚ä¾‹å¦‚ï¼š</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> x;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">Foo::x</span><span class="params">(<span class="number">1024</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Foo f;</span><br><span class="line">    cout &lt;&lt; f.x &lt;&lt; endl;    <span class="comment">// 1024</span></span><br><span class="line">    f.x = <span class="number">233</span>;</span><br><span class="line">    cout &lt;&lt; f.x&lt;&lt; endl;     <span class="comment">// 233</span></span><br><span class="line">    Foo g;</span><br><span class="line">    cout &lt;&lt; g.x &lt;&lt; endl;    <span class="comment">// 233</span></span><br><span class="line">    cout &lt;&lt; Foo::x &lt;&lt; endl; <span class="comment">// 233</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="3-2-4-std-uniqie-lock"><a href="#3-2-4-std-uniqie-lock" class="headerlink" title="3.2.4 std::uniqie_lock"></a>3.2.4 std::uniqie_lock</h4><p>å¯¹ swap å‡½æ•°çš„æ”¹å†™ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">bank_account</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">bank_account</span><span class="params">(<span class="type">int</span> balance)</span> : balance&#123;</span>balance&#125; &#123;&#125;</span><br><span class="line">    <span class="type">int</span> balance;</span><br><span class="line">    std::mutex m;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">my_swap</span><span class="params">(bank_account &amp;from, bank_account &amp;to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(&amp;from == &amp;to) <span class="keyword">return</span>; <span class="comment">// avoid deadlock in case of self transfer</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°†äº’æ–¥é‡ä¼ å…¥ unique è¡¨ç¤ºè¯¥äº’æ–¥é‡åº”è¯¥ä¿æŒè§£é”çŠ¶æ€ï¼ˆä¸åº”è¯¥å†è¢«å…¶ä»–çº¿ç¨‹ä¸Šé”ï¼‰</span></span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock_a</span><span class="params">(from.m, std::defer_lock)</span></span>;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock_b</span><span class="params">(to.m, std::defer_lock)</span></span>;</span><br><span class="line">    <span class="comment">// std::defer_lock ç•™ä¸‹æœªä¸Šé”çš„äº’æ–¥é‡</span></span><br><span class="line">    std::<span class="built_in">lock</span>(lock_a, lock_b);</span><br><span class="line">    std::<span class="built_in">swap</span>(from.balance, to.balance);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    bank_account my_account&#123;<span class="number">100</span>&#125;;</span><br><span class="line">    bank_account your_account&#123;<span class="number">50</span>&#125;;</span><br><span class="line"> </span><br><span class="line">    std::thread t1&#123;my_swap, std::<span class="built_in">ref</span>(my_account), std::<span class="built_in">ref</span>(your_account)&#125;;</span><br><span class="line">    std::thread t2&#123;my_swap, std::<span class="built_in">ref</span>(your_account), std::<span class="built_in">ref</span>(my_account)&#125;;</span><br><span class="line">    std::thread t3&#123;my_swap, std::<span class="built_in">ref</span>(my_account), std::<span class="built_in">ref</span>(your_account)&#125;;</span><br><span class="line"></span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    t3.<span class="built_in">join</span>();</span><br><span class="line"> </span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;my_account.balance = &quot;</span> &lt;&lt; my_account.balance &lt;&lt; <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;your_account.balance = &quot;</span> &lt;&lt; your_account.balance &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">f</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="3-2-5-Passing-of-mutex-ownership-in-different-domains"><a href="#3-2-5-Passing-of-mutex-ownership-in-different-domains" class="headerlink" title="3.2.5  Passing of mutex ownership in different domains"></a>3.2.5  Passing of mutex ownership in different domains</h4><p><code>std::unique_lock</code> å®ä¾‹æ²¡æœ‰ä¸è‡ªèº«ç›¸å…³çš„äº’æ–¥é‡ï¼Œäº’æ–¥é‡çš„æ‰€æœ‰æƒå¯ä»¥é€šè¿‡<strong>ç§»åŠ¨æ“ä½œ</strong>ï¼Œ åœ¨ä¸åŒçš„å®ä¾‹é—´ä¼ é€’ã€‚</p>
<p>â€¦ çœ‹ä¸æ‡‚åœ¨å¹²å•¥ ğŸ˜­</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">get_lock</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">extern</span> std::mutex some_mutex;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(some_mutex)</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;get_lock()&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> lock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process_data</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(get_lock())</span></span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;process_data()&quot;</span> &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;hello!&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(process_data)</span></span>;</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="3-2-5-Lock-Granularity"><a href="#3-2-5-Lock-Granularity" class="headerlink" title="3.2.5 Lock Granularity"></a>3.2.5 Lock Granularity</h4><p>é”çš„ç²’åº¦ç”¨æ¥æè¿°é€šè¿‡ä¸€ä¸ªé”ä¿æŠ¤ç€çš„æ•°æ®é‡å¤§å°ã€‚ä¸€ä¸ªç»†ç²’åº¦é”(a fine-grained lock) èƒ½å¤Ÿä¿æŠ¤è¾ƒå°çš„æ•°æ®é‡ï¼Œä¸€ä¸ªç²—ç²’åº¦é”(a coarse-grained lock)èƒ½ä¿æŠ¤è¾ƒå¤šçš„æ•°æ®é‡ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Y</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// private:</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> some_detail;</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex m;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get_detail</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock_a</span><span class="params">(m)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> some_detail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Y</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">Y</span>(<span class="type">int</span> _sd) : <span class="built_in">some_detail</span>(_sd) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">friend</span> <span class="type">bool</span> <span class="keyword">operator</span>==(<span class="type">const</span> Y &amp;lhs, <span class="type">const</span> Y &amp;rhs)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(&amp;lhs == &amp;rhs)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> lhs_value = lhs.<span class="built_in">get_detail</span>(); <span class="comment">// (1)</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;I get lhs value:&quot;</span> &lt;&lt; lhs_value &lt;&lt; endl;;</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// é”çš„ç²’åº¦å°ï¼Œåœ¨å¾—åˆ°lhs_valueä¹‹å</span></span><br><span class="line">        <span class="comment">// rhs_valueå¯èƒ½ä¸æ˜¯è·å–lhs_valueç¬é—´çš„å€¼</span></span><br><span class="line">        <span class="comment">// ä»–çš„å€¼å¯èƒ½è¢«ä¿®æ”¹</span></span><br><span class="line">        <span class="type">const</span> <span class="type">int</span> rhs_value = rhs.<span class="built_in">get_detail</span>();  <span class="comment">// (2)</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;I get rhs value!: &quot;</span> &lt;&lt; rhs_value &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> lhs_value == rhs_value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::thread::id master_id;</span><br><span class="line"></span><br><span class="line">Y a[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">(<span class="type">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(this_thread::<span class="built_in">get_id</span>() == master_id) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;]I am master!: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line">            cout &lt;&lt; (a[<span class="number">0</span>] == a[<span class="number">1</span>] ? <span class="string">&quot;Yes&quot;</span> : <span class="string">&quot;No&quot;</span>) &lt;&lt; endl;</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; i &lt;&lt; <span class="string">&quot;]I am slaver: &quot;</span> &lt;&lt; id &lt;&lt; endl;</span><br><span class="line">            a[id].some_detail = <span class="built_in">rand</span>() % <span class="number">10</span>;</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">    a[<span class="number">0</span>].some_detail = <span class="number">1</span>;</span><br><span class="line">    a[<span class="number">1</span>].some_detail = <span class="number">2</span>;</span><br><span class="line">    <span class="function">thread <span class="title">master</span><span class="params">(process, <span class="number">-1</span>)</span></span>;</span><br><span class="line">    master_id = master.<span class="built_in">get_id</span>();</span><br><span class="line">    cout &lt;&lt; master.<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">    thread slaver[<span class="number">2</span>];</span><br><span class="line">    slaver[<span class="number">0</span>] = <span class="built_in">thread</span>(process, <span class="number">0</span>);</span><br><span class="line">    slaver[<span class="number">1</span>] = <span class="built_in">thread</span>(process, <span class="number">1</span>);</span><br><span class="line">    master.<span class="built_in">join</span>();</span><br><span class="line">    slaver[<span class="number">0</span>].<span class="built_in">join</span>();</span><br><span class="line">    slaver[<span class="number">1</span>].<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="3-3-subsititute-of-shared-data-protect"><a href="#3-3-subsititute-of-shared-data-protect" class="headerlink" title="3.3 subsititute of shared data protect"></a>3.3 subsititute of shared data protect</h3><h4 id="3-3-1-protect-initialization-process-of-data"><a href="#3-3-1-protect-initialization-process-of-data" class="headerlink" title="3.3.1 protect initialization process of data"></a>3.3.1 protect initialization process of data</h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå…±äº«æºï¼Œæ„å»ºä»£ä»·å¾ˆæ˜‚è´µï¼Œä»–å¯èƒ½ä¼šæ‰“å¼€ä¸€ä¸ªæ•°æ®åº“è¿æ¥æˆ–åˆ†é…å‡ºå¾ˆå¤šçš„èµ„æºã€‚</p>
<p>Lazy Initialization åœ¨å•çº¿ç¨‹ä»£ç ä¸­å¾ˆå¸¸è§ â€”â€” æ²¡ä¸€ä¸ªæ“ä½œéƒ½éœ€è¦å¯¹æºè¿›è¡Œæ£€æŸ¥ï¼Œäº†è§£æ•°æ®æ˜¯å¦è¢«åˆå§‹åŒ–ï¼Œç„¶ååœ¨å…¶ä½¿ç”¨å‰å†³å®šï¼Œæ•°æ®æ˜¯å¦éœ€è¦åˆå§‹åŒ–ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">some_resources</span>;</span><br><span class="line">std::shared_ptr&lt;some_resources&gt; resources_ptr;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!resources_ptr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// lazy initialization</span></span><br><span class="line">        resources_ptr.<span class="built_in">reset</span>(<span class="keyword">new</span> some_resources);</span><br><span class="line">    &#125;</span><br><span class="line">    resources_ptr-&gt;<span class="built_in">do_something</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œä¸€ç§å¤§ç²’åº¦é”æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">some_resources</span>;</span><br><span class="line">std::shared_ptr&lt;some_resources&gt; resources_ptr;</span><br><span class="line">std::mutex resource_mutex;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(resource_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(!resources_ptr)</span><br><span class="line">    &#123;</span><br><span class="line">        resources_ptr.<span class="built_in">reset</span>(<span class="keyword">new</span> some_resources);</span><br><span class="line">    &#125;</span><br><span class="line">    resources_ptr-&gt;<span class="built_in">do_something</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å£°åç‹¼è—‰çš„â€œåŒé‡æ£€æŸ¥é”æ¨¡å¼â€:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">std::shared_ptr&lt;some_resources&gt; resources_ptr;</span><br><span class="line">std::mutex resource_mutex;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!resources_ptr)	<span class="comment">// ç¬¬ä¸€æ¬¡æ£€æŸ¥</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// åœ¨ if ä¸åŠ é”ä¹‹é—´ï¼Œresources_ptr å¯èƒ½è¢«ä¿®æ”¹äº†</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(resource_mutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(!resources_ptr) <span class="comment">// ç¬¬äºŒæ¬¡æ£€æŸ¥</span></span><br><span class="line">        &#123;</span><br><span class="line">            resources_ptr.<span class="built_in">reset</span>(<span class="keyword">new</span> some_resources); <span class="comment">// (1)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resources_ptr-&gt;<span class="built_in">do_something</span>(); <span class="comment">// (2)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ¨¡å¼å£°åç‹¼è—‰çš„åŸå› åœ¨äºï¼Œå­˜åœ¨æ½œåœ¨çš„æ¡ä»¶ç«äº‰ã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.aristeia.com/Papers/DDJ_Jul_Aug_2004_revised.pdf">å…·ä½“çš„å¯ä»¥å‚è€ƒè¿™é‡Œ</a></p>
</blockquote>
<p>è®ºæ–‡å¤ªé•¿ï¼Œæˆ‘ç²—ç•¥çš„çœ‹äº†ä¸€ä¸‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œnew æ˜¯åˆ†ä¸ºä¸¤æ­¥çš„ï¼š</p>
<ol>
<li>operator new(size_of_object)</li>
<li>ctor</li>
<li>assign</li>
</ol>
<p>æ–‡ç« ç»™å‡ºä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Singleton *<span class="title">Singleton::instance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pInstance == <span class="number">0</span>) &#123;</span><br><span class="line">        Lock lock;</span><br><span class="line">        <span class="keyword">if</span> (pInstance == <span class="number">0</span>) &#123;</span><br><span class="line">            pInstance =               <span class="comment">// Step 3</span></span><br><span class="line">            <span class="keyword">operator</span> <span class="built_in">new</span>(<span class="built_in">sizeof</span>(Singleton)); <span class="comment">// Step 1</span></span><br><span class="line">            <span class="keyword">new</span> (pInstance) Singleton;    <span class="comment">// Step 2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–‡ç« çš„æ„æ€åº”è¯¥æ˜¯ï¼Œåœ¨ ctor ä¹‹å‰ï¼Œå¯¹è±¡è¿˜æ²¡è¢«æ„å»ºï¼Œæ­¤æ—¶æŒ‡å‘å®ƒçš„æŒ‡é’ˆä¸ºç©ºï¼Œå³ä½¿ ctor å®Œæˆäº†ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†å…¶åœ°å€èµ‹å€¼ç»™æŒ‡å‘å®ƒçš„æŒ‡é’ˆï¼Œè€Œåœ¨ctorä¸assignä¹‹é—´ï¼ŒæŒ‡é’ˆä¾ç„¶ä¸ºç©ºã€‚</p>
<p>æŒ‡é’ˆä¸ºç©ºå°±æ„å‘³ç€ï¼Œç¬¬äºŒæ¬¡æ£€æŸ¥ä¸ä¸€å®šæ˜¯æœ‰æ•ˆçš„ï¼Œä¹Ÿå³ï¼Œä»ç„¶å¯èƒ½æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥ (1) ä»è€Œç ´åæ•°æ®ï¼Œå¹¶ä¸”è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼</p>
<hr>
<p>ä¸ºäº†è§£å†³è¿™ç§æ¡ä»¶ç«äº‰ï¼ŒC++ æ ‡å‡†åº“æä¾›äº† <code>std::once_flag</code> å’Œ <code>std::call_once</code> ï¼Œå¹¶ä¸”ä½¿ç”¨ <code>std::call_one</code> æ¯”ä½¿ç”¨äº’æ–¥é‡æ¶ˆè€—çš„èµ„æºæ›´å°‘ã€‚</p>
<blockquote>
<p><code>std::call_once</code> : é¡¾åæ€ä¹‰ï¼Œå¯ä»¥å‡†ç¡®æ‰§è¡Œä¸€æ¬¡ callable objectï¼Œå…¶é€šè¿‡ <code>std::once_flag</code> æ¥åˆ¤æ–­æ˜¯å¦è¢«æ‰§è¡Œè¿‡ï¼Œå¦‚æœå¤šæ¬¡è°ƒç”¨ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>call_one åˆ†ä¸º:</p>
<ol>
<li>active callï¼šç¬¬ä¸€æ¬¡è°ƒç”¨</li>
<li>passive callï¼šååºè°ƒç”¨</li>
<li>exceptional callï¼šæŠ›å‡ºå¼‚å¸¸çš„è°ƒç”¨ï¼Œä¸ä¼šä¿®æ”¹ once_flag</li>
</ol>
</blockquote>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">std::once_flag flag1, flag2;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">simple_do_once</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::<span class="built_in">call_once</span>(flag1, []()&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Simple example: call one\n&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">may_throw_function</span><span class="params">(<span class="type">bool</span> do_throw)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(do_throw)</span><br><span class="line">    &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;throw: call once will retry\n&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">exception</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Do no throw: call once will not attempt retry\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_once</span><span class="params">(<span class="type">bool</span> do_throw)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        std::<span class="built_in">call_once</span>(flag2, may_throw_function, do_throw);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(...) </span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;get exception\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::thread <span class="title">st1</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">st2</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">st3</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">st4</span><span class="params">(simple_do_once)</span></span>;</span><br><span class="line">    st1.<span class="built_in">join</span>();</span><br><span class="line">    st2.<span class="built_in">join</span>();</span><br><span class="line">    st3.<span class="built_in">join</span>();</span><br><span class="line">    st4.<span class="built_in">join</span>();</span><br><span class="line">    <span class="comment">/**/</span></span><br><span class="line">    <span class="function">std::thread <span class="title">t1</span><span class="params">(do_once, <span class="literal">true</span>)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t2</span><span class="params">(do_once, <span class="literal">true</span>)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t3</span><span class="params">(do_once, <span class="literal">false</span>)</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t4</span><span class="params">(do_once, <span class="literal">true</span>)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    t3.<span class="built_in">join</span>();</span><br><span class="line">    t4.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Foo</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±æ­¤ï¼Œå¯ä»¥å°†ä¸Šé¢çš„ä¾‹å­ä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">std::shared_ptr&lt;some_resource&gt; resource_ptr;</span><br><span class="line">std::once_flag resource_flag;  <span class="comment">// 1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init_resource</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	resource_ptr.<span class="built_in">reset</span>(<span class="keyword">new</span> some_resource);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::<span class="built_in">call_once</span>(resource_flag,init_resource); <span class="comment">// å¯ä»¥å®Œæ•´çš„è¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–</span></span><br><span class="line">	resource_ptr-&gt;<span class="built_in">do_something</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">X</span></span><br><span class="line">&#123;</span><br><span class="line">    std::once_flag flag;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">do_once</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;do once&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;f1&quot;</span> &lt;&lt; endl;</span><br><span class="line">        std::<span class="built_in">call_once</span>(flag, &amp;X::do_once, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;f2&quot;</span> &lt;&lt; endl;</span><br><span class="line">        std::<span class="built_in">call_once</span>(flag, &amp;X::do_once, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    X x;</span><br><span class="line">    x.<span class="built_in">f1</span>();</span><br><span class="line">    x.<span class="built_in">f2</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Foo</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœä¸º: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">f1</span><br><span class="line">do once</span><br><span class="line">f2</span><br></pre></td></tr></table></figure>

<hr>
<p>å±€éƒ¨ static å˜é‡çš„çº¿ç¨‹å®‰å…¨çš„åˆå§‹åŒ–æ–¹å¼ï¼ˆ<code>std::call_once</code> çš„æ›¿ä»£æ–¹æ¡ˆï¼‰</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">my_class</span>;</span><br><span class="line"><span class="function">my_class&amp; <span class="title">get_my_class_instance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> my_class instance;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–å’Œå®šä¹‰å®Œå…¨åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å‘ç”Ÿï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–çº¿ç¨‹å¯åœ¨åˆå§‹åŒ–å®Œæˆå‰å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚</p>
<p>å…¶å®è¿™ä¸ªå°±æ˜¯ä¾‹å­è®¾è®¡æ¨¡å¼(<strong>Singleton</strong>)çš„æ€è·¯ï¼Œè®© static å˜é‡åœ¨å‡½æ•°å†…éƒ¨å®Œæˆåˆå§‹åŒ–ï¼Œä»è€Œä½¿å¾—è°ƒç”¨è¯¥å¯¹è±¡æ—¶ï¼Œè¯¥å¯¹è±¡ä¸€å®šè¢«åˆå§‹åŒ–ã€‚</p>
<p>ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>å…¶å®ä¸»è¦æ˜¯å› ä¸º<strong>â€œC++åªèƒ½ä¿è¯åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­å£°æ˜çš„staticå˜é‡çš„åˆå§‹åŒ–é¡ºåºä¸å…¶å˜é‡å£°æ˜çš„é¡ºåºä¸€è‡´ã€‚ä½†æ˜¯ä¸èƒ½ä¿è¯ä¸åŒçš„æ–‡ä»¶ä¸­çš„staticå˜é‡çš„åˆå§‹åŒ–é¡ºåºã€‚â€</strong></p>
<p>ç„¶åå¯¹äºå•ä¾‹æ¨¡å¼è€Œè¨€ï¼Œä¸åŒçš„å•ä¾‹å¯¹è±¡ä¹‹é—´è¿›è¡Œè°ƒç”¨ä¹Ÿæ˜¯å¸¸è§çš„åœºæ™¯ã€‚æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªå•ä¾‹ï¼Œå­˜å‚¨äº†ç¨‹åºå¯åŠ¨æ—¶åŠ è½½çš„é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚å¦å¤–æœ‰ä¸€ä¸ªå•ä¾‹ï¼ŒæŒç®¡ç€ä¸€ä¸ªå…¨å±€çš„æ—¥å¿—ç®¡ç†å™¨ã€‚åœ¨æ—¥å¿—ç®¡ç†åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¦é€šè¿‡é…ç½®æ–‡ä»¶çš„å•ä¾‹å¯¹è±¡æ¥è·å–åˆ°æŸä¸ªé…ç½®é¡¹ï¼Œå®ç°æ—¥å¿—æ‰“å°ã€‚</p>
<p>è¿™æ—¶å€™ä¸¤ä¸ªå•ä¾‹åœ¨ä¸åŒæ–‡ä»¶ä¸­å„è‡ªå®ç°ï¼Œå¾ˆæœ‰å¯èƒ½åœ¨æ—¥å¿—ç®¡ç†å™¨çš„å•ä¾‹ä½¿ç”¨é…ç½®æ–‡ä»¶å•ä¾‹çš„æ—¶å€™ï¼Œé…ç½®æ–‡ä»¶çš„å•ä¾‹å¯¹è±¡æ˜¯æ²¡æœ‰è¢«åˆå§‹åŒ–çš„ã€‚è¿™ä¸ªæœªåˆå§‹åŒ–å¯èƒ½äº§ç”Ÿçš„é£é™©æŒ‡çš„æ˜¯C++å˜é‡çš„æœªåˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯è¯´é…ç½®æ–‡ä»¶æœªåŠ è½½çš„ä¹‹ç±»ä¸šåŠ¡é€»è¾‘ä¸Šçš„æœªåˆå§‹åŒ–å¯¼è‡´çš„é—®é¢˜ã€‚</p>
<p>è€Œ<code>Meyers&#39; Singleton</code>å†™æ³•ä¸­ï¼Œå•ä¾‹å¯¹è±¡æ˜¯æ¬¡è®¿é—®çš„æ—¶å€™ï¼ˆä¹Ÿå°±æ˜¯æ¬¡è°ƒç”¨<code>getInstance()</code>å‡½æ•°çš„æ—¶å€™ï¼‰æ‰åˆå§‹åŒ–çš„ï¼Œä½†ä¹Ÿæ˜¯æ°æ°å› ä¸ºå¦‚æ­¤ï¼Œå› è€Œèƒ½ä¿è¯å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œåœ¨è¯¥å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œæ˜¯èƒ½å®Œæˆåˆå§‹åŒ–çš„ã€‚æ‰€ä»¥å…ˆ<code>getInstance()</code>å†è®¿é—® è¿™ç§å½¢å¼çš„å•ä¾‹ å…¶å…³é”®å¹¶ä¸æ˜¯åœ¨äºè¿™ä¸ªå½¢å¼ã€‚è€Œæ˜¯åœ¨äºå…¶å†…å®¹ï¼Œå±€éƒ¨staticå˜é‡èƒ½ä¿è¯é€šè¿‡å‡½æ•°æ¥è·å–staticå˜é‡çš„æ—¶å€™ï¼Œè¯¥å‡½æ•°è¿”å›çš„å¯¹è±¡æ˜¯è‚¯å®šå®Œæˆäº†åˆå§‹åŒ–çš„ï¼</p>
<p>å¦å¤–ï¼Œè¯¥å†™æ³•éœ€è¦ C++11 çš„æ”¯æŒï¼Œå› ä¸ºåœ¨ C++11 ä¹‹åï¼Œstatic å˜é‡çš„åˆå§‹åŒ–æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://z.itpub.net/article/detail/DC3250F681713244F01A546413CC2828">ã€Œè¯¦ç»†ä¿¡æ¯å‚è€ƒè¿™é‡Œâ€”referenceã€</a></p>
</blockquote>
<h4 id="3-3-2-protect-data-struct-which-updatelessly"><a href="#3-3-2-protect-data-struct-which-updatelessly" class="headerlink" title="3.3.2 protect data struct which updatelessly"></a>3.3.2 protect data struct which updatelessly</h4><p>å¯¹äºæ›´æ–°æ¯”è¾ƒå°‘ï¼Œè¯»å–é¢‘ç¹çš„æ•°æ®ç»“æ„ï¼Œä½¿ç”¨ <code>std::mutex</code> æ˜¾å¾—æœ‰äº›ååº”è¿‡æ¿€äº†ï¼Œå› ä¸ºåœ¨æ²¡æœ‰ä¿®æ”¹æ—¶ï¼Œå®ƒå°†å‰Šå¼±å¹¶å‘è¯»å–æ•°æ®çš„å¯èƒ½æ€§ï¼Œå› æ­¤ï¼Œè¿™é‡Œéœ€è¦ä¸€ç§ä¸åŒçš„äº’æ–¥é‡ â€“ è¯»å†™é”ï¼šä¸€ä¸ªâ€œå†™â€çº¿ç¨‹ç‹¬ç«‹è®¿é—®ï¼Œå¤šä¸ª â€œè¯»â€ çº¿ç¨‹å¹¶å‘è®¿é—®ã€‚</p>
<p>C++ æ ‡å‡†åº“æš‚æ—¶æ²¡æœ‰æä¾›â€œè¯»è€…-å†™è€…é”â€ï¼Œä½†æ˜¯ Boost åº“æä¾›äº†æ”¯æŒ <code>boost::shared_lock</code> (è¯»å†™é”)ï¼Œé€šå¸¸ç”¨äºè¯»æ“ä½œæ¯”è¾ƒé¢‘ç¹çš„ï¼Œè€Œå†™æ“ä½œæ¯”è¾ƒå°‘çš„æƒ…å†µã€‚</p>
<p>è¯»å†™é”æ¯”èµ·mutexå…·æœ‰æ›´é«˜çš„é€‚ç”¨æ€§ï¼Œå…·æœ‰æ›´é«˜çš„å¹¶è¡Œæ€§ï¼Œå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å ç”¨è¯»æ¨¡å¼çš„è¯»å†™é”ï¼Œä½†æ˜¯åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å ç”¨å†™æ¨¡å¼çš„è¯»å†™é”ï¼Œè¯»å†™é”çš„åŸºæœ¬è§„åˆ™å¯ä»¥æ€»ç»“ä¸º<strong>â€œwrite firstï¼Œread sharedï¼Œcross mutex(äº¤å‰äº’æ–¥)â€</strong>ï¼Œå…·ä½“è¡¨ç°ä¸ºè¯»å†™é”çš„ä¸‰ç§çŠ¶æ€ï¼š</p>
<ol>
<li>å½“è¯»å†™é”æ˜¯å†™åŠ é”çŠ¶æ€æ—¶ï¼Œåœ¨è¿™ä¸ªé”è¢«è§£é”ä¹‹å‰ï¼Œæ‰€æœ‰è¯•å›¾å¯¹è¿™ä¸ªé”åŠ é”çš„çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚ï¼ˆäº¤å‰äº’æ–¥ï¼‰</li>
<li>å½“è¯»å†™é”åœ¨è¯»åŠ é”çŠ¶æ€æ—¶ï¼Œæ‰€æœ‰è¯•å›¾ä»¥è¯»æ¨¡å¼å¯¹å®ƒè¿›è¡ŒåŠ é”çš„çº¿ç¨‹éƒ½å¯ä»¥å¾—åˆ°è®¿é—®æƒï¼Œä½†æ˜¯ä»¥å†™æ¨¡å¼å¯¹å®ƒè¿›è¡ŒåŠ é”çš„çº¿ç¨‹å°†ä¼šè¢«é˜»å¡ã€‚ï¼ˆè¯»å…±äº«ï¼Œäº¤å‰äº’æ–¥ï¼‰</li>
<li>å½“è¯»å†™é”åœ¨è¯»æ¨¡å¼çš„é”çŠ¶æ€æ—¶ï¼Œå¦‚æœæœ‰å¦å¤–çš„çº¿ç¨‹è¯•å›¾ä»¥å†™æ¨¡å¼åŠ é”ï¼Œè¯»å†™é”é€šå¸¸ä¼šé˜»å¡éšåçš„è¯»æ¨¡å¼é”çš„è¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥é¿å…è¯»æ¨¡å¼é”é•¿æœŸå ç”¨ï¼Œè€Œç­‰å¾…çš„å†™æ¨¡å¼é”è¯·æ±‚åˆ™é•¿æœŸé˜»å¡ã€‚ï¼ˆå†™ä¼˜å…ˆï¼‰</li>
</ol>
<p>æ³¨ï¼šå…¶å®åœ¨è¯»è€…-å†™è€…é—®é¢˜ä¸­ï¼Œæœ‰è¯»è€…ä¼˜å…ˆå’Œå†™è€…ä¼˜å…ˆä¸¤ç§æ¨¡å¼ï¼Œåªæ˜¯åœ¨ <strong>shared_mutex which in boost library default complement in writing first</strong>ï¼Œè¿™å…¶å®ä¹Ÿæ˜¯æœ‰é“ç†çš„ï¼Œ<strong>because we always want to read the least data</strong>ï¼Œè¿™å°±å¾—ä¿è¯å†™è€…ä¼˜å…ˆã€‚</p>
<p>ä¾‹å­ï¼šæ¨¡æ‹Ÿ dns ç¼“å­˜çš„ä¿®æ”¹å’ŒæŸ¥è¯¢</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/thread/shared_mutex.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dns_entry</span></span><br><span class="line">&#123;</span><br><span class="line">    string domain;</span><br><span class="line">    string ip_addr;</span><br><span class="line">    <span class="comment">/*....*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dns_cache</span> </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::map&lt;std::string, dns_entry&gt; entries;   <span class="comment">// ç¼“å­˜ dns æ•°æ®</span></span><br><span class="line">    <span class="keyword">mutable</span> boost::shared_mutex entry_mutex;    <span class="comment">// å¯¹æ•°æ®è¿›è¡Œä¿æŠ¤</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// from domin name to IP addr</span></span><br><span class="line">    <span class="function">dns_entry <span class="title">find_entry</span><span class="params">(<span class="type">const</span> std::string &amp;domain)</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">boost::shared_lock&lt;boost::shared_mutex&gt; <span class="title">lk</span><span class="params">(entry_mutex)</span></span>; <span class="comment">// åŠ è¯»é”</span></span><br><span class="line">        <span class="keyword">auto</span> it = entries.<span class="built_in">find</span>(domain);</span><br><span class="line">        <span class="keyword">return</span> (it == entries.<span class="built_in">end</span>()) ? <span class="built_in">dns_entry</span>() : it-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">update_or_addr_entry</span><span class="params">(<span class="type">const</span> std::string &amp;domain, <span class="type">const</span> dns_entry &amp;dns_details)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;boost::shared_mutex&gt; <span class="title">lock</span><span class="params">(entry_mutex)</span></span>; <span class="comment">// åŠ å†™é”</span></span><br><span class="line">        <span class="comment">// or add unique_lock&lt;boost::shared_mutex&gt;</span></span><br><span class="line">        entries[domain] = dns_details;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h4 id="3-3-3-nested-lock"><a href="#3-3-3-nested-lock" class="headerlink" title="3.3.3 nested lock"></a>3.3.3 nested lock</h4><p><code>std::recursive_mutex</code></p>
<h2 id="P4-synchronization"><a href="#P4-synchronization" class="headerlink" title="P4 synchronization"></a>P4 synchronization</h2><p>å•å•å°†æ•°æ®ä¿æŠ¤èµ·æ¥å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿˜æƒ³å¯¹å•ç‹¬çš„çº¿ç¨‹è¿›è¡ŒåŒæ­¥ã€‚ä¾‹å¦‚ï¼ŒæŸä¸ªçº¿ç¨‹ä½œä¸ºå¦ä¸€ä¸ªçº¿ç¨‹çš„è¾“å…¥ã€‚</p>
<p>é€šè¿‡æ¡ä»¶å˜é‡(<strong>condition variables</strong>)å’ŒæœŸæœ›(<strong>futures</strong>)å®ç°çº¿ç¨‹ä¹‹é—´çš„åŒæ­¥ã€‚</p>
<h3 id="4-1-wait-event-or-condition"><a href="#4-1-wait-event-or-condition" class="headerlink" title="4.1 wait event or condition"></a>4.1 wait event or condition</h3><h4 id="4-1-1-introduce"><a href="#4-1-1-introduce" class="headerlink" title="4.1.1 introduce"></a>4.1.1 introduce</h4><p>æƒ…æ™¯ï¼šæˆ‘ä»¬éœ€è¦ç­‰å¾…ä¸€ä¸ªäº‹ä»¶ã€‚</p>
<p>æœ€ç¬¨çš„æ–¹æ³•æ˜¯ä¸€ç›´åŠ é”ï¼Œç„¶åæ—¶é—´æ¥ä¸´ä¹‹åï¼Œå¤„ç†äº‹ä»¶ï¼Œè§£é”ã€‚ä½†æ˜¯è¿™ç§æ–¹æ³•æ˜¯å¾ˆä½æ•ˆçš„ï¼Œå› ä¸ºç­‰å¾…äº‹ä»¶æ—¶æˆ‘ä»¬æŒæœ‰é”ä½†ä»€ä¹ˆä¹Ÿä¸åšã€‚</p>
<p>è¿›æ­¥çš„æ–¹æ³•æ˜¯ä¸‹é¢è¿™ç§ï¼ˆ<code>std::this_thread::sleep_for()</code>ï¼‰ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å°±è¿›è¡Œä¸€æ¬¡æ£€æŸ¥ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•çš„é—®é¢˜æ˜¯ï¼Œå¾ˆéš¾ç¡®å®šä¸­é—´é—´éš”çš„æ—¶é—´ï¼Œå¤ªçŸ­æˆ–è€…å¤ªé•¿äº†éƒ½ä¸å¥½ï¼</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex, std::mutex_guard</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/thread/shared_mutex.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> flag;</span><br><span class="line">std::mutex m;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">wait_for_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(m)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(!flag)</span><br><span class="line">    &#123;</span><br><span class="line">        lk.<span class="built_in">unlock</span>();</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">100</span>));    <span class="comment">// 100ms</span></span><br><span class="line">        lk.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">wait_for_flag</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€å¥½çš„åŠæ³•å°±æ˜¯ä½¿ç”¨æ¡ä»¶å˜é‡ï¼Œå½“æ—¶é—´å‘ç”Ÿæ—¶ï¼Œå¹¿æ’­â€œæ¡ä»¶è¾¾æˆâ€çš„ä¿¡æ¯ï¼Œç”±æ­¤å‡ºå‘ç­‰å¾…è¯¥äº‹ä»¶çš„çº¿ç¨‹ã€‚</p>
<h4 id="4-1-2-condition-variable"><a href="#4-1-2-condition-variable" class="headerlink" title="4.1.2 condition variable"></a>4.1.2 condition variable</h4><p>C++æ ‡å‡†åº“å¯¹æ¡ä»¶å˜é‡æœ‰ä¸¤å¥—å®ç°ï¼š<code>std::condition_variable</code>å’Œ<code>std::condition_variable_any</code>ã€‚è¿™ä¸¤ä¸ªå®ç°éƒ½åŒ…å«åœ¨<code>&lt;condition_variable&gt;</code>å¤´æ–‡ä»¶çš„å£°æ˜ä¸­ã€‚ä¸¤è€…éƒ½éœ€è¦ä¸ä¸€ä¸ªäº’æ–¥é‡ä¸€èµ·æ‰èƒ½å·¥ä½œ(äº’æ–¥é‡æ˜¯ä¸ºäº†åŒæ­¥)ï¼›å‰è€…ä»…é™äºä¸<code>std::mutex</code>ä¸€èµ·å·¥ä½œï¼Œè€Œåè€…å¯ä»¥å’Œä»»ä½•æ»¡è¶³æœ€ä½æ ‡å‡†çš„äº’æ–¥é‡ä¸€èµ·å·¥ä½œï¼Œä»è€ŒåŠ ä¸Šäº†*_any*çš„åç¼€ã€‚å› ä¸º<code>std::condition_variable_any</code>æ›´åŠ é€šç”¨ï¼Œè¿™å°±å¯èƒ½ä»ä½“ç§¯ã€æ€§èƒ½ï¼Œä»¥åŠç³»ç»Ÿèµ„æºçš„ä½¿ç”¨æ–¹é¢äº§ç”Ÿé¢å¤–çš„å¼€é”€ï¼Œæ‰€ä»¥<code>std::condition_variable</code>ä¸€èˆ¬ä½œä¸ºé¦–é€‰çš„ç±»å‹ï¼Œå½“å¯¹çµæ´»æ€§æœ‰ç¡¬æ€§è¦æ±‚æ—¶ï¼Œæˆ‘ä»¬æ‰ä¼šå»è€ƒè™‘<code>std::condition_variable_any</code>ã€‚</p>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨ <code>std::condition_variable</code> å¤„ç†ç­‰å¾…æ•°æ®</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">data_chunk</span> &#123;<span class="comment">/*...*/</span>&#125;;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">more_data_to_prepare</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">const</span> data_chunk&amp; <span class="title">prepare_data</span><span class="params">()</span></span>; </span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">is_last_chunk</span><span class="params">(<span class="type">const</span> data_chunk&amp;)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">(data_chunk&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">std::mutex mut;</span><br><span class="line">std::queue&lt;data_chunk&gt; data_queue;</span><br><span class="line">std::condition_variable data_cond;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">data_preparation_thread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">more_data_to_prepare</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> data_chunk data = <span class="built_in">prepare_data</span>();</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_queue.<span class="built_in">push</span>(data);</span><br><span class="line">        data_cond.<span class="built_in">notify_one</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">data_preocessing_thread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_cond.<span class="built_in">wait</span>(lock, []&#123; <span class="comment">// (1) åœ¨è¿™ä¸Šé” ç±»ä¼¼ try_lock</span></span><br><span class="line">            <span class="keyword">return</span> !data_queue.<span class="built_in">empty</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        data_chunk data = data_queue.<span class="built_in">front</span>();</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        lock.<span class="built_in">unlock</span>();	<span class="comment">// (2) è®°å¾—è§£é”</span></span><br><span class="line">        <span class="built_in">process</span>(data);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">is_last_chunk</span>(data))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ (1) ä¸­ï¼Œå¦‚æœæ¡ä»¶ä¸æ»¡è¶³(<code>lambda</code> è¿”å› <code>false</code>)ï¼Œ<code>wait()</code> å‡½æ•°å°†è§£é”äº’æ–¥é‡ï¼Œå¹¶å°†è¿™ä¸ªçº¿ç¨‹ç½®äºé˜»å¡æˆ–ç­‰å¾…çŠ¶æ€ã€‚</p>
<p>å½“åœ¨ <code>data_preparation_thread</code> ä¸­è°ƒç”¨ <code>notify_one</code> é€šçŸ¥æ¡ä»¶å˜é‡ä¹‹åï¼Œå¤„ç†æ•°æ®çš„çº¿ç¨‹ä»ç¡çœ çŠ¶æ€ä¸­è‹é†’ï¼Œé‡æ–°è·å¾—äº’æ–¥é”ï¼Œå¹¶ä¸”å¯¹æ¡ä»¶å†æ¬¡æ£€æŸ¥ï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œçº¿ç¨‹å°†å¯¹äº’æ–¥é‡è§£é”ï¼Œå¹¶ä¸”é‡æ–°å¼€å§‹ç­‰å¾…ï¼Œå½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œä» <code>wait()</code> è¿”å›å¹¶ç»§ç»­æŒæœ‰é”ã€‚</p>
<blockquote>
<p>æ³¨æ„åœ¨å”¤é†’ä¹‹åéœ€è¦å†æ¬¡æ£€æŸ¥æ¡ä»¶ï¼Œå› ä¸ºå¯èƒ½è¿˜æœ‰å…¶ä»–çº¿ç¨‹ä¹Ÿè¢«å”¤é†’ï¼Œæ­¤æ—¶ä¼šæœ‰ç«äº‰ã€‚è¿™å°±æ˜¯æ‰€è°“çš„**ä¼ªå”¤é†’(spurious wakeup)**ï¼Œ</p>
</blockquote>
<p>è¿™ä¹Ÿæ˜¯ä¸ºç”šä¹ˆè¦ä½¿ç”¨ <code>std::unique_lock</code> è€Œä¸æ˜¯ <code>std::lock_guard</code> çš„åŸå›  â€”â€” ç­‰å¾…ä¸­çš„çº¿ç¨‹å¿…é¡»åœ¨ç­‰å¾…æœŸé—´è§£é”äº’æ–¥é‡ï¼Œå¹¶åœ¨è¿™ä¹‹åå¯¹äº’æ–¥é‡å†æ¬¡ä¸Šé”ï¼Œè€Œ <code>std::lock_guard</code> æ²¡æœ‰è¿™ä¹ˆçµæ´»ã€‚</p>
<blockquote>
<p>å…¶å®è¿™ä¹Ÿè¯´æ˜äº† <code>std::unique_lock</code> çš„ä¸»è¦ç”¨é€” â€”â€” å’Œ <code>std::condition_variable</code> é…åˆä½¿ç”¨ï¼Œåšåˆ°å¤šæ¬¡ <code>lock()</code> å’Œ <code>unlock()</code>ã€‚</p>
</blockquote>
<h4 id="4-1-3-thread-safety-queue"><a href="#4-1-3-thread-safety-queue" class="headerlink" title="4.1.3 thread safety queue"></a>4.1.3 thread safety queue</h4><p><code>std::queue</code> æ¥å£</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">T</span>, <span class="keyword">class</span> <span class="title class_">Container</span> = std::deque&lt;T&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> queue</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">queue</span>(<span class="type">const</span> Container&amp;);</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">queue</span><span class="params">(Container&amp;&amp; = Container())</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Alloc</span>&gt; <span class="function"><span class="keyword">explicit</span> <span class="title">queue</span><span class="params">(<span class="type">const</span> Alloc&amp;)</span></span>;</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Alloc</span>&gt; <span class="built_in">queue</span>(<span class="type">const</span> Container&amp;, <span class="type">const</span> Alloc&amp;);</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Alloc</span>&gt; <span class="built_in">queue</span>(Container&amp;&amp;, <span class="type">const</span> Alloc&amp;);</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">Alloc</span>&gt; <span class="built_in">queue</span>(queue&amp;&amp;, <span class="type">const</span> Alloc&amp;);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(queue &amp;q)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span> </span>;</span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span> </span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">T&amp; <span class="title">front</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> T&amp; <span class="title">front</span><span class="params">()</span> <span class="type">const</span> </span>;</span><br><span class="line">    <span class="function">T&amp; <span class="title">back</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">const</span> T&amp; <span class="title">back</span><span class="params">()</span> <span class="type">const</span> </span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(<span class="type">const</span> T&amp; x)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T&amp;&amp; x)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pop</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">class</span>... Args&gt; <span class="type">void</span> <span class="title">emplace</span><span class="params">(Args&amp;&amp;... args)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadsafe_queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex mut; <span class="comment">// äº’æ–¥é‡å¿…é¡»æ˜¯å¯å˜çš„</span></span><br><span class="line">    std::queue&lt;T&gt; data_queue;</span><br><span class="line">    std::condition_variable data_cond;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadsafe_queue</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">threadsafe_queue</span>(<span class="type">const</span> threadsafe_queue&amp; other)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;std::mutex&gt; <span class="title">my_lock</span><span class="params">(mut)</span></span>;    <span class="comment">// ä¸ºä»€ä¹ˆä¸å¯¹è‡ªå·±ä¸Šé”å‘¢ï¼Ÿ</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(other.mut)</span></span>;</span><br><span class="line">        data_queue = other.data_queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">threadsafe_queue</span>(threadsafe_queue&amp;&amp; other) <span class="comment">// è‡ªå·±å†™çš„ï¼Œå¯èƒ½æœ‰è¯¯ï¼Ÿ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">lock_guard&lt;std::mutex&gt; <span class="title">my_lock</span><span class="params">(mut)</span></span>;    <span class="comment">// ä¸ºä»€ä¹ˆä¸å¯¹è‡ªå·±ä¸Šé”å‘¢ï¼Ÿ</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(other.mut)</span></span>;</span><br><span class="line">        data_queue = <span class="built_in">move</span>(other.data_queue);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    threadsafe_queue&amp; <span class="keyword">operator</span>=(<span class="type">const</span> threadsafe_queue&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T new_value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_queue.<span class="built_in">push</span>(new_value);</span><br><span class="line">        data_cond.<span class="built_in">notify_one</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">try_pop</span><span class="params">(T &amp;value)</span> <span class="comment">// é€šè¿‡ä¼ å¼•ç”¨è·å¾— front å¹¶ pop</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// é˜²æ­¢ front-pop æ¥å£ä¹‹é—´å­˜åœ¨çš„ç«äº‰æ¡ä»¶</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data_queue.<span class="built_in">empty</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        value = data_queue.<span class="built_in">front</span>(); <span class="comment">// get value</span></span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">try_pop</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data_queue.<span class="built_in">empty</span>())</span><br><span class="line">            <span class="keyword">return</span> std::<span class="built_in">shared_ptr</span>&lt;T&gt;();    <span class="comment">// NULL</span></span><br><span class="line">        <span class="function">std::shared_ptr&lt;T&gt; <span class="title">res</span><span class="params">(std::make_shared&lt;T&gt;(data_queue.front()))</span></span>;</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wait_and_pop</span><span class="params">(T &amp;value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_cond.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>]&#123;</span><br><span class="line">            <span class="keyword">return</span> !data_queue.<span class="built_in">empty</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        value = data_queue.<span class="built_in">front</span>();</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">wait_and_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_cond.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>]&#123;</span><br><span class="line">            <span class="keyword">return</span> !data_queue.<span class="built_in">empty</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        std::shared_ptr&lt;T&gt; res = (std::<span class="built_in">make_shared</span>&lt;T&gt;(data_queue.<span class="built_in">front</span>()));</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> data_queue.<span class="built_in">empty</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">size_t</span> <span class="title">size</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> data_queue.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line"></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒä¹‹å‰æåˆ°çš„ä¸€æ ·ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œ <code>front()-pop()</code> æ—¶ï¼Œä¼šæœ‰æ¥å£ä¹‹é—´çš„æ¡ä»¶ç«äº‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†è¿™ä¸¤ä¸ªå‡½æ•°æ”¾åˆ°åŒä¸€ä¸ªå‡½æ•°ä¸­ã€‚</p>
<h3 id="4-2-future"><a href="#4-2-future" class="headerlink" title="4.2 future"></a>4.2 future</h3><h4 id="4-2-1-introdece"><a href="#4-2-1-introdece" class="headerlink" title="4.2.1 introdece"></a>4.2.1 introdece</h4><p>C++ æ ‡å‡†åº“æ¨¡å‹å°†è¿™ç§ä¸€æ¬¡æ€§äº‹ä»¶æˆä¸º**æœŸæœ›(future)**ã€‚å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œè¿™ä¸ªâ€œæœŸæœ›â€å°±ä¸èƒ½è¢«é‡ç½®ã€‚</p>
<p>åœ¨C++æ ‡å‡†åº“ä¸­ï¼Œæœ‰ä¸¤ç§â€œæœŸæœ›â€ï¼Œä½¿ç”¨ä¸¤ç§ç±»å‹æ¨¡æ¿å®ç°ï¼Œå£°æ˜åœ¨å¤´æ–‡ä»¶ä¸­: å”¯ä¸€<em>æœŸæœ›</em>(unique futures)(<code>std::future&lt;&gt;</code>)å’Œ<em>å…±äº«æœŸæœ›</em>(shared futures)(<code>std::shared_future&lt;&gt;</code>)ã€‚è¿™æ˜¯ä»¿ç…§<code>std::unique_ptr</code>å’Œ<code>std::shared_ptr</code>ã€‚<code>std::future</code>çš„å®ä¾‹åªèƒ½ä¸ä¸€ä¸ªæŒ‡å®šäº‹ä»¶ç›¸å…³è”ï¼Œè€Œ<code>std::shared_future</code>çš„å®ä¾‹å°±èƒ½å…³è”å¤šä¸ªäº‹ä»¶ã€‚åè€…çš„å®ç°ä¸­ï¼Œæ‰€æœ‰å®ä¾‹ä¼šåœ¨åŒæ—¶å˜ä¸ºå°±ç»ªçŠ¶æ€ï¼Œå¹¶ä¸”ä»–ä»¬å¯ä»¥è®¿é—®ä¸äº‹ä»¶ç›¸å…³çš„ä»»ä½•æ•°æ®ã€‚è¿™ç§æ•°æ®å…³è”ä¸æ¨¡æ¿æœ‰å…³ï¼Œæ¯”å¦‚<code>std::unique_ptr</code> å’Œ<code>std::shared_ptr</code>çš„æ¨¡æ¿å‚æ•°å°±æ˜¯ç›¸å…³è”çš„æ•°æ®ç±»å‹ã€‚åœ¨ä¸æ•°æ®æ— å…³çš„åœ°æ–¹ï¼Œå¯ä»¥ä½¿ç”¨<code>std::future&lt;void&gt;</code>ä¸<code>std::shared_future&lt;void&gt;</code>çš„ç‰¹åŒ–æ¨¡æ¿ã€‚è™½ç„¶ï¼Œæˆ‘å¸Œæœ›ç”¨äºçº¿ç¨‹é—´çš„é€šè®¯ï¼Œä½†æ˜¯â€œæœŸæœ›â€å¯¹è±¡æœ¬èº«å¹¶ä¸æä¾›åŒæ­¥è®¿é—®ã€‚å½“å¤šä¸ªçº¿ç¨‹éœ€è¦è®¿é—®ä¸€ä¸ªç‹¬ç«‹â€œæœŸæœ›â€å¯¹è±¡æ—¶ï¼Œä»–ä»¬å¿…é¡»ä½¿ç”¨äº’æ–¥é‡æˆ–ç±»ä¼¼åŒæ­¥æœºåˆ¶å¯¹è®¿é—®è¿›è¡Œä¿æŠ¤ï¼Œå¦‚åœ¨ç¬¬3ç« æåˆ°çš„é‚£æ ·ã€‚ä¸è¿‡ï¼Œåœ¨ä½ å°†è¦é˜…è¯»åˆ°çš„4.2.5èŠ‚ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹ä¼šå¯¹ä¸€ä¸ª<code>std::shared_future&lt;&gt;</code>å®ä¾‹çš„å‰¯æœ¬è¿›è¡Œè®¿é—®ï¼Œè€Œä¸éœ€è¦æœŸæœ›åŒæ­¥ï¼Œå³ä½¿ä»–ä»¬æ˜¯åŒä¸€ä¸ªå¼‚æ­¥ç»“æœã€‚</p>
<p>æœ€åŸºæœ¬çš„ä¸€æ¬¡æ€§äº‹ä»¶ï¼Œå°±æ˜¯ä¸€ä¸ªåå°è¿è¡Œå‡ºçš„è®¡ç®—ç»“æœã€‚åœ¨ç¬¬2ç« ä¸­ï¼Œä½ å·²ç»äº†è§£äº†<code>std::thread</code> æ‰§è¡Œçš„ä»»åŠ¡ä¸èƒ½æœ‰è¿”å›å€¼ï¼Œå¹¶ä¸”æˆ‘èƒ½ä¿è¯ï¼Œè¿™ä¸ªé—®é¢˜å°†åœ¨ä½¿ç”¨â€œæœŸæœ›â€åè§£å†³â€”â€”ç°åœ¨å°±æ¥çœ‹çœ‹æ˜¯æ€ä¹ˆè§£å†³çš„ã€‚</p>
<h4 id="4-2-2-background-task-with-return-value-â€”-async"><a href="#4-2-2-background-task-with-return-value-â€”-async" class="headerlink" title="4.2.2 background task with return value â€” async"></a>4.2.2 background task with return value â€” async</h4><p>å‡è®¾ï¼Œä½ ç°åœ¨æœ‰ä¸€ä¸ªéœ€è¦é•¿æ—¶é—´çš„è¿ç®—ï¼Œä½ éœ€è¦èƒ½è®¡ç®—å‡ºä¸€ä¸ªæœ‰æ•ˆçš„å€¼ï¼Œä½†æ˜¯ä½ ç°åœ¨å¹¶ä¸è¿«åˆ‡éœ€è¦è¿™ä¸ªå€¼ã€‚å› ä¸º <code>std::thread</code> å¹¶ä¸æä¾›æ¥å—è¿”å›å€¼çš„æœºåˆ¶ï¼Œè¿™é‡Œå°±éœ€è¦ <code>std::async</code> å‡½æ•°æ¨¡æ¿ï¼ˆä¹Ÿå°±æ˜¯åœ¨ <code>&lt;future&gt;</code> ä¸­å£°æ˜ï¼‰</p>
<p>å½“ä¸ç€æ€¥å¾—åˆ°ä»»åŠ¡çš„ç»“æœæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>std::async</code> å¯åŠ¨ä¸€ä¸ª<strong>å¼‚æ­¥</strong>ä»»åŠ¡ï¼Œä¸ <code>std::thread</code> å¯¹è±¡ç­‰å¾…çš„æ–¹å¼ä¸åŒï¼Œ<code>std::async</code> ä¼šè¿”å›ä¸€ä¸ª <code>std::future</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æŒæœ‰æœ€ç»ˆè®¡ç®—å‡ºæ¥çš„ç»“æœï¼Œä½ åªéœ€è¦è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„ <code>get()</code> æˆå‘˜å‡½æ•°ï¼›å¹¶ä¸”ä¼šé˜»å¡çº¿ç¨‹ç›´åˆ°â€œæœŸæœ›â€çŠ¶æ€æœªå°±ç»ªä¸ºæ­¢ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find_the_answer_to_ltuae</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">/* do something */</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; the_answer = std::<span class="built_in">async</span>(find_the_answer_to_ltuae);</span><br><span class="line">    <span class="comment">/* do something */</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;The answer is &quot;</span> &lt;&lt; the_answer.<span class="built_in">get</span>() &lt;&lt; std::endl;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ <code>std::thread</code> æ–¹å¼ä¸€æ ·ï¼Œ<code>std::async</code> å…è®¸é€šè¿‡æ·»åŠ é¢å¤–çš„è°ƒç”¨å‚æ•°ï¼Œæƒ³å‡½æ•°ä¼ é€’é¢å¤–çš„å‚æ•°ã€‚</p>
<p>ä¾‹å¦‚ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘æˆå‘˜å‡½æ•°çš„æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æä¾›è¿™ä¸ªå‡½æ•°æˆå‘˜ç±»çš„å…·ä½“å¯¹è±¡ã€‚</p>
<p>å’Œ <code>std::thread</code> ä¸€æ ·ï¼Œå½“å‚æ•°æ˜¯å³å€¼æ—¶ï¼Œæ‹·è´æ“ä½œå°†ä½¿ç”¨ç§»åŠ¨çš„æ–¹å¼è½¬ç§»åŸå§‹æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬è¿˜å¯ä»¥åœ¨è°ƒç”¨ä¹‹å‰å‘ <code>std::async</code> ä¼ é€’ä¸€ä¸ªé¢å¤–å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°çš„ç±»å‹æ˜¯ <code>std::launch</code>ï¼Œå®ƒæä¾›äº†ä¸¤ç§ç­–ç•¥å¯ä¾›é€‰æ‹©ï¼š</p>
<ul>
<li><code>std::launch::async</code> ï¼šåœ¨è°ƒç”¨ <code>std::async</code> ä¹‹åå°±å¼€å§‹åˆ›å»ºçº¿ç¨‹</li>
<li><code>std::launch::deferred</code> ï¼š å»¶è¿ŸåŠ è½½æ–¹å¼åˆ›å»ºçº¿ç¨‹ã€‚è°ƒç”¨ <code>std::async</code> ä¸åˆ›å»ºçº¿ç¨‹ï¼Œç›´åˆ°è°ƒç”¨äº† <code>future</code> çš„ <code>get()</code> æˆ–è€… <code>wait()</code> æ—¶æ‰åˆ›å»ºçº¿ç¨‹ã€‚ï¼ˆ<strong>lazy calculate</strong>ï¼‰</li>
</ul>
<p>é»˜è®¤ç­–ç•¥æ˜¯ <code>std::launch::async | std::launch::deferred</code></p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">X</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> i, <span class="type">const</span> std::string&amp; s)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        i ++ ;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; s &lt;&lt; <span class="string">&quot;] id: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::string <span class="title">bar</span><span class="params">(<span class="type">const</span> std::string&amp; s)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; s &lt;&lt; <span class="string">&quot;] id: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; x;</span><br><span class="line"></span><br><span class="line"><span class="comment">// f1 å’Œ f2 å¯èƒ½åœ¨ main ç»“æŸä¹‹åæ‰æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡æŒ‡å‘ x çš„æŒ‡é’ˆè°ƒç”¨ foo</span></span><br><span class="line"><span class="keyword">auto</span> f1 = std::<span class="built_in">async</span>(&amp;X::foo, &amp;x, <span class="number">42</span>, <span class="string">&quot;f1&quot;</span>);</span><br><span class="line"><span class="comment">// é€šè¿‡ x çš„æ‹·è´è°ƒç”¨ bar</span></span><br><span class="line"><span class="keyword">auto</span> f2 = std::<span class="built_in">async</span>(&amp;X::bar, x, <span class="string">&quot;f2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*=============================================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Y</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::string <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> std::string s)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// std::cout &lt;&lt; d &lt;&lt; std::endl;</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; s &lt;&lt; <span class="string">&quot;] id: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; y;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ y çš„ç§»åŠ¨æ„é€ å‡½æ•°è°ƒç”¨ operator()</span></span><br><span class="line"><span class="keyword">auto</span> f3 = std::<span class="built_in">async</span>(<span class="built_in">Y</span>(), <span class="string">&quot;f3&quot;</span>);</span><br><span class="line"><span class="comment">// é€šè¿‡ y çš„å¼•ç”¨è°ƒç”¨ operator()</span></span><br><span class="line"><span class="keyword">auto</span> f4 = std::<span class="built_in">async</span>(std::<span class="built_in">ref</span>(y), <span class="string">&quot;f4&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*=============================================*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">move_only</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">move_only</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">move_only</span>(move_only&amp;&amp;) = <span class="keyword">default</span>;</span><br><span class="line">    <span class="built_in">move_only</span>(<span class="type">const</span> move_only&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    move_only&amp; <span class="keyword">operator</span>=(move_only&amp;&amp;) = <span class="keyword">default</span>;</span><br><span class="line">    move_only&amp; <span class="keyword">operator</span>=(<span class="type">const</span> move_only&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> std::string s)</span> </span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; s &lt;&lt; <span class="string">&quot;] id: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Move only!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> f5 = std::<span class="built_in">async</span>(<span class="built_in">move_only</span>(), <span class="string">&quot;f5&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*=============================================*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨æ–°çº¿ç¨‹ä¸Šæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">auto</span> f6 = std::<span class="built_in">async</span>(std::launch::async, <span class="built_in">Y</span>(), <span class="string">&quot;f6&quot;</span>);</span><br><span class="line"><span class="comment">// åœ¨ wait() æˆ– get() è°ƒç”¨æ—¶æ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">auto</span> f7 = std::<span class="built_in">async</span>(std::launch::deferred, &amp;X::bar, std::<span class="built_in">ref</span>(x), <span class="string">&quot;f7&quot;</span>);</span><br><span class="line"><span class="comment">// å®ç°é€‰æ‹©æ‰§è¡Œæ–¹å¼</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> std::string s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;[&quot;</span> &lt;&lt; s &lt;&lt; <span class="string">&quot;] id: &quot;</span> &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">auto</span> f8 = std::<span class="built_in">async</span>(std::launch::deferred | std::launch::async, f, <span class="string">&quot;f8&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="comment">// f7.wait();</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;main: &quot;</span> &lt;&lt; hex &lt;&lt; std::this_thread::<span class="built_in">get_id</span>() &lt;&lt; endl;</span><br><span class="line">    <span class="comment">// f8.get();</span></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>std::future</code> æœ‰ä¸‰ç§çŠ¶æ€ï¼š</p>
<ul>
<li><code>future_status::deferred</code>ï¼šå¼‚æ­¥æ“ä½œè¿˜æœªå®Œæˆ</li>
<li><code>future_status::ready</code> ï¼šå¼‚æ­¥æ“ä½œå·²ç»å®Œæˆ</li>
<li><code>future_status::timeout</code> ï¼šå¼‚æ­¥æ“ä½œè¶…æ—¶ï¼Œä¸»è¦ç”¨äº <code>std::future&lt;T&gt;.wait_for()</code></li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;step1&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;step2&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;step3&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    std::future_status status;</span><br><span class="line">    <span class="keyword">auto</span> f = std::<span class="built_in">async</span>(std::launch::deferred ,process);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        status = f.<span class="built_in">wait_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span>(status == std::future_status::deferred) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;deferred&quot;</span> &lt;&lt; endl;</span><br><span class="line">            <span class="comment">// f.wait();</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(status == std::future_status::timeout) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;timeout&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(status == std::future_status::ready) &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;ready&quot;</span> &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(status != std::future_status::ready);</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039083151">reference</a></p>
</blockquote>
<h4 id="4-2-3-task-and-future"><a href="#4-2-3-task-and-future" class="headerlink" title="4.2.3 task and future"></a>4.2.3 task and future</h4><p><code>std::packaged_task&lt;&gt;</code> ä¼šå°† <code>future</code> ä¸å‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡è¿›è¡Œç»‘å®šã€‚å½“è°ƒç”¨ <code>package_task&lt;&gt;</code> æ—¶ï¼Œå°±ä¼šè°ƒç”¨ç›¸å…³å‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡ï¼Œå½“ <code>future</code> çŠ¶æ€æœªå°±ç»ªæ—¶ï¼Œä¼šå­˜å‚¨è¿”å›å€¼ã€‚</p>
<p><code>std::packaged_task&lt;&gt;</code> çš„æ¨¡æ¿å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ç­¾åã€‚æˆ‘ä»¬ä¼ å…¥å¯¹è±¡çš„ç­¾åå¯ä»¥ä¸æ¨¡æ¿å‚æ•°ä¸­æŒ‡å®šçš„ç­¾åä¸ä¸€è‡´ï¼Œä½†æ˜¯å¿…é¡»èƒ½éšå¼è½¬æ¢åˆ°ç›®æ ‡ç±»å‹ã€‚</p>
<p>ä¾‹å¦‚ï¼Œä¸€ç§ä¾¿ç‰¹åŒ–çš„ <code>packaged_task</code> çš„æ„ä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">packaged_task</span>&lt;std::<span class="built_in">string</span>(std::vector&lt;<span class="type">char</span>*&gt;, <span class="type">int</span>)&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Callable&gt;</span></span><br><span class="line"><span class="function">    <span class="keyword">explicit</span> <span class="title">packaged_task</span><span class="params">(Callable &amp;&amp;f)</span></span>;</span><br><span class="line">    <span class="function">std::future&lt;std::string&gt; <span class="title">get_future</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(std::vector&lt;<span class="type">char</span>*&gt;, <span class="type">int</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>std::packaged_task</code> æ˜¯ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå¯ä»¥å°è£…åœ¨ <code>std::function</code> å¯¹è±¡ä¸­ï¼Œä»è€Œä½œä¸ºæ±‰åŸå‡½æ•°ä¼ é€’åˆ° <code>std::thread</code> å¯¹è±¡ä¸­ï¼Œæˆ–ä½œä¸ºå¯è°ƒç”¨ç‰©å¯¹è±¡ä¼ é€’åˆ°å¦ä¸€ä¸ªå‡½æ•°ä¸­æˆ–ç›´æ¥è°ƒç”¨ã€‚</p>
<p>ä¾‹å­1ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;deque&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line">std::mutex m;</span><br><span class="line">std::deque&lt;std::packaged_task&lt;<span class="type">void</span>()&gt; &gt; tasks;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">gui_shutdown_message_received</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_and_process_gui_message</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gui_thread</span><span class="params">()</span>  <span class="comment">// 1</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span>(!<span class="built_in">gui_shutdown_message_received</span>())  <span class="comment">// 2</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">get_and_process_gui_message</span>();  <span class="comment">// 3</span></span><br><span class="line">    std::packaged_task&lt;<span class="built_in">void</span>()&gt; task;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(m)</span></span>;</span><br><span class="line">      <span class="keyword">if</span>(tasks.<span class="built_in">empty</span>())  <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      task=std::<span class="built_in">move</span>(tasks.<span class="built_in">front</span>());  <span class="comment">// 5</span></span><br><span class="line">      tasks.<span class="built_in">pop_front</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">task</span>();  <span class="comment">// 6</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">std::thread <span class="title">gui_bg_thread</span><span class="params">(gui_thread)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Func&gt;</span></span><br><span class="line"><span class="function">std::future&lt;<span class="type">void</span>&gt; <span class="title">post_task_for_gui_thread</span><span class="params">(Func f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">std::packaged_task&lt;<span class="title">void</span><span class="params">()</span>&gt; <span class="title">task</span><span class="params">(f)</span></span>;  <span class="comment">// 7</span></span><br><span class="line">  std::future&lt;<span class="type">void</span>&gt; res=task.<span class="built_in">get_future</span>();  <span class="comment">// 8</span></span><br><span class="line">  <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(m)</span></span>;  <span class="comment">// 9</span></span><br><span class="line">  tasks.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(task));  <span class="comment">// 10</span></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c++ reference ä¸Šçš„ä¾‹å­ 2ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">my_add</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> </span>&#123; <span class="keyword">return</span> x + y; &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">task_lambda</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>&gt; <span class="title">task</span><span class="params">([](<span class="type">int</span> a, <span class="type">int</span> b)&#123;</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">return</span> a + b;</span></span></span><br><span class="line"><span class="params"><span class="function">    &#125;)</span></span>;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; res = task.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="built_in">task</span>(<span class="number">2</span>, <span class="number">9</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;task_lambda: &quot;</span> &lt;&lt; res.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">task_bind</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// æ³¨æ„ä¸‹é¢packaged_taskçš„å‡½æ•°ç­¾åå¯¹åº”çš„å‚æ•°è¦ä¸bindå¯¹åº” </span></span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">()</span>&gt; <span class="title">task</span><span class="params">(std::bind(my_add, <span class="number">2</span>, <span class="number">11</span>))</span></span>;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; res = task.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="built_in">task</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;task_bind: &quot;</span> &lt;&lt; res.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">task_thread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">int</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>&gt; <span class="title">task</span><span class="params">(my_add)</span></span>;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; res = task.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="comment">// move åˆ°çº¿ç¨‹å½“ä¸­</span></span><br><span class="line">    <span class="function">std::thread <span class="title">task_td</span><span class="params">(std::move(task), <span class="number">2</span>, <span class="number">9</span>)</span></span>;</span><br><span class="line">    task_td.<span class="built_in">join</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;task_thread: &quot;</span> &lt;&lt; res.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">task_lambda</span>();</span><br><span class="line">    <span class="built_in">task_lambda</span>();</span><br><span class="line">    <span class="built_in">task_thread</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šä¸€ä¸‹ï¼š<code>std::future&lt;int&gt; result = task.get_future();</code> è¿™æ¡è¯­å¥å¹¶ä¸ä¼šå¯¼è‡´ <code>task</code> å°è£…çš„å¯è°ƒç”¨å¯¹è±¡çš„æ‰§è¡Œï¼Œå®ƒä»…ä»…æ˜¯å°† <code>task</code> çš„è¿”å›å€¼å­˜å‚¨åˆ° <code>result</code> è¿™ä¸ªå¯¹è±¡å½“ä¸­ã€‚</p>
<blockquote>
<p>å‚è€ƒï¼š </p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/611029683">Zhihu</a></p>
<p><a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/thread/packaged_task">Cpp-reference</a></p>
</blockquote>
<h4 id="4-2-4-std-promises"><a href="#4-2-4-std-promises" class="headerlink" title="4.2.4 std::promises"></a>4.2.4 std::promises</h4><p>cppreference ä¾‹1:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">accumulate</span><span class="params">(std::vector&lt;<span class="type">int</span>&gt;::iterator first, std::vector&lt;<span class="type">int</span>&gt;::iterator last, </span></span></span><br><span class="line"><span class="params"><span class="function">                std::promise&lt;<span class="type">int</span>&gt; accumulate_promise)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> sum = std::<span class="built_in">accumulate</span>(first, last, <span class="number">0</span>);</span><br><span class="line">    accumulate_promise.<span class="built_in">set_value</span>(sum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_work</span><span class="params">(std::promise&lt;<span class="type">void</span>&gt; barrier)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">1</span>));</span><br><span class="line">    barrier.<span class="built_in">set_value</span>(); <span class="comment">// æ³¨é‡Šæ‰æ”¹è¡Œä¸ä¼šé˜»å¡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; numbers&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;;</span><br><span class="line"></span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; accumulate_promise;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; accumulate_future = accumulate_promise.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="comment">// åŠ ä¸Š :: ï¼Œé˜²æ­¢è¯†åˆ«ä¸º std::accumulate</span></span><br><span class="line">    <span class="function">std::thread <span class="title">work_thread</span><span class="params">(::accumulate, numbers.begin(), numbers.end(), std::move(accumulate_promise))</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// future::get() å°†ç­‰å¾…ç›´è‡³è¯¥ future æ‹¥æœ‰åˆæ³•ç»“æœå¹¶å–å¾—å®ƒ</span></span><br><span class="line">    <span class="comment">// æ— éœ€åœ¨ get() å‰è°ƒç”¨ wait()</span></span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Result: &quot;</span> &lt;&lt; accumulate_future.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    work_thread.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨ primise&lt;void&gt; åœ¨çº¿ç¨‹é—´å¯¹çŠ¶æ€å‘ä¿¡å·</span></span><br><span class="line">    std::promise&lt;<span class="type">void</span>&gt; barrier;</span><br><span class="line">    std::future&lt;<span class="type">void</span>&gt; barrier_future = barrier.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="function">std::thread <span class="title">new_work_thread</span><span class="params">(do_work, std::move(barrier))</span></span>;</span><br><span class="line">    barrier_future.<span class="built_in">wait</span>();</span><br><span class="line">    new_work_thread.<span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¾‹2: çº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::promise&lt;<span class="type">int</span>&gt; promise = std::<span class="built_in">promise</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> t1 = std::<span class="built_in">thread</span>([&amp;promise]&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread running\n&quot;</span>;</span><br><span class="line">        <span class="comment">// do something ~</span></span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(chrono::<span class="built_in">seconds</span>(<span class="number">2</span>)); </span><br><span class="line"></span><br><span class="line">        <span class="comment">// write data and invoke the threads which are waiting for that</span></span><br><span class="line">        promise.<span class="built_in">set_value</span>(<span class="number">42</span>);	<span class="comment">// æ³¨é‡Šæ‰æ”¹è¡Œä¼šé˜»å¡</span></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread end\n&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// block until get value</span></span><br><span class="line">    cout &lt;&lt; promise.<span class="built_in">get_future</span>().<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>[TODO]</strong></p>
<p>åœ¨è¿™é‡Œæˆ‘å‘ç°äº†ä¸€ä¸ªç¥å¥‡çš„äº‹æƒ…ï¼Œå¦‚æœæ˜¯æŒ‰ç…§ä¸Šé¢çš„å½¢å¼ï¼ˆä¾‹2ï¼‰å³ï¼Œlambda è¡¨è¾¾å¼çš„å½¢å¼åˆ›å»ºçº¿ç¨‹ï¼Œå¦‚æœä¸ set_value() çš„è¯ï¼Œfuture::wait() ä¼šä¸€ç›´ç­‰å¾…ï¼Œè€Œä½¿ç”¨æ˜¾å¼çš„å‡½æ•°åˆ™ä¸ä¼šï¼ˆä¾‹1ï¼‰ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
</blockquote>
<blockquote>
<p>å‚è€ƒï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/6300e02d0625#">JianShu</a></p>
<p><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/thread/promise">Cpp-reference</a></p>
</blockquote>
<h4 id="4-2-5-exception-and-future"><a href="#4-2-5-exception-and-future" class="headerlink" title="4.2.5 exception and future"></a>4.2.5 exception and future</h4><p>å¦‚æœæˆ‘ä»¬æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™ä¸ªå¼‚å¸¸ä¼šå­˜å‚¨åˆ° <code>future</code> ä¸­ï¼Œç„¶å <code>future</code> çš„çŠ¶æ€è®¾ç½®ä¸º <code>ready</code>ï¼Œä¹‹åè°ƒç”¨ <code>get()</code> ä¼šæŠ›å‡ºå·²å­˜å‚¨çš„å¼‚å¸¸ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼æ ‡å‡†å¹¶æœªè§„å®šé‡æ–°æŠ›å‡ºçš„è¿™ä¸ªå¼‚å¸¸æ˜¯åŸå¯¹è±¡è¿˜æ˜¯ä¸€ä»½æ‹·è´ï¼Œè¿™å–å†³äºå±±è¥¿iå®‰</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">my_sqrt</span><span class="params">(<span class="type">double</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;out of range ^ ^\n&quot;</span>;</span><br><span class="line">        <span class="keyword">throw</span> std::<span class="built_in">out_of_range</span>(<span class="string">&quot;x &lt; 0&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sqrt</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å°† promise ä¸ future ç»‘å®šèµ·æ¥</span></span><br><span class="line">    std::promise&lt;<span class="type">double</span>&gt; promise;</span><br><span class="line">    std::future&lt;<span class="type">double</span>&gt; future = promise.<span class="built_in">get_future</span>();</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;pls input a number: &quot;</span>;</span><br><span class="line">        <span class="type">double</span> x;       </span><br><span class="line">        cin &gt;&gt; x;</span><br><span class="line">        promise.<span class="built_in">set_value</span>(<span class="built_in">my_sqrt</span>(x));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(<span class="type">const</span> exception &amp;e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// promise.set_exception(current_exception());</span></span><br><span class="line">        promise.<span class="built_in">set_exception</span>(std::<span class="built_in">make_exception_ptr</span>(<span class="built_in">logic_error</span>(<span class="string">&quot;sqrt() error ^ ^&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; future.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="4-2-6-waiting-of-multiple-thread"><a href="#4-2-6-waiting-of-multiple-thread" class="headerlink" title="4.2.6 waiting of multiple thread"></a>4.2.6 waiting of multiple thread</h4><p>å¦‚æœå¹¶è¡Œä»£ç æ²¡åŠæ³•è®©å¤šä¸ªçº¿ç¨‹ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶ï¼Œ <code>std::shared_future </code>å¯ä»¥å¸®ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å› ä¸º<code>future</code>æ˜¯åª <strong>move</strong> çš„ï¼Œæ‰€ä»¥å…¶æ‰€æœ‰æƒå¯ä»¥åœ¨ä¸åŒçš„å®ä¾‹ä¸­äº’ç›¸ä¼ é€’ï¼Œä½†åªæœ‰ä¸€ä¸ªå®ä¾‹å¯ä»¥è·å¾—ç‰¹å®šçš„åŒæ­¥ç»“æœï¼Œè€Œ <code>std::shared_future</code>å®ä¾‹æ˜¯å¯ <strong>copy</strong> çš„ï¼Œæ‰€ä»¥å¤šä¸ªå¯¹è±¡å¯ä»¥å¼•ç”¨åŒä¸€å…³è”æœŸæœ›å€¼çš„ç»“æœã€‚</p>
<p>ä¾‹: std::shared_future</p>
<p><code>std::shared_future</code> é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«ä¸€ä¸ª <code>std::shared_future</code>ã€‚å¯ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ä¼ é€’æ•°æ®ç»™å¤šä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œå¤šä¸ªçº¿ç¨‹åœ¨è‡ªèº«çš„çº¿ç¨‹ç©ºé—´å†…é€šè¿‡ <code>std::shared_future</code> å…±äº«ä¸€ä¸ª <code>future</code>ï¼Œè¿™æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::literals;</span><br><span class="line">    <span class="keyword">auto</span> promise = std::<span class="built_in">promise</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> t1 = std::<span class="built_in">thread</span>([&amp;promise]&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread 1 running\n&quot;</span>;</span><br><span class="line">        std::this_thread::<span class="built_in">sleep_for</span>(std::chrono::<span class="built_in">seconds</span>(<span class="number">4</span>));</span><br><span class="line">        <span class="comment">// å†™å…¥æ•°æ®ï¼Œè¿™å›å”¤é†’é‚£äº›æ­£åœ¨ç­‰å¾…æ•°æ®çš„çº¿ç¨‹</span></span><br><span class="line">        promise.<span class="built_in">set_value</span>(<span class="number">42</span>);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread 1 end\n&quot;</span>; </span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> shared_future = std::<span class="built_in">shared_future</span>&lt;<span class="type">int</span>&gt;(promise.<span class="built_in">get_future</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> t2 = std::<span class="built_in">thread</span>([shared_future]&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread 2 running\n&quot;</span>;</span><br><span class="line">        <span class="comment">// è·å–æ•°æ®ï¼Œå¦‚æœæ•°æ®è¿˜æ²¡å‡†å¤‡å¥½å°±ä¼šé˜»å¡</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œä½¿ç”¨ std::printf è€Œä¸æ˜¯ std::cout æ˜¯ä¸ºäº†ä¿è¯è¾“å‡ºåœ¨åŒä¸€è¡Œ</span></span><br><span class="line">        std::<span class="built_in">printf</span>(<span class="string">&quot;thread: 2 %d\n&quot;</span>, shared_future.<span class="built_in">get</span>());</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread 2 end\n&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    std::<span class="built_in">printf</span>(<span class="string">&quot;Test: %d\n&quot;</span>, shared_future.<span class="built_in">get</span>());</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>std::shared_future::get</code> å¯ä»¥æ— é™æ¬¡è°ƒç”¨ï¼Œè€Œ <code>std::future::get</code> ä»…èƒ½è°ƒç”¨ä¸€æ¬¡ã€‚</p>
<p><code>std::shared_future::get</code> è¿”å›çš„ä¸€å®šæ˜¯å¼•ç”¨ï¼ˆæ¨¡æ¿å‚æ•°æ˜¯ <code>void</code> çš„é™¤å¤–ï¼‰</p>
</blockquote>
<p>åœ¨æ¯ä¸€ä¸ª<code>std::shared_future</code>çš„ç‹¬ç«‹å¯¹è±¡ä¸Šæˆå‘˜å‡½æ•°è°ƒç”¨è¿”å›çš„ç»“æœè¿˜æ˜¯ä¸åŒæ­¥çš„ï¼Œæ‰€ä»¥ä¸ºäº†åœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªç‹¬ç«‹å¯¹è±¡æ—¶ï¼Œé¿å…æ•°æ®ç«äº‰ï¼Œå¿…é¡»ä½¿ç”¨é”æ¥å¯¹è®¿é—®è¿›è¡Œä¿æŠ¤ã€‚ä¼˜å…ˆä½¿ç”¨çš„åŠæ³•ï¼šä¸ºäº†æ›¿ä»£åªæœ‰ä¸€ä¸ªæ‹·è´å¯¹è±¡çš„æƒ…å†µï¼Œå¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±å¯¹åº”çš„æ‹·è´å¯¹è±¡ã€‚è¿™æ ·ï¼Œå½“æ¯ä¸ªçº¿ç¨‹éƒ½é€šè¿‡è‡ªå·±æ‹¥æœ‰çš„<code>std::shared_future</code>å¯¹è±¡è·å–ç»“æœï¼Œé‚£ä¹ˆå¤šä¸ªçº¿ç¨‹è®¿é—®å…±äº«åŒæ­¥ç»“æœå°±æ˜¯å®‰å…¨çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::literals;</span><br><span class="line">    <span class="comment">// æ³¨æ„ promise åªèƒ½ set ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">auto</span> promise = std::<span class="built_in">promise</span>&lt;<span class="type">int</span>&gt;();</span><br><span class="line">    <span class="keyword">auto</span> shared_future = std::<span class="built_in">shared_future</span>&lt;<span class="type">int</span>&gt;(promise.<span class="built_in">get_future</span>());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> f = [&amp;promise, shared_future](<span class="type">int</span> x)&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot; running\n&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(x)</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;value: &quot;</span> &lt;&lt; shared_future.<span class="built_in">get</span>() &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            promise.<span class="built_in">set_value</span>(x);</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;thread &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot; end\n&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    vector&lt;thread&gt; threads;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> t = std::<span class="built_in">thread</span>(f, i);</span><br><span class="line">        threads.<span class="built_in">push_back</span>(<span class="built_in">move</span>(t));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::<span class="built_in">printf</span>(<span class="string">&quot;Test: %d\n&quot;</span>, shared_future.<span class="built_in">get</span>());</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;t : threads)  t.<span class="built_in">join</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-3-time-limited-wait"><a href="#4-3-time-limited-wait" class="headerlink" title="4.3 time limited wait"></a>4.3 time limited wait</h3><h4 id="4-3-1-introduce"><a href="#4-3-1-introduce" class="headerlink" title="4.3.1 introduce"></a>4.3.1 introduce</h4><p>Sometimes, it is needed to limited the wating time of the wait thread.</p>
<p>There are two ways to signated if timeout:</p>
<ol>
<li>time duration(relative): you are expected to signated a duration of time like: 30s</li>
<li>time point(absolute): you are expected to signated a concrete  time like: <code>[UTC] 17:40:15.034583458</code>, <code>2011-11-30</code></li>
</ol>
<p>The variable which used for relative time  suffixed by <code>_for</code>, and other used for absolute time suffixed by <code>_until</code></p>
<p>Before observe the usage of timeout funtion, letâ€™s check the way to signated the time in C++</p>
<h4 id="4-3-2-clock"><a href="#4-3-2-clock" class="headerlink" title="4.3.2 clock"></a>4.3.2 clock</h4><p><code>#include &lt;chrono&gt;</code></p>
<p>å¯¹äº C++ æ¥è¯´ï¼Œæ—¶é’Ÿå°±æ˜¯æ—¶é—´ä¿¡æ¯æºã€‚å¹¶ä¸”ï¼Œæ—¶é’Ÿæ˜¯ä¸€ä¸ª <code>class</code>ï¼Œæä¾›äº†å››ç§ä¸åŒçš„ä¿¡æ¯ï¼š</p>
<ol>
<li>å½“å‰æ—¶é—´ï¼š<code>std::chrono::system_clock::now()</code> ä¼šè¿”å›ç³»ç»Ÿçš„å½“å‰æ—¶é—´ï¼Œå®ƒå±äº <code>time point</code>.</li>
<li>æ—¶é—´ç±»å‹</li>
<li>æ—¶é’ŸèŠ‚æ‹ï¼š<code>std::chrono::high_resolution_clock</code> å¯èƒ½æ˜¯æ ‡å‡†åº“ä¸­æä¾›çš„å…·æœ‰æœ€å°èŠ‚æ‹å‘¨æœŸï¼ˆå› æ­¤å…·æœ‰æœ€é«˜çš„ç²¾åº¦ï¼‰çš„æ—¶é’Ÿã€‚</li>
<li>ç¨³å®šæ—¶é’Ÿï¼š<code>std::chrono::steady_clock</code></li>
</ol>
<h4 id="4-3-3-ratio"><a href="#4-3-3-ratio" class="headerlink" title="4.3.3 ratio"></a>4.3.3 ratio</h4><p>å…ˆä»‹ç»ä¸€ä¸‹ <code>std::ratio</code>ï¼Œä»–å®šä¹‰åœ¨ <code>&lt;ratio&gt;</code> å¤´æ–‡ä»¶å½“ä¸­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="type">intmax_t</span> N, <span class="type">intmax_t</span> D = <span class="number">1</span>&gt;</span><br><span class="line"><span class="keyword">class</span> ratio &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> ratio&lt;num, den&gt; type;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">intmax_t</span> num;  <span class="comment">// åˆ†å­</span></span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">intmax_t</span> den;  <span class="comment">// åˆ†æ¯</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“çš„å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/header/ratio">cppreference</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ratio&gt;</span> <span class="comment">// !</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="keyword">using</span> two_third = std::ratio&lt;<span class="number">2</span>, <span class="number">3</span>&gt;;</span><br><span class="line">    <span class="keyword">using</span> one_six   = std::ratio&lt;<span class="number">1</span>, <span class="number">6</span>&gt;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">using</span> sum = std::ratio_add&lt;two_third, one_six&gt;;</span><br><span class="line">    <span class="comment">// exppect print 5/6</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;2/3 + 1/6 = &quot;</span> &lt;&lt; sum::num &lt;&lt; <span class="string">&#x27;/&#x27;</span> &lt;&lt; sum::den &lt;&lt; endl;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-4-literal"><a href="#4-3-4-literal" class="headerlink" title="4.3.4 literal"></a>4.3.4 literal</h4><p>åœ¨ C++14 ä¸­çš„ <code>namespace std::chrono_literals</code> ä¸­é¢„å®šä¹‰äº†è®¸å¤šåç¼€æ“ä½œç¬¦ç”¨æ¥è¡¨ç¤ºæ—¶é•¿ä¸­çš„å¸¸ç”¨å•ä½æ¥ç®€åŒ–ä»£ç ã€‚åŒæ ·ï¼Œè¿˜ç”¨ç”¨äºè¡¨ç¤ºå­—ç¬¦ä¸²çš„ <code>namespace std::string_literals</code> ç­‰ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// d å’Œ y æ˜¯ C++20 æä¾›çš„</span></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> string_literals;</span><br><span class="line">    <span class="keyword">auto</span> one_day = <span class="number">24</span>h;</span><br><span class="line">    <span class="keyword">auto</span> half_an_hour = <span class="number">30</span>min;</span><br><span class="line">    <span class="keyword">auto</span> half_a_minuter = <span class="number">30</span>s;</span><br><span class="line">    <span class="comment">// ä¸å¸¸ç”¨çš„è¿˜æœ‰ msï¼ˆå¾®ç§’ï¼‰, usï¼ˆå¾®ç§’ï¼‰, nmï¼ˆçº³ç§’ï¼‰, </span></span><br><span class="line">    <span class="comment">// 1s = 1e3ms(æ¯«ç§’) = 1e6us(å¾®ç§’) = 1e9ns(çº³ç§’) = 1e12ps(çš®ç§’)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// auto çš„ç±»å‹æ˜¯ï¼š</span></span><br><span class="line">    std::chrono::milliseconds ms = <span class="number">1</span>s;</span><br><span class="line">    cout &lt;&lt; ms.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;ms&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> chrono_literals;</span><br><span class="line">    string s = <span class="string">&quot;hello&quot;</span>s; <span class="comment">// suffix by x</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test1</span>();</span><br><span class="line">    <span class="built_in">Test2</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-5-time-duration"><a href="#4-3-5-time-duration" class="headerlink" title="4.3.5 time duration"></a>4.3.5 time duration</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Rep</span>, <span class="keyword">class</span> <span class="title class_">Period</span> = std::ratio&lt;<span class="number">1</span>&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> duration;</span><br><span class="line"><span class="comment">// Rep: è¡¨ç¤ºè®¡æ•°çš„ç®—æ•°ç±»å‹</span></span><br><span class="line"><span class="comment">// Periodï¼šè¡¨ç¤ºè®¡æ¬¡å‘¨æœŸçš„ std::ratio(å³æ¯ç§’çš„æ¬¡æ•°)</span></span><br></pre></td></tr></table></figure>

<p>é€šä¿—æ¥è®²ï¼Œ<code>Period</code> æŒ‡å®šçš„æ˜¯ <code>duration</code> çš„å•ä½ï¼Œé»˜è®¤æ˜¯ <code>1s</code>,ä¾‹å¦‚ï¼Œå¦‚æœ <code>Period</code> æŒ‡å®šçš„æ˜¯ <code>ratio&lt;3600,1&gt;</code> ï¼Œé‚£ä¹ˆå•ä½å°±ç›¸å½“äº <code>h</code>ï¼Œé‚£ä¹ˆ <code>10</code> ä¸ª <code>duration</code> å°±æ˜¯ <code>10h</code><br><code>Rep</code> å‚æ•°æŒ‡å®šäº†ä¼ å…¥çš„æ—¶é—´å•ä½çš„ç±»å‹ï¼Œå¯ä»¥ä¸º <code>float</code>, <code>int</code>, <code>int64</code> ç­‰ï¼Œå¦‚æœä¸º <code>float</code> åˆ™å¯ä»¥è¡¨ç¤ºä¼ å…¥æ—¶é—´å•ä½çš„â€œä¸€éƒ¨åˆ†â€ï¼Œæ¯”å¦‚ä¼ å…¥ <code>1.2</code> è¡¨ç¤º <code>1.2</code> å€ä¸ªæ—¶é—´å•ä½ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> std::chrono::duration;</span><br><span class="line">    <span class="keyword">using</span> std::chrono::duration_cast;</span><br><span class="line">    <span class="keyword">using</span> std::ratio;</span><br><span class="line"> </span><br><span class="line">    duration&lt;<span class="type">long</span> <span class="type">long</span>, ratio&lt;<span class="number">1</span>, <span class="number">1</span>&gt;&gt; tick_s&#123;<span class="number">15</span>&#125;; <span class="comment">// 15s</span></span><br><span class="line">    duration&lt;<span class="type">long</span> <span class="type">long</span>, ratio&lt;<span class="number">1</span>, <span class="number">1000</span>&gt;&gt; tick_ms&#123;<span class="number">15</span>&#125;; <span class="comment">// 1500ms</span></span><br><span class="line">    duration&lt;<span class="type">long</span> <span class="type">long</span>, ratio&lt;<span class="number">60</span>&gt;&gt; tick_min&#123;<span class="number">15</span>&#125;; <span class="comment">// 15min</span></span><br><span class="line">    duration&lt;<span class="type">float</span>, ratio&lt;<span class="number">3600</span>&gt;&gt; tick_h&#123;<span class="number">1.5</span>&#125;; <span class="comment">// 1.5h</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// count()æ–¹æ³•å¯ä»¥è¿”å›æˆ‘ä»¬è®¾ç½®çš„æ•°å€¼</span></span><br><span class="line">    cout &lt;&lt; tick_h.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;h&quot;</span> &lt;&lt; endl; </span><br><span class="line">    cout &lt;&lt; tick_min.<span class="built_in">count</span>() &lt;&lt;  <span class="string">&quot;min&quot;</span> &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// duration_cast </span></span><br><span class="line">    <span class="keyword">auto</span> min = <span class="built_in">duration_cast</span>&lt;std::chrono::minutes&gt;(tick_h);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;1.5h = &quot;</span> &lt;&lt; min.<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;min&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹Ÿå¯ä»¥éšå¼ç±»å‹è½¬æ¢</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;15min = &quot;</span> &lt;&lt; chrono::<span class="built_in">seconds</span>(tick_min).<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;s&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¹Ÿå¯ä»¥è‡ªå®šä¹‰è½¬æ¢ç±»å‹</span></span><br><span class="line">    <span class="keyword">using</span> _day = duration&lt;<span class="type">double</span>, ratio&lt;<span class="number">24</span> * <span class="number">3600</span>&gt;&gt;;</span><br><span class="line">    <span class="keyword">auto</span> hour = duration&lt;<span class="type">long</span> <span class="type">long</span>, ratio&lt;<span class="number">3600</span>&gt;&gt;&#123;<span class="number">8</span>&#125;;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;8h = &quot;</span> &lt;&lt; <span class="built_in">duration_cast</span>&lt;_day&gt;(hour).<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;day&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// duration è¿˜å¯ä»¥æ”¯æŒç®—æ•°è¿ç®—å’Œæ¯”è¾ƒè¿ç®—</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œå°±ä¸å±•ç¤ºäº†</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>ä¾‹å¦‚ï¼šç­‰å¾… <code>future</code> çŠ¶æ€å˜ä¸ºå°±ç»ªéœ€è¦ 35ms</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">task</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::this_thread::<span class="built_in">sleep_for</span>(<span class="number">40</span>ms);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::future&lt;<span class="type">int</span>&gt; f = std::<span class="built_in">async</span>(task);</span><br><span class="line">    <span class="keyword">if</span>(f.<span class="built_in">wait_for</span>(std::chrono::<span class="built_in">milliseconds</span>(<span class="number">35</span>ms)) == std::future_status::ready)</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;ready&quot;</span> &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;deferred&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-3-4-time-point"><a href="#4-3-4-time-point" class="headerlink" title="4.3.4 time point"></a>4.3.4 time point</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> <span class="title class_">Clock</span>, <span class="keyword">class</span> <span class="title class_">Duration</span> = <span class="keyword">typename</span> Clock::duration&gt;</span><br><span class="line"><span class="keyword">class</span> time_point;</span><br><span class="line"><span class="comment">// time_point è¡¨ç¤ºæ—¶é—´ä¸­çš„ä¸€ä¸ªç‚¹</span></span><br><span class="line"><span class="comment">// Clock è¡¨ç¤ºæ—¶é’Ÿçš„ç±»å‹</span></span><br><span class="line"><span class="comment">// Duration å­˜å‚¨ä¸€ä¸ªè‡ª Clock çš„çºªå…ƒèµ·å¼€å§‹çš„æ—¶é—´é—´éš”</span></span><br><span class="line"><span class="comment">// Unix çš„çºªå…ƒä¸º 1970/1/1/00/00/00ï¼ˆepochï¼‰</span></span><br></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">slow_motion</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> a[] &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>&#125;;</span><br><span class="line">    <span class="keyword">do</span>&#123;&#125; <span class="comment">// ç”Ÿæˆ 12! ä¸ªæ’åˆ—</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">next_permutation</span>(a, a + <span class="number">12</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::literals;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> std::chrono;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Test 1 */</span></span><br><span class="line">    <span class="type">const</span> time_point&lt;system_clock&gt; now = system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="type">const</span> <span class="type">time_t</span> t_c = system_clock::<span class="built_in">to_time_t</span>(now - <span class="number">24</span>h);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;24 hour ago, the time was &quot;</span> &lt;&lt; <span class="built_in">put_time</span>(std::<span class="built_in">localtime</span>(&amp;t_c), <span class="string">&quot;%F %T.\n&quot;</span>) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Test 2 */</span></span><br><span class="line">    <span class="type">const</span> time_point&lt;steady_clock&gt; start = steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="built_in">slow_motion</span>();</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> end = steady_clock::<span class="built_in">now</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Slow calculation took &quot;</span></span><br><span class="line">         &lt;&lt; <span class="built_in">duration_cast</span>&lt;milliseconds&gt;(end - start).<span class="built_in">count</span>() &lt;&lt; <span class="string">&quot;us = &quot;</span></span><br><span class="line">         &lt;&lt; (end - start) / <span class="number">1</span>ms &lt;&lt; <span class="string">&quot;ms = &quot;</span></span><br><span class="line">         &lt;&lt; (end - start) / <span class="number">1</span>s &lt;&lt; <span class="string">&quot;s.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¾‹2: ç­‰å¾…æ¡ä»¶å˜é‡æ»¡è¶³æ¡ä»¶ â€”â€” æœ‰è¶…æ—¶åŠŸèƒ½</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> chrono_literals;</span><br><span class="line">std::condition_variable cv;</span><br><span class="line"><span class="type">bool</span> done;</span><br><span class="line">std::mutex m;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">wait_loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;wait_loop running\n&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    this_thread::<span class="built_in">sleep_for</span>(<span class="number">100</span>ms);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;wait loop sleep done.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> timeout = <span class="comment">// now + xms</span></span><br><span class="line">        std::chrono::steady_clock::<span class="built_in">now</span>() </span><br><span class="line">        + std::chrono::<span class="built_in">milliseconds</span>(<span class="number">1000</span>);   </span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(m)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(!done)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(cv.<span class="built_in">wait_until</span>(lock, timeout) == std::cv_status::timeout)</span><br><span class="line">        &#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;timeout.\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// do something or done = true</span></span><br><span class="line">        <span class="comment">// done = true;</span></span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;wait_loop end\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">signal</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;thread running.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    this_thread::<span class="built_in">sleep_for</span>(<span class="number">1000</span>ms);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;thread sleep done.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    cv.<span class="built_in">notify_one</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;thread end.\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="function">thread <span class="title">tl</span><span class="params">(wait_loop)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t</span><span class="params">(signal)</span></span>;</span><br><span class="line">    tl.<span class="built_in">join</span>();</span><br><span class="line">    t.<span class="built_in">join</span>();</span><br><span class="line">    <span class="keyword">if</span>(done)    cout &lt;&lt; <span class="string">&quot;done.\n&quot;</span> &lt;&lt; endl;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="4-3-5-use-timeout"><a href="#4-3-5-use-timeout" class="headerlink" title="4.3.5 use timeout"></a>4.3.5 use timeout</h4><p>ä½¿ç”¨è¶…æ—¶æœºåˆ¶çš„å‡½æ•°</p>
<table>
<thead>
<tr>
<th>ç±»å‹&#x2F;å‘½åç©ºé—´</th>
<th>å‡½æ•°</th>
<th>è¿”å›å€¼</th>
</tr>
</thead>
<tbody><tr>
<td>std::this_thread[namespace]</td>
<td>sleep_for(duration)</td>
<td>N&#x2F;A</td>
</tr>
<tr>
<td>sleep_until(time_point)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>std::condition_variable æˆ– std::condition_variable_any</td>
<td>wait_for(lock, duration)</td>
<td>std::cv_status::time_out æˆ– std::cv_status::no_timeout</td>
</tr>
<tr>
<td>wait_until(lock, time_point)</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>wait_for(lock, duration, predicate)</td>
<td>bool â€”â€” å½“å”¤é†’æ—¶ï¼Œè¿”å›è°“è¯çš„ç»“æœ</td>
</tr>
<tr>
<td>wait_until(lock, duration, predicate)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>std::timed_mutex æˆ– std::recursive_timed_mutex</td>
<td>try_lock_for(duration)</td>
<td>bool â€”â€” è·å–é”æ—¶è¿”å›trueï¼Œå¦åˆ™è¿”å›fasle</td>
</tr>
<tr>
<td>try_lock_until(time_point)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>std::unique_lock<TimedLockable></td>
<td>unique_lock(lockable, duration)</td>
<td>N&#x2F;A â€”â€” å¯¹æ–°æ„å»ºçš„å¯¹è±¡è°ƒç”¨owns_lock();</td>
</tr>
<tr>
<td>unique_lock(lockable, time_point)</td>
<td>å½“è·å–é”æ—¶è¿”å›trueï¼Œå¦åˆ™è¿”å›false</td>
<td></td>
</tr>
<tr>
<td></td>
<td>try_lock_for(duration)</td>
<td>bool â€”â€” å½“è·å–é”æ—¶è¿”å›trueï¼Œå¦åˆ™è¿”å›false</td>
</tr>
<tr>
<td>try_lock_until(time_point)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>std::future<ValueType>æˆ–std::shared_future<ValueType></td>
<td>wait_for(duration)</td>
<td>å½“ç­‰å¾…è¶…æ—¶ï¼Œè¿”å›std::future_status::timeout</td>
</tr>
<tr>
<td>wait_until(time_point)</td>
<td>å½“â€œæœŸæœ›â€å‡†å¤‡å°±ç»ªæ—¶ï¼Œè¿”å›std::future_status::ready</td>
<td></td>
</tr>
<tr>
<td>å½“â€œæœŸæœ›â€æŒæœ‰ä¸€ä¸ªä¸ºå¯åŠ¨çš„å»¶è¿Ÿå‡½æ•°ï¼Œè¿”å›std::future_status::deferred</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬è®¨è®ºçš„æœºåˆ¶æœ‰ï¼š<strong>condition variable</strong>ã€â€œ<strong>future</strong>â€ã€â€œ<strong>promise</strong>â€è¿˜æœ‰ <strong>packaged_task</strong>ã€‚æ˜¯æ—¶å€™ä»æ›´é«˜çš„è§’åº¦å»çœ‹å¾…è¿™äº›æœºåˆ¶ï¼Œæ€ä¹ˆæ ·ä½¿ç”¨è¿™äº›æœºåˆ¶ï¼Œç®€åŒ–çº¿ç¨‹çš„åŒæ­¥æ“ä½œã€‚</p>
<h3 id="4-4-simplify-code"><a href="#4-4-simplify-code" class="headerlink" title="4.4 simplify code"></a>4.4 simplify code</h3><p>åŒæ­¥å·¥å…·åœ¨æœ¬ç« æˆä¸ºâ€œæ„å»ºå—â€ã€‚</p>
<p>æ¯”èµ·åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«æ•°æ®ï¼Œæ¯ä¸ªä»»åŠ¡æœ€å¥½æ‹¥æœ‰è‡ªå·±çš„æ•°æ®ï¼Œå¹¶ä¸”å…¶ä»–çº¿ç¨‹å¯ä»¥é€šè¿‡ä½¿ç”¨ <code>future</code> è·å–è¿è¡Œç»“æœã€‚</p>
<h4 id="4-4-1-funtional-programming-by-future"><a href="#4-4-1-funtional-programming-by-future" class="headerlink" title="4.4.1 funtional programming by future"></a>4.4.1 funtional programming by future</h4><blockquote>
<p><strong>functional programming(FP)</strong> is a programming way which the function_return_value only depend on the arguments and you will get the same result always if you pass the same arguments</p>
</blockquote>
<p>ä¸²å½¢ç‰ˆé’ˆå¯¹ <code>list</code> çš„ <code>qsort</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">std::list&lt;T&gt; <span class="title">sequential_quick_sort</span><span class="params">(std::list&lt;T&gt; input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(input.<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    &#125;</span><br><span class="line">    std::list&lt;T&gt; result;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// std::list::splice å®ç°å°†å…ƒç´ ä»ä¸€ä¸ªlistè½¬ç§»åˆ°å¦ä¸€ä¸ªlist</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”ä»…ä»…é€šè¿‡ pointer move å®ç°ï¼Œè€Œä¸ copy or move elements</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// splice(const_iterator pos, list &amp;other, const_iterator it)</span></span><br><span class="line">    <span class="comment">// ä» other è½¬ç§» it æ‰€æŒ‡å‘çš„å…ƒç´ åˆ° [*this](calleer) å½“ä¸­ï¼Œå…ƒç´ è¢«æ’å…¥åˆ° pos æ‰€æŒ‡å‘çš„å…ƒç´ ä¹‹å‰</span></span><br><span class="line">    <span class="comment">// å³ï¼Œå°† input çš„ç¬¬ä¸€ä¸ªå…ƒç´ è½¬ç§»åˆ° reesult çš„ begin ä¹‹å‰</span></span><br><span class="line">    result.<span class="built_in">splice</span>(result.<span class="built_in">begin</span>(), input, input.<span class="built_in">begin</span>());</span><br><span class="line">    <span class="comment">// é€‰å–ä¸€ä¸ªâ€œä¸­é—´å…ƒç´ â€</span></span><br><span class="line">    <span class="type">const</span> T&amp; pivot = *result.<span class="built_in">begin</span>();   <span class="comment">// pivot: æ¢çº½</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// paration è¿”å›ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼Œæ­£å¥½æ˜¯å¼€åŒºé—´</span></span><br><span class="line">    <span class="comment">// æ–¹ä¾¿ [) çš„è®¾è®¡</span></span><br><span class="line">    <span class="comment">// æ ¹æ®â€œä¸­é—´å…ƒç´ â€åˆ’åˆ†ä¸ºå·¦å³å»è§</span></span><br><span class="line">    <span class="keyword">auto</span> divide_point = std::<span class="built_in">partition</span>(input.<span class="built_in">begin</span>(), input.<span class="built_in">end</span>(),</span><br><span class="line">        [&amp;](<span class="type">const</span> T&amp; t)&#123;<span class="keyword">return</span> t &lt; pivot;&#125; <span class="comment">// ä»¥ t&lt;pivot åˆ’åˆ†å…ƒç´ ï¼Œinputå·¦ä¾§éƒ½æ˜¯å°äºpivotï¼Œå³ä¾§å¤§äºpivot</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    std::list&lt;T&gt; lower_part;</span><br><span class="line">    lower_part.<span class="built_in">splice</span>(lower_part.<span class="built_in">end</span>(), input, input.<span class="built_in">begin</span>(), divide_point);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// recursion</span></span><br><span class="line">    <span class="comment">// åˆ†åˆ«å¯¹å·¦å³åŒºé—´çš„å…ƒç´ é€’å½’sort</span></span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">new_lower</span><span class="params">(sequential_quick_sort(std::move(lower_part)))</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">new_higher</span><span class="params">(sequential_quick_sort(std::move(input)))</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// left, middle(privot), right</span></span><br><span class="line">    result.<span class="built_in">splice</span>(result.<span class="built_in">end</span>(), new_higher);</span><br><span class="line">    result.<span class="built_in">splice</span>(result.<span class="built_in">begin</span>(), new_lower);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    list&lt;<span class="type">int</span>&gt; l&#123;<span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    l = <span class="built_in">sequential_quick_sort</span>(l);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;val : l)</span><br><span class="line">        cout &lt;&lt; val &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>qsort â€”â€” FP pattern with thread strongthenï¼ˆå¹¶è¡Œç‰ˆæœ¬ï¼‰</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">parallel_quick_sort</span><span class="params">(std::list&lt;T&gt; input)</span> -&gt; <span class="keyword">auto</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(input.<span class="built_in">empty</span>())</span><br><span class="line">        <span class="keyword">return</span> input;</span><br><span class="line">    </span><br><span class="line">    std::list&lt;T&gt; result;</span><br><span class="line">    </span><br><span class="line">    result.<span class="built_in">splice</span>(result.<span class="built_in">begin</span>(), input, input.<span class="built_in">begin</span>());</span><br><span class="line">    <span class="type">const</span> T&amp; pivot = *result.<span class="built_in">begin</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> divide_point = std::<span class="built_in">partition</span>(input.<span class="built_in">begin</span>(), input.<span class="built_in">end</span>(), </span><br><span class="line">        [&amp;](<span class="type">const</span> T&amp; t)&#123;</span><br><span class="line">            <span class="keyword">return</span> t &lt; pivot;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    std::list&lt;T&gt; lower_part;</span><br><span class="line">    lower_part.<span class="built_in">splice</span>(lower_part.<span class="built_in">end</span>(), input, </span><br><span class="line">        input.<span class="built_in">begin</span>(), divide_point);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹è¿›è¡Œæ’åº</span></span><br><span class="line">    std::future&lt;std::list&lt;T&gt;&gt; <span class="built_in">new_lower</span>(</span><br><span class="line">        std::<span class="built_in">async</span>(&amp;parallel_quick_sort&lt;T&gt;, std::<span class="built_in">move</span>(lower_part))</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæ— éœ€ä¸€ä¸ªæ–°çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">auto</span> new_higher = (</span><br><span class="line">        <span class="built_in">parallel_quick_sort</span>(std::<span class="built_in">move</span>(input))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    result.<span class="built_in">splice</span>(result.<span class="built_in">end</span>(), new_higher);;</span><br><span class="line">    result.<span class="built_in">splice</span>(result.<span class="built_in">begin</span>(), new_lower.<span class="built_in">get</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    list&lt;<span class="type">int</span>&gt; l&#123;<span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">    l = <span class="built_in">parallel_quick_sort</span>(l);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;val : l)</span><br><span class="line">        cout &lt;&lt; val &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡ <code>parallel_quich_sort</code>ï¼Œæˆ‘ä»¬ä¾¿åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œç”±äºé€’å½’æ‰§è¡Œçš„ç¼˜æ•…ï¼Œçº¿ç¨‹çš„åˆ›å»ºæ˜¯æŒ‡æ•°çº§åˆ«çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœé€’å½’æ‰§è¡Œ 10 æ¬¡ï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»º 1024 ä¸ªçº¿ç¨‹ï¼ä½†åˆ›å»ºå¤ªå¤šçº¿ç¨‹æ˜¾ç„¶æ˜¯ä¸å¥½çš„ï¼Œå› æ­¤ <code>async()</code> ä¼šè‡ªåŠ¨æ‰§è¡ŒæŸäº›æ“ä½œï¼Œé¿å…åˆ›å»ºå¤ªå¤šçº¿ç¨‹ã€‚è¿™ä¹Ÿç¬¦åˆ <code>async()</code> çš„ç­–ç•¥ï¼ˆæ—¢å¯ç«‹é©¬åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥ä»¥å»¶è¿ŸåŠ è½½çš„æ–¹å¼åˆ›å»ºçº¿ç¨‹ï¼‰ã€‚</p>
<p>å…¶å®ï¼Œå¦‚æœ <code>async()</code> ä»¥å»¶è¿ŸåŠ è½½çš„æ–¹å¼æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯ç›´åˆ°åœ¨ <code>std::async()</code> è¿”å›çš„ <code>future</code> å¯¹è±¡è°ƒç”¨ <code>get()</code> æˆ–è€… <code>wait()</code> æ—¶æ‰æ‰§è¡Œã€‚</p>
<p>ç„¶é¹…ï¼Œå½“è°ƒç”¨ <code>get/wait</code> æ—¶ï¼Œå‡½æ•°ä¼šåŒæ­¥æ‰§è¡Œï¼Œå³è°ƒç”¨è€…ä¼šé˜»å¡ç›´åˆ°å‡½æ•°è¿è¡Œç»“æŸï¼Œå¦‚æœ <code>get/wait</code> æ²¡æœ‰è¢«è°ƒç”¨ï¼Œå‡½æ•°å°±ç»å¯¹ä¸ä¼šæ‰§è¡Œã€‚</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039083151">ref here</a></p>
</blockquote>
<p>æ¯”èµ·ä½¿ç”¨<code>std::async()</code>ï¼Œä½ å¯ä»¥å†™ä¸€ä¸ªspawn_task()å‡½æ•°å¯¹<code>std::packaged_task</code>å’Œ<code>std::thread</code>åšç®€å•çš„åŒ…è£…ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼›ä½ éœ€è¦ä¸ºå‡½æ•°ç»“æœåˆ›å»ºä¸€ä¸ª<code>std::packaged_task</code>å¯¹è±¡ï¼Œ å¯ä»¥ä»è¿™ä¸ªå¯¹è±¡ä¸­è·å–â€œæœŸæœ›â€ï¼Œæˆ–åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œå®ƒï¼Œè¿”å›â€œæœŸæœ›â€ã€‚</p>
<p>å…¶æœ¬èº«å¹¶ä¸æä¾›å¤ªå¤šçš„å¥½å¤„(å¹¶ä¸”äº‹å®ä¸Šä¼šé€ æˆå¤§è§„æ¨¡çš„è¶…é¢ä»»åŠ¡)ï¼Œä½†æ˜¯å®ƒä¼šä¸ºè½¬å‹æˆä¸€ä¸ªæ›´å¤æ‚çš„å®ç°é“ºå¹³é“è·¯ï¼Œå°†ä¼šå®ç°å‘ä¸€ä¸ªé˜Ÿåˆ—æ·»åŠ ä»»åŠ¡ï¼Œè€Œåä½¿ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥è¿è¡Œå®ƒä»¬ã€‚æˆ‘ä»¬å°†åœ¨ç¬¬9ç« å†è®¨è®ºçº¿ç¨‹æ± ã€‚ä½¿ç”¨<code>std::async</code>æ›´é€‚åˆäºå½“ä½ çŸ¥é“ä½ åœ¨å¹²ä»€ä¹ˆï¼Œå¹¶ä¸”è¦å®Œå…¨æ§åˆ¶åœ¨çº¿ç¨‹æ± ä¸­æ„å»ºæˆ–æ‰§è¡Œè¿‡ä»»åŠ¡çš„çº¿ç¨‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span> A&gt;</span><br><span class="line">std::future&lt;std::result_of&lt;<span class="built_in">F</span>(A&amp;&amp;)&gt;::type&gt; <span class="built_in">spawn_task</span>(F &amp;&amp;f, A &amp;&amp;a)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">typedef</span> std::result_of&lt;<span class="built_in">F</span>(A&amp;&amp;)&gt;::type result_type;</span><br><span class="line">    <span class="function">std::packaged_task&lt;<span class="title">result_type</span><span class="params">(A&amp;&amp;)</span>&gt; <span class="title">task</span><span class="params">(std::move(f))</span></span>;</span><br><span class="line">    <span class="function">std::future&lt;result_type&gt; <span class="title">res</span><span class="params">(task.get_future())</span></span>;</span><br><span class="line">    <span class="function">std::thread <span class="title">t</span><span class="params">(std::move(task), std::move(a))</span></span>;</span><br><span class="line">    t.<span class="built_in">detach</span>();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-4-2-synchronization-by-message-passing"><a href="#4-4-2-synchronization-by-message-passing" class="headerlink" title="4.4.2 synchronization by message passing"></a>4.4.2 synchronization by message passing</h4><blockquote>
<p> <strong>MPIï¼š</strong>Message Passing Interfaceï¼Œæ¶ˆæ¯ä¼ é€’æ¥å£</p>
<p><strong>CSPï¼š</strong>Communicating Sequentiasl Processerï¼Œé€šè®¯é¡ºåºè¿›ç¨‹</p>
</blockquote>
<p><font color=blue>??????? Â THIS SECTION AND NEXT SECTION TODO</font></p>
<p>TODO â€¦</p>
<h3 id="4-5-summary"><a href="#4-5-summary" class="headerlink" title="4.5 summary"></a>4.5 summary</h3><p>åŒæ­¥æ“ä½œå¯¹äºä½¿ç”¨å¹¶å‘ç¼–å†™ä¸€æ¬¾å¤šçº¿ç¨‹åº”ç”¨æ¥è¯´ï¼Œæ˜¯å¾ˆé‡è¦çš„ä¸€éƒ¨åˆ†ï¼šå¦‚æœæ²¡æœ‰åŒæ­¥ï¼Œçº¿ç¨‹åŸºæœ¬ä¸Šå°±æ˜¯ç‹¬ç«‹çš„ï¼Œä¹Ÿå¯å†™æˆå•ç‹¬çš„åº”ç”¨ï¼Œå› å…¶ä»»åŠ¡ä¹‹é—´çš„ç›¸å…³æ€§ï¼Œå®ƒä»¬å¯ä½œä¸ºä¸€ä¸ªç¾¤ä½“ç›´æ¥æ‰§è¡Œã€‚</p>
<p>æœ¬ç« ï¼Œæˆ‘ä»¬è®¨è®ºäº†å„å¼å„æ ·çš„åŒæ­¥æ“ä½œï¼Œä»åŸºæœ¬çš„<strong>æ¡ä»¶å˜é‡ï¼Œåˆ°â€œæœŸæœ›â€ã€â€œæ‰¿è¯ºâ€ï¼Œå†åˆ°æ‰“åŒ…ä»»åŠ¡</strong>ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿè®¨è®ºäº†æ›¿ä»£åŒæ­¥çš„è§£å†³æ–¹æ¡ˆï¼š<strong>å‡½æ•°åŒ–æ¨¡å¼ç¼–ç¨‹ï¼Œå®Œå…¨ç‹¬ç«‹æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸ä¼šå—åˆ°å¤–éƒ¨ç¯å¢ƒçš„å½±å“ï¼›è¿˜æœ‰ï¼Œæ¶ˆæ¯ä¼ é€’æ¨¡å¼ï¼Œä»¥æ¶ˆæ¯å­ç³»ç»Ÿä¸ºä¸­ä»‹ï¼Œå‘çº¿ç¨‹å¼‚æ­¥çš„å‘é€æ¶ˆæ¯ã€‚</strong></p>
<h2 id="P5-memory-model-and-atomatic-operation"><a href="#P5-memory-model-and-atomatic-operation" class="headerlink" title="P5 memory model and atomatic operation"></a>P5 memory model and atomatic operation</h2><h2 id="P6-data-struct-with-mutex"><a href="#P6-data-struct-with-mutex" class="headerlink" title="P6 data struct with mutex"></a>P6 data struct with mutex</h2><p>æœ¬ç« ä¸»è¦å†…å®¹ï¼š</p>
<ul>
<li>è®¾è®¡å¹¶å‘æ•°æ®ç»“æ„</li>
<li>å¦‚ä½•è®¾è®¡</li>
<li>å®ç°æ•°æ®ç»“æ„</li>
</ul>
<p>è®¾è®¡å¹¶å‘æ•°æ®ç»“æ„æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ä¸­çš„æ„å»ºå—ï¼Œæ¯”å¦‚ï¼š<code>condition_variable</code> å’Œ <code>mutex</code>ã€‚å½“ç„¶ä¹Ÿè¦ä¿è¯å¹¶å‘å—åœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„çº¿ç¨‹å®‰å…¨ã€‚</p>
<h3 id="6-1-the-significance-of-concurrency-design"><a href="#6-1-the-significance-of-concurrency-design" class="headerlink" title="6.1 the significance of concurrency design"></a>6.1 the significance of concurrency design</h3><p>è®¾è®¡å¹¶å‘æ•°æ®ç»“æ„æ˜¯ä¸ºäº†è®©å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œå¹¶ä¸”çº¿ç¨‹å¯å¯¹æ•°æ®ç»“æ„åšç›¸åŒæˆ–ä¸åŒçš„æ“ä½œã€‚</p>
<p>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæ— æ•°æ®ä¸¢å¤±å’ŒæŸåï¼Œè‹å“Ÿå¶çš„æ•°æ®éƒ½ç»´æŒåŸæ ·ï¼Œä¸”æ— ç«äº‰æ¡ä»¶çš„æ•°æ®ç»“æ„ï¼Œç§°ä¹‹ä¸ºâ€œçº¿ç¨‹å®‰å…¨â€çš„æ•°æ®ç»“æ„ã€‚</p>
<p>å®é™…ä¸Šï¼Œæˆ‘ä»¬è¦é€šè¿‡è®¾è®¡çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ä¸ºçº¿ç¨‹æä¾›å¹¶å‘è®¿é—®æ•°æ®ç»“æ„çš„æœºä¼šã€‚å› ä¸ºå°±æœ¬è´¨æ¥è¯´ï¼Œäº’æ–¥é‡ä¸ºäº†ä¿æŠ¤æ•°æ®ï¼Œä¼šæ˜¾ç¤ºé˜»æ­¢çº¿ç¨‹å¯¹æ•°æ®çš„å¹¶å‘è®¿é—®ã€‚</p>
<h4 id="6-1-1-guideline-of-desiging-the-concurrency-DB"><a href="#6-1-1-guideline-of-desiging-the-concurrency-DB" class="headerlink" title="6.1.1 guideline of desiging the concurrency DB"></a>6.1.1 guideline of desiging the concurrency DB</h4><p>è®¾è®¡å¹¶å‘æ•°æ®ç»“æ„æ—¶ï¼Œéœ€è¦ä¸¤æ–¹é¢çš„è€ƒé‡ï¼š</p>
<ol>
<li>ç¡®ä¿è®¿é—®å®‰å…¨</li>
<li>çœŸæ­£å¹¶å‘è®¿é—®</li>
</ol>
<p>ç¬¬ä¸‰ç« å·²ç»å¯¹å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨åšè¿‡ç®€å•çš„æè¿°ï¼š</p>
<ul>
<li>ç¡®ä¿æ— çº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°â€œä¸å˜é‡â€å˜åŒ–æ—¶çš„çŠ¶æ€</li>
<li>å°å¿ƒä¼šå¼•èµ·æ¡ä»¶ç«äº‰çš„æ¥å£ï¼Œæä¾›å®Œæ•´æ“ä½œçš„å‡½æ•°ï¼Œè€Œéæ“ä½œæ­¥éª¤ï¼ˆtop-popï¼‰</li>
<li>æ³¨æ„æ•°æ®ç»“æ„çš„è¡Œä¸ºæ˜¯å¦ä¼šäº§ç”Ÿå¼‚å¸¸ï¼Œä»è€Œç¡®ä¿â€œä¸å˜é‡â€çš„çŠ¶æ€</li>
<li>å°†æ­»é”çš„æ¦‚ç‡é™åˆ°æœ€ä½ã€‚é™åˆ¶é”çš„èŒƒå›´ï¼Œé¿å…åµŒå¥—é”ç­‰</li>
</ul>
<p><strong>è¿˜éœ€è¦è€ƒè™‘æ•°æ®ç»“æ„å¯¹äºä½¿ç”¨è€…æœ‰ä»€ä¹ˆé™åˆ¶</strong>ï¼Œå½“çº¿ç¨‹é€šè¿‡ç‰¹æ®Šçš„å‡½æ•°å¯¹æ•°æ®ç»“æ„è¿›è¡Œè®¿é—®æ—¶ï¼Œå…¶ä»–çš„çº¿ç¨‹è¿˜æœ‰å“ªäº›å‡½æ•°èƒ½å®‰å…¨è°ƒç”¨?</p>
<p>è¿™æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„é—®é¢˜ï¼Œæ™®é€šçš„æ„é€ å‡½æ•°å’Œææ„å‡½æ•°éœ€è¦ç‹¬ç«‹è®¿é—®æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ç”¨æˆ·ä½¿ç”¨æ—¶ï¼Œå°±ä¸èƒ½åœ¨æ„é€ å‡½æ•°å®Œæˆå‰æˆ–ææ„å‡½æ•°å®Œæˆåå¯¹æ•°æ®ç»“æ„è¿›è¡Œè®¿é—®ã€‚å½“æ•°æ®ç»“æ„æ”¯æŒèµ‹å€¼æ“ä½œswap()æˆ–æ‹·è´æ„é€ æ—¶ï¼Œä½œä¸º æ•°æ®ç»“æ„çš„è®¾è®¡è€…ï¼Œå³ä½¿çº¿ç¨‹æ“çºµæ•°æ®ç»“æ„ä¸­æœ‰å¤§é‡çš„å‡½æ•°ï¼Œä¹Ÿéœ€è¦ä¿è¯è¿™äº›æ“ä½œåœ¨å¹¶å‘ä¸‹æ˜¯å®‰å…¨çš„(æˆ–ç¡®ä¿ è¿™äº›æ“ä½œèƒ½å¤Ÿç‹¬ç«‹è®¿é—®)ï¼Œä»¥ä¿è¯å¹¶å‘è®¿é—®æ—¶ä¸ä¼šå‡ºé”™ã€‚</p>
<p>ç¬¬äºŒä¸ªæ–¹é¢æ˜¯ç¡®ä¿çœŸæ­£çš„å¹¶å‘ï¼Œéœ€è¦è€ƒè™‘ä¸€ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>æ“ä½œåœ¨é”çš„èŒƒå›´ä¸­è¿›è¡Œï¼Œæ˜¯å¦å…è®¸åœ¨é”å¤–æ‰§è¡Œï¼Ÿ</li>
<li>æ•°æ®ç»“æ„ä¸­ä¸åŒçš„äº’æ–¥èƒ½å¦ä¿æŠ¤ä¸åŒçš„åŒºåŸŸï¼Ÿ</li>
<li>æ‰€æœ‰æ“ä½œéƒ½éœ€è¦åŒçº§äº’æ–¥é‡çš„ä¿æŠ¤å—ï¼Ÿ</li>
<li>èƒ½å¦å¯¹æ•°æ®ç»“æ„è¿›è¡Œç®€å•çš„ä¿®æ”¹ï¼Œå¢åŠ å¹¶å‘è®¿é—®çš„æ¦‚ç‡ï¼Ÿ</li>
</ol>
<p>è¿™äº›é—®é¢˜éƒ½æºäºä¸€ä¸ªæŒ‡å¯¼æ€æƒ³:<strong>å¦‚ä½•è®©åºåˆ—åŒ–è®¿é—®æœ€å°åŒ–ï¼Œè®©çœŸå®å¹¶å‘æœ€å¤§åŒ–?ğŸ˜Šï¼Ÿï¼ŸğŸ˜­</strong></p>
<p>å…è®¸çº¿ç¨‹å¹¶å‘è¯»å–çš„æ•°æ®ç»“æ„å¹¶ä¸å°‘è§ï¼Œä½†ä¿®æ”¹å¿…é¡»æ˜¯å•çº¿ç¨‹çš„ï¼Œè¿™ç§ç»“æ„ç±»ä¼¼äº <code>std::shared_mutex</code> ã€‚åŒæ ·ï¼Œè¿™ç§æ•°æ®ç»“æ„ä¹Ÿå¾ˆå¸¸è§â€”â€” æ”¯æŒå¤šçº¿ç¨‹çš„ä¸åŒæ“ä½œæ—¶ï¼Œä¹Ÿèƒ½ä¸²è¡Œæ‰§è¡Œç›¸åŒçš„æ“ä½œã€‚</p>
<p>æœ€ç®€å•çš„çº¿ç¨‹å®‰å…¨ç»“æ„é€šå¸¸ä¼šå¯¹æ•°æ®ä½¿ç”¨äº’æ–¥é‡æˆ–é”ã€‚è™½ç„¶ï¼Œè¿™ä¹ˆåšè¿˜æœ‰é—®é¢˜ï¼Œä¸è¿‡è¿™æ ·åšç›¸å¯¹ç®€å•ï¼Œå¹¶ä¸”èƒ½ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´å¯¹æ•°æ®ç»“æ„è¿›è¡Œç‹¬ç«‹è®¿é—®ã€‚ä¸ºäº†æ›´è½»æ¾çš„è®¾è®¡çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ï¼Œæ¥ä¸‹æ¥äº†è§£ä¸€ä¸‹åŸºäºé”çš„æ•°æ®ç»“æ„ã€‚</p>
<h3 id="6-2-DS-based-on-mutex"><a href="#6-2-DS-based-on-mutex" class="headerlink" title="6.2 DS based on mutex"></a>6.2 DS based on mutex</h3><p>åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„ç¡®ä¿è®¿é—®çº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´æœ€çŸ­ï¼›å¯¹äºåªæœ‰ä¸€ä¸ªäº’æ–¥é‡çš„æ•°æ®ç»“æ„ï¼Œéœ€è¦é”ä¹‹å¤–çš„æ“ä½œä¸èƒ½è®¿é—®æ•°æ®ï¼›ä½¿ç”¨å¤šä¸ªäº’æ–¥é‡ä¿æŠ¤æ•°æ®ç»“æ„ä¸åŒçš„åŒºåŸŸæ—¶è¦é¿å…æ­»é”ã€‚</p>
<h4 id="6-2-1-threadsafe-stack"><a href="#6-2-1-threadsafe-stack" class="headerlink" title="6.2.1 threadsafe stack"></a>6.2.1 threadsafe stack</h4><p>åœ¨ push() æ“ä½œä¸­ï¼Œæ— è®ºå¦‚ä½•éƒ½æ— æ³•é¿å…æ–°æ•°æ®çš„åˆ›å»ºï¼Œé™¤éä½ ç›´æ¥ move åŸæ¥çš„æ•°æ®ï¼ˆå³å€¼å¼•ç”¨ + moveï¼‰ï¼Œä½†æ˜¯ç›´æ¥ move åŸæ¥çš„æ•°æ®æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœå†…å­˜ä¸è¶³ï¼Œmove ä¸€åŠå¼‚å¸¸äº†ï¼Œé‚£ä¹ˆåŸæ¥çš„æ•°æ®å°±ä¼šè¢«ç ´åï¼Œå› æ­¤ï¼Œä½¿ç”¨ä¼ å€¼çš„æ–¹å¼æ‹·è´åˆå§‹æ•°æ®ï¼Œåœ¨ move åˆ°å®¹å™¨ä¸­ï¼Œæ›´ä¸ºç¨³å¦¥ã€‚</p>
<p>è¿™é‡Œçš„ â€œå¼‚å¸¸ - å®‰å…¨â€ å¥½æ¶å¿ƒğŸ˜­</p>
<p>å¦å¤–ï¼Œè¿™é‡Œçš„ä»£ç æ˜¯å¯èƒ½å‘ç”Ÿæ­»é”çš„;</p>
<p>ç”¨æˆ·è¦å¯¹æ ˆè´Ÿè´£ï¼Œå½“æ ˆæœªå¯¹ä¸€ä¸ªæ•°æ®è¿›è¡Œæ‹·è´æˆ–åˆ†é…æ—¶ï¼Œç”¨æˆ·å°±ä¸èƒ½æƒ³å½“ç„¶çš„å°†å…¶æ·»åŠ åˆ°æ ˆä¸­ã€‚</p>
<p>æ‰€æœ‰æˆå‘˜å‡½æ•°éƒ½ä½¿ç”¨ std::lock_guard&lt;&gt; ä¿æŠ¤æ•°æ®ï¼Œæ‰€ä»¥æ ˆæˆå‘˜å‡½æ•°æ‰æ˜¯â€œçº¿ç¨‹å®‰å…¨â€çš„ã€‚å½“ç„¶ï¼Œæ„é€ ä¸ææ„å‡½æ•°ä¸æ˜¯â€œçº¿ç¨‹å®‰å…¨â€çš„ï¼Œä½†æ„é€ ä¸ææ„åªæœ‰ä¸€æ¬¡ã€‚è°ƒç”¨ä¸å®Œå…¨æ„é€ å¯¹è±¡æˆ–æ˜¯å·²é”€æ¯å¯¹è±¡çš„æˆå‘˜å‡½æ•°ï¼Œæ— è®ºåœ¨å“ªç§ç¼–ç¨‹æ–¹å¼ä¸‹éƒ½ä¸å¯å–ã€‚æ‰€ä»¥ï¼Œç”¨æˆ·å°±è¦ä¿è¯åœ¨æ ˆå¯¹è±¡å®Œæˆæ„é€ å‰ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å¯¹å…¶è¿›è¡Œè®¿é—®ã€‚å¹¶ä¸”ï¼Œè¦ä¿è¯åœ¨æ ˆå¯¹è±¡é”€æ¯åï¼Œåœæ­¢æ‰€æœ‰çº¿ç¨‹çš„è®¿é—®æ“ä½œã€‚</p>
<p>ä¸²å½¢åŒ–çš„çº¿ç¨‹ä¼šéšæ€§çš„é™åˆ¶ç¨‹åºæ€§èƒ½ã€‚ä¾‹å¦‚æˆ‘ä»¬éœ€è¦ pop ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆå½“æ ˆä¸ºç©ºæ—¶æˆ‘ä»¬åªèƒ½ç­‰å¾…ï¼Œä½†è¿™ç§ç­‰å¾…æ—¶æ— æ„ä¹‰çš„ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä¸è¿™ä¹ˆé—²ç€ç­‰ï¼Œè€Œæ˜¯å»åšä¸€äº›å…¶ä»–äº‹ï¼Œå› æ­¤ï¼Œè¿™éœ€è¦ç”¨æˆ·ç¼–å†™ç­‰å¾…å’Œæç¤ºçš„ä»£ç ï¼ˆä¾‹å¦‚ï¼šæ¡ä»¶å˜é‡ï¼‰ã€‚ä¸‹é¢çš„é˜Ÿåˆ—å°±æ˜¯å¦‚æ­¤ã€‚</p>
<h4 id="6-2-2-threadsafe-queue-â€“-mutex-amp-amp-condition-variable"><a href="#6-2-2-threadsafe-queue-â€“-mutex-amp-amp-condition-variable" class="headerlink" title="6.2.2 threadsafe queue â€“ mutex &amp;&amp; condition_variable"></a>6.2.2 threadsafe queue â€“ mutex &amp;&amp; condition_variable</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadsafe_queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex mut;</span><br><span class="line">    std::queue&lt;T&gt; data_queue;</span><br><span class="line">    std::condition_variable data_cond;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadsafe_queue</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; mut;</span><br><span class="line">        data_queue.<span class="built_in">push</span>(std::<span class="built_in">move</span>(data));</span><br><span class="line">        data_cond.<span class="built_in">notify_one</span>(); <span class="comment">// ä¸ä¸ºç©ºï¼Œé€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wait_and_pop</span><span class="params">(T &amp;value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// å› ä¸ºwaitå¯èƒ½å‡å”¤é†’ï¼Œå› æ­¤è¿™é‡Œéœ€è¦å¤šæ¬¡lock&amp;&amp;unlock</span></span><br><span class="line">        <span class="comment">// å› æ­¤unique_lockç”¨æ¥æ­é…condition_variableæ˜¯æ›´å¥½çš„é€‰æ‹©</span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_cond.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>]&#123;</span><br><span class="line">            <span class="keyword">return</span> !data_queue.<span class="built_in">empty</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        value = std::<span class="built_in">move</span>(data_queue.<span class="built_in">top</span>());</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">wait_and_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_cond.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>]&#123;</span><br><span class="line">            <span class="keyword">return</span> !data_queue.<span class="built_in">empty</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="function">std::shared_ptr&lt;T&gt; <span class="title">res</span><span class="params">(std::make_shared&lt;T&gt;(data_queue.front()))</span></span>;</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* [TOOD]</span></span><br><span class="line"><span class="comment">    * æ„Ÿè§‰è¿™é‡Œå¯ä»¥æŠŠä¸¤ä¸ªpopä¸­åˆ¤æ–­queueæ˜¯å¦ä¸ºç©ºçš„éƒ¨åˆ†æ‹¿å‡ºæ¥</span></span><br><span class="line"><span class="comment">    * æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°é‡Œé¢ï¼Œè¿™æ ·å²‚ä¸æ˜¯æ›´å¥½ï¼Ÿ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">try_pop</span><span class="params">(T &amp;value)</span></span></span><br><span class="line"><span class="function">   </span>&#123;    </span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data_queue.<span class="built_in">empty</span>())  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        value = data_queue.<span class="built_in">front</span>();</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function">std::shared_ptr&lt;T&gt; <span class="title">try_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data_queue.<span class="built_in">empty</span>())  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>; </span><br><span class="line">        <span class="function">std::shared_ptr&lt;T&gt; <span class="title">res</span><span class="params">(make_shared&lt;T&gt;(data_queue.front()))</span></span>;</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> data_queue.<span class="built_in">empty</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„ä»£ç åœ¨æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å½“ push() æ‰§è¡Œ notice_one() ä¹‹åï¼Œå¦‚æœå”¤é†’çš„é‚£ä¸ªçº¿ç¨‹å‘ç”Ÿäº†å¼‚å¸¸æ­»äº†ï¼Œä¾‹å¦‚æ„é€ æ–°çš„ shared_ptr å¯¹è±¡æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆæ‰€æœ‰çº¿ç¨‹éƒ½å°†æ°¸çœ ï¼Œå› ä¸ºæ­¤æ—¶æ²¡æœ‰å…¶å®ƒæ¡ä»¶èƒ½å°†ä»–ä»¬å”¤é†’ï¼Œè§£æ”¾æ–¹æ¡ˆæœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
<ol>
<li>notice_all()ï¼Œä½†æ˜¯è¿™ä¹ˆåšçš„å¼€é”€å¤ªå¤§äº†ï¼Œå› ä¸ºå¾€å¾€åªæœ‰ä¸€ä¸ªçº¿ç¨‹æœ€ç»ˆå”¤é†’ï¼Œè€Œå…¶ä»–çº¿ç¨‹ä»ç„¶éœ€è¦æ²‰ç¡</li>
<li>å½“å”¤é†’çš„çº¿ç¨‹å¼‚å¸¸æ—¶ï¼Œè°ƒç”¨ notice_one() å»å”¤é†’å¦ä¸€ä¸ªçº¿ç¨‹</li>
<li>å°†<code>std::shared_ptr&lt;&gt;</code>çš„åˆå§‹åŒ–è¿‡ç¨‹ç§»åˆ°push()ä¸­ï¼Œå¹¶ä¸”å­˜å‚¨<code>std::shared_ptr&lt;&gt;</code>å®ä¾‹ï¼Œè€Œéç›´æ¥ä½¿ç”¨æ•°æ®çš„å€¼ã€‚å°†<code>std::shared_ptr&lt;&gt;</code>æ‹·è´åˆ°å†…éƒ¨<code>std::queue&lt;&gt;</code>ä¸­ï¼Œå°±ä¸ä¼šæŠ›å‡ºå¼‚å¸¸äº†ï¼Œè¿™æ ·wait_and_pop()åˆæ˜¯å®‰å…¨çš„äº†ã€‚</li>
</ol>
<p>ä¸‹é¢æ˜¯ä½¿ç”¨ç¬¬ä¸‰ç§æ–¹æ¡ˆä¿®æ”¹åçš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadsafe_queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> std::mutex mut;</span><br><span class="line">    std::queue&lt;std::shared_ptr&lt;T&gt;&gt; data_queue;</span><br><span class="line">    std::condition_variable data_cond;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadsafe_queue</span>() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T new_value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// è¿™æ ·å³ä½¿å‘ç”Ÿäº†å¼‚å¸¸ä¹Ÿä¸ä¼šå¯¼è‡´æ‰€æœ‰çº¿ç¨‹æ²‰ç¡</span></span><br><span class="line">        <span class="comment">// å› ä¸ºæ„é€ å¯¹è±¡å¹¶ä¸æ¶‰åŠå¯¹å…±äº«å¯¹è±¡çš„è®¿é—®</span></span><br><span class="line">        <span class="comment">// å› æ­¤å®ƒå®é™…ä¸Šä¸éœ€è¦åŠ é”</span></span><br><span class="line">        <span class="function">std::shared_ptr&lt;T&gt; <span class="title">data</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            std::make_shared&lt;T&gt;(std::move(new_value))</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">        <span class="comment">// åˆ†é…å®Œæ‰åŠ é”ï¼Œå‡å°‘é”æŒæœ‰çš„æ—¶é—´ï¼Œæé«˜å¹¶å‘èƒ½åŠ›</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_queue.<span class="built_in">push</span>(data);</span><br><span class="line">        data_cond.<span class="built_in">notify_one</span>(); <span class="comment">// ä¸ä¸ºç©ºï¼Œé€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wait_and_pop</span><span class="params">(T &amp;value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_cond.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>]&#123;</span><br><span class="line">            <span class="keyword">return</span> !data_queue.<span class="built_in">empty</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        value = std::<span class="built_in">move</span>(*data_queue.<span class="built_in">top</span>());</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">wait_and_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        data_cond.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>]&#123;</span><br><span class="line">            <span class="keyword">return</span> !data_queue.<span class="built_in">empty</span>();</span><br><span class="line">        &#125;);</span><br><span class="line">        std::shared_ptr&lt;T&gt; res = data_queue.<span class="built_in">front</span>(); <span class="comment">// æ”¹ä¸ºèµ‹å€¼è€Œä¸æ˜¯åˆ›å»º</span></span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* [TOOD]</span></span><br><span class="line"><span class="comment">    * æ„Ÿè§‰è¿™é‡Œå¯ä»¥æŠŠä¸¤ä¸ªpopä¸­åˆ¤æ–­queueæ˜¯å¦ä¸ºç©ºçš„éƒ¨åˆ†æ‹¿å‡ºæ¥</span></span><br><span class="line"><span class="comment">    * æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°é‡Œé¢ï¼Œè¿™æ ·å²‚ä¸æ˜¯æ›´å¥½ï¼Ÿ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">try_pop</span><span class="params">(T &amp;value)</span></span></span><br><span class="line"><span class="function">   </span>&#123;    </span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data_queue.<span class="built_in">empty</span>())  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        value = std::<span class="built_in">move</span>(*data_queue.<span class="built_in">front</span>());</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function">std::shared_ptr&lt;T&gt; <span class="title">try_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(data_queue.<span class="built_in">empty</span>())  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>; </span><br><span class="line">        std::shared_ptr&lt;T&gt; res = data_queue.<span class="built_in">front</span>();</span><br><span class="line">        data_queue.<span class="built_in">pop</span>();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mut)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> data_queue.<span class="built_in">empty</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-2-3-threadsaft-queue-small-granularity-amp-amp-condition-variable"><a href="#6-2-3-threadsaft-queue-small-granularity-amp-amp-condition-variable" class="headerlink" title="6.2.3 threadsaft queue -  small granularity &amp;&amp; condition_variable"></a>6.2.3 threadsaft queue -  small granularity &amp;&amp; condition_variable</h4><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå•çº¿ç¨‹ç¯å¢ƒä¸‹ç®€å•é˜Ÿåˆ—çš„å®ç°ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰å¤´å°¾èŠ‚ç‚¹çš„å•é“¾è¡¨ï¼Œå½“é“¾è¡¨ä¸ºç©ºæ—¶ï¼Œå¤´å°¾æŒ‡é’ˆä¸ºç©ºã€‚</p>
<blockquote>
<p>å¤´èŠ‚ç‚¹ !&#x3D; å¤´æŒ‡é’ˆ</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">node</span> </span><br><span class="line">    &#123;</span><br><span class="line">        T data;</span><br><span class="line">        std::unique_ptr&lt;node&gt; next; <span class="comment">//  ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ</span></span><br><span class="line">        <span class="built_in">node</span>(T _data) : <span class="built_in">data</span>(<span class="built_in">move</span>(_data)) &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    std::unique_ptr&lt;node&gt; head;</span><br><span class="line">    node *tail; <span class="comment">// å› ä¸ºè¿™é‡Œçš„tailå¹¶ä¸ä»å †ä¸Šåˆ†é…å†…å­˜ï¼Œä»–åªæ˜¯æŒ‡å‘ä¸€ä¸ªåœ°å€ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆä»£æ›¿</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Queue</span>() &#123;&#125;</span><br><span class="line">    <span class="built_in">Queue</span>(<span class="type">const</span> Queue&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">    Queue&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Queue&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›èŠ‚ç‚¹å¹¶åˆ é™¤</span></span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">try_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!head)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="comment">/* è¿™é‡Œçš„constæ˜¯é¡¶å±‚constï¼ŒæŒ‡å®šresä¸èƒ½å†æŒ‡å‘åˆ«çš„ä¸œè¥¿äº†ï¼Œä½†æ˜¯æ•°æ®ä»ç„¶å¯ä»¥ä¿®æ”¹</span></span><br><span class="line"><span class="comment">        * ä½ å¯èƒ½ç–‘æƒ‘ï¼Œæ—¢ç„¶resä¸èƒ½ä¿®æ”¹ï¼Œä½†æ˜¯æ¥å—è¿”å›å€¼çš„å˜é‡ä¸ä¸€å®šæœ‰è¿™ä¸ªé™åˆ¶çš„ï¼Œä»–æ˜¯å¯ä»¥ä¿®æ”¹çš„ï¼Œæ²¡é”™ï¼Œå¯ä»¥ä¿®æ”¹ï¼Œä½†è¦è®°ä½äº†ï¼Œshared_ptr æ˜¯æœ‰å¼•ç”¨è®¡æ•°çš„ï¼Œä½ ä¿®æ”¹äº†æŒ‡å‘ï¼Œå…¶å®å°±ç›¸å½“äºåœ¨ä¿®æ”¹å¼•ç”¨è®¡æ•°ï¼ˆåˆ›å»ºäº†ä¸€ä¸ªæ–°æŒ‡é’ˆï¼‰ï¼Œè¿™å¹¶ä¸ä¼šä¿®æ”¹åŸæ¥çš„æŒ‡é’ˆï¼Œé¡¶å¤šå¯¼è‡´å¥¹å¼•ç”¨è®¡æ•°ä¸º0ä»è€Œè¢«é”€æ¯äº†ã€‚</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ†åˆ«å–å¾—å¤´èŠ‚ç‚¹çš„æ•°æ®å’ŒnextæŒ‡é’ˆ</span></span><br><span class="line">        <span class="function"><span class="type">const</span> std::shared_ptr&lt;T&gt; <span class="title">res</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            std::make_shared&lt;T&gt;(std::move(head-&gt;data))</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">        <span class="type">const</span> std::unique_ptr&lt;node&gt; old_head = std::<span class="built_in">move</span>(head);</span><br><span class="line">        <span class="comment">// å¤´æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        head = std::<span class="built_in">move</span>(old_head-&gt;next);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T new_value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 1. åˆ›å»ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;node&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> node(std::move(new_value)))</span></span>;</span><br><span class="line">        <span class="type">const</span> node* new_tail = p.<span class="built_in">get</span>();</span><br><span class="line">        <span class="comment">// 2. è®©å°¾èŠ‚ç‚¹çš„nextæŒ‡å‘æ–°èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span>(tail)</span><br><span class="line">            tail-&gt;next = std::<span class="built_in">move</span>(p);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            head = std::<span class="built_in">move</span>(p);</span><br><span class="line">        <span class="comment">// 3. æ›´æ–°å°¾èŠ‚ä¸ºå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">        tail = new_tail;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç åœ¨å•çº¿ç¨‹ä¸‹æ²¡é—®é¢˜ï¼Œä½†æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹é—®é¢˜å°±å¤ªå¤šäº†ï¼</p>
<p>å› ä¸ºåœ¨ç»™å®šçš„å®ç°ä¸­æœ‰ä¸¤ä¸ªæ•°æ®é¡¹(headâ‘ å’Œtailâ‘¡)ï¼›å³ä½¿ï¼Œä½¿ç”¨ä¸¤ä¸ªäº’æ–¥é‡ï¼Œæ¥ä¿æŠ¤å¤´æŒ‡é’ˆå’Œå°¾æŒ‡é’ˆï¼Œä¹Ÿä¼šå‡ºç°é—®é¢˜ã€‚</p>
<p>æ˜¾è€Œæ˜“è§çš„é—®é¢˜å°±æ˜¯push()å¯ä»¥åŒæ—¶ä¿®æ”¹å¤´æŒ‡é’ˆâ‘¤å’Œå°¾æŒ‡é’ˆâ‘¥ï¼Œæ‰€ä»¥push()å‡½æ•°ä¼šåŒæ—¶è·å–ä¸¤ä¸ªäº’æ–¥é‡ã€‚è™½ç„¶ä¼šå°†ä¸¤ä¸ªäº’æ–¥é‡éƒ½ä¸Šé”ï¼Œä½†è¿™è¿˜ä¸æ˜¯å¤ªç³Ÿç³•çš„é—®é¢˜ã€‚ç³Ÿç³•çš„é—®é¢˜æ˜¯push()å’Œpop()éƒ½èƒ½è®¿é—®nextæŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹ï¼špush()å¯æ›´æ–°tail-&gt;nextâ‘£ï¼Œè€Œåtry_pop()è¯»å–head-&gt;nextâ‘¢ã€‚å½“é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œhead&#x3D;&#x3D;tailï¼Œæ‰€ä»¥head-&gt;nextå’Œtail-&gt;nextæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªå¯¹è±¡éœ€è¦ä¿æŠ¤ã€‚ä¸è¿‡ï¼Œâ€œåœ¨åŒä¸€ä¸ªå¯¹è±¡åœ¨æœªè¢«headå’ŒtailåŒæ—¶è®¿é—®æ—¶ï¼Œpush()å’Œtry_pop()é”ä½çš„æ˜¯åŒä¸€ä¸ªé”â€ï¼Œå°±ä¸å¯¹äº†ã€‚æ‰€ä»¥ï¼Œä½ å°±æ²¡æœ‰æ¯”ä¹‹é—´å®ç°æ›´å¥½çš„é€‰æ‹©äº†ã€‚è¿™é‡Œä¼šâ€œæŸ³æš—èŠ±æ˜åˆä¸€æ‘â€å—ï¼Ÿ</p>
<p>å¯ä»¥é€šè¿‡<strong>åˆ†ç¦»æ•°æ®</strong>å®ç°å¹¶å‘ã€‚</p>
<p>é€šè¿‡â€œé¢„åˆ†é…è™šæ‹ŸèŠ‚ç‚¹ï¼ˆæ— æ•°æ®ï¼‰â€ï¼Œç¡®ä¿è¿™ä¸ªèŠ‚ç‚¹æ°¸è¿œåœ¨é˜Ÿåˆ—çš„æœ€åï¼Œç”¨æ¥åˆ†ç¦»å¤´å°¾æŒ‡é’ˆèƒ½è®¿é—®çš„èŠ‚ç‚¹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">node</span> </span><br><span class="line">    &#123;</span><br><span class="line">        std::shared_ptr&lt;T&gt; data;</span><br><span class="line">        std::unique_ptr&lt;node&gt; next; <span class="comment">//  ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unique_ptr&lt;node&gt; head;</span><br><span class="line">    node *tail; </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Queue</span>() <span class="comment">// é¢„åˆ†é…ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹</span></span><br><span class="line">    : <span class="built_in">head</span>(<span class="keyword">new</span> node), <span class="built_in">tail</span>(head.<span class="built_in">get</span>()) </span><br><span class="line">    &#123;&#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    initialization: </span></span><br><span class="line"><span class="comment">        [head(taial)] -&gt; NULL </span></span><br><span class="line"><span class="comment">    push value a</span></span><br><span class="line"><span class="comment">        [head] -&gt; [a(tail)] -&gt; NULL</span></span><br><span class="line"><span class="comment">    push value b</span></span><br><span class="line"><span class="comment">        [head] -&gt; [a] -&gt; [b(tail)] -&gt; NULL</span></span><br><span class="line"><span class="comment">    pop value</span></span><br><span class="line"><span class="comment">        [head] -&gt; [a(tail)] -&gt; NULL</span></span><br><span class="line"><span class="comment">    è¿™æ ·ï¼Œé™¤äº†é˜Ÿåˆ—ä¸ºç©ºçŠ¶æ€ä¸‹ head-&gt;next == tail-&gt;next == NULL</span></span><br><span class="line"><span class="comment">    ä»»ä½•æ—¶å€™ä»–ä»¬ä¸ä¼šä¸ºåŒä¸€ä¸ªå…ƒç´ ï¼Œè€Œé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œä¸ä¼šåŒæ—¶å‘ç”Ÿ push å’Œ pop</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">Queue</span>(<span class="type">const</span> Queue&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">    Queue&amp; <span class="keyword">operator</span>=(<span class="type">const</span> Queue&amp; other) = <span class="keyword">delete</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">try_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(head.<span class="built_in">get</span>() == tail) <span class="comment">// headä¸tailæŒ‡å‘åŒä¸€å…ƒç´ ï¼Œé˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå…ˆ front() å† pop()</span></span><br><span class="line">        <span class="function"><span class="type">const</span> std::shared_ptr&lt;T&gt; <span class="title">res</span><span class="params">(head-&gt;data)</span></span>; <span class="comment">// shared_ptr ä¸éœ€è¦ move</span></span><br><span class="line">        <span class="type">const</span> std::unique_ptr&lt;node&gt; old_head = std::<span class="built_in">move</span>(head);</span><br><span class="line">        head = std::<span class="built_in">move</span>(old_head-&gt;next);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T new_value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// å› ä¸º tail æ˜¯æˆ‘ä»¬é¢„åˆ†é…çš„èŠ‚ç‚¹ï¼Œå› æ­¤ç›´æ¥ä¿®æ”¹ tail çš„ dat å³å¯</span></span><br><span class="line">        <span class="function">std::shared_ptr&lt;T&gt; <span class="title">new_data</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            std::make_shared&lt;T&gt;(std::move(new_value))</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>; </span><br><span class="line">        tail-&gt;data = new_data;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æˆ‘ä»¬å·²ç»æŠŠä¸Šæ¬¡é¢„åˆ†é…çš„ä½¿ç”¨äº†ï¼Œå› æ­¤éœ€è¦é‡æ–°é¢„åˆ†é…å¹¶ä½œä¸ºå°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;node&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> node)</span></span>; </span><br><span class="line">        <span class="type">const</span> node* new_tail = p.<span class="built_in">get</span>();</span><br><span class="line">        tail-&gt;next = std::<span class="built_in">move</span>(p);</span><br><span class="line">        tail = new_tail;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»è¿‡ä¿®æ”¹ä¹‹åï¼Œpush ä¾¿åªéœ€è¦è®¿é—® tailï¼Œè€ŒåŸæ¥è¿˜éœ€è¦è®¿é—® headï¼Œtry_pop éœ€è¦è®¿é—® head å’Œ tailï¼Œä½†æ˜¯ head åªåœ¨å¼€å§‹æ—¶ç”¨äº†ä¸€ä¸‹ï¼Œæ‰€ä»¥å­˜åœ¨çš„æ—¶é—´å¾ˆçŸ­ã€‚</p>
<p>ä¸è¿‡ï¼Œæœ€é‡å¤§çš„æå‡åœ¨äºï¼Œtry_pop å’Œ push ä¸èƒ½å¯¹åŒä¸€èŠ‚ç‚¹è¿›è¡Œæ“ä½œï¼Œä¹Ÿå°±ä¸éœ€è¦äº’æ–¥äº†ã€‚å› æ­¤ï¼Œç°åœ¨åªéœ€è¦ä¸€ä¸ªäº’æ–¥é‡æ¥ä¿æŠ¤ head å’Œ tail å°±è¡Œäº†ã€‚</p>
<p>é‚£ä¹ˆï¼Œè¯¥å¦‚ä½•åŠ é”å‘¢ï¼Ÿ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadsaft_queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">node</span> </span><br><span class="line">    &#123;</span><br><span class="line">        std::shared_ptr&lt;T&gt; data;</span><br><span class="line">        std::unique_ptr&lt;node&gt; next;</span><br><span class="line">    &#125;;</span><br><span class="line">    std::mutex head_mutex, tail_mutex;</span><br><span class="line">    std::unique_ptr&lt;node&gt; head;</span><br><span class="line">    node *tail;</span><br><span class="line"></span><br><span class="line">    <span class="function">node* <span class="title">get_tail</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">tail_lock</span><span class="params">(tail_mutex)</span></span>;</span><br><span class="line">        <span class="keyword">return</span> tail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::unique_ptr&lt;node&gt; <span class="title">pop_head</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">head_lock</span><span class="params">(head_mutex)</span></span>;</span><br><span class="line">        <span class="keyword">if</span>(head.<span class="built_in">get</span>() == <span class="built_in">get_tail</span>()) <span class="comment">// é˜Ÿåˆ—ä¸ºç©º</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        std::unique_ptr&lt;node&gt; old_head = std::<span class="built_in">move</span>(head_mutex);</span><br><span class="line">        <span class="comment">// move æ‰ next ä¹Ÿæ˜¯ä¸ªå¥½äº‹ï¼Œç”¨æˆ·æƒ³å¾—åˆ°çš„åº”è¯¥åªæ˜¯æ•°æ®è€Œä¸æ˜¯ next æŒ‡é’ˆ</span></span><br><span class="line">        head = std::<span class="built_in">move</span>(old_head-&gt;next);</span><br><span class="line">        <span class="keyword">return</span> old_head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadsaft_queue</span>(): <span class="built_in">head</span>(<span class="keyword">new</span> node), <span class="built_in">tail</span>(head.<span class="built_in">get</span>()) &#123;&#125;</span><br><span class="line">    <span class="built_in">threadsaft_queue</span>(<span class="type">const</span> threadsaft_queue&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    threadsaft_queue&amp; <span class="keyword">operator</span>=(<span class="type">const</span> threadsaft_queue&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">try_pop</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::unique_ptr&lt;node&gt; old_head = <span class="built_in">pop_head</span>();</span><br><span class="line">        <span class="keyword">return</span> old_head ? old_head-&gt;data : std::<span class="built_in">shared_ptr</span>&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T new_value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">std::shared_ptr&lt;T&gt; <span class="title">new_data</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            std::make_shared&lt;T&gt;(std::move(new_value))</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">        <span class="function">std::unique_ptr&lt;node&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> node)</span></span>;</span><br><span class="line">        <span class="type">const</span> node *new_tail = p.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">tail_lock</span><span class="params">(tail_mutex)</span></span>;</span><br><span class="line">        tail-&gt;data = new_data;</span><br><span class="line">        tail-&gt;next = std::<span class="built_in">move</span>(p);</span><br><span class="line">        tail = new_tail;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼ŒèŠ‚ç‚¹åŠæ•°æ®çš„åˆ†é…æ—¶â€œå¹¶å‘å®‰å…¨â€çš„ã€‚</p>
</blockquote>
<p>ä¸‹é¢æ˜¯å¯ä¸Šé”å’Œç­‰å¾…çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadsaft_queue</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">node</span> </span><br><span class="line">    &#123;</span><br><span class="line">        std::shared_ptr&lt;T&gt; data;</span><br><span class="line">        std::unique_ptr&lt;node&gt; next;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::mutex head_mutex, tail_mutex;</span><br><span class="line">    std::condition_variable data_cond;</span><br><span class="line">    std::unique_ptr&lt;node&gt; head;</span><br><span class="line">    node *tail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function">node* <span class="title">get_tail</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::unique_ptr&lt;node&gt; <span class="title">pop_head</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">wait_for_data</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;node&gt; <span class="title">wait_pop_head</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;node&gt; <span class="title">wait_pop_head</span><span class="params">(T &amp;value)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function">std::unique_ptr&lt;node&gt; <span class="title">try_pop_head</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;node&gt; <span class="title">try_pop_head</span><span class="params">(T&amp; value)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">try_pop</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">try_pop</span><span class="params">(T &amp;value)</span></span>;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">wait_and_pop</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">wait_and_pop</span><span class="params">(T &amp;value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push</span><span class="params">(T new_value)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*====================*</span></span><br><span class="line"><span class="comment">*       function      *</span></span><br><span class="line"><span class="comment">*=====================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::shared_ptr&lt;T&gt; threadsaft_queue&lt;T&gt;::<span class="built_in">try_pop</span>()</span><br><span class="line">&#123;</span><br><span class="line">    std::unique_ptr&lt;node&gt; old_head = <span class="built_in">try_pop_head</span>();</span><br><span class="line">    <span class="keyword">return</span> old_head ? old_head-&gt;data : std::<span class="built_in">shared_ptr</span>&lt;T&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">bool</span> threadsaft_queue&lt;T&gt;::<span class="built_in">try_pop</span>(T &amp;value)</span><br><span class="line">&#123;</span><br><span class="line">    std::unique_ptr&lt;node&gt; old_head = <span class="built_in">try_pop_head</span>();</span><br><span class="line">    <span class="keyword">return</span> old_head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::shared_ptr&lt;T&gt; threadsaft_queue&lt;T&gt;::<span class="built_in">wait_and_pop</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> std::unique_ptr&lt;node&gt; old_head = <span class="built_in">wait_pop_head</span>();</span><br><span class="line">    <span class="keyword">return</span> old_head-&gt;data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> threadsaft_queue&lt;T&gt;::<span class="built_in">wait_and_pop</span>(T &amp;new_value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> std::unique_ptr&lt;node&gt; old_head = <span class="built_in">wait_and_pop</span>(new_value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">void</span> threadsaft_queue&lt;T&gt;::<span class="built_in">push</span>(T new_value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::shared_ptr&lt;T&gt; <span class="title">new_data</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        std::make_shared&lt;T&gt;(std::move(new_value))</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>;</span><br><span class="line">    <span class="function">std::unique_ptr&lt;node&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> node)</span></span>;</span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">// use &#123;&#125; to unlock early </span></span><br><span class="line">        <span class="type">const</span> node *new_tail = p.<span class="built_in">get</span>();</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">tail_lock</span><span class="params">(tail_mutex)</span></span>;</span><br><span class="line">        tail-&gt;data = new_data;</span><br><span class="line">        tail-&gt;next = std::<span class="built_in">move</span>(p);</span><br><span class="line">        tail = new_tail;</span><br><span class="line">    &#125;</span><br><span class="line">    data_cond.<span class="built_in">notify_one</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="type">bool</span> threadsaft_queue&lt;T&gt;::<span class="built_in">empty</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">head_lock</span><span class="params">(head_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> (head.<span class="built_in">get</span>() == <span class="built_in">get_tail</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*====================*</span></span><br><span class="line"><span class="comment">*   helper function   *</span></span><br><span class="line"><span class="comment">*=====================*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> threadsaft_queue&lt;T&gt;::node* </span><br><span class="line">threadsaft_queue&lt;T&gt;::<span class="built_in">get_tail</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">tail_lock</span><span class="params">(tail_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> tail;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// execute within head mutex</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::unique_ptr&lt;<span class="keyword">typename</span> threadsaft_queue&lt;T&gt;::node&gt; </span><br><span class="line">threadsaft_queue&lt;T&gt;::<span class="built_in">pop_head</span>()</span><br><span class="line">&#123;</span><br><span class="line">    std::unique_ptr&lt;node&gt; old_head = std::<span class="built_in">move</span>(head);</span><br><span class="line">    head = std::<span class="built_in">move</span>(old_head-&gt;next);</span><br><span class="line">    <span class="keyword">return</span> old_head;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::unique_lock&lt;std::mutex&gt; </span><br><span class="line">threadsaft_queue&lt;T&gt;::<span class="built_in">wait_for_data</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">head_lock</span><span class="params">(head_mutex)</span></span>;</span><br><span class="line">    <span class="comment">// å› ä¸ºè·å–äº† head_lockï¼Œæ‰€ä»¥ä¸‹é¢è°ƒç”¨ head.get() å¹¶å‘å®‰å…¨</span></span><br><span class="line">    data_cond.<span class="built_in">wait</span>(head_lock, [&amp;]&#123;</span><br><span class="line">        <span class="keyword">return</span> head.<span class="built_in">get</span>() != <span class="built_in">get_tail</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> std::<span class="built_in">move</span>(head_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::unique_ptr&lt;<span class="keyword">typename</span> threadsaft_queue&lt;T&gt;::node&gt; </span><br><span class="line">threadsaft_queue&lt;T&gt;::<span class="built_in">wait_pop_head</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. [wait] until queue is not empty</span></span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">head_lock</span><span class="params">(wait_for_data())</span></span>;</span><br><span class="line">    <span class="comment">// 2. [pop] head</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pop_head</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::unique_ptr&lt;<span class="keyword">typename</span> threadsaft_queue&lt;T&gt;::node&gt; </span><br><span class="line">threadsaft_queue&lt;T&gt;::<span class="built_in">wait_pop_head</span>(T &amp;value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1. [wait] until queue is not empty</span></span><br><span class="line">    <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">head_lock</span><span class="params">(wait_for_data())</span></span>;</span><br><span class="line">    <span class="comment">// get data</span></span><br><span class="line">    value = std::<span class="built_in">move</span>(*head-&gt;data);</span><br><span class="line">    <span class="comment">// 2. [pop] head</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pop_head</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::unique_ptr&lt;<span class="keyword">typename</span> threadsaft_queue&lt;T&gt;::node&gt; </span><br><span class="line">threadsaft_queue&lt;T&gt;::<span class="built_in">try_pop_head</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">head_lock</span><span class="params">(head_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(head.<span class="built_in">get</span>() == <span class="built_in">get_tail</span>())</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;node&gt;();</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pop_head</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">std::unique_ptr&lt;<span class="keyword">typename</span> threadsaft_queue&lt;T&gt;::node&gt; </span><br><span class="line">threadsaft_queue&lt;T&gt;::<span class="built_in">try_pop_head</span>(T&amp; value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">head_lock</span><span class="params">(head_mutex)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(head.<span class="built_in">get</span>() == <span class="built_in">get_tail</span>())</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;node&gt;();</span><br><span class="line">    value = std::<span class="built_in">move</span>(*head-&gt;data);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pop_head</span>();</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="6-3-design-more-complex-DS"><a href="#6-3-design-more-complex-DS" class="headerlink" title="6.3 design more complex DS"></a>6.3 design more complex DS</h3><p>æ ˆå’Œé˜Ÿåˆ—çš„è®¾è®¡å¤ª easy å•¦ï¼ˆç„¶è€Œæˆ‘ä¹Ÿæ‹›æ¶ä¸ä½ğŸ˜­ï¼‰ï¼Œä¸‹é¢æ¥ç‚¹å¤§çš„ã€‚ğŸ˜ ğŸ˜ ğŸ˜ </p>
<h4 id="6-3-1-threadsafe-dictionary"><a href="#6-3-1-threadsafe-dictionary" class="headerlink" title="6.3.1 threadsafe dictionary"></a>6.3.1 threadsafe dictionary</h4><p>å’Œæ ˆå’Œé˜Ÿåˆ—ä¸€æ ·ï¼Œæ ‡å‡†å®¹å™¨çš„æ¥å£ä¸é€‚åˆå¤šçº¿ç¨‹è¿›è¡Œå¹¶å‘è®¿é—®ï¼Œå› ä¸ºè¿™äº›æ¥å£éƒ½å­˜åœ¨å›ºæœ‰çš„æ¡ä»¶ç«äº‰ï¼Œæ‰€ä»¥è¿™äº›æ¥å£éœ€è¦ç æ‰æˆ–è€…é‡æ–°ä¿®è®¢ã€‚</p>
<p>å¹¶å‘è®¿é—®æ—¶ï¼Œ<code>std::map&lt;&gt;</code> æœ€å¤§çš„é—®é¢˜åœ¨äº â€”â€” è¿­ä»£å™¨ã€‚ä¾‹å¦‚å½“è¿­ä»£å™¨å¼•ç”¨çš„å…ƒç´ è¢«å…¶å®ƒçº¿ç¨‹åˆ é™¤æ—¶ï¼Œè¿­ä»£å™¨å°±ä¼šå¤±æ•ˆï¼Œä½†æˆ‘ä»¬ä¸çŸ¥é“ã€‚</p>
<p>æŸ¥è¯¢è¡¨ï¼ˆå­—å…¸ï¼‰åŸºæœ¬æ“ä½œï¼š</p>
<ol>
<li>ï¼ˆå¢ï¼‰æ·»åŠ  key-value</li>
<li>ï¼ˆåˆ ï¼‰åˆ é™¤ key-value</li>
<li>ï¼ˆæ”¹ï¼‰ä¿®æ”¹æŒ‡å®š key æ‰€å¯¹åº”çš„ value</li>
<li>ï¼ˆæŸ¥ï¼‰æŸ¥è¯¢æŒ‡å®š key æ‰€å¯¹åº”çš„ value</li>
<li>so onâ€¦</li>
</ol>
<p>å¦‚æœä½ åšæŒä¹‹å‰çš„çº¿ç¨‹å®‰å…¨æŒ‡å¯¼æ„è§ï¼Œä¾‹å¦‚ï¼š<strong>ä¸è¦è¿”å›ä¸€ä¸ªå¼•ç”¨</strong>ï¼Œå¹¶ä¸”ç”¨ä¸€ä¸ªç®€å•çš„äº’æ–¥é”å¯¹æ¯ä¸€ä¸ªæˆå‘˜å‡½æ•°è¿›è¡Œä¸Šé”ï¼Œä»¥ç¡®ä¿æ¯ä¸€ä¸ªå‡½æ•°çº¿ç¨‹å®‰å…¨ã€‚æœ€æœ‰å¯èƒ½çš„æ¡ä»¶ç«äº‰åœ¨äºï¼Œå½“ä¸€å¯¹â€œé”®å€¼-æ•°æ®â€åŠ å…¥æ—¶ï¼›å½“ä¸¤ä¸ªçº¿ç¨‹éƒ½æ·»åŠ ä¸€ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆè‚¯å®šä¸€ä¸ªå…ˆä¸€ä¸ªåã€‚ä¸€ç§æ–¹å¼æ˜¯åˆå¹¶â€œæ·»åŠ â€å’Œâ€œä¿®æ”¹â€æ“ä½œä¸ºä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œå°±åƒæ¸…å•3.13å¯¹åŸŸåç³»ç»Ÿç¼“å­˜æ‰€åšçš„é‚£æ ·ã€‚</p>
<p>åŒºåˆ«å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¸€ä¸‹å®¹å™¨çš„å¹¶å‘èƒ½åŠ›ï¼š</p>
<ol>
<li>äºŒå‰æ ‘ï¼Œæ¯”å¦‚ï¼šçº¢é»‘æ ‘</li>
<li>æœ‰åºæ•°ç»„</li>
<li>å“ˆå¸Œè¡¨</li>
</ol>
<p>å…¶ä¸­å“ˆå¸Œè¡¨å¹¶å‘æ€§èƒ½æœ€å¥½ï¼Œå› ä¸ºå“ˆå¸Œè¡¨å¯ä»¥è®¾è®¡ä¸ºåŒ bucket+list(æˆ–æœ‰åºæ•°ç»„)ï¼Œè€Œæ¯ä¸€ä¸ª bucket å¯ä»¥ç‹¬ç«‹åŠ é”ï¼Œbucket ä¸ bucket ä¹‹é—´ç‹¬ç«‹</p>
<p>ä¸‹é¢æ˜¯åŸºäºå“ˆå¸Œè¡¨ï¼Œä½¿ç”¨è¯»å†™é”ï¼Œçº¿ç¨‹å®‰å…¨çš„ï¼Œå­—å…¸ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [TODO] separate bucket_t from threadsafe_lookup_table</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Key, <span class="keyword">typename</span> Value, <span class="keyword">typename</span> Hash = std::hash&lt;Key&gt;&gt;</span><br><span class="line"><span class="keyword">class</span> threadsafe_lookup_table </span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">class</span> <span class="type">bucket_t</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="comment">/* [BUG]</span></span><br><span class="line"><span class="comment">            if you don&#x27;t add this, in the function of get_map()</span></span><br><span class="line"><span class="comment">            you cant access the number of data typed bucket_data</span></span><br><span class="line"><span class="comment">            .... </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">friend</span> <span class="keyword">class</span> threadsafe_lookup_table;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="keyword">typedef</span> std::pair&lt;Key,Value&gt;                 bucket_value;</span><br><span class="line">        <span class="keyword">typedef</span> std::list&lt;bucket_value&gt;              bucket_data;</span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> bucket_data::iterator       bucket_iterator;</span><br><span class="line">        <span class="comment">/* [BUG]</span></span><br><span class="line"><span class="comment">            author use iterator, but it is go CE</span></span><br><span class="line"><span class="comment">            we should use const_iterator</span></span><br><span class="line"><span class="comment">            ... ?</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">typedef</span> <span class="keyword">typename</span> bucket_data::const_iterator bucket_const_iterator;</span><br><span class="line"></span><br><span class="line">        bucket_data data;</span><br><span class="line">        <span class="keyword">mutable</span> std::shared_mutex mutex;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// helper function</span></span><br><span class="line">        <span class="function">bucket_const_iterator <span class="title">find_entry_for</span><span class="params">(<span class="type">const</span> Key &amp;key)</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">/* [BUG]</span></span><br><span class="line"><span class="comment">                </span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">return</span> std::<span class="built_in">find_if</span>(data.<span class="built_in">begin</span>(), data.<span class="built_in">end</span>(), </span><br><span class="line">                [&amp;](<span class="type">const</span> bucket_value &amp;items)&#123;</span><br><span class="line">                    <span class="keyword">return</span> items.first == key;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="comment">// Advise: do not return by reference</span></span><br><span class="line">        <span class="comment">// this function return the value which mapped to the key</span></span><br><span class="line">        <span class="comment">// if ther is no item match, then return default value</span></span><br><span class="line">        <span class="comment">// and the default value is designated by the caller</span></span><br><span class="line">        <span class="function">Value <span class="title">value_for</span><span class="params">(<span class="type">const</span> Key &amp;key, <span class="type">const</span> Value &amp;default_value)</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="function">std::shared_lock&lt;std::shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>; <span class="comment">// read lock</span></span><br><span class="line">            bucket_const_iterator found_entry = <span class="built_in">find_entry_for</span>(key);</span><br><span class="line">            <span class="keyword">return</span> (found_entry == data.<span class="built_in">end</span>()) ? </span><br><span class="line">                default_value : found_entry-&gt;second;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// update if this key is existed otherwise add this K-V</span></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">add_or_update_mapping</span><span class="params">(<span class="type">const</span> Key &amp;key, <span class="type">const</span> Value &amp;value)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>; <span class="comment">// write lock</span></span><br><span class="line">            bucket_const_iterator found_entry = <span class="built_in">find_entry_for</span>(key);</span><br><span class="line">            <span class="keyword">if</span>(found_entry == data.<span class="built_in">end</span>())</span><br><span class="line">                data.<span class="built_in">push_back</span>(<span class="built_in">bucket_value</span>(key, value));</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">/* [BUG]</span></span><br><span class="line"><span class="comment">                    because we use the const_iterator(lower const for the data which pointed on)</span></span><br><span class="line"><span class="comment">                    so we cant&#x27;t modify the data</span></span><br><span class="line"><span class="comment">                    otherwise ust the type convertion</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">                <span class="keyword">auto</span> &amp;data = <span class="built_in">const_cast</span>&lt;bucket_value&amp;&gt;(*found_entry);</span><br><span class="line">                data.second = value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">reomove_mapping</span><span class="params">(<span class="type">const</span> Key &amp;key)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>; <span class="comment">// write lock</span></span><br><span class="line">            bucket_const_iterator found_entry = <span class="built_in">find_entry_for</span>(key);</span><br><span class="line">            <span class="keyword">if</span>(found_entry != data.<span class="built_in">end</span>())</span><br><span class="line">                data.<span class="built_in">erase</span>(found_entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    std::vector&lt;std::unique_ptr&lt;<span class="type">bucket_t</span>&gt;&gt; buckets;</span><br><span class="line">    Hash hasher;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">bucket_t</span>&amp; <span class="title">get_bucket</span><span class="params">(<span class="type">const</span> Key &amp;key)</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">const</span> std::<span class="type">size_t</span> bucket_index = <span class="built_in">hasher</span>(key) % buckets.<span class="built_in">size</span>();</span><br><span class="line">        <span class="comment">// buckets[idx] is a object of unique_ptr </span></span><br><span class="line">        <span class="comment">// so use operator* to get the object which ptr pointed on</span></span><br><span class="line">        <span class="keyword">return</span> *buckets[bucket_index];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">typedef</span> Key   key_type;</span><br><span class="line">    <span class="keyword">typedef</span> Value mapped_type;    </span><br><span class="line">    <span class="keyword">typedef</span> Hash  hash_type;</span><br><span class="line">    <span class="keyword">typedef</span> pair&lt;Key, Value&gt; value_type;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">threadsafe_lookup_table</span>(</span><br><span class="line">        <span class="comment">// the _num_bucket should be a prime so that it will have the best performance</span></span><br><span class="line">        <span class="type">unsigned</span> _num_buckets = <span class="number">19</span>, <span class="type">const</span> Hash &amp;_hasher = <span class="built_in">Hash</span>()</span><br><span class="line">    ) : <span class="built_in">buckets</span>(_num_buckets), <span class="built_in">hasher</span>(_hasher) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; _num_buckets; i ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            buckets[i].<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="type">bucket_t</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">threadsafe_lookup_table</span>(<span class="type">const</span> threadsafe_lookup_table&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    threadsafe_lookup_table&amp; <span class="keyword">operator</span>=(<span class="type">const</span> threadsafe_lookup_table&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*        DO NOT NEED MUTEX</span></span><br><span class="line"><span class="comment">    *  because the count of buckets can&#x27;t changed</span></span><br><span class="line"><span class="comment">    *  so it is needn&#x27;t to lock in the following functions </span></span><br><span class="line"><span class="comment">    *  -- when they call get_bucket() </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// caller, should designated the default value</span></span><br><span class="line">    <span class="function">Value <span class="title">value_for</span><span class="params">(<span class="type">const</span> Key &amp;key, <span class="type">const</span> Value &amp;default_value = Value())</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get_bucket</span>(key).<span class="built_in">value_for</span>(key, default_value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">add_or_update_mapping</span><span class="params">(<span class="type">const</span> Key &amp;key, <span class="type">const</span> Value &amp;value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">get_bucket</span>(key).<span class="built_in">add_or_update_mapping</span>(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">remove_mapping</span><span class="params">(<span class="type">const</span> Key &amp;key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">get_bucket</span>(key).<span class="built_in">reomove_mapping</span>(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// snapshot, return the backup in std::map</span></span><br><span class="line">    <span class="comment">// because we need to lock all buckets</span></span><br><span class="line">    <span class="comment">// if we add unique_lock, it would much wasty</span></span><br><span class="line">    <span class="comment">// so a bettery way is to use shared_mutex(read-lock)</span></span><br><span class="line">    <span class="comment">// so that other threads can also read meanwhile when we have locked a bucket</span></span><br><span class="line">    <span class="comment">// and then, we want to get the current state</span></span><br><span class="line">    <span class="comment">// so we should lock all buckets at one time</span></span><br><span class="line">    <span class="comment">// it is bad to lock and copy bucket one by one</span></span><br><span class="line">    <span class="comment">// because eg. when we lock A, and B will be modified</span></span><br><span class="line">    <span class="comment">// so the state is not consistency</span></span><br><span class="line">    <span class="function">std::map&lt;Key,Value&gt; <span class="title">get_map</span><span class="params">()</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        std::vector&lt;std::unique_lock&lt;std::shared_mutex&gt;&gt; locks;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; buckets.<span class="built_in">size</span>(); i ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            locks.<span class="built_in">push_back</span>(</span><br><span class="line">                std::<span class="built_in">unique_lock</span>&lt;std::shared_mutex&gt;(buckets[i]-&gt;mutex)</span><br><span class="line">            );</span><br><span class="line">        &#125;   </span><br><span class="line">        std::map&lt;Key,Value&gt; res;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; buckets.<span class="built_in">size</span>(); i ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;map_item : buckets[i]-&gt;data)</span><br><span class="line">            &#123;</span><br><span class="line">                res.<span class="built_in">insert</span>(map_item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Key, <span class="keyword">typename</span> Value, <span class="keyword">typename</span> Hash = std::hash&lt;Key&gt;&gt;</span><br><span class="line"><span class="keyword">using</span> _map = threadsafe_lookup_table&lt;Key, Value&gt;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _map&lt;<span class="type">int</span>,string&gt; table;</span><br><span class="line">    table.<span class="built_in">add_or_update_mapping</span>(<span class="number">1</span>, <span class="string">&quot;jyyyx&quot;</span>);</span><br><span class="line">    cout &lt;&lt; table.<span class="built_in">value_for</span>(<span class="number">1</span>) &lt;&lt; endl;</span><br><span class="line">    table.<span class="built_in">add_or_update_mapping</span>(<span class="number">2</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    cout &lt;&lt; table.<span class="built_in">value_for</span>(<span class="number">2</span>) &lt;&lt; endl;</span><br><span class="line">    table.<span class="built_in">add_or_update_mapping</span>(<span class="number">1</span>, <span class="string">&quot;sbg&quot;</span>);</span><br><span class="line">    cout &lt;&lt; table.<span class="built_in">value_for</span>(<span class="number">1</span>) &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        table.<span class="built_in">add_or_update_mapping</span>(i, <span class="string">&quot;jyyyx: &quot;</span> + <span class="built_in">to_string</span>(i));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> mp = table.<span class="built_in">get_map</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;x : mp)</span><br><span class="line">        cout &lt;&lt; x.first &lt;&lt; <span class="string">&#x27; &#x27;</span> &lt;&lt; x.second &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>âš ï¸âš ï¸âš ï¸    <strong>[BUG]</strong>    âš ï¸âš ï¸âš ï¸</p>
</blockquote>
<p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­å‡ºç°äº†å¾ˆæ¶å¿ƒçš„ bugï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘å¤ªè ¢äº†ï¼‰ï¼Œ å¯¼è‡´æˆ‘æ’æŸ¥äº†å¥½é•¿å¥½é•¿æ—¶é—´ï¼Œå…¶å®é”™è¯¯åŸå› å¾ˆç®€å•ã€‚</p>
<p>åœ¨æˆå‘˜å‡½æ•°ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æ·»åŠ äº† const å‡½æ•°ä¿®é¥°ç¬¦ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¿”å›ä¸€ä¸ªè¿­ä»£å™¨çš„è¯ï¼Œå…¶å®è¿”å›çš„æ˜¯ const_iterator è€Œä¸æ˜¯ iteratorï¼Œconst_iterator æœ‰åº•å±‚ä¿®é¥°ï¼Œä¸èƒ½ä¿®æ”¹æŒ‡å‘çš„å¯¹è±¡ã€‚</p>
<p>ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¼šæŠ¥é”™ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iterator&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt; PII;</span><br><span class="line"><span class="keyword">typedef</span> list&lt;PII&gt; L;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">typename</span> L::iterator       L_iterator;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">typename</span> L::const_iterator L_const_iterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    L l;</span><br><span class="line">    <span class="function">L_iterator <span class="title">get</span><span class="params">(<span class="type">int</span> x)</span> <span class="type">const</span> <span class="comment">// (1)</span></span></span><br><span class="line"><span class="function">    </span>&#123;   </span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">find_if</span>(l.<span class="built_in">begin</span>(), l.<span class="built_in">end</span>(), [&amp;](<span class="type">const</span> PII &amp;it)&#123;</span><br><span class="line">            <span class="keyword">return</span> it.first == x;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">get_val</span><span class="params">(<span class="type">int</span> x)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        L_iterator entry = <span class="built_in">get</span>(x);</span><br><span class="line">        <span class="keyword">return</span> entry-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Foo f;</span><br><span class="line">    L &amp;l = f.l; </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++ )   l.<span class="built_in">push_back</span>(&#123;i, i + <span class="number">10</span>&#125;);</span><br><span class="line">    L_iterator it = f.<span class="built_in">get</span>(<span class="number">2</span>);</span><br><span class="line">    cout &lt;&lt; it-&gt;second &lt;&lt; endl;</span><br><span class="line">    it-&gt;second = <span class="number">1000</span>;</span><br><span class="line">    cout &lt;&lt; f.<span class="built_in">get_val</span>(<span class="number">2</span>) &lt;&lt; endl;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;<span class="built_in">test</span>();&#125;</span><br></pre></td></tr></table></figure>

<p>æŠ¥é”™ä¿¡æ¯ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> std::<span class="built_in">find_if</span>(l.<span class="built_in">begin</span>(), l.<span class="built_in">end</span>(), [&amp;](<span class="type">const</span> PII &amp;it)&#123;</span><br><span class="line">      |                ~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">      |                            |</span><br><span class="line">      |                            std::_List_const_iterator&lt;std::pair&lt;<span class="type">int</span>, <span class="type">int</span>&gt; &gt;</span><br><span class="line">   <span class="number">20</span> |             <span class="keyword">return</span> it.first == x;</span><br><span class="line">      |             ~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">   <span class="number">21</span> |         &#125;);</span><br><span class="line">      |         ~~</span><br></pre></td></tr></table></figure>

<p>å¾ˆæ˜æ˜¾çš„å‘ç°ï¼Œç¼–è¯‘å™¨æç¤ºæˆ‘ä»¬ï¼Œæˆ‘ä»¬çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª <code>list::const_iterator</code> ç±»å‹ï¼Œè€Œä¸æ˜¯ <code>list::iterator</code>ã€‚</p>
<p>é‚£ä½ å¯èƒ½ä¼šè¯´ï¼Œå¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›è¿”å› const_ierator çš„è¯ï¼ŒæŠŠ (1) å¤„çš„ const å»æ‰ä¸ä¹…è¡Œäº†ï¼Ÿ</p>
<p>é‚£ä½ å°±å¾—å¥½å¥½çœ‹äº†ï¼Œä¸‹é¢çš„é”™è¯¯æ›´éšè”½å’Œæ¶å¿ƒï¼Œå»æ‰ (1) å¤„çš„ const ä¹‹åï¼Œ</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a.cpp: In member function <span class="string">&#x27;int Foo::get_val(int) const&#x27;</span>:</span><br><span class="line">a.cpp:<span class="number">25</span>:<span class="number">33</span>: error: passing <span class="string">&#x27;const Foo&#x27;</span> as <span class="string">&#x27;this&#x27;</span> argument discards qualifiers [-fpermissive]</span><br><span class="line">   <span class="number">25</span> |         L_iterator entry = <span class="built_in">get</span>(x);</span><br><span class="line">      |                                 ^</span><br><span class="line">a.cpp:<span class="number">17</span>:<span class="number">16</span>: note:   in call to <span class="string">&#x27;L_iterator Foo::get(int)&#x27;</span></span><br><span class="line">   <span class="number">17</span> |     <span class="function">L_iterator <span class="title">get</span><span class="params">(<span class="type">int</span> x)</span> <span class="comment">// (1)</span></span></span><br><span class="line"><span class="function">      |                ^~~</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„æŠ¥é”™ä¿¡æ¯ä¸è®¤çœŸçœ‹ï¼Œç†è§£ç€çœ‹çš„è¯ï¼Œæœ‰å¯èƒ½ä¸çŸ¥é“ä»–è¯´çš„æ˜¯ä»€ä¹ˆæ„æ€ï¼å…¶å®è¿™ç§é”™è¯¯åœ¨ ã€ŠEffective C++ã€‹ ç³»åˆ—éƒ½æ˜¯å¼ºè°ƒè¿‡çš„ï¼ç”±æ­¤å¯è§ï¼Œå…‰ç†è®ºï¼Œä¸å®è·µï¼ŒæŒæ¡çš„çŸ¥è¯†ä¸ç‰¢å›ºï¼Œå®¹æ˜“å¿˜ï¼</p>
<p>å…¶å®äººè¯æ¥è¯´ï¼Œå°±æ˜¯ get_val() æ˜¯ä¸€ä¸ª const æˆå‘˜å‡½æ•°ï¼Œæ‰€ä»¥ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œ **this æŒ‡é’ˆæ˜¯ this *const(åº•å±‚ const)**ï¼Œæƒ³å¿…å¦‚æœä½ å¾ˆæ•æ„Ÿçš„è¯ï¼Œé‚£ä¹ˆä½ åº”è¯¥çŸ¥é“é”™åœ¨å“ªäº†ï¼æˆ‘ä»¬æŠŠä¸€ä¸ª this *const ä¼ å…¥åˆ°ä¸€ä¸ªé const çš„æˆå‘˜å‡½æ•° get() å½“ä¸­ï¼Œé‚£ä¹ˆåœ¨ get() å½“ä¸­å°±å¯èƒ½ä¿®æ”¹æˆ‘ä»¬çš„ thisï¼Œä»è€Œé—´æ¥çš„ç ´åäº† get_val() çš„ const å±æ€§ï¼</p>
<blockquote>
<p>å®é™…ä¸Šï¼Œä¸Šé¢çš„ bug æ­£æ˜¯ ã€Šeffective STLã€‹çš„ä¸€æ¡ item:</p>
<p>â€œconst_iterator fist!â€</p>
</blockquote>
<p>é‚£ä¹ˆï¼Œä½œè€…ä¸ºä»€ä¹ˆä¼šå†™å‡ºå¦‚æ­¤ä¸ä¸¥è°¨çš„ä»£ç å‘¢ï¼Ÿæ˜¯é€‰ï¼Œæœ‰æ„æ€çš„ä¸€ç‚¹æ˜¯ï¼Œå¦‚æœä¸è¿›è¡Œæµ‹è¯•ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼é‚£ä¹ˆï¼Œåˆ°åº•æ˜¯ä½œè€…å†™è¿™æœ¬æ—¶çš„ C++ å’Œç¼–è¯‘å™¨çš„ç‰ˆæœ¬é—®é¢˜ï¼Œè¿˜æ˜¯ä½œè€…å·æ‡’æ²¡æœ‰è¿›è¡Œæµ‹è¯•å‘¢ï¼Ÿå¤§æ¦‚æ˜¯å‰è€…å§ï¼ğŸ˜Š</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wangdamingll/article/details/107086966">æœ€ç»ˆåœ¨è¿™ç¯‡åšå®¢æ‰¾åˆ°äº† bug çš„è§£å†³æ–¹æ¡ˆï¼Œæ„Ÿæ©ï¼</a></p>
</blockquote>
<p>æœ€åï¼Œç»™å‡ºä½¿ç”¨ iterator çš„ç‰ˆæœ¬ï¼Œåªéœ€è¦æŠŠæ‰€æœ‰ const æˆå‘˜å‡½æ•°ä¿®é¥°å»æ‰å°±è¡Œäº†ã€‚</p>
<blockquote>
<p>è§£å†³é—®é¢˜çš„æ–¹æ³•å°±æ˜¯ä¸è®©é—®é¢˜äº§ç”Ÿ ğŸ˜­</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Key,<span class="keyword">typename</span> Value,<span class="keyword">typename</span> Hash=std::hash&lt;Key&gt; &gt;</span><br><span class="line"><span class="keyword">class</span> threadsafe_lookup_table</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">class</span> bucket_type</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">typedef</span> std::pair&lt;Key,Value&gt; bucket_value;</span><br><span class="line">    <span class="keyword">typedef</span> std::list&lt;bucket_value&gt; bucket_data;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> bucket_data::iterator bucket_iterator;</span><br><span class="line">    <span class="keyword">typedef</span> <span class="keyword">typename</span> bucket_data::const_iterator bucket_const_iterator;</span><br><span class="line">    </span><br><span class="line">    bucket_data data;</span><br><span class="line">    <span class="keyword">mutable</span> shared_mutex mutex;  <span class="comment">// 1</span></span><br><span class="line">    <span class="function">bucket_iterator <span class="title">find_entry_for</span><span class="params">(Key <span class="type">const</span>&amp; key)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> std::<span class="built_in">find_if</span>(data.<span class="built_in">begin</span>(),data.<span class="built_in">end</span>(),</span><br><span class="line">      [&amp;](bucket_value <span class="type">const</span>&amp; item)</span><br><span class="line">      &#123;<span class="keyword">return</span> item.first==key;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">public</span>:</span><br><span class="line">    <span class="function">Value <span class="title">value_for</span><span class="params">(Key <span class="type">const</span>&amp; key,Value <span class="type">const</span>&amp; default_value)</span> </span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="function">shared_lock&lt;shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>;  <span class="comment">// 3</span></span><br><span class="line">      bucket_iterator <span class="type">const</span> found_entry=<span class="built_in">find_entry_for</span>(key);</span><br><span class="line">      <span class="keyword">return</span> (found_entry==data.<span class="built_in">end</span>())?</span><br><span class="line">        default_value:found_entry-&gt;second;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">add_or_update_mapping</span><span class="params">(Key <span class="type">const</span>&amp; key,Value <span class="type">const</span>&amp; value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="function">std::unique_lock&lt;shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>;  <span class="comment">// 4</span></span><br><span class="line">      bucket_iterator <span class="type">const</span> found_entry=<span class="built_in">find_entry_for</span>(key);</span><br><span class="line">      <span class="keyword">if</span>(found_entry==data.<span class="built_in">end</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        data.<span class="built_in">push_back</span>(<span class="built_in">bucket_value</span>(key,value));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        found_entry-&gt;second=value;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">remove_mapping</span><span class="params">(Key <span class="type">const</span>&amp; key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="function">std::unique_lock&lt;shared_mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>;  <span class="comment">// 5</span></span><br><span class="line">      bucket_iterator <span class="type">const</span> found_entry=<span class="built_in">find_entry_for</span>(key);</span><br><span class="line">      <span class="keyword">if</span>(found_entry!=data.<span class="built_in">end</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        data.<span class="built_in">erase</span>(found_entry);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;bucket_type&gt; &gt; buckets;  <span class="comment">// 6</span></span><br><span class="line">  Hash hasher;</span><br><span class="line">  <span class="function">bucket_type&amp; <span class="title">get_bucket</span><span class="params">(Key <span class="type">const</span>&amp; key)</span>   <span class="comment">// 7</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    std::<span class="type">size_t</span> <span class="type">const</span> bucket_index=<span class="built_in">hasher</span>(key)%buckets.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">return</span> *buckets[bucket_index];</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">typedef</span> Key key_type;</span><br><span class="line">  <span class="keyword">typedef</span> Value mapped_type;</span><br><span class="line">  <span class="keyword">typedef</span> Hash hash_type;</span><br><span class="line">  <span class="built_in">threadsafe_lookup_table</span>(</span><br><span class="line">    <span class="type">unsigned</span> num_buckets=<span class="number">19</span>,Hash <span class="type">const</span>&amp; hasher_=<span class="built_in">Hash</span>()):</span><br><span class="line">    <span class="built_in">buckets</span>(num_buckets),<span class="built_in">hasher</span>(hasher_)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">unsigned</span> i=<span class="number">0</span>;i&lt;num_buckets;++i)</span><br><span class="line">    &#123;</span><br><span class="line">      buckets[i].<span class="built_in">reset</span>(<span class="keyword">new</span> bucket_type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">threadsafe_lookup_table</span>(threadsafe_lookup_table <span class="type">const</span>&amp; other)=<span class="keyword">delete</span>;</span><br><span class="line">  threadsafe_lookup_table&amp; <span class="keyword">operator</span>=(</span><br><span class="line">    threadsafe_lookup_table <span class="type">const</span>&amp; other)=<span class="keyword">delete</span>;</span><br><span class="line">  <span class="function">Value <span class="title">value_for</span><span class="params">(Key <span class="type">const</span>&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                  Value <span class="type">const</span>&amp; default_value=Value())</span> </span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">get_bucket</span>(key).<span class="built_in">value_for</span>(key,default_value);  <span class="comment">// 8</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">add_or_update_mapping</span><span class="params">(Key <span class="type">const</span>&amp; key,Value <span class="type">const</span>&amp; value)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">get_bucket</span>(key).<span class="built_in">add_or_update_mapping</span>(key,value);  <span class="comment">// 9</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">remove_mapping</span><span class="params">(Key <span class="type">const</span>&amp; key)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">get_bucket</span>(key).<span class="built_in">remove_mapping</span>(key);  <span class="comment">// 10</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    threadsafe_lookup_table&lt;<span class="type">int</span>,string&gt; table;</span><br><span class="line">    table.<span class="built_in">add_or_update_mapping</span>(<span class="number">1</span>, <span class="string">&quot;jyyyx&quot;</span>);</span><br><span class="line">    cout &lt;&lt; table.<span class="built_in">value_for</span>(<span class="number">1</span>) &lt;&lt; endl;</span><br><span class="line">    table.<span class="built_in">add_or_update_mapping</span>(<span class="number">2</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    cout &lt;&lt; table.<span class="built_in">value_for</span>(<span class="number">2</span>) &lt;&lt; endl;</span><br><span class="line">    table.<span class="built_in">add_or_update_mapping</span>(<span class="number">1</span>, <span class="string">&quot;sbg&quot;</span>);</span><br><span class="line">    cout &lt;&lt; table.<span class="built_in">value_for</span>(<span class="number">1</span>) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="6-3-2-threadsafe-list"><a href="#6-3-2-threadsafe-list" class="headerlink" title="6.3.2 threadsafe list"></a>6.3.2 threadsafe list</h4><p>åŒä¸Šé¢è°ˆåˆ°çš„ï¼Œå®¹å™¨ä¸­çš„è¿­ä»£å™¨åœ¨å¹¶å‘æ—¶ä¼šäº§ç”Ÿéº»çƒ¦ï¼Œé™¤éè®©è¿­ä»£å™¨æŒæœ‰é”ï¼Œä½†è¿™æ˜¯ä¸ªå¾ˆæ§½ç³•çš„åšæ³•ã€‚å› æ­¤è¿™æ„å‘³ç€è¿­ä»£å™¨å—é™äºé”ï¼Œè€Œä¸æ˜¯å®¹å™¨ã€‚</p>
<p>æ›¿ä»£æ–¹æ¡ˆæ˜¯ä½¿ç”¨è¿­ä»£å‡½æ•°ï¼Œä¾‹å¦‚ï¼šå°† for_each ä½œä¸ºå®¹å™¨æœ¬èº«çš„ä¸€éƒ¨åˆ†ã€‚è¿™å°±èƒ½è®©å®¹å™¨å¯¹è¿­ä»£çš„éƒ¨åˆ†è¿›è¡Œè´Ÿè´£å’Œé”å®šã€‚</p>
<p>ã€‚ã€‚ã€‚</p>
<p>é“¾è¡¨åº”è¯¥æä¾›çš„æ“ä½œï¼šï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰</p>
<ul>
<li>å‘åˆ—è¡¨æ·»åŠ ä¸€ä¸ªå…ƒç´ </li>
<li>å½“æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œå°±ä»é“¾è¡¨ä¸­åˆ é™¤æŸä¸ªå…ƒç´ </li>
<li>å½“æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œä»é“¾è¡¨ä¸­æŸ¥æ‰¾æŸä¸ªå…ƒç´ </li>
<li>å½“æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶ï¼Œæ›´æ–°é“¾è¡¨ä¸­çš„æŸä¸ªå…ƒç´ </li>
<li>ï¼ˆmoreï¼‰å°†å½“å‰å®¹å™¨ä¸­é“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œå¤åˆ¶åˆ°å¦ä¸€ä¸ªå®¹å™¨ä¸­</li>
<li>ï¼ˆmoreï¼‰æ’å…¥å…ƒç´ åˆ°æŸä¸ªæŒ‡å®šçš„ä½ç½®</li>
</ul>
<p>ä½¿ç”¨ç»†ç²’åº¦é”æœ€åˆçš„æƒ³æ³•ï¼Œæ˜¯ä¸ºäº†<strong>è®©é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹éƒ½æ‹¥æœ‰ä¸€ä¸ªäº’æ–¥é‡</strong>ã€‚å½“é“¾è¡¨å¾ˆé•¿æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¾ˆå¤šçš„äº’æ–¥é‡!è¿™æ ·çš„å¥½å¤„æ˜¯å¯¹äºé“¾è¡¨ä¸­æ¯ä¸€ä¸ªç‹¬ç«‹çš„éƒ¨åˆ†ï¼Œéƒ½èƒ½å®ç°çœŸå®çš„å¹¶å‘ï¼šå…¶çœŸæ­£æ„Ÿå…´è¶£çš„æ˜¯å¯¹æŒæœ‰çš„èŠ‚ç‚¹ç¾¤è¿›è¡Œä¸Šé”ï¼Œå¹¶ä¸”åœ¨ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶ï¼Œå¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œé‡Šæ”¾ã€‚ä¸‹é¢çš„æ¸…å•ä¸­å°†å±•ç¤ºè¿™æ ·çš„ä¸€ä¸ªé“¾è¡¨å®ç°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a list with head-node</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">threadsafe_list</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">node</span> </span><br><span class="line">    &#123;</span><br><span class="line">        std::mutex m;</span><br><span class="line">        std::shared_ptr&lt;T&gt; data;</span><br><span class="line">        std::unique_ptr&lt;node&gt; next;</span><br><span class="line">        <span class="built_in">node</span>() : <span class="built_in">next</span>() &#123;&#125; <span class="comment">// default NULL</span></span><br><span class="line">        <span class="built_in">node</span>(<span class="type">const</span> T &amp;value) : <span class="built_in">data</span>(std::<span class="built_in">make_shared</span>&lt;T&gt;(value)) &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    node head; <span class="comment">// default head node</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">threadsafe_list</span>() = <span class="keyword">default</span>;</span><br><span class="line">    ~<span class="built_in">threadsafe_list</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">remove_if</span>([](<span class="type">const</span> node&amp;)&#123;<span class="keyword">return</span> <span class="literal">true</span>;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">threadsafe_list</span>(<span class="type">const</span> threadsafe_list&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    threadsafe_list&amp; <span class="keyword">operator</span>=(<span class="type">const</span> threadsafe_list&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">push_front</span><span class="params">(<span class="type">const</span> T &amp;value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// the construction of new node neeedn&#x27;t to lock</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;node&gt; <span class="title">new_node</span><span class="params">(<span class="keyword">new</span> node(value))</span></span>;</span><br><span class="line">        <span class="comment">// lock head</span></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(head.m)</span></span>;</span><br><span class="line">        new_node-&gt;next = std::<span class="built_in">move</span>(head.next);</span><br><span class="line">        head.next = std::<span class="built_in">move</span>(new_node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Function&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">for_each</span><span class="params">(Function f)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// the node of head is a fixed and virtual node</span></span><br><span class="line">        <span class="comment">// it means no one can change it, so there is no &quot;race condition&quot;</span></span><br><span class="line">        <span class="comment">// -- when multiple threads execute the follow sentense</span></span><br><span class="line">        node *current = &amp;head; </span><br><span class="line">        <span class="comment">// because we need do unlock by self, so unique_lock does</span></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(head.m)</span></span>; </span><br><span class="line">        <span class="keyword">while</span>(node *next = current-&gt;next.<span class="built_in">get</span>()) <span class="comment">// declare a local variable </span></span><br><span class="line">                            <span class="comment">// -- next in the while&#x27;s check ????</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// lock the next first and unlock the past succession</span></span><br><span class="line">            <span class="comment">// there is a beautiful name for this process: hand to hand lock ^_^</span></span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">next_lock</span><span class="params">(next-&gt;m)</span></span>;</span><br><span class="line">            lock.<span class="built_in">unlock</span>();</span><br><span class="line">            <span class="comment">// because head is a virtual node(no data)</span></span><br><span class="line">            <span class="comment">// we should call funtion start at head-&gt;next</span></span><br><span class="line">            <span class="built_in">f</span>(*next-&gt;data);</span><br><span class="line">            current = next;</span><br><span class="line">            lock = std::<span class="built_in">move</span>(next_lock);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// expect for unary Predicate</span></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Predicate&gt;</span></span><br><span class="line"><span class="function">    std::shared_ptr&lt;T&gt; <span class="title">find_first_if</span><span class="params">(Predicate p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        node *current = &amp;head;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(head.m)</span></span>;</span><br><span class="line">        <span class="keyword">while</span>(node *next = current-&gt;next.<span class="built_in">get</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">next_lock</span><span class="params">(next-&gt;m)</span></span>;</span><br><span class="line">            lock.<span class="built_in">unlock</span>();</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">p</span>(*next-&gt;data))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> next-&gt;data;</span><br><span class="line">            &#125;</span><br><span class="line">            current = next;</span><br><span class="line">            lock = std::<span class="built_in">move</span>(next_lock);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">shared_ptr</span>&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Predicate&gt;</span></span><br><span class="line"><span class="function">    <span class="type">void</span> <span class="title">remove_if</span><span class="params">(Predicate p)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        node *current = &amp;head;</span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(head.m)</span></span>;</span><br><span class="line">        <span class="keyword">while</span>(node *next = current-&gt;next.<span class="built_in">get</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">next_lock</span><span class="params">(next-&gt;m)</span></span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">p</span>(*next-&gt;data))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// usage of smart_ptr and move() can avoid to execute big copy</span></span><br><span class="line">                std::unique_ptr&lt;node&gt; old_next = std::<span class="built_in">move</span>(current-&gt;next);</span><br><span class="line">                current-&gt;next = std::<span class="built_in">move</span>(next-&gt;next);</span><br><span class="line">                next_lock.<span class="built_in">unlock</span>();</span><br><span class="line">                <span class="comment">// needn&#x27;t to move current to next node</span></span><br><span class="line">                <span class="comment">// because the new next node will satisfiy Predicate, too</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> </span><br><span class="line">            &#123;</span><br><span class="line">                lock.<span class="built_in">unlock</span>();</span><br><span class="line">                current = next;</span><br><span class="line">                lock = std::<span class="built_in">move</span>(next_lock);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    threadsafe_list&lt;<span class="type">int</span>&gt; L;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++ )   </span><br><span class="line">        L.<span class="built_in">push_front</span>(i % <span class="number">5</span>);</span><br><span class="line">    L.for_each([](<span class="type">const</span> <span class="type">int</span> &amp;x)&#123;cout &lt;&lt; x &lt;&lt; <span class="string">&#x27; &#x27;</span>;&#125;);</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    L.<span class="built_in">remove_if</span>([](<span class="type">const</span> <span class="type">int</span> &amp;x)&#123;<span class="keyword">return</span> x == <span class="number">4</span>;&#125;);</span><br><span class="line">    L.for_each([](<span class="type">const</span> <span class="type">int</span> &amp;x)&#123;cout &lt;&lt; x &lt;&lt; <span class="string">&#x27; &#x27;</span>;&#125;);</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">auto</span> it = L.<span class="built_in">find_first_if</span>([](<span class="type">const</span> <span class="type">int</span> x)&#123;<span class="keyword">return</span> x == <span class="number">1</span>;&#125;);</span><br><span class="line">    *it = <span class="number">1024</span>;</span><br><span class="line">    L.for_each([](<span class="type">const</span> <span class="type">int</span> &amp;x)&#123;cout &lt;&lt; x &lt;&lt; <span class="string">&#x27; &#x27;</span>;&#125;);</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    it = L.<span class="built_in">find_first_if</span>([](<span class="type">const</span> <span class="type">int</span> x)&#123;<span class="keyword">return</span> x == <span class="number">1</span>;&#125;);</span><br><span class="line">    *it = <span class="number">666</span>;</span><br><span class="line">    L.for_each([](<span class="type">const</span> <span class="type">int</span> &amp;x)&#123;cout &lt;&lt; x &lt;&lt; <span class="string">&#x27; &#x27;</span>;&#125;);</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    L.<span class="built_in">remove_if</span>([](<span class="type">const</span> <span class="type">int</span> &amp;x)&#123;<span class="keyword">return</span> x == <span class="number">1</span>;&#125;);</span><br><span class="line">    L.for_each([](<span class="type">const</span> <span class="type">int</span> &amp;x)&#123;cout &lt;&lt; x &lt;&lt; <span class="string">&#x27; &#x27;</span>;&#125;);</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å­¦åˆ°äº†ä¸ªæ–°ä¸œè¥¿</p>
</blockquote>
<p>å¯ä»¥åœ¨ while çš„æ¡ä»¶åˆ¤æ–­é‡Œé¢å£°åä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ while body é‡Œé¢ä½¿ç”¨ï¼Œä½†æ˜¯æœ‰ä¸ªé™åˆ¶ï¼Œå°±æ˜¯åªèƒ½ä½¿ç”¨é»˜è®¤æ¯”ä»·æ–¹å¼ï¼ˆ0ï¼Œnullptrï¼‰ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨ç‰¹æ®Šçš„æ¯”è¾ƒæ–¹å¼ï¼Œä¾‹å¦‚ï¼š<code>while((int y = x + 1) != 3)</code>ï¼Œé‚£ä¹ˆå±€éƒ¨å˜é‡ y çš„ä½œç”¨åŸŸå®é™…ä¸Šæ˜¯ <code>(int y = x + 1)</code> è¿™ä¸ªæ‹¬å·é‡Œé¢ï¼Œé™¤äº†æ‹¬å·å°±æ­»äº†ï¼Œå› æ­¤åœ¨ while body é‡Œé¢ä¹Ÿå°±æ— æ³•ä½¿ç”¨ï¼Œè¿™æ—¶å€™ï¼Œå°±å¾—åœ¨ while å¤–é¢å£°æ˜è¿™ä¸ªå˜é‡äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="type">int</span> y = x + <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; y &lt;&lt; endl;</span><br><span class="line">        x ++ ;</span><br><span class="line">        <span class="keyword">if</span>(y &gt; <span class="number">10</span>)  <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="P7-data-struct-without-mutex"><a href="#P7-data-struct-without-mutex" class="headerlink" title="P7 data struct without mutex"></a>P7 data struct without mutex</h2><p><font color=blue> TODO</font></p>
<h2 id="P8-concurrency-design"><a href="#P8-concurrency-design" class="headerlink" title="P8 concurrency design"></a>P8 concurrency design</h2><p><font color=blue> TODO</font></p>
<p>æ–‡ç« ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>çº¿ç¨‹é—´åˆ’åˆ†æ•°æ®çš„æŠ€æœ¯</li>
<li>å½±å“å¹¶å‘ä»£ç æ€§èƒ½çš„å› ç´ </li>
<li>æ€§èƒ½å› ç´ æ˜¯å¦‚ä½•å½±å“æ•°æ®ç»“æ„çš„è®¾è®¡</li>
<li>å¤šçº¿ç¨‹ä»£ç ä¸­çš„å¼‚å¸¸å®‰å…¨</li>
<li>å¯æ‹“å±•æ€§</li>
<li>å¹¶è¡Œç®—æ³•çš„å®ç°</li>
</ul>
<h3 id="8-1-divide-work-among-threads"><a href="#8-1-divide-work-among-threads" class="headerlink" title="8.1 divide work among threads"></a>8.1 divide work among threads</h3><p> æœ€ç›´ç™½çš„ï¼Œå¯¹äºä¸€ä¸ªçº¿ç¨‹ï¼Œæ˜¯è®©ä»–å……å½“ä¸€ä¸ªâ€œå…¨èƒ½â€çº¿ç¨‹æ¥å®Œæˆæ‰€æœ‰å·¥ä½œï¼Œè¿˜æ˜¯å……å½“ä¸€ä¸ªâ€œä¸“ä¸šâ€çº¿ç¨‹å®Œæˆä¸€ä»¶äº‹æƒ…ï¼Œè¿˜æ˜¯ä¸¤è€…æ··åˆã€‚ç­‰ç­‰ã€‚è¯¸å¦‚æ­¤ç±»çš„é€‰æ‹©è‡³å…³é‡è¦ã€‚</p>
<h4 id="8-1-1-prepare-divide"><a href="#8-1-1-prepare-divide" class="headerlink" title="8.1.1 prepare divide"></a>8.1.1 prepare divide</h4><p>æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨åˆ›å»ºçº¿ç¨‹ä¹‹å‰ï¼ŒæŠŠå¤šä¸ªä»»åŠ¡åˆ†ä¸ºä¸€ç»„ï¼Œä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ç»„ä»»åŠ¡ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·åšä»ç„¶æœ‰ä¸€ä¸ªä¸å¤ªå¥½çš„åœ°æ–¹ï¼Œå¦‚ä»£ç 2.8 æ‰€ç¤ºï¼Œæœ€åä¸€æ­¥ä»ç„¶æ˜¯ä¸²è¡Œçš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">accumulate_block</span>&lt;Iterator,T&gt;()</span><br><span class="line">(block_start,last,results[num_threads<span class="number">-1</span>]); </span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ï¼Œaccumulate å®é™…ä¸Šæ˜¯ä¸€ä¸ªé€’å‡æ“ä½œï¼ˆå³ä»»åŠ¡çš„ä¸ªæ•°æ˜¯é€æ¸å‡å°‘çš„ï¼‰ï¼Œå› æ­¤å½“çº¿ç¨‹æ•°é‡å¤§äºä¸€ä¸ªçº¿ç¨‹ä¸Šæœ€å°å¤„ç†é¡¹æ—¶ï¼Œå¯ä»¥å¯¹å‡½æ•°é€’å½’è°ƒç”¨ï¼Œè¿™æ ·å°±å¯ä»¥æœ€å¤§åŒ–å¹¶è¡Œçš„ç¨‹åº¦ã€‚</p>
<blockquote>
<p>åŸæœ¬é€’å½’æ˜¯ç­‰ä¸€ä¸ªå­å‡½æ•°æ‰§è¡Œå®Œï¼Œå†æ‰§è¡Œå¦ä¸€ä¸ªå­å‡½æ•°ã€‚ä½†æ˜¯é€šè¿‡çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åŒæ—¶é€’å½’æ‰§è¡Œå¤šä¸ªå­å‡½æ•°ï¼Œè‡ªå‡½æ•°å†é€’å½’æ‰§è¡Œå¤šä¸ªè‡ªå‡½æ•°ï¼Œæ¯ä¸ªå­å‡½æ•°å ç”¨ä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>å¯ä»¥å‘ç°ï¼Œè¿™å¯¹çº¿ç¨‹æ•°é‡çš„è¦æ±‚æ¯”è¾ƒé«˜ï¼</p>
</blockquote>
<h4 id="8-1-2-recursion-divide"><a href="#8-1-2-recursion-divide" class="headerlink" title="8.1.2 recursion divide"></a>8.1.2 recursion divide</h4><p>å¿«é€Ÿæ’åºå°±ç”¨åˆ°äº†é€’å½’ï¼</p>
<p>ä¸‹é¢æ˜¯ list çš„å¿«é€Ÿæ’åºç®—æ³•çš„å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TODO</span></span><br></pre></td></tr></table></figure>



<h4 id="8-1-3-work-divide"><a href="#8-1-3-work-divide" class="headerlink" title="8.1.3 work divide"></a>8.1.3 work divide</h4><p>å¤šçº¿ç¨‹ä¸‹æœ‰ä¸¤ä¸ªå±é™©éœ€è¦åˆ†ç¦»ã€‚</p>
<ol>
<li>ç¬¬ä¸€ä¸ªæ˜¯å¯¹é”™è¯¯çš„æ‹…å¿§ï¼ˆä¸»è¦è¡¨ç°ä¸ºçº¿ç¨‹é—´å…±äº«ç€å¾ˆå¤šçš„æ•°æ®ï¼‰</li>
<li>ç¬¬äºŒä¸ªæ˜¯ä¸åŒçš„çº¿ç¨‹éœ€è¦ç›¸äº’ç­‰å¾…ã€‚</li>
</ol>
<p>è¿™ä¸¤ç§æƒ…å†µéƒ½æ˜¯å› ä¸ºçº¿ç¨‹é—´å¾ˆå¯†åˆ‡çš„äº¤äº’ã€‚å¦‚æœè¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå°±éœ€è¦çœ‹ä¸€ä¸‹ä¸ºä»€ä¹ˆå‘ç”Ÿè¿™ä¹ˆå¤šäº¤äº’ã€‚å½“æ‰€æœ‰äº¤äº’éƒ½æœ‰ç›¸åŒçš„é—®é¢˜ï¼Œå°±åº”è¯¥ä½¿ç”¨ä½†çº¿ç¨‹æ¥è§£å†³ï¼Œå¹¶å°†å¼•ç”¨åŒä¸€æºçš„çº¿ç¨‹æå–å‡ºæ¥ã€‚æˆ–è€…å½“æœ‰ä¸¤ä¸ªçº¿ç¨‹éœ€è¦é¢‘ç¹çš„äº¤æµï¼Œåœ¨æ²¡æœ‰å…¶å®ƒçº¿ç¨‹æ—¶ï¼Œå°±å¯ä»¥å°†è¿™ä¸¤ä¸ªçº¿ç¨‹åˆä¸ºä¸€ä¸ªçº¿ç¨‹ã€‚</p>
<p>å½“ä»»åŠ¡ä¼šåº”ç”¨åˆ°ç›¸åŒçš„ä»»åŠ¡åºåˆ—ï¼Œå»å¤„ç†ç‹¬ç«‹çš„æ•°æ®é¡¹æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨ pipeline ç³»ç»Ÿè¿›è¡Œå¹¶å‘ã€‚</p>
<p>ä½¿ç”¨è¿™ç§æ–¹å¼åˆ’åˆ†å·¥ä½œï¼Œå¯ä»¥ä¸ºæµæ°´çº¿ä¸­çš„æ¯ä¸€é˜¶æ®µæ“ä½œåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹ã€‚</p>
<h3 id="8-2-performance-of-concurrency"><a href="#8-2-performance-of-concurrency" class="headerlink" title="8.2 performance of concurrency"></a>8.2 performance of concurrency</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_34074740/article/details/92960920">å…³äºcpuçš„æ ¸å’ŒèŠ¯</a></p>
<p>åŸç”Ÿå¤šæ ¸ï¼Œå°è£…å¤šèŠ¯</p>
<p>ä½œè€…è¯´ï¼Œå››æ ¸ä¸¤èŠ¯çš„cpuå¯ä»¥æœ‰16ä¸ªçº¿ç¨‹ï¼Œæ˜¯å› ä¸ºè¶…çº¿ç¨‹å—ï¼Ÿ</p>
</blockquote>
<h4 id="8-2-1-cpu-count"><a href="#8-2-1-cpu-count" class="headerlink" title="8.2.1 cpu count"></a>8.2.1 cpu count</h4><p>ä¸ºäº†æ‹“å±•çº¿ç¨‹çš„æ•°é‡ï¼Œä¸”ä¸ç¡¬ä»¶æ‰€æ”¯æŒçš„å¹¶å‘çº¿ç¨‹æ•°ä¸€è‡´ï¼ŒC++ æ ‡å‡†åº“æä¾›äº† <code>std::thread::hardware_concurrency()</code>ï¼Œä½¿ç”¨è¿™ä¸ªå‡½æ•°å¯ä»¥çŸ¥é“åœ¨ç»™å®šç¡¬ä»¶ä¸Šå¯ä»¥æ‹“å±•çš„çº¿ç¨‹æ•°é‡ã€‚</p>
<blockquote>
<p>æˆ‘çš„ MacBook M1 Air æ‰æ˜¯ 8</p>
</blockquote>
<p>ä½¿ç”¨çš„çº¿ç¨‹ä¸ªæ•°ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œå¤ªå¤šçº¿ç¨‹è¿›è¡Œåˆ‡æ¢ä¼šå¯¼è‡´ oversubscription(è¶…é¢è¯·æ±‚)</p>
<h4 id="8-2-2-race-data-and-cache-ping-pong"><a href="#8-2-2-race-data-and-cache-ping-pong" class="headerlink" title="8.2.2 race data and cache ping-pong"></a>8.2.2 race data and cache ping-pong</h4><p>å½“å¤šä¸ªçº¿ç¨‹åœ¨ä¸åŒçš„å¤„ç†å™¨ä¸Šæ—¶ï¼Œå¯¹æ•°æ®çš„è¯»å–é€šå¸¸ä¸ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºæ•°æ®ä¼šæ‹·è´åˆ°æ¯ä¸ªçº¿ç¨‹çš„ç¼“å­˜ä¸­ï¼Œå¹¶è®©å¤šä¸ªå¤„ç†å™¨åŒæ—¶å¤„ç†ã€‚ç„¶é¹…ï¼Œå½“æœ‰çº¿ç¨‹å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä¸”éœ€è¦åŒæ­¥åˆ°å…¶å®ƒæ ¸å¿ƒçš„ç¼“å­˜æ—¶ï¼Œéœ€è¦æµªè´¹ä¸€å®šçš„æ—¶é—´ã€‚è¿™æ ·çš„ä¿®æ”¹å¯èƒ½ä¼šè®©å…¶å®ƒå¤„ç†æƒ…åœä¸‹æ¥ï¼Œç­‰å¾…ç¡¬ä»¶å†…å­˜æ›´æ–°ç¼“å­˜çš„æ•°æ®ã€‚å¹¶ä¸”ï¼Œæ ¹æ® cpu æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹åˆ«æ…¢çš„æ“ä½œã€‚</p>
<blockquote>
<p><strong>high contention</strong>ï¼šå¤„ç†å™¨ä¹‹é—´ç»å¸¸éœ€è¦ç­‰å¾…æ•°æ®çš„æ›´æ”¹</p>
<p><strong>low contention</strong>ï¼šå¤„ç†å™¨ä¹‹é—´å¾ˆå°‘éœ€è¦ç›¸äº’ç­‰å¾…</p>
<p><strong>cache ping-pong</strong>ï¼šåœ¨å¤šä¸ªå¤„ç†å™¨çš„ç¼“å­˜ä¹‹é—´æ¥å›ä¼ é€’çš„æ•°æ®</p>
</blockquote>
<p>é¿å… cache ping-pong çš„æ–¹æ³•å°±æ˜¯å‡å°‘ä¸¤ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå†…å­˜ä¸ºæ­¢çš„ç«äº‰</p>
<h4 id="8-2-3-false-sharing"><a href="#8-2-3-false-sharing" class="headerlink" title="8.2.3 false sharing"></a>8.2.3 false sharing</h4><p>cache line sharing</p>
<p>å…¶å®å°±æ˜¯å‡å°‘ç¼“å­˜çš„åˆ·æ–°æ¬¡æ•°ï¼Œé™ä½æ•°æ®ä¼ªå…±äº«ç¼“å­˜çš„æ¦‚ç‡ã€‚</p>
<h4 id="â€¦"><a href="#â€¦" class="headerlink" title="â€¦."></a>â€¦.</h4><h3 id="8-3-design-data-struct-for-multiple-thread-environment"><a href="#8-3-design-data-struct-for-multiple-thread-environment" class="headerlink" title="8.3 design data struct for multiple thread environment"></a>8.3 design data struct for multiple thread environment</h3><p>å½“ä¸ºå¤šçº¿ç¨‹è®¾è®¡æ•°æ®ç»“æ„æ—¶ï¼Œéœ€è¦è€ƒè™‘ï¼šcontention, false sharing, data proximity(æ•°æ®ä¸´è¿‘)ï¼Œè¿™äº›å¯¹æ€§èƒ½éƒ½æœ‰é‡å¤§å½±å“ã€‚</p>
<h2 id="P9-advance-thread-management"><a href="#P9-advance-thread-management" class="headerlink" title="P9 advance thread management"></a>P9 advance thread management</h2><h2 id="P10-parallel-algorithm"><a href="#P10-parallel-algorithm" class="headerlink" title="P10 parallel algorithm"></a>P10 parallel algorithm</h2><h2 id="P11-test-and-debug-in-multiple-thread-environment"><a href="#P11-test-and-debug-in-multiple-thread-environment" class="headerlink" title="P11 test and debug in multiple thread environment"></a>P11 test and debug in multiple thread environment</h2><p><strong>[TODO]</strong></p>
<h2 id="A-Myheader"><a href="#A-Myheader" class="headerlink" title="A Myheader"></a>A Myheader</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">@copyright jyyyx</span></span><br><span class="line"><span class="comment">    __</span></span><br><span class="line"><span class="comment">.__(.)&lt; (qaq ~~~)</span></span><br><span class="line"><span class="comment">\____)</span></span><br><span class="line"><span class="comment">~~~~~~~~~~~~~~~~~--&gt;</span></span><br><span class="line"><span class="comment">When I write this, only god and me konw what the program mean</span></span><br><span class="line"><span class="comment">Now, only god konws QAQ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MY_HEADER_GUARD</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_HEADER_GUARD</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span> <span class="comment">// C++ Concurrency Library for thread&#x27;s management</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span> <span class="comment">// std::mutex &amp; std::mutex_guard</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span> <span class="comment">// condition_variable &amp; condition_variable_any</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;future&gt;</span> <span class="comment">// future &amp; async</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;shared_mutex&gt;</span> <span class="comment">// std::shared_mutex</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span>    <span class="comment">// for_each</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ratio&gt;</span>    <span class="comment">// class ratio</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span> <span class="comment">// unique_ptr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_set&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;type_traits&gt;</span> <span class="comment">// result_of</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;numeric&gt;</span> <span class="comment">// accumulate</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;functional&gt;</span>   <span class="comment">// mem_fn</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;chrono&gt;</span>   <span class="comment">// std::chrono, time point, time duration</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span>    <span class="comment">// copy_exception renamed to make_exception_ptr</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span>   <span class="comment">// put_time</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;climits&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*================ header ================*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_BEGIN std::cout &lt;&lt; <span class="string">&quot;|------ begin ------|&quot;</span> &lt;&lt; std::endl;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRINT_END   std::cout &lt;&lt; <span class="string">&quot;|------- end -------|&quot;</span> &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">std::mutex some_mutex;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br></pre></td></tr></table></figure>



<h2 id="B-std-atomic"><a href="#B-std-atomic" class="headerlink" title="B std::atomic"></a>B std::atomic</h2><h3 id="0-reference"><a href="#0-reference" class="headerlink" title="0. reference"></a>0. reference</h3><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7086226046931959838">ref1</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/haippy/p/3284540.html">ref2</a></p>
<p><a target="_blank" rel="noopener" href="https://subingwen.cn/cpp/atomic/">ref3</a></p>
<h3 id="1-introduce"><a href="#1-introduce" class="headerlink" title="1. introduce"></a>1. introduce</h3><p><code>#include &lt;atomic&gt;</code></p>
<p>åŸå­ç±»å‹(<code>std::atoimic&lt;T&gt;</code>)æ˜¯å°è£…äº†ä¸€ä¸ªå€¼çš„ç±»å‹ï¼Œå®ƒçš„è®¿é—®ä¿è¯ä¸ä¼šå¯¼è‡´æ•°æ®çš„ç«äº‰ï¼Œå¹¶ä¸”å¯ä»¥ç”¨äºåœ¨ä¸åŒçš„çº¿ç¨‹ä¹‹é—´åŒæ­¥å†…å­˜è®¿é—®ã€‚</p>
<p>åŸå­ç±»å‹ä¸»è¦ç”¨äºé¿å…åŠ é”è§£é”æ—¶çš„ç¨‹åºå¼€é”€ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚(äº’æ–¥é‡åŠ é”ä¸€èˆ¬é’ˆå¯¹çš„æ˜¯ä¸€ä¸ªä»£ç æ®µï¼Œè€ŒåŸå­æ“ä½œé’ˆå¯¹çš„ä¸€èˆ¬æ˜¯ä¸€ä¸ªå˜é‡)ã€‚</p>
<p>åŸå­ç±»å‹æ˜¯â€œæŒ‡ä»¤â€å±‚é¢ä¸Šçš„æ”¯æŒï¼Œå› æ­¤å®ƒçš„æ€§èƒ½ç›¸æ¯”é”å’Œæ¶ˆæ¯ä¼ é€’ä¼šå¥½å¾ˆå¤šã€‚</p>
<p>std::atomic å†…éƒ¨ä½¿ç”¨äº† CAS(compare and swap) è‡ªæ—‹é”ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">CompareAndSwap</span><span class="params">(<span class="type">int</span> *ptr, <span class="type">int</span> expceted, <span class="type">int</span> <span class="keyword">new</span>)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> actual = *ptr;</span><br><span class="line">    <span class="keyword">if</span>(actual == expected) *ptr = <span class="keyword">new</span>;</span><br><span class="line">    <span class="keyword">return</span> *actual;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*===================================*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">lock</span><span class="params">(<span class="type">lock_t</span> *lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">CompareAndSwap</span>(&amp;lock-&gt;flag, <span class="number">0</span>, <span class="number">1</span>) == <span class="number">1</span>) </span><br><span class="line">        	; <span class="comment">// spin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-std-atomic-flag"><a href="#2-std-atomic-flag" class="headerlink" title="2. std::atomic_flag"></a>2. std::atomic_flag</h3><p><code>std::atomic_flag</code>æ˜¯åŸå­å¸ƒå°”ç±»å‹ï¼Œå®ƒä¿è¯æ˜¯å…é”ï¼ˆlock-freeï¼‰çš„ã€‚åªæ”¯æŒä¸¤ç§æ“ä½œï¼š<code>test-andset</code> å’Œ <code>clear</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;myheader.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¿…é¡»ä½¿ç”¨ ATOMIC_FLAG_INIT åˆå§‹åŒ–ï¼Œå¦åˆ™å€¼æ˜¯ UB</span></span><br><span class="line"><span class="comment">// å³ï¼Œæ—¢ä¸æ˜¯ set ä¹Ÿä¸æ˜¯ clear</span></span><br><span class="line"><span class="comment">// è¯¥å®å°†ä½¿å¾— atomic_flag å¤„äº clear çŠ¶æ€</span></span><br><span class="line">std::atomic_flag alock = ATOMIC_FLAG_INIT;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(alock.<span class="built_in">test_and_set</span>(std::memory_order_acquire)) <span class="comment">// è·å¾—é”</span></span><br><span class="line">            ;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Output from thread &quot;</span> &lt;&lt; n &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        alock.<span class="built_in">clear</span>(std::memory_order_release);  <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    std::vector&lt;std::thread&gt; v;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++ )</span><br><span class="line">        v.<span class="built_in">emplace_back</span>(f, i); <span class="comment">// é€šè¿‡ emplace ä¼ å…¥çº¿ç¨‹å’Œå‚æ•°</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;it : v)   </span><br><span class="line">        it.<span class="built_in">join</span>();</span><br><span class="line">    PRINT_END;  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è‡ªæ—‹é”</p>
<blockquote>
<p>è‡ªæ—‹é”æ˜¯<strong>è®¡ç®—æœºç§‘å­¦ç”¨äºå¤šçº¿ç¨‹åŒæ­¥çš„ä¸€ç§é”</strong>ï¼Œçº¿ç¨‹åå¤æ£€æŸ¥é”å˜é‡æ˜¯å¦å¯ç”¨ã€‚ ç”±äºçº¿ç¨‹åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ä¿æŒæ‰§è¡Œï¼Œå› æ­¤æ˜¯ä¸€ç§<strong>å¿™ç­‰å¾…</strong>ã€‚ ä¸€æ—¦è·å–äº†è‡ªæ—‹é”ï¼Œçº¿ç¨‹ä¼šä¸€ç›´ä¿æŒè¯¥é”ï¼Œç›´è‡³æ˜¾å¼é‡Šæ”¾è‡ªæ—‹é”ã€‚ è‡ªæ—‹é”é¿å…äº†è¿›ç¨‹ä¸Šä¸‹æ–‡çš„è°ƒåº¦å¼€é”€ï¼Œå› æ­¤å¯¹äºçº¿ç¨‹åªä¼šé˜»å¡å¾ˆçŸ­æ—¶é—´çš„åœºåˆæ˜¯æœ‰æ•ˆçš„ã€‚</p>
</blockquote>
<p>C++ æ˜¯ç³»ç»Ÿçº§åˆ«çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ ‡å‡†å§”å‘˜ä¼šçš„ç›®æ ‡æ˜¯ä¸éœ€è¦æ¯”C++è¿˜è¦åº•å±‚çš„é«˜çº§è¯­è¨€ã€‚C++ åº”è¯¥å‘ç¨‹åºå‘˜æä¾›è¶³å¤Ÿçš„çµæ´»æ€§ï¼Œæ— éšœç¢çš„å»åšä»–ä»¬æƒ³è¦åšçš„äº‹æƒ…ã€‚éœ€è¦æ—¶ï¼Œä¹Ÿå¯ä»¥â€œæ¥è§¦ç¡¬ä»¶â€ã€‚åŸå­ç±»å‹å’ŒåŸå­æ“ä½œå°±å¯ä»¥<strong>â€œæ¥è§¦ç¡¬ä»¶â€</strong>ï¼Œå¹¶æä¾›åº•å±‚åŒæ­¥æ“ä½œï¼Œé€šå¸¸ä¼šå°†æŒ‡ä»¤æ•°ç¼©å‡åˆ° 1ï½2 ä¸ªCPUæŒ‡ä»¤ã€‚</p>
<p><font color = blue> TODO âŒ›ï¸âŒ›ï¸âŒ›ï¸Â </font></p>
<p>ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread_pool_cpp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_COUNT 10000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Counter</span> </span><br><span class="line">&#123;</span><br><span class="line">    mutex m;</span><br><span class="line">    <span class="comment">// int value;</span></span><br><span class="line">    atomic&lt;<span class="type">int</span>&gt; value;</span><br><span class="line">    <span class="built_in">Counter</span>(<span class="type">int</span> _value = <span class="number">0</span>) : <span class="built_in">value</span>(_value) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">produce</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_COUNT; i ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            value ++ ;</span><br><span class="line">            <span class="comment">// cout &lt;&lt; &quot;increment number: &quot; &lt;&lt; value </span></span><br><span class="line">            <span class="comment">//     &lt;&lt; &quot;, threadID: &quot; &lt;&lt; hex &lt;&lt; this_thread::get_id() &lt;&lt; &quot;\n&quot;;</span></span><br><span class="line">            <span class="comment">// this_thread::sleep_for(chrono::milliseconds(100));</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">consume</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_COUNT; i ++ )</span><br><span class="line">        &#123;</span><br><span class="line">            value -- ;</span><br><span class="line">            <span class="comment">// cout &lt;&lt; &quot;decrement number: &quot; &lt;&lt; value </span></span><br><span class="line">            <span class="comment">//     &lt;&lt; &quot;, threadID: &quot; &lt;&lt; hex &lt;&lt; this_thread::get_id() &lt;&lt; &quot;\n&quot;;</span></span><br><span class="line">            <span class="comment">// this_thread::sleep_for(chrono::milliseconds(100));</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Counter <span class="title">c</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> increment = <span class="built_in">bind</span>(&amp;Counter::produce, &amp;c);</span><br><span class="line">    <span class="keyword">auto</span> decrement = <span class="built_in">bind</span>(&amp;Counter::consume, &amp;c);</span><br><span class="line">    <span class="function">thread <span class="title">t1</span><span class="params">(increment)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t3</span><span class="params">(decrement)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t4</span><span class="params">(decrement)</span></span>;</span><br><span class="line">    <span class="function">thread <span class="title">t2</span><span class="params">(increment)</span></span>;</span><br><span class="line">    t1.<span class="built_in">join</span>();</span><br><span class="line">    t2.<span class="built_in">join</span>();</span><br><span class="line">    t3.<span class="built_in">join</span>();</span><br><span class="line">    t4.<span class="built_in">join</span>();</span><br><span class="line">    cout &lt;&lt; c.value &lt;&lt; endl;</span><br><span class="line">;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PRINT_BEGIN;</span><br><span class="line">    <span class="built_in">Test</span>();</span><br><span class="line">    PRINT_END;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>















<h1 id="C-thread-pool"><a href="#C-thread-pool" class="headerlink" title="C:thread_pool"></a>C:thread_pool</h1><h2 id="ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š"><a href="#ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š" class="headerlink" title="ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š"></a>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://subingwen.cn/categories/Linux/">document</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1sv41177e4/?p=19">multiple thread</a>    <a target="_blank" rel="noopener" href="https://subingwen.cn/linux/threadpool/#1-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8E%9F%E7%90%86">document</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1jV411J795/?spm_id_from=333.999.0.0&vd_source=38033fe3a1f136728a1d6f8acf710b51">thread pool in C</a></p>
</blockquote>
<h2 id="ä¸€ã€-å¤šçº¿ç¨‹"><a href="#ä¸€ã€-å¤šçº¿ç¨‹" class="headerlink" title="ä¸€ã€ å¤šçº¿ç¨‹"></a>ä¸€ã€ å¤šçº¿ç¨‹</h2><h3 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1. æ¦‚å¿µ"></a>1. æ¦‚å¿µ</h3><blockquote>
<p>å¯ä»¥é€šè¿‡sleepç¨å¾®æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºã€‚ã€‚ã€‚</p>
</blockquote>
<p>ä¸€ä¸ªçº¿ç¨‹å°±æ˜¯ä¸€ä¸ªâ€œä»»åŠ¡â€ï¼Œå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œå®ƒå°±å¼€å§‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡ã€‚</p>
<h3 id="2-åˆ›å»ºçº¿ç¨‹"><a href="#2-åˆ›å»ºçº¿ç¨‹" class="headerlink" title="2. åˆ›å»ºçº¿ç¨‹"></a>2. åˆ›å»ºçº¿ç¨‹</h3><p>æˆ‘ä»¬åˆ›å»ºçš„çº¿ç¨‹ä¸€èˆ¬ç§°ä¸ºå­çº¿ç¨‹ï¼Œä¸ºå•¥ä¸æ˜¯ä¸»çº¿ç¨‹å‘¢ï¼Ÿå› ä¸ºä¸»çº¿ç¨‹ä¸€èˆ¬æ˜¯é»˜è®¤å­˜åœ¨çš„ï¼å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­åˆ›å»ºçº¿ç¨‹æ—¶ï¼Œä¸»è¿›ç¨‹ä¼šå˜æˆä¸»çº¿ç¨‹ã€‚</p>
<p>å› æ­¤ï¼Œå½“ä¸»çº¿ç¨‹é€€å‡ºæ—¶ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸»è¿›ç¨‹ç»“æŸäº†ï¼Œä¹Ÿå°±æ„å‘³ç€åˆ†é…çš„è™šæ‹Ÿå†…å­˜ç©ºé—´è¦é‡Šæ”¾ï¼Œå› æ­¤å…¶ä½™çº¿ç¨‹ä¹Ÿè¦é”€æ¯ã€‚</p>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨ç›¸å…³APIï¼Œä½¿å¾—ä¸»çº¿ç¨‹é€€å‡ºåï¼Œå­çº¿ç¨‹ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œã€‚</p>
<p><code>pthread_create();</code></p>
<h3 id="3-çº¿ç¨‹é€€å‡º"><a href="#3-çº¿ç¨‹é€€å‡º" class="headerlink" title="3. çº¿ç¨‹é€€å‡º"></a>3. çº¿ç¨‹é€€å‡º</h3><p>åœ¨ä¸Šé¢æåˆ°ï¼Œå¦‚æœä¸»çº¿ç¨‹é€€å‡ºï¼Œå­çº¿ç¨‹æ²¡æ‰§è¡Œå®Œä¹Ÿä¼šç»“æŸã€‚æˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œåªéœ€è¦ä½¿ç”¨ï¼ˆçº¿ç¨‹é€€å‡ºå‡½æ•°ï¼‰å°±å¯ä»¥è®©å½“å‰çº¿ç¨‹â€œé©¬ä¸Šé€€å‡ºâ€ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„æ­£å¸¸è¿è¡Œã€‚</p>
<p>å¦‚æœæ‰€æœ‰çº¿ç¨‹éƒ½ä½¿ç”¨äº†çº¿ç¨‹é€€å‡ºå‡½æ•°ï¼Œé‚£ä¹ˆå½“æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œç»“æŸä¹‹åï¼Œç³»ç»Ÿèµ„æºï¼ˆè™šæ‹Ÿåœ°å€ç©ºé—´ï¼‰ä¼šè¢«æ“ä½œç³»ç»Ÿå›æ”¶ã€‚</p>
<p><code>pthread_exit();</code></p>
<p>å½“çº¿ç¨‹é€€å‡ºæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡è¯¥å‡½æ•°ä¼ å‡ºä¸€äº›æ•°æ®ï¼ˆå…¶å®æ˜¯è¿™äº›æ•°æ®çš„åœ°å€ï¼‰ã€‚ æ³¨æ„ä¸èƒ½ä¼ å‡ºæ ˆä¸­çš„æ•°æ®ã€‚</p>
<p>å¯ä»¥é€šè¿‡ä¸‹é¢ä¸‰ç§æ–¹å¼ï¼š</p>
<ol>
<li>heap</li>
<li>å…¨å±€&#x2F;static</li>
<li>æ¥å—ä¸»çº¿ç¨‹ï¼ˆè°ƒç”¨çº¿ç¨‹ï¼‰ä¸­çš„æ•°æ®ï¼Œå¹¶ä¼ å‡ºæ¥å—çš„æ•°æ®ã€‚</li>
</ol>
<p>å­çº¿ç¨‹æ˜¯ä¸èƒ½è®¿é—®ä¸»çº¿ç¨‹çš„æ ˆç©ºé—´çš„ï¼Œä½†æ˜¯ä¸»çº¿ç¨‹å¯ä»¥ä¸»åŠ¨ä¼ å…¥ã€‚</p>
<h3 id="4-çº¿ç¨‹å›æ”¶"><a href="#4-çº¿ç¨‹å›æ”¶" class="headerlink" title="4. çº¿ç¨‹å›æ”¶"></a>4. çº¿ç¨‹å›æ”¶</h3><p>ä¸»çº¿ç¨‹å›æ”¶å­çº¿ç¨‹èµ„æºã€‚</p>
<p>å›æ”¶ä»€ä¹ˆèµ„æºå‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œçº¿ç¨‹ç‹¬å stackç­‰ï¼Œå½“çº¿ç¨‹ç»“æŸæ—¶ï¼Œstackèµ„æºä¼šè‡ªåŠ¨é‡Šæ”¾ï¼Œheapï¼Œdataå’Œtextç­‰å…±äº«èµ„æºç”±æ“ä½œç³»ç»Ÿè‡ªåŠ¨å›æ”¶ã€‚</p>
<p>ä¸»çº¿ç¨‹å›æ”¶çš„ä¸»è¦æ˜¯â€œå†…æ ¸èµ„æºâ€ã€‚è¿™ä»¶äº‹å­çº¿ç¨‹è‡ªå·±å¹²ä¸äº†ã€‚</p>
<p><code>pthread_join(tid, **retval);</code></p>
<p>ä¸ºä»€ä¹ˆç¬¬äºŒä¸ªå‚æ•°æ¥å—ä¸€ä¸ªäºŒçº§æŒ‡é’ˆå‘¢ï¼Ÿ</p>
<p>å› ä¸ºæˆ‘ä»¬å¦‚æœè¦æ¥å—<code>pthread_exit();</code> è¿”å›çš„æ•°æ®ï¼Œå°±è¦ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆï¼ˆ<code>void*</code>ï¼‰æ¥å—ã€‚å› ä¸º <code>pthread_exit</code> è¿”å›çš„æ•°æ®ç±»å‹å°±æ˜¯ <code>void*</code>ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬è¦ä¿®æ”¹ä¸€ä¸ªæŒ‡é’ˆï¼ˆæ³¨æ„ä¸æ˜¯æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ï¼‰ï¼Œå°±è¦ä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆçš„åœ°å€ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦ç”¨æŒ‡å‘æŒ‡é’ˆçš„æŒ‡é’ˆã€‚</p>
<p>æ³¨æ„ join æ˜¯ä¸€ä¸ªé˜»å¡å‡½æ•°ã€‚</p>
<h3 id="5-çº¿ç¨‹åˆ†ç¦»"><a href="#5-çº¿ç¨‹åˆ†ç¦»" class="headerlink" title="5. çº¿ç¨‹åˆ†ç¦»"></a>5. çº¿ç¨‹åˆ†ç¦»</h3><p>detachï¼šåˆ†ç¦»</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹æ˜¯æœ‰è”ç³»çš„ï¼Œå³ï¼Œä¸»çº¿ç¨‹éœ€è¦é‡Šæ”¾å­çº¿ç¨‹æ‹¥æœ‰çš„èµ„æºã€‚</p>
<p>è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹åï¼ŒæŒ‡å®šçš„å­çº¿ç¨‹å’Œä¸»çº¿ç¨‹åˆ†ç¦»ã€‚å½“å­çº¿ç¨‹æ¨å‡ºçš„æ—¶å€™ï¼Œå…¶å ç”¨çš„å†…æ ¸èµ„æºå°±è¢«ç³»ç»Ÿçš„å…¶ä»–è¿›ç¨‹æ¥ç®¡å¹¶å›æ”¶äº†ã€‚ï¼ˆè¿™æ„å‘³ç€ <code>pthread_join()</code> æ— æ³•å›æ”¶å­çº¿ç¨‹èµ„æºï¼‰</p>
<p>å¯èƒ½ä½ ä¼šé—®ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº† <code>join</code> äº†å•Šï¼Œä»–å·²ç»å¯ä»¥å®Œæˆçº¿ç¨‹å†…æ ¸èµ„æºå›æ”¶çš„ä»»åŠ¡äº†ï¼Œä¸ºä»€ä¹ˆè¿˜æœ‰æœ‰ <code>detach</code> å‘¢ï¼Œè¿™æ˜¯å› ä¸º <code>join</code> æ˜¯é˜»å¡æ€§å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å­çº¿ç¨‹ä¸ <code>exit</code> æ—¶ï¼Œä¸»çº¿ç¨‹å°±ä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ã€‚</p>
<p><code>detach</code> å°±æ˜¯ç»™ä¸»çº¿ç¨‹å‡è´Ÿçš„ï¼Œå½“å­çº¿ç¨‹ç»“æŸæ—¶ï¼Œå…¶èµ„æºä¸éœ€è¦ä¸»çº¿ç¨‹æ¥å›æ”¶ã€‚</p>
<p>ä½†æ˜¯å½“ä¸»çº¿ç¨‹ç»“æŸæ—¶ï¼Œå­çº¿ç¨‹ä»ç„¶ä¼šç»“æŸï¼Œå³ä½¿å­çº¿ç¨‹å¤„äº <code>detach</code> çŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›ä¸»çº¿ç¨‹ç»“æŸæ—¶ä¸å½±å“å­çº¿ç¨‹çš„æ‰§è¡Œï¼Œåº”è¯¥è°ƒç”¨ <code>exit</code> å‡½æ•°ã€‚ </p>
<h2 id="äºŒã€çº¿ç¨‹åŒæ­¥"><a href="#äºŒã€çº¿ç¨‹åŒæ­¥" class="headerlink" title="äºŒã€çº¿ç¨‹åŒæ­¥"></a>äºŒã€çº¿ç¨‹åŒæ­¥</h2><h3 id="1-ä¸ºä»€ä¹ˆè¦åŒæ­¥"><a href="#1-ä¸ºä»€ä¹ˆè¦åŒæ­¥" class="headerlink" title="1. ä¸ºä»€ä¹ˆè¦åŒæ­¥"></a>1. ä¸ºä»€ä¹ˆè¦åŒæ­¥</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX (25)</span></span><br><span class="line"><span class="type">int</span> sum;    </span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">add</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> ch = *(<span class="type">char</span>*)arg;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> old = sum;</span><br><span class="line">        old ++ ;</span><br><span class="line">        <span class="comment">// do something to make thread run currency worse</span></span><br><span class="line">        usleep(<span class="number">5</span>);</span><br><span class="line">        sum = old;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%c]sum = %d\n&quot;</span>, ch, sum);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> p1, p2;</span><br><span class="line">    <span class="type">char</span> c1 = <span class="string">&#x27;A&#x27;</span>, c2 = <span class="string">&#x27;B&#x27;</span>;</span><br><span class="line">    pthread_create(&amp;p1, <span class="literal">NULL</span>, add, (<span class="type">void</span>*)&amp;c1);</span><br><span class="line">    pthread_create(&amp;p2, <span class="literal">NULL</span>, add, (<span class="type">void</span>*)&amp;c2);</span><br><span class="line">    pthread_join(p1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(p2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;End, sum = %d\n&quot;</span>, sum);</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä»£ç å¸Œæœ›é€šè¿‡ä¸¤ä¸ªçº¿ç¨‹å®ç°å¯¹ sum çš„ç´¯åŠ ï¼Œå¹¶å¸Œæœ›ç»“æœä¸º50ï¼Œä½†æ˜¯å´ä¸æ˜¯ã€‚</p>
<h3 id="2-äº’æ–¥é”"><a href="#2-äº’æ–¥é”" class="headerlink" title="2. äº’æ–¥é”"></a>2. äº’æ–¥é”</h3><p>å¦‚å…¶åï¼Œäº’æ–¥é”åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚</p>
<p>é€šè¿‡äº’æ–¥é”ï¼Œè®©çº¿ç¨‹çº¿æ€§æ‰§è¡Œï¼Œè¿™æ ·å°±ä¸ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚</p>
<p>é”çš„ä¸ªæ•°å–å†³äºä¸´ç•Œèµ„æºè€Œä¸æ˜¯çº¿ç¨‹ä¸ªæ•°ã€‚</p>
<p>å¦å¤–ï¼Œå¯ä»¥å‘ç°ä½¿ç”¨äº’æ–¥é”çš„å‡½æ•°éƒ½æ˜¯ç”¨çš„mutexæŒ‡é’ˆï¼Œè¿™å°±è¯´æ˜æˆ‘ä»¬çš„mutexä¸èƒ½åˆ†é…åœ¨ å±€éƒ¨å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// create mutex</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex;</span><br><span class="line"><span class="comment">// init</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_init</span><span class="params">(<span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,<span class="type">const</span> <span class="type">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br><span class="line"><span class="comment">// destory</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_destory</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="comment">// lockï¼Œå·²ç»lockä¼šé˜»å¡</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_lock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="comment">// å·²ç»lockä¼šå¤±è´¥</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_trylock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br></pre></td></tr></table></figure>

<p>key :strict</p>
<blockquote>
<p>ç”¨æ¥ä¿®é¥°æŒ‡é’ˆï¼Œåªæœ‰è¿™ä¸ªå…³é”®å­—ä¿®é¥°çš„æŒ‡é’ˆæ‰èƒ½è®¿é—®æŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œå…¶ä»–æŒ‡é’ˆéƒ½æ˜¯ä¸è¡Œçš„ï¼ˆç±»å‹åŒ¹é…ä¹Ÿä¸è¡Œï¼‰ã€‚</p>
<p><strong>TODO:</strong> ä½†æ˜¯æˆ‘æµ‹è¯•ä¸è¡Œï¼Ÿï¼Ÿ</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(<span class="type">int</span> *restrict p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     ++ *p;</span><br><span class="line">    <span class="type">int</span> *q = (<span class="type">int</span>*)p;</span><br><span class="line">    ++ *q;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">add</span>(&amp;x);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, x);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-è¯»å†™é”"><a href="#3-è¯»å†™é”" class="headerlink" title="3. è¯»å†™é”"></a>3. è¯»å†™é”</h3><p>è¯»å†™é”æ˜¯äº’æ–¥é”çš„å‡çº§ç‰ˆã€‚åœ¨åšè¯»æ“ä½œçš„æ—¶å€™å¯ä»¥æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ï¼Œå¦‚æœæ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯è¯»æ“ä½œï¼Œé‚£ä¹ˆéƒ½æ˜¯å¹¶è¡Œçš„ã€‚è€Œä½¿ç”¨äº’æ–¥é”ï¼Œè¯»æ“ä½œæ˜¯ä¸²è¡Œçš„ã€‚</p>
<p>å…¶ä¸äº’æ–¥é”çš„åŒºåˆ«ä¸»è¦åœ¨äºè¯»æ“ä½œå¯ä»¥å¹¶è¡Œï¼Œå› æ­¤ï¼Œå½“çº¿ç¨‹æ¶‰åŠåˆ°å¤§é‡è¯»æ“ä½œï¼Œè¯»å†™é”çš„æ•ˆç‡æ¯”äº’æ–¥é”é«˜ã€‚</p>
<p>è¯»å†™é”è™½ç„¶æœ‰è¯»é”å’Œå†™é”ï¼Œä½†ä»–æ˜¯ã€Œä¸€æŠŠé”ã€ã€‚</p>
<p>å†™é”çš„ä¼˜å…ˆçº§æ¯”è¯»é”é«˜ã€‚</p>
<p>API:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// declare</span></span><br><span class="line"><span class="type">pthread_rwlock_t</span> rwlock;</span><br><span class="line"><span class="comment">// init</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_rwlock_init</span><span class="params">(<span class="type">pthread_rwlock_t</span> *restrict rolock, <span class="type">const</span> <span class="type">pthread_rwlockattr_t</span> *restrict attr)</span></span>;</span><br><span class="line"><span class="comment">// destory</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_destory</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="comment">// read lockï¼Œå¦‚æœå·²ç»åŠ äº†å†™é”ï¼Œçº¿ç¨‹é˜»å¡</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_rwlock_rdlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="comment">// try read lockï¼Œå¦‚æœå·²ç»å†™äº†å†™é”ï¼Œå¤±è´¥è¿”å›ï¼Œä¸ä¼šé˜»å¡</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_rwlock_tryrdlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="comment">// write lockï¼Œåªè¦åŠ äº†é”ï¼ˆè¯»/å†™ï¼‰å°±ä¼šå¤±è´¥ï¼Œé˜»å¡</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_rwlock_wrlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="comment">// try write lock</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_rwlock_tryrwlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"><span class="comment">// unlock</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_rwlock_unlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br></pre></td></tr></table></figure>

<p>Exampleï¼šä¸‹é¢æ˜¯ï¼Œ5ä¸ªçº¿ç¨‹æ‰§è¡Œè¯»æ“ä½œï¼Œ3ä¸ªçº¿ç¨‹æ‰§è¡Œå†™æ“ä½œã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX (20)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> READ_COUNT  (5)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_COUNT (3)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> sum;    </span><br><span class="line"><span class="type">pthread_rwlock_t</span> rwlock;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func_read</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_rwlock_rdlock</span>(&amp;rwlock);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Thread read, id = %lu, sum = %d\n&quot;</span>, <span class="built_in">pthread_self</span>(), sum);</span><br><span class="line">        <span class="built_in">pthread_rwlock_unlock</span>(&amp;rwlock);</span><br><span class="line">        <span class="built_in">usleep</span>(<span class="built_in">rand</span>() % <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">func_write</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_rwlock_wrlock</span>(&amp;rwlock);</span><br><span class="line">        <span class="type">int</span> cur = sum;</span><br><span class="line">        cur ++ ;   </span><br><span class="line">        sum = cur;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Thread write, id = %lu, sum = %d\n&quot;</span>, <span class="built_in">pthread_self</span>(), sum);</span><br><span class="line">        <span class="built_in">pthread_rwlock_unlock</span>(&amp;rwlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">pthread_rwlock_init</span>(&amp;rwlock, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">pthread_t</span> rd[READ_COUNT], wr[READ_COUNT];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_COUNT; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        rd[i] = <span class="built_in">pthread_create</span>(&amp;rd[i], <span class="literal">NULL</span>, func_read, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; WRITE_COUNT; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        wr[i] = <span class="built_in">pthread_create</span>(&amp;wr[i], <span class="literal">NULL</span>, func_write, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; READ_COUNT; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(rd[i], <span class="literal">NULL</span>);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; WRITE_COUNT; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(wr[i], <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// expect sum = 60</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Father thread id = %ld\n, sum = %d&quot;</span>, <span class="built_in">pthread_self</span>(), sum);</span><br><span class="line">    <span class="built_in">pthread_exit</span>(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">pthread_rwlock_destroy</span>(&amp;rwlock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæ‰€æœ‰æ‰“å°å‡ºæ¥çš„ sum æ˜¯å‡åºçš„ï¼Œè¿™è¯´æ˜æˆ‘ä»¬çš„è¯»å†™é”æ²¡æœ‰é—®é¢˜ï¼Œå¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œæœ‰å¤§é‡è¯»æ“ä½œåœ¨æœ€åæ‰æ‰§è¡Œï¼Œè¿™æ˜¯å› ä¸ºå‰é¢è¯´çš„ï¼Œå½“ä¸€ä¸ªè¯»æ“ä½œå’Œä¸€ä¸ªå†™æ“ä½œåŒæ—¶è®¿é—®åŒä¸€ä¸ªä¸´ç•Œèµ„æºæ—¶ï¼Œå†™æ“ä½œçš„ä¼˜å…ˆçº§æ›´é«˜ã€‚</p>
<h3 id="4-æ¡ä»¶å˜é‡"><a href="#4-æ¡ä»¶å˜é‡" class="headerlink" title="4. æ¡ä»¶å˜é‡"></a>4. æ¡ä»¶å˜é‡</h3><p>ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼Œæ¡ä»¶å˜é‡çš„ä¸»è¦ä½œç”¨ä¸æ˜¯å¤„ç†çº¿ç¨‹åŒæ­¥ï¼Œ<strong>è€Œæ˜¯è¿›è¡Œçº¿ç¨‹çš„é˜»å¡ã€‚</strong></p>
<p>å¦‚æœå¤šçº¿ç¨‹ä¸‹åªä½¿ç”¨æ¡ä»¶å˜é‡æ— æ³•å®Œæˆçº¿ç¨‹çš„åŒæ­¥ï¼Œå¿…é¡»è¦é…åˆäº’æ–¥é”æ¥ä½¿ç”¨ã€‚</p>
<p>é‚£æ—¢ç„¶æœ‰äº†äº’æ–¥é”ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨æ¡ä»¶å˜é‡å‘¢ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†å¤„ç†ã€Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹ã€ã€‚ï¼ˆå¸¸è§„çš„ä¸´ç•Œèµ„æºåªæœ‰ä¸€ä»½ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œè€Œæœ‰æ—¶å€™ä¸´ç•Œèµ„æºå¯èƒ½æœ‰å¤šä»½ï¼Œå¯ä»¥åˆ†ç»™å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å°±æ˜¯æ¡ä»¶å˜é‡çš„ç”¨å¤„ï¼‰</p>
<p>APIs</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// declare</span></span><br><span class="line"><span class="type">pthread_cond_t</span> cond;</span><br><span class="line"><span class="comment">// create</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_init</span><span class="params">(<span class="type">pthread_cond_t</span> *restrict cond, <span class="type">const</span> <span class="type">pthread_condattr_t</span> *restrict atrt)</span></span>;</span><br><span class="line"><span class="comment">// destroy</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_destroy</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span></span>;</span><br><span class="line"><span class="comment">// waitï¼Œä¼šé˜»å¡</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_wait</span><span class="params">(<span class="type">pthread_cond_t</span> *restrict cond, <span class="type">pthread_mutex_t</span> *restrict mutex)</span></span>; <span class="comment">// å¯ä»¥å‘ç°ï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªäº’æ–¥é”;å…¶ä¸­ï¼Œäº’æ–¥é”æ˜¯ç”¨æ¥åŒæ­¥çš„ï¼Œæ¡ä»¶å˜é‡æ˜¯ç”¨æ¥é˜»å¡çº¿ç¨‹çš„ã€‚</span></span><br><span class="line"><span class="comment">// time waitï¼Œå°†çº¿ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_timewait</span><span class="params">(<span class="type">pthread_cond_t</span> *restrict cond, <span class="type">pthread_mutex_t</span> *restrict mutex, <span class="type">const</span> <span class="keyword">struct</span> timespec *restrict abstime)</span></span>; <span class="comment">// é˜»å¡æ—¶é—´ä¸º sec + nsecã€‚</span></span><br><span class="line"><span class="comment">// signal specific oneï¼Œè‡³å°‘æœ‰ä¸€ä¸ªè¢«è§£é™¤é˜»å¡</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_signal</span><span class="params">(<span class="type">pthread_cont_t</span> *cond)</span></span>;</span><br><span class="line"><span class="comment">// signal allï¼Œå”¤é†’é˜»å¡åœ¨æ¡ä»¶å˜é‡ä¼¤çš„çº¿ç¨‹ï¼Œè¢«é˜»å¡çš„çº¿ç¨‹å…¨éƒ¨è§£é™¤é˜»å¡</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_cond_broadcast</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span></span>; 	<span class="comment">// å°†æ‰€æœ‰çº¿ç¨‹å”¤é†’ä¹‹åï¼Œåªæœ‰waitæˆåŠŸçš„çº¿ç¨‹æ‰ä¼šæ‰§è¡Œï¼Œå‰©ä¸‹çš„waitå¤±è´¥çš„çº¿ç¨‹ä¼šç»§ç»­é˜»å¡ã€‚</span></span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆ pthread_cond_wait() çš„å‚æ•°æœ‰ä¸€ä¸ª mutexï¼Ÿ</p>
<blockquote>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ wait åšäº†ä»€ä¹ˆï¼Ÿ</p>
<ol>
<li>é‡Šæ”¾è‡ªå·±å æ®çš„ mutexï¼ˆä½œä¸ºå‚æ•°ä¼ å…¥ï¼‰</li>
<li>é˜»å¡ï¼Œç­‰å¾…è¢«åˆ«çš„çº¿ç¨‹å”¤é†’</li>
<li>è¢«å”¤é†’åï¼Œå†æ¬¡è·å– mutexï¼ˆä½œä¸ºå‚æ•°ä¼ å…¥ï¼‰</li>
</ol>
<p>ç°åœ¨æ˜ç™½äº†å§ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬æ‰§è¡Œ cond_wait çš„æ—¶å€™ï¼Œéƒ½æ˜¯å·²ç» mutex_lock çš„ï¼Œå¦‚æœæˆ‘ä»¬ä¸ unlock çš„è¯ï¼Œå…¶ä»–çº¿ç¨‹å°±æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¹Ÿå°±æ— æ³• cond_signalï¼Œé‚£ä¹ˆè¢«é˜»å¡çš„çº¿ç¨‹ä¹Ÿå°±ä¸ä¼šè¢«å”¤é†’ã€‚ä¹Ÿå°±å‘ç”Ÿäº†æ­»é”ã€‚</p>
</blockquote>
<p>example1ï¼šç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ - é“¾è¡¨</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COUNT (5)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">node_t</span> &#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">node_t</span> *next;</span><br><span class="line">&#125; Node;</span><br><span class="line"></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex;</span><br><span class="line"><span class="type">pthread_cond_t</span> cond;</span><br><span class="line">Node *head;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">produce</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> id = (<span class="type">unsigned</span> <span class="type">long</span>)arg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// é“¾è¡¨ä¸å¯èƒ½æ»¡ï¼Œé™¤émallocé”™è¯¯</span></span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line">        <span class="type">int</span> val = <span class="built_in">rand</span>() % <span class="number">1000</span>;</span><br><span class="line">        Node *newNode = (Node*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(Node));</span><br><span class="line">        newNode-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        newNode-&gt;val = val;</span><br><span class="line">        <span class="keyword">if</span>(newNode == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[Producer] id = %ld, malloc Wrong\n&quot;</span>, id);</span><br><span class="line">        &#125;</span><br><span class="line">        newNode-&gt;next = head;</span><br><span class="line">        head = newNode;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[Producer%d] id = %lu, val = %d\n&quot;</span>, id, <span class="built_in">pthread_self</span>(), val);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line">        <span class="built_in">pthread_cond_signal</span>(&amp;cond);</span><br><span class="line">        <span class="comment">// pthread_cond_broadcast(&amp;mutex);</span></span><br><span class="line">        <span class="built_in">sleep</span>(<span class="built_in">rand</span>() % <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">consume</span><span class="params">(<span class="type">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> id = (<span class="type">unsigned</span> <span class="type">long</span>)arg;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_mutex_lock</span>(&amp;mutex);</span><br><span class="line">        <span class="keyword">while</span>(head == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// é˜»å¡æ¶ˆè´¹è€…è¿›ç¨‹ï¼Œå¹¶é‡Šæ”¾å®ƒçš„é”ï¼Œå¦åˆ™ï¼Œå®ƒæ—¢å æ®ç€mutexï¼Œåˆå æ®condï¼Œå°±ä¼šæ­»é”</span></span><br><span class="line">            <span class="built_in">pthread_cond_wait</span>(&amp;cond, &amp;mutex);   </span><br><span class="line">        &#125;</span><br><span class="line">        Node *cur = head;</span><br><span class="line">        head = head-&gt;next;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[Consumer%d] id = %lu, val = %d\n&quot;</span>, id, <span class="built_in">pthread_self</span>(), cur-&gt;val);</span><br><span class="line">        <span class="built_in">free</span>(cur);</span><br><span class="line">        <span class="built_in">pthread_mutex_unlock</span>(&amp;mutex);</span><br><span class="line">        <span class="built_in">sleep</span>(<span class="built_in">rand</span>() % <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">srand</span>(<span class="built_in">time</span>(<span class="literal">NULL</span>));</span><br><span class="line">    <span class="built_in">pthread_mutex_init</span>(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">pthread_cond_init</span>(&amp;cond, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="type">pthread_t</span> t1[COUNT], t2[COUNT];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;t1[i], <span class="literal">NULL</span>, produce, (<span class="type">void</span>*)i);</span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;t2[i], <span class="literal">NULL</span>, consume, (<span class="type">void</span>*)i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">pthread_join</span>(t1[i], <span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">pthread_join</span>(t2[i], <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_cond_destroy</span>(&amp;cond);</span><br><span class="line">    <span class="built_in">pthread_mutex_destroy</span>(&amp;mutex);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨è¿™ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨é“¾è¡¨å‚¨å­˜äº§å“ï¼Œå› ä¸ºç†è®ºä¸Šå¯ä»¥å­˜å‚¨æ— é™ä¸ªäº§å“ï¼Œæ‰€ä»¥åªéœ€è¦ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶å˜é‡åˆ¤æ–­äº§å“é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚</p>
<p>å¦‚æœä½¿ç”¨æ•°ç»„ï¼Œå³äº§å“æ˜¯æœ‰é™çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ–°çš„æ¡ä»¶å˜é‡æ¥åˆ¤æ–­äº§å“æ˜¯å¦æ»¡äº†ã€‚</p>
<p>æ³¨æ„æˆ‘ä»¬ä¸èƒ½åŒæ—¶ä½¿ç”¨åŒä¸€ä¸ªæ¡ä»¶å˜é‡åˆ¤æ–­æ˜¯å¦ä¸ºæ»¡å’Œæ˜¯å¦ä¸ºç©ºã€‚</p>
</blockquote>
<p>example2ï¼šç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ - æ•°ç»„</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="5-ä¿¡å·é‡"><a href="#5-ä¿¡å·é‡" class="headerlink" title="5. ä¿¡å·é‡"></a>5. ä¿¡å·é‡</h3><p>åŒæ¡ä»¶å˜é‡ä¸€æ ·ï¼Œä¿¡å·é‡ä¸»è¦ç”¨äºé˜»å¡çº¿ç¨‹ï¼Œä¸èƒ½å®Œå…¨ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¦‚æœè¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œéœ€è¦ä¿¡å·é‡å’Œäº’æ–¥é”ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>å¦å¤–ï¼Œéœ€è¦æ³¨æ„ä¿¡å·é‡çš„waitå’Œæ¡ä»¶å˜é‡çš„waitæ˜¯ä¸åŒçš„ï¼Œè¿™ä»å‚æ•°åˆ—è¡¨å°±å¯ä»¥å‘ç°ï¼Œä¿¡å·é‡çš„waitå‚æ•°åˆ—è¡¨ä¸­å¹¶æ²¡æœ‰ mutex å‚æ•°ï¼Œå› æ­¤ï¼Œå½“çº¿ç¨‹é˜»å¡æ—¶ï¼Œä»–ä¸ä¼šé‡Šæ”¾è·å–çš„ mutex èµ„æºï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡æ‰‹å·¥çš„æ–¹å¼æ§åˆ¶ä¿¡å·é‡å’Œé”çš„è·å–é¡ºåºï¼šå…ˆè·å–ä¿¡å·é‡ï¼Œå†è·å–é”ï¼Œä»¥é¿å…æ­»é”ã€‚</p>
<p><code>&lt;semaphore.h&gt;</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// declare</span></span><br><span class="line"><span class="type">sem_t</span> sem;</span><br><span class="line"><span class="comment">// create</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sem_init</span><span class="params">(<span class="type">sem_t</span> *sem, <span class="type">int</span> pshared, <span class="type">unsigned</span> <span class="type">int</span> value)</span></span>;</span><br><span class="line">	<span class="comment">// pshared</span></span><br><span class="line">		<span class="comment">// 0: çº¿ç¨‹åŒæ­¥</span></span><br><span class="line">		<span class="comment">// !0:è¿›ç¨‹åŒæ­¥</span></span><br><span class="line">	<span class="comment">// value:åˆå§‹åŒ–å½“å‰ä¿¡å·é‡æ‹¥æœ‰çš„èµ„æºæ•°ï¼Œå¦‚æœèµ„æºæ•°ä¸º0ï¼Œçº¿ç¨‹å°±ä¼šè¢«é˜»å¡äº†ã€‚</span></span><br><span class="line"><span class="comment">// destroy</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sem_destroy</span><span class="params">(<span class="type">se_t</span> *sem)</span></span>;</span><br><span class="line"><span class="comment">// waitï¼Œif value==0ï¼Œé˜»å¡</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sem_wait</span><span class="params">(<span class="type">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="comment">// trywaitï¼Œä¸ä¼šé˜»å¡ï¼Œç›´æ¥å¤±è´¥</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sem_trywait</span><span class="params">(<span class="type">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="comment">// timewaitï¼Œèµ„æºæ•°ä¸º0æ—¶ï¼Œé˜»å¡çº¿ç¨‹ï¼Œåœ¨é˜»å¡ abs_timeout å¯¹åº”çš„æ—¶é—´ä¹‹åï¼Œè§£é™¤é˜»å¡çº¿ç¨‹</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sem_timedwait</span><span class="params">(<span class="type">sem_t</span> *sem, <span class="type">const</span> <span class="keyword">struct</span> timespec, *abs_timeout)</span></span>;</span><br><span class="line"><span class="comment">// post</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sem_post</span><span class="params">(<span class="type">sem_t</span> *sem)</span></span>;</span><br><span class="line"><span class="comment">// get shared value</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sem_getvalue</span><span class="params">(<span class="type">sem_t</span> *sem, <span class="type">int</span> *sval)</span></span>;</span><br><span class="line">	<span class="comment">// ç¬¬äºŒä¸ªå‚æ•°è¿”å› shared-valueï¼Œè¿”å›å€¼æ˜¯ç”¨æ¥é”™è¯¯æ£€æŸ¥çš„</span></span><br></pre></td></tr></table></figure>

<p>exampleï¼šç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å‹</p>
<h3 id="6-timespec"><a href="#6-timespec" class="headerlink" title="6. timespec"></a>6. timespec</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">timespec</span> &#123;</span><br><span class="line">    <span class="type">time_t</span> tv_sec;	<span class="comment">// ç§’</span></span><br><span class="line">    <span class="type">long</span> tv_nsec;	<span class="comment">// çº³ç§’</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// -------</span></span><br><span class="line">time mytim = <span class="built_in">time</span>(<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">timespec</span> tmsp;</span><br><span class="line">tmsp.tv.nsec = <span class="number">0</span>;</span><br><span class="line">tmsp.tv_sec = <span class="built_in">time</span>(<span class="literal">NULL</span>) + <span class="number">100</span>;	<span class="comment">// çº¿ç¨‹é˜»å¡100ç§’s</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¸‰ã€çº¿ç¨‹æ± "><a href="#ä¸‰ã€çº¿ç¨‹æ± " class="headerlink" title="ä¸‰ã€çº¿ç¨‹æ± "></a>ä¸‰ã€çº¿ç¨‹æ± </h2><h3 id="1-åŸç†"><a href="#1-åŸç†" class="headerlink" title="1. åŸç†"></a>1. åŸç†</h3><p>ä¸ºä»€ä¹ˆè¦æœ‰çº¿ç¨‹æ± </p>
<blockquote>
<p>åŒå†…å­˜æ± çš„è®¾è®¡éœ€æ±‚ä¸€æ ·ï¼Œçº¿ç¨‹æ± ä¹Ÿæ˜¯ç”¨æ¥é¿å…çº¿ç¨‹çš„å¤§é‡åˆ›å»ºå’Œé”€æ¯æ‰€å¸¦æ¥çš„å·¨å¤§å¼€é”€ã€‚</p>
</blockquote>
<p>çº¿ç¨‹æ± çš„ç»„æˆéƒ¨åˆ†</p>
<ol>
<li>ä»»åŠ¡é˜Ÿåˆ—ï¼šçº¿ç¨‹å°±æ˜¯ç”¨æ¥å¤„ç†ä»»åŠ¡çš„ï¼Œä½†æ˜¯å¯èƒ½ä»»åŠ¡çš„ä¸ªæ•°è¦è¿œå¤§äºçº¿ç¨‹çš„ä¸ªæ•°ï¼Œå› æ­¤æ— æ³•ä¸€æ¬¡æ€§å¤„ç†å®Œæ‰€æœ‰çš„ä»»åŠ¡ï¼Œå› æ­¤æˆ‘ä»¬å°±éœ€è¦ç”¨ä¸€ä¸ª data structï¼ˆä¸€èˆ¬ä¸ºæ•°ç»„ or é“¾è¡¨ï¼‰ å°†ä»»åŠ¡å­˜èµ·æ¥ã€‚</li>
<li>å·¥ä½œçš„çº¿ç¨‹ï¼šå¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡çš„æ¶ˆè´¹è€…ï¼Œé€šå¸¸æœ‰å¤šä¸ªã€‚</li>
<li>ç®¡ç†è€…çº¿ç¨‹ï¼šä¸å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œè´Ÿè´£ç®¡ç†å·¥ä½œçš„çº¿ç¨‹ï¼ˆå¢åŠ æˆ–è€…é”€æ¯çº¿ç¨‹ï¼‰ï¼Œåªæœ‰ä¸€ä¸ªã€‚</li>
</ol>
<p>ä»»åŠ¡é˜Ÿåˆ—çš„å­˜åœ¨ä¹Ÿæ„å‘³ç€ï¼Œçº¿ç¨‹æ± å°±å·®ä¸å¤šæ˜¯ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€‚çº¿ç¨‹æ± è´Ÿè´£ä¸ºè´Ÿæ¶ˆè´¹è€…çº¿ç¨‹å’Œä»»åŠ¡é˜Ÿåˆ—ï¼Œè€Œä½¿ç”¨è€…è´Ÿè´£ç»´æŠ¤ç”Ÿäº§è€…çº¿ç¨‹ï¼ˆé€šè¿‡çº¿ç¨‹æ± æä¾›çš„ API æ¥å£ï¼‰ã€‚</p>
<p>ä»»åŠ¡é˜Ÿåˆ—å­˜å‚¨çš„æ˜¯ä»»åŠ¡ï¼Œè€Œä»»åŠ¡é€šå¸¸æ˜¯ä¸€ä¸ªä¸ªï¼ˆå›è°ƒï¼‰å‡½æ•°ï¼Œå› æ­¤ä»»åŠ¡é˜Ÿåˆ—éœ€è¦å­˜å‚¨å‡½æ•°çš„åœ°å€ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å·¥ä½œçº¿ç¨‹æ˜¯ä¸€ç›´ä¸åœçš„å¹²æ´»ï¼Œç®¡ç†çº¿ç¨‹æ˜¯é—´éš”æ£€æµ‹çš„ã€‚</span><br><span class="line">å¦‚ä½•â€œé”€æ¯â€çº¿ç¨‹ï¼Ÿè®©ä»–ä»¬è‡ªæ€</span><br><span class="line">æ²¡å¹²æ´»çš„çº¿ç¨‹åœ¨å“ªå‘¢ï¼Ÿé€šè¿‡workerå‡½æ•°å¯ä»¥å‘ç°ï¼Œæ²¡å·¥ä½œçš„çº¿ç¨‹éƒ½é˜»å¡åœ¨äº†æ¡ä»¶å˜é‡é‡Œé¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚</span><br></pre></td></tr></table></figure>

<h3 id="2-è™šå‡å”¤é†’"><a href="#2-è™šå‡å”¤é†’" class="headerlink" title="2. è™šå‡å”¤é†’"></a>2. è™šå‡å”¤é†’</h3><p><font color=blue>TODO</font></p>
<h1 id="C-thread-pool-1"><a href="#C-thread-pool-1" class="headerlink" title="C++:thread_pool"></a>C++:thread_pool</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">jyyyx</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qaqowoqaq" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;qaqowoqaq" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/2407217576@qq.com" title="E-Mail â†’ 2407217576@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jyyyx</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
